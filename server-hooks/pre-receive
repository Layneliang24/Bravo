#!/bin/bash
# ğŸ›¡ï¸ Server-Side Pre-Receive Hook - Ultimate Protection Layer
# ç”¨é€”ï¼šåœ¨æœåŠ¡å™¨ç«¯è¿è¡Œæ‰€æœ‰æœ¬åœ°æ£€æŸ¥ï¼Œé˜²æ­¢ç»•è¿‡æœ¬åœ°é’©å­
# åŸåˆ™ï¼šå¿«é€Ÿå¤±è´¥ï¼Œä¸€æ—¦æ£€æŸ¥å¤±è´¥ç«‹å³ç»ˆæ­¢
# éƒ¨ç½²ï¼šé€‚ç”¨äºè‡ªå»ºGitæœåŠ¡å™¨ï¼ˆGitea/GitLab/GitHub Enterpriseï¼‰

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
set -o pipefail  # ç®¡é“å‘½ä»¤ä¸­ä»»ä¸€å¤±è´¥éƒ½ç®—å¤±è´¥

# =============================================================================
# é…ç½®åŒºåŸŸ
# =============================================================================

# ä¿æŠ¤çš„åˆ†æ”¯
PROTECTED_BRANCHES="main dev"

# é¢œè‰²è¾“å‡º
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# å¿«é€Ÿå¤±è´¥è®¡æ•°å™¨
FAILED_CHECKS=0
TOTAL_CHECKS=0

# =============================================================================
# å·¥å…·å‡½æ•°
# =============================================================================

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1" >&2
}

log_success() {
    echo -e "${GREEN}[âœ“]${NC} $1" >&2
}

log_warning() {
    echo -e "${YELLOW}[âš ]${NC} $1" >&2
}

log_error() {
    echo -e "${RED}[âœ—]${NC} $1" >&2
}

log_section() {
    echo -e "\n${BOLD}${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}" >&2
    echo -e "${BOLD}${BLUE}  $1${NC}" >&2
    echo -e "${BOLD}${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n" >&2
}

fail_check() {
    FAILED_CHECKS=$((FAILED_CHECKS + 1))
    log_error "$1"
    # å¿«é€Ÿå¤±è´¥ï¼šç«‹å³é€€å‡º
    echo -e "\n${RED}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}" >&2
    echo -e "${RED}${BOLD}â•‘  ğŸš« æœåŠ¡å™¨ç«¯æ£€æŸ¥å¤±è´¥ï¼æ¨é€è¢«æ‹’ç»ï¼                       â•‘${NC}" >&2
    echo -e "${RED}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n" >&2
    exit 1
}

pass_check() {
    TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
    log_success "$1"
}

# =============================================================================
# æ£€æŸ¥å‡½æ•°
# =============================================================================

# æ£€æŸ¥1ï¼šåˆ†æ”¯ä¿æŠ¤
check_branch_protection() {
    log_section "æ£€æŸ¥1/7ï¼šåˆ†æ”¯ä¿æŠ¤"

    local branch=$1

    for protected in $PROTECTED_BRANCHES; do
        if [ "$branch" = "$protected" ]; then
            log_error "ç›´æ¥æ¨é€åˆ°å—ä¿æŠ¤åˆ†æ”¯ '$branch' è¢«æœåŠ¡å™¨ç­–ç•¥æ‹’ç»ï¼"
            log_warning "å—ä¿æŠ¤åˆ†æ”¯: $PROTECTED_BRANCHES"
            log_info "è¯·ä½¿ç”¨ Pull Request å·¥ä½œæµ"
            echo "" >&2
            log_info "å¦‚æœä½ æ˜¯ä»“åº“ç®¡ç†å‘˜å¹¶éœ€è¦è¦†ç›–æ­¤ä¿æŠ¤ï¼š" >&2
            log_info "  1. ä¸´æ—¶ç¦ç”¨é’©å­: mv pre-receive pre-receive.disabled" >&2
            log_info "  2. æ¨é€å˜æ›´" >&2
            log_info "  3. é‡æ–°å¯ç”¨é’©å­: mv pre-receive.disabled pre-receive" >&2
            fail_check "åˆ†æ”¯ä¿æŠ¤æ£€æŸ¥å¤±è´¥"
        fi
    done

    pass_check "åˆ†æ”¯ä¿æŠ¤æ£€æŸ¥é€šè¿‡"
}

# æ£€æŸ¥2ï¼šæäº¤æ¶ˆæ¯æ ¼å¼
check_commit_message() {
    log_section "æ£€æŸ¥2/7ï¼šæäº¤æ¶ˆæ¯æ ¼å¼"

    local commit_msg="$1"
    local commit_sha="$2"

    # æ£€æŸ¥æäº¤æ¶ˆæ¯é•¿åº¦
    local msg_length=${#commit_msg}
    if [ $msg_length -lt 10 ]; then
        log_error "æäº¤æ¶ˆæ¯å¤ªçŸ­ (${msg_length}å­—ç¬¦ï¼Œæœ€å°‘10å­—ç¬¦)"
        log_error "Commit: $commit_sha"
        log_error "Message: $commit_msg"
        fail_check "æäº¤æ¶ˆæ¯æ ¼å¼æ£€æŸ¥å¤±è´¥"
    fi

    # æ£€æŸ¥æäº¤æ¶ˆæ¯æ ¼å¼ (å¯é€‰ï¼šéµå¾ª Conventional Commits)
    if [[ ! "$commit_msg" =~ ^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: ]]; then
        log_warning "æäº¤æ¶ˆæ¯ä¸ç¬¦åˆ Conventional Commits æ ¼å¼"
        log_warning "æ¨èæ ¼å¼: type(scope): subject"
        log_warning "ä¾‹å¦‚: feat(auth): add login functionality"
    fi

    pass_check "æäº¤æ¶ˆæ¯æ ¼å¼æ£€æŸ¥é€šè¿‡"
}

# æ£€æŸ¥3ï¼šç¦æ­¢çš„æ–‡ä»¶æ¨¡å¼
check_forbidden_files() {
    log_section "æ£€æŸ¥3/7ï¼šç¦æ­¢çš„æ–‡ä»¶å’Œæ¨¡å¼"

    local oldrev=$1
    local newrev=$2

    # æ£€æŸ¥æ˜¯å¦æœ‰æ•æ„Ÿæ–‡ä»¶
    local forbidden_patterns=(
        '\.env$'
        '\.env\.local$'
        '\.env\.production$'
        '\.(key|pem|p12|pfx|jks)$'
        'id_rsa'
        'id_dsa'
        'password'
        'secret'
    )

    local files_changed
    if [ "$oldrev" = "0000000000000000000000000000000000000000" ]; then
        # æ–°åˆ†æ”¯ï¼šæ£€æŸ¥æ‰€æœ‰æ–‡ä»¶
        files_changed=$(git diff-tree -r --name-only --no-commit-id $newrev 2>/dev/null || true)
    else
        # ç°æœ‰åˆ†æ”¯ï¼šæ£€æŸ¥å˜æ›´çš„æ–‡ä»¶
        files_changed=$(git diff --name-only $oldrev..$newrev 2>/dev/null || true)
    fi

    for pattern in "${forbidden_patterns[@]}"; do
        local matched_files=$(echo "$files_changed" | grep -E "$pattern" || true)
        if [ -n "$matched_files" ]; then
            log_error "æ£€æµ‹åˆ°ç¦æ­¢çš„æ–‡ä»¶æ¨¡å¼: $pattern"
            log_error "åŒ¹é…çš„æ–‡ä»¶:"
            echo "$matched_files" | while read file; do
                log_error "  - $file"
            done
            fail_check "ç¦æ­¢çš„æ–‡ä»¶æ£€æŸ¥å¤±è´¥"
        fi
    done

    pass_check "ç¦æ­¢çš„æ–‡ä»¶æ£€æŸ¥é€šè¿‡"
}

# æ£€æŸ¥4ï¼šå¤§æ–‡ä»¶æ£€æŸ¥
check_large_files() {
    log_section "æ£€æŸ¥4/7ï¼šå¤§æ–‡ä»¶æ£€æŸ¥"

    local oldrev=$1
    local newrev=$2
    local max_size=$((10 * 1024 * 1024))  # 10MB

    # è·å–æ–°å¢æˆ–ä¿®æ”¹çš„æ–‡ä»¶
    local files_to_check
    if [ "$oldrev" = "0000000000000000000000000000000000000000" ]; then
        files_to_check=$(git diff-tree -r --name-only --no-commit-id $newrev 2>/dev/null || true)
    else
        files_to_check=$(git diff --name-only $oldrev..$newrev 2>/dev/null || true)
    fi

    local large_files_found=false
    while read -r file; do
        [ -z "$file" ] && continue

        # è·å–æ–‡ä»¶å¤§å°
        local file_size=$(git cat-file -s "$newrev:$file" 2>/dev/null || echo 0)

        if [ "$file_size" -gt "$max_size" ]; then
            large_files_found=true
            local size_mb=$((file_size / 1024 / 1024))
            log_error "å¤§æ–‡ä»¶: $file (${size_mb}MB)"
        fi
    done <<< "$files_to_check"

    if [ "$large_files_found" = true ]; then
        log_error "æ£€æµ‹åˆ°å¤§äº10MBçš„æ–‡ä»¶"
        log_info "è¯·ä½¿ç”¨ Git LFS ç®¡ç†å¤§æ–‡ä»¶"
        fail_check "å¤§æ–‡ä»¶æ£€æŸ¥å¤±è´¥"
    fi

    pass_check "å¤§æ–‡ä»¶æ£€æŸ¥é€šè¿‡"
}

# æ£€æŸ¥5ï¼šä»£ç è´¨é‡æ ‡è®°
check_code_quality_markers() {
    log_section "æ£€æŸ¥5/7ï¼šä»£ç è´¨é‡æ ‡è®°"

    local oldrev=$1
    local newrev=$2

    # æ£€æŸ¥æ˜¯å¦æœ‰TODO/FIXME/HACKç­‰æ ‡è®°ï¼ˆå¯é€‰ï¼‰
    local quality_markers=(
        'console\.log'
        'debugger'
        'TODO:'
        'FIXME:'
        'HACK:'
    )

    # è·å–æ–°å¢çš„ä»£ç è¡Œ
    local new_code
    if [ "$oldrev" = "0000000000000000000000000000000000000000" ]; then
        new_code=$(git show $newrev 2>/dev/null || true)
    else
        new_code=$(git diff $oldrev..$newrev 2>/dev/null || true)
    fi

    # æ£€æŸ¥åˆå¹¶å†²çªæ ‡è®°ï¼ˆä¸¥æ ¼ï¼‰- ä½¿ç”¨å˜é‡æ‹¼æ¥é¿å…è¯¯æŠ¥
    local conflict_start="<""<""<""<""<""<""< HEAD"
    local conflict_sep="=""=""=""=""=""=""="
    local conflict_end=">"">"">"">"">"">"">"">"
    if echo "$new_code" | grep -qE "($conflict_start|$conflict_sep|$conflict_end)"; then
        log_error "æ£€æµ‹åˆ°æœªè§£å†³çš„åˆå¹¶å†²çªæ ‡è®°"
        fail_check "ä»£ç è´¨é‡æ ‡è®°æ£€æŸ¥å¤±è´¥"
    fi

    # æ£€æŸ¥å…¶ä»–æ ‡è®°ï¼ˆè­¦å‘Šï¼‰
    for marker in 'console\.log' 'debugger'; do
        if echo "$new_code" | grep -q "$marker"; then
            log_warning "æ£€æµ‹åˆ°è°ƒè¯•ä»£ç : $marker"
        fi
    done

    pass_check "ä»£ç è´¨é‡æ ‡è®°æ£€æŸ¥é€šè¿‡"
}

# æ£€æŸ¥6ï¼šDockerå®¹å™¨ä¾èµ–ç®¡ç†è§„èŒƒï¼ˆåŸºäº30è½®ä¿®å¤æ•™è®­ï¼‰
check_docker_dependency_rules() {
    log_section "æ£€æŸ¥6/7ï¼šDockerå®¹å™¨ä¾èµ–ç®¡ç†è§„èŒƒ"

    local oldrev=$1
    local newrev=$2

    # æ£€æŸ¥æ˜¯å¦ä¿®æ”¹äº†ä¾èµ–ç›¸å…³æ–‡ä»¶
    local dependency_files
    if [ "$oldrev" = "0000000000000000000000000000000000000000" ]; then
        dependency_files=$(git diff-tree -r --name-only --no-commit-id $newrev 2>/dev/null | grep -E '(package\.json|package-lock\.json|requirements\.txt|Pipfile|Pipfile\.lock)' || true)
    else
        dependency_files=$(git diff --name-only $oldrev..$newrev 2>/dev/null | grep -E '(package\.json|package-lock\.json|requirements\.txt|Pipfile|Pipfile\.lock)' || true)
    fi

    if [ -n "$dependency_files" ]; then
        log_info "æ£€æµ‹åˆ°ä¾èµ–æ–‡ä»¶å˜æ›´:"
        echo "$dependency_files" | while read file; do
            log_info "  - $file"
        done

        # æ£€æŸ¥æ˜¯å¦æœ‰ npm workspaces ç»“æ„ç ´å
        if echo "$dependency_files" | grep -q 'frontend/e2e/package-lock\.json'; then
            log_error "æ£€æµ‹åˆ°å­ç›®å½•çš„ package-lock.json å˜æ›´"
            log_error "è¿™å¯èƒ½ç ´å npm workspaces ä¾èµ–ç»“æ„"
            log_info "æ­£ç¡®åšæ³•ï¼š"
            log_info "  1. åªåœ¨æ ¹ç›®å½•è¿è¡Œ 'npm ci'"
            log_info "  2. å­ç›®å½•åªè¿è¡Œ 'npm run build/test'"
            fail_check "Dockerä¾èµ–ç®¡ç†è§„èŒƒæ£€æŸ¥å¤±è´¥"
        fi

        log_info "ä¾èµ–å˜æ›´å·²è®°å½•ï¼Œè¯·ç¡®ä¿åœ¨Dockerå®¹å™¨ä¸­æµ‹è¯•"
    fi

    pass_check "Dockerä¾èµ–ç®¡ç†è§„èŒƒæ£€æŸ¥é€šè¿‡"
}

# æ£€æŸ¥7ï¼šæ ¹ç›®å½•å®ˆå«
check_root_directory_guard() {
    log_section "æ£€æŸ¥7/12ï¼šæ ¹ç›®å½•å®ˆå«"

    local oldrev=$1
    local newrev=$2

    # è·å–æ ¹ç›®å½•æ–°å¢æˆ–ä¿®æ”¹çš„æ–‡ä»¶
    local root_files
    if [ "$oldrev" = "0000000000000000000000000000000000000000" ]; then
        root_files=$(git diff-tree -r --name-only --no-commit-id $newrev 2>/dev/null | grep -E '^[^/]+\.' || true)
    else
        root_files=$(git diff --name-only --diff-filter=AM $oldrev..$newrev 2>/dev/null | grep -E '^[^/]+\.' || true)
    fi

    if [ -z "$root_files" ]; then
        pass_check "æ ¹ç›®å½•å®ˆå«æ£€æŸ¥é€šè¿‡"
        return 0
    fi

    # å…è®¸çš„æ ¹ç›®å½•æ–‡ä»¶æ¨¡å¼
    local allowed_patterns=(
        '^\.'  # éšè—æ–‡ä»¶/é…ç½®æ–‡ä»¶
        '^package\.json$'
        '^package-lock\.json$'
        '^docker-compose.*\.yml$'
        '^Dockerfile.*'
        '^Makefile$'
        '^(setup|install|configure|build|deploy|test|safe-push|passport)\.(sh|py|js)$'
        '^(README|CODE_OF_CONDUCT|CONTRIBUTING|SECURITY|CHANGELOG|LICENSE|AUTHORS|NOTICE)\.md$'
        '^(requirements|Pipfile|Gemfile|go\.mod|Cargo\.toml).*'
    )

    # æ£€æŸ¥æ¯ä¸ªæ ¹ç›®å½•æ–‡ä»¶
    local forbidden_files=""
    while read -r file; do
        [ -z "$file" ] && continue

        local is_allowed=false
        for pattern in "${allowed_patterns[@]}"; do
            if echo "$file" | grep -qE "$pattern"; then
                is_allowed=true
                break
            fi
        done

        if [ "$is_allowed" = false ]; then
            forbidden_files="${forbidden_files}  - $file\n"
        fi
    done <<< "$root_files"

    if [ -n "$forbidden_files" ]; then
        log_error "æ£€æµ‹åˆ°æ ¹ç›®å½•ä¸å…è®¸çš„æ–‡ä»¶ï¼š"
        echo -e "$forbidden_files" >&2
        log_info "å…è®¸çš„æ–‡ä»¶ç±»å‹ï¼š"
        log_info "  - é…ç½®æ–‡ä»¶ï¼ˆ.å¼€å¤´ï¼‰"
        log_info "  - æ ‡å‡†æ–‡æ¡£ï¼ˆREADME, LICENSEç­‰ï¼‰"
        log_info "  - å®‰è£…è„šæœ¬ï¼ˆsetup.sh, install.shç­‰ï¼‰"
        log_info "  - Dockeræ–‡ä»¶ï¼ˆdocker-compose.yml, Dockerfileï¼‰"
        fail_check "æ ¹ç›®å½•å®ˆå«æ£€æŸ¥å¤±è´¥"
    fi

    pass_check "æ ¹ç›®å½•å®ˆå«æ£€æŸ¥é€šè¿‡"
}

# æ£€æŸ¥8ï¼šYAML/JSON æ–‡ä»¶è¯­æ³•
check_file_syntax() {
    log_section "æ£€æŸ¥8/12ï¼šYAML/JSON æ–‡ä»¶è¯­æ³•"

    local oldrev=$1
    local newrev=$2

    # è·å–ä¿®æ”¹çš„ YAML/JSON æ–‡ä»¶
    local config_files
    if [ "$oldrev" = "0000000000000000000000000000000000000000" ]; then
        config_files=$(git diff-tree -r --name-only --no-commit-id $newrev 2>/dev/null | grep -E '\.(yml|yaml|json)$' || true)
    else
        config_files=$(git diff --name-only $oldrev..$newrev 2>/dev/null | grep -E '\.(yml|yaml|json)$' || true)
    fi

    if [ -z "$config_files" ]; then
        pass_check "æ–‡ä»¶è¯­æ³•æ£€æŸ¥è·³è¿‡ï¼ˆæ— é…ç½®æ–‡ä»¶å˜æ›´ï¼‰"
        return 0
    fi

    local syntax_errors=false
    while read -r file; do
        [ -z "$file" ] && continue

        # è·å–æ–‡ä»¶å†…å®¹
        local file_content=$(git show "$newrev:$file" 2>/dev/null || true)

        # YAML åŸºæœ¬è¯­æ³•æ£€æŸ¥
        if echo "$file" | grep -qE '\.(yml|yaml)$'; then
            # æ£€æŸ¥åŸºæœ¬ YAML è¯­æ³•é”™è¯¯
            if echo "$file_content" | grep -qE '^\s*\t'; then
                log_error "YAML æ–‡ä»¶åŒ…å«åˆ¶è¡¨ç¬¦ï¼ˆåº”ä½¿ç”¨ç©ºæ ¼ï¼‰: $file"
                syntax_errors=true
            fi
            if echo "$file_content" | grep -qE '^[^#]*:[^/].*[^:]$' | grep -qE ':\s*[^"\x27\s].*:\s*[^"\x27\s]'; then
                log_warning "å¯èƒ½çš„ YAML è¯­æ³•é—®é¢˜: $file"
            fi
        fi

        # JSON åŸºæœ¬è¯­æ³•æ£€æŸ¥
        if echo "$file" | grep -qE '\.json$'; then
            # æ£€æŸ¥åŸºæœ¬ JSON ç»“æ„
            if ! echo "$file_content" | grep -qE '^\s*[\{\[].*[\}\]]\s*$'; then
                log_warning "å¯èƒ½çš„ JSON è¯­æ³•é—®é¢˜: $file"
            fi
        fi
    done <<< "$config_files"

    if [ "$syntax_errors" = true ]; then
        fail_check "æ–‡ä»¶è¯­æ³•æ£€æŸ¥å¤±è´¥"
    fi

    pass_check "æ–‡ä»¶è¯­æ³•æ£€æŸ¥é€šè¿‡"
}

# æ£€æŸ¥9ï¼šæ–‡ä»¶åå†²çªæ£€æµ‹
check_filename_conflicts() {
    log_section "æ£€æŸ¥9/12ï¼šæ–‡ä»¶åå†²çªæ£€æµ‹"

    local oldrev=$1
    local newrev=$2

    # è·å–æ‰€æœ‰æ–‡ä»¶
    local all_files=$(git ls-tree -r --name-only $newrev 2>/dev/null || true)

    # è½¬æ¢ä¸ºå°å†™å¹¶æŸ¥æ‰¾é‡å¤
    local conflicts=$(echo "$all_files" | tr '[:upper:]' '[:lower:]' | sort | uniq -d)

    if [ -n "$conflicts" ]; then
        log_error "æ£€æµ‹åˆ°æ–‡ä»¶åå¤§å°å†™å†²çªï¼ˆè·¨å¹³å°é—®é¢˜ï¼‰ï¼š"
        while read -r conflict; do
            [ -z "$conflict" ] && continue
            # æ‰¾åˆ°å®é™…çš„å†²çªæ–‡ä»¶
            local actual_files=$(echo "$all_files" | grep -i "^${conflict}$")
            log_error "å†²çª: $actual_files"
        done <<< "$conflicts"
        log_info "Windows ä¸åŒºåˆ†å¤§å°å†™ï¼ŒLinux/Mac åŒºåˆ†"
        log_info "è¯·é‡å‘½åæ–‡ä»¶ä»¥é¿å…å†²çª"
        fail_check "æ–‡ä»¶åå†²çªæ£€æŸ¥å¤±è´¥"
    fi

    pass_check "æ–‡ä»¶åå†²çªæ£€æŸ¥é€šè¿‡"
}

# æ£€æŸ¥10ï¼šNPM Workspaces æ¶æ„ä¿æŠ¤ï¼ˆå¢å¼ºç‰ˆï¼‰
check_npm_workspaces_enhanced() {
    log_section "æ£€æŸ¥10/12ï¼šNPM Workspaces æ¶æ„ä¿æŠ¤ï¼ˆå¢å¼ºï¼‰"

    local oldrev=$1
    local newrev=$2

    # è·å–å˜æ›´çš„æ–‡ä»¶
    local changed_files
    if [ "$oldrev" = "0000000000000000000000000000000000000000" ]; then
        changed_files=$(git diff-tree -r --name-only --no-commit-id $newrev 2>/dev/null || true)
    else
        changed_files=$(git diff --name-only $oldrev..$newrev 2>/dev/null || true)
    fi

    local violations=""

    # 1. æ£€æŸ¥å­ç›®å½•çš„ package-lock.json
    if echo "$changed_files" | grep -qE '^(frontend|backend)/[^/]+/package-lock\.json$'; then
        violations="${violations}âŒ æ£€æµ‹åˆ°å­ç›®å½•çš„ package-lock.json å˜æ›´\n"
        violations="${violations}   è¿™ä¼šç ´å npm workspaces ä¾èµ–ç»“æ„\n"
    fi

    # 2. æ£€æŸ¥å·¥ä½œæµæ–‡ä»¶ä¸­çš„å±é™©å‘½ä»¤
    local workflow_files=$(echo "$changed_files" | grep -E '\.github/workflows/.*\.yml$' || true)
    if [ -n "$workflow_files" ]; then
        while read -r workflow; do
            [ -z "$workflow" ] && continue
            local content=$(git show "$newrev:$workflow" 2>/dev/null || true)

            # æ£€æŸ¥å­ç›®å½•çš„ npm ci/install
            if echo "$content" | grep -qE 'cd\s+(frontend|backend)/[^/]+.*npm\s+(ci|install)'; then
                violations="${violations}âŒ å·¥ä½œæµæ–‡ä»¶åŒ…å«å­ç›®å½• npm ci/install: $workflow\n"
            fi
        done <<< "$workflow_files"
    fi

    # 3. æ£€æŸ¥è„šæœ¬æ–‡ä»¶ä¸­çš„å±é™©å‘½ä»¤
    local script_files=$(echo "$changed_files" | grep -E '\.(sh|py|js|Makefile)$' || true)
    if [ -n "$script_files" ]; then
        while read -r script; do
            [ -z "$script" ] && continue
            local content=$(git show "$newrev:$script" 2>/dev/null || true)

            # æ£€æŸ¥å­ç›®å½•çš„ npm ci/install
            if echo "$content" | grep -qE '(frontend|backend)/[^/]+.*npm\s+(ci|install)'; then
                violations="${violations}âš ï¸  è„šæœ¬æ–‡ä»¶å¯èƒ½åŒ…å«å­ç›®å½• npm æ“ä½œ: $script\n"
            fi
        done <<< "$script_files"
    fi

    if [ -n "$violations" ]; then
        log_error "NPM Workspaces æ¶æ„è¿è§„ï¼š"
        echo -e "$violations" >&2
        log_info "æ­£ç¡®åšæ³•ï¼š"
        log_info "  1. åªåœ¨æ ¹ç›®å½•è¿è¡Œ 'npm ci'"
        log_info "  2. å­ç›®å½•åªè¿è¡Œ 'npm run build/test'"
        log_info "  3. å·¥å…·ä½¿ç”¨ 'npx' è€Œéå…¨å±€å®‰è£…"
        fail_check "NPM Workspaces æ¶æ„ä¿æŠ¤å¤±è´¥"
    fi

    pass_check "NPM Workspaces æ¶æ„ä¿æŠ¤é€šè¿‡"
}

# æ£€æŸ¥11ï¼šScripts-Golden æ ¸å¿ƒè„šæœ¬ä¿æŠ¤
check_scripts_golden_protection() {
    log_section "æ£€æŸ¥11/12ï¼šScripts-Golden æ ¸å¿ƒè„šæœ¬ä¿æŠ¤"

    local oldrev=$1
    local newrev=$2

    # æ£€æŸ¥ scripts-golden ç›®å½•çš„ä¿®æ”¹
    local golden_changes
    if [ "$oldrev" = "0000000000000000000000000000000000000000" ]; then
        golden_changes=$(git diff-tree -r --name-only --no-commit-id $newrev 2>/dev/null | grep '^scripts-golden/' || true)
    else
        golden_changes=$(git diff --name-only $oldrev..$newrev 2>/dev/null | grep '^scripts-golden/' || true)
    fi

    if [ -n "$golden_changes" ]; then
        log_error "æ£€æµ‹åˆ° scripts-golden ç›®å½•çš„ä¿®æ”¹ï¼š"
        echo "$golden_changes" | while read file; do
            log_error "  - $file"
        done
        log_warning "scripts-golden ç›®å½•åŒ…å«æ ¸å¿ƒå®‰å…¨è„šæœ¬"
        log_info "ä¿®æ”¹è¿™äº›è„šæœ¬éœ€è¦ï¼š"
        log_info "  1. å®‰å…¨å®¡æŸ¥"
        log_info "  2. å›¢é˜Ÿæ‰¹å‡†"
        log_info "  3. è¯¦ç»†çš„å˜æ›´è¯´æ˜"
        log_info "å¦‚æœç¡®å®éœ€è¦ä¿®æ”¹ï¼Œè¯·è”ç³»é¡¹ç›®ç»´æŠ¤äººå‘˜"
        fail_check "Scripts-Golden ä¿æŠ¤æ£€æŸ¥å¤±è´¥"
    fi

    pass_check "Scripts-Golden ä¿æŠ¤æ£€æŸ¥é€šè¿‡"
}

# æ£€æŸ¥12ï¼šæœ¬åœ°æµ‹è¯•é€šè¡Œè¯ï¼ˆå¦‚æœå¯ç”¨ï¼‰
check_local_test_passport() {
    log_section "æ£€æŸ¥12/12ï¼šæœ¬åœ°æµ‹è¯•é€šè¡Œè¯éªŒè¯"

    # æ³¨æ„ï¼šæœåŠ¡å™¨ç«¯å¯èƒ½æ— æ³•éªŒè¯æœ¬åœ°é€šè¡Œè¯
    # è¿™é‡Œåªåšè­¦å‘Šï¼Œä¸åšå¼ºåˆ¶æ£€æŸ¥
    log_warning "æœåŠ¡å™¨ç«¯æ— æ³•éªŒè¯æœ¬åœ°æµ‹è¯•é€šè¡Œè¯"
    log_warning "è¯·ç¡®ä¿æ¨é€å‰å·²è¿è¡Œæœ¬åœ°æµ‹è¯•"
    log_info "æ¨èå·¥ä½œæµï¼š"
    log_info "  1. ./test (è¿è¡Œæœ¬åœ°æµ‹è¯•)"
    log_info "  2. ./passport (æ£€æŸ¥é€šè¡Œè¯)"
    log_info "  3. ./safe-push (å®‰å…¨æ¨é€)"

    pass_check "æœ¬åœ°æµ‹è¯•é€šè¡Œè¯æ£€æŸ¥è·³è¿‡ï¼ˆè­¦å‘Šï¼‰"
}

# =============================================================================
# ä¸»é€»è¾‘
# =============================================================================

log_section "ğŸ›¡ï¸ æœåŠ¡å™¨ç«¯ Pre-Receive Hook å¯åŠ¨"
log_info "å¿«é€Ÿå¤±è´¥æ¨¡å¼ï¼šä»»ä½•æ£€æŸ¥å¤±è´¥éƒ½å°†ç«‹å³ç»ˆæ­¢æ¨é€"
log_info "é˜²æ­¢ç»•è¿‡æœ¬åœ°é’©å­çš„æœ€åä¸€é“é˜²çº¿"

# è¯»å–æ¨é€çš„å¼•ç”¨
while read oldrev newrev refname
do
    # æå–åˆ†æ”¯å
    branch=$(echo "$refname" | sed 's/refs\/heads\///')

    log_section "æ¨é€ä¿¡æ¯"
    log_info "åˆ†æ”¯: $branch"
    log_info "æ—§ç‰ˆæœ¬: ${oldrev:0:8}"
    log_info "æ–°ç‰ˆæœ¬: ${newrev:0:8}"

    # å¦‚æœæ˜¯åˆ é™¤åˆ†æ”¯ï¼Œè·³è¿‡æ£€æŸ¥
    if [ "$newrev" = "0000000000000000000000000000000000000000" ]; then
        log_warning "åˆ é™¤åˆ†æ”¯æ“ä½œï¼Œè·³è¿‡æ£€æŸ¥"
        continue
    fi

    # æ‰§è¡Œæ‰€æœ‰æ£€æŸ¥ï¼ˆå¿«é€Ÿå¤±è´¥ï¼‰
    check_branch_protection "$branch"
    check_forbidden_files "$oldrev" "$newrev"
    check_large_files "$oldrev" "$newrev"
    check_code_quality_markers "$oldrev" "$newrev"
    check_docker_dependency_rules "$oldrev" "$newrev"
    check_root_directory_guard "$oldrev" "$newrev"
    check_file_syntax "$oldrev" "$newrev"
    check_filename_conflicts "$oldrev" "$newrev"
    check_npm_workspaces_enhanced "$oldrev" "$newrev"
    check_scripts_golden_protection "$oldrev" "$newrev"
    check_local_test_passport

    # æ£€æŸ¥æ¯ä¸ªæäº¤çš„æ¶ˆæ¯
    log_section "æäº¤æ¶ˆæ¯æ£€æŸ¥"
    if [ "$oldrev" = "0000000000000000000000000000000000000000" ]; then
        # æ–°åˆ†æ”¯ï¼šæ£€æŸ¥æ‰€æœ‰æäº¤
        commits=$(git rev-list $newrev 2>/dev/null || true)
    else
        # ç°æœ‰åˆ†æ”¯ï¼šåªæ£€æŸ¥æ–°æäº¤
        commits=$(git rev-list $oldrev..$newrev 2>/dev/null || true)
    fi

    commit_count=0
    while read -r commit; do
        [ -z "$commit" ] && continue
        commit_count=$((commit_count + 1))

        commit_msg=$(git log --format=%B -n 1 $commit 2>/dev/null || echo "")
        check_commit_message "$commit_msg" "${commit:0:8}"
    done <<< "$commits"

    log_info "æ£€æŸ¥äº† $commit_count ä¸ªæäº¤"

done

# æ‰€æœ‰æ£€æŸ¥é€šè¿‡
echo -e "\n${GREEN}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}" >&2
echo -e "${GREEN}${BOLD}â•‘  âœ… æ‰€æœ‰æœåŠ¡å™¨ç«¯æ£€æŸ¥é€šè¿‡ï¼å…è®¸æ¨é€ï¼                    â•‘${NC}" >&2
echo -e "${GREEN}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n" >&2
log_success "é€šè¿‡æ£€æŸ¥: $TOTAL_CHECKS é¡¹"
log_success "å¤±è´¥æ£€æŸ¥: $FAILED_CHECKS é¡¹"

exit 0
