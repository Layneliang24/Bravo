# ğŸ›¡ï¸ æœåŠ¡å™¨ç«¯ Git é’©å­éƒ¨ç½²æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬ç›®å½•åŒ…å«**æœåŠ¡å™¨ç«¯ Git é’©å­**ï¼Œç”¨äºåœ¨ Git æœåŠ¡å™¨ä¸Šè¿è¡Œæ£€æŸ¥ï¼Œé˜²æ­¢ç»•è¿‡æœ¬åœ°é’©å­ã€‚

### ğŸ¯ å…³é”®åŒºåˆ«

#### æœ¬åœ°é’©å­ vs æœåŠ¡å™¨ç«¯é’©å­

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœ¬åœ°é’©å­ï¼ˆç”± Husky ç®¡ç†ï¼‰                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä½ç½®: .husky/ ç›®å½•                                     â”‚
â”‚ è§¦å‘: æœ¬åœ° Git æ“ä½œï¼ˆcommit, push ç­‰ï¼‰                â”‚
â”‚ ç®¡ç†: npm run prepare (Husky)                         â”‚
â”‚ å¯ç»•è¿‡: âœ— æ˜¯ï¼ˆå¯ç”¨ --no-verify ç»•è¿‡ï¼‰                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœåŠ¡å™¨ç«¯é’©å­ï¼ˆæœ¬ç›®å½•ï¼‰                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä½ç½®: æœåŠ¡å™¨çš„ä»“åº“ hooks/ ç›®å½•                        â”‚
â”‚ è§¦å‘: æœåŠ¡å™¨æ¥æ”¶æ¨é€æ—¶                                â”‚
â”‚ ç®¡ç†: æ‰‹åŠ¨éƒ¨ç½²åˆ°æœåŠ¡å™¨                                â”‚
â”‚ å¯ç»•è¿‡: âœ“ å¦ï¼ˆæ— æ³•ç»•è¿‡ï¼ŒæœåŠ¡å™¨å¼ºåˆ¶æ‰§è¡Œï¼‰              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ”’ é˜²å¾¡å±‚æ¬¡

```
ç¬¬ä¸€å±‚: æœ¬åœ° pre-commit (.husky/pre-commit)
  â†“ å¼€å‘è€…å¯èƒ½ç»•è¿‡ (--no-verify)

ç¬¬äºŒå±‚: æœ¬åœ° pre-push (.husky/pre-push)
  â†“ å¼€å‘è€…å¯èƒ½ç»•è¿‡ (--no-verify)

ç¬¬ä¸‰å±‚: GitHub Actions (PR/Push å·¥ä½œæµ)
  â†“ å¯èƒ½è¢«åˆ†æ”¯è§„åˆ™ç»•è¿‡

ç¬¬å››å±‚: æœåŠ¡å™¨ç«¯ pre-receive (æœ¬ç›®å½•) â­
  âœ“ æ— æ³•ç»•è¿‡ï¼Œæœ€åé˜²çº¿
```

## ğŸ“ é’©å­åˆ—è¡¨

### `pre-receive`

**ç”¨é€”**: æœåŠ¡å™¨æ¥æ”¶æ¨é€å‰çš„æœ€åæ£€æŸ¥
**æ£€æŸ¥é¡¹ç›®**:

1. âœ… åˆ†æ”¯ä¿æŠ¤ï¼ˆç¦æ­¢ç›´æ¥æ¨é€åˆ° main/devï¼‰
2. âœ… æäº¤æ¶ˆæ¯æ ¼å¼éªŒè¯
3. âœ… ç¦æ­¢çš„æ–‡ä»¶æ£€æŸ¥ï¼ˆå¯†é’¥ã€ç¯å¢ƒå˜é‡ç­‰ï¼‰
4. âœ… å¤§æ–‡ä»¶æ£€æŸ¥ï¼ˆ>10MBï¼‰
5. âœ… ä»£ç è´¨é‡æ ‡è®°ï¼ˆåˆå¹¶å†²çªã€è°ƒè¯•ä»£ç ï¼‰
6. âœ… Docker ä¾èµ–ç®¡ç†è§„èŒƒ
7. âœ… æœ¬åœ°æµ‹è¯•é€šè¡Œè¯éªŒè¯ï¼ˆè­¦å‘Šï¼‰

**ç‰¹ç‚¹**:

- ğŸš€ å¿«é€Ÿå¤±è´¥ï¼šä»»ä½•æ£€æŸ¥å¤±è´¥ç«‹å³ç»ˆæ­¢
- ğŸ”’ æ— æ³•ç»•è¿‡ï¼šæœåŠ¡å™¨å¼ºåˆ¶æ‰§è¡Œ
- ğŸ“Š è¯¦ç»†æ—¥å¿—ï¼šæä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

## ğŸš€ éƒ¨ç½²æŒ‡å—

### å‰ææ¡ä»¶

- æ‹¥æœ‰ Git æœåŠ¡å™¨çš„è®¿é—®æƒé™
- æ”¯æŒè‡ªå®šä¹‰é’©å­çš„ Git æœåŠ¡å™¨ï¼ˆGitea/GitLab/GitHub Enterprise/è£¸ä»“åº“ï¼‰

### éƒ¨ç½²æ­¥éª¤

#### æ–¹æ¡ˆ 1: Gitea/Gogs éƒ¨ç½²

```bash
# 1. SSH åˆ°æœåŠ¡å™¨
ssh user@your-git-server.com

# 2. æ‰¾åˆ°ä»“åº“ä½ç½®ï¼ˆé€šå¸¸åœ¨ /data/gitea/repositories/ï¼‰
cd /data/gitea/repositories/your-org/your-repo.git

# 3. å¤åˆ¶é’©å­æ–‡ä»¶
cp /path/to/server-hooks/pre-receive hooks/pre-receive

# 4. è®¾ç½®æ‰§è¡Œæƒé™
chmod +x hooks/pre-receive

# 5. æµ‹è¯•é’©å­
./hooks/pre-receive --version  # å¦‚æœæœ‰ç‰ˆæœ¬å‘½ä»¤çš„è¯
```

#### æ–¹æ¡ˆ 2: GitLab éƒ¨ç½²

```bash
# 1. SSH åˆ° GitLab æœåŠ¡å™¨
ssh user@gitlab-server.com

# 2. æ‰¾åˆ°ä»“åº“ä½ç½®ï¼ˆé€šå¸¸åœ¨ /var/opt/gitlab/git-data/repositories/ï¼‰
cd /var/opt/gitlab/git-data/repositories/<namespace>/<project>.git

# 3. å¤åˆ¶é’©å­åˆ° custom_hooks ç›®å½•
mkdir -p custom_hooks
cp /path/to/server-hooks/pre-receive custom_hooks/pre-receive

# 4. è®¾ç½®æ‰§è¡Œæƒé™
chmod +x custom_hooks/pre-receive

# 5. é‡å¯ GitLabï¼ˆå¦‚éœ€è¦ï¼‰
sudo gitlab-ctl restart
```

#### æ–¹æ¡ˆ 3: GitHub Enterprise éƒ¨ç½²

```bash
# ä½¿ç”¨ GitHub Enterprise ç®¡ç†æ§åˆ¶å°
# å¯¼èˆªåˆ°: Repository Settings > Hooks
# ä¸Šä¼  pre-receive é’©å­è„šæœ¬
```

#### æ–¹æ¡ˆ 4: è£¸ä»“åº“éƒ¨ç½²

```bash
# 1. æ‰¾åˆ°è£¸ä»“åº“ä½ç½®
cd /path/to/bare/repo.git

# 2. å¤åˆ¶é’©å­
cp /path/to/server-hooks/pre-receive hooks/pre-receive

# 3. è®¾ç½®æ‰§è¡Œæƒé™
chmod +x hooks/pre-receive
```

### ğŸ§ª æµ‹è¯•éƒ¨ç½²

```bash
# åœ¨æœ¬åœ°æµ‹è¯•æ¨é€
git push origin feature/test-branch

# é¢„æœŸç»“æœï¼š
# - å¦‚æœæ¨é€åˆ° main/dev â†’ è¢«æ‹’ç»
# - å¦‚æœåŒ…å«æ•æ„Ÿæ–‡ä»¶ â†’ è¢«æ‹’ç»
# - å¦‚æœåŒ…å«å¤§æ–‡ä»¶ â†’ è¢«æ‹’ç»
# - å¦‚æœæ¨é€åˆ° feature åˆ†æ”¯ â†’ æˆåŠŸ
```

## ğŸ”§ é…ç½®

### ä¿®æ”¹ä¿æŠ¤çš„åˆ†æ”¯

ç¼–è¾‘ `pre-receive` æ–‡ä»¶çš„ç¬¬ 12 è¡Œï¼š

```bash
# é»˜è®¤
PROTECTED_BRANCHES="main dev"

# è‡ªå®šä¹‰
PROTECTED_BRANCHES="main develop production"
```

### ä¿®æ”¹å¤§æ–‡ä»¶é™åˆ¶

ç¼–è¾‘ `pre-receive` æ–‡ä»¶çš„ç¬¬ 181 è¡Œï¼š

```bash
# é»˜è®¤: 10MB
local max_size=$((10 * 1024 * 1024))

# è‡ªå®šä¹‰: 5MB
local max_size=$((5 * 1024 * 1024))
```

### ç¦ç”¨ç‰¹å®šæ£€æŸ¥

æ³¨é‡Šæ‰ä¸éœ€è¦çš„æ£€æŸ¥å‡½æ•°è°ƒç”¨ï¼ˆç¬¬ 326-331 è¡Œï¼‰ï¼š

```bash
# æ‰§è¡Œæ‰€æœ‰æ£€æŸ¥ï¼ˆå¿«é€Ÿå¤±è´¥ï¼‰
check_branch_protection "$branch"
check_forbidden_files "$oldrev" "$newrev"
# check_large_files "$oldrev" "$newrev"  # ç¦ç”¨å¤§æ–‡ä»¶æ£€æŸ¥
check_code_quality_markers "$oldrev" "$newrev"
check_docker_dependency_rules "$oldrev" "$newrev"
# check_local_test_passport  # ç¦ç”¨é€šè¡Œè¯æ£€æŸ¥
```

## ğŸ› ï¸ ç»´æŠ¤

### æ›´æ–°é’©å­

```bash
# 1. åœ¨æœ¬åœ°æ›´æ–° server-hooks/pre-receive
vim server-hooks/pre-receive

# 2. æäº¤åˆ°ä»“åº“
git add server-hooks/pre-receive
git commit -m "chore(hooks): update server-side pre-receive hook"
git push

# 3. é‡æ–°éƒ¨ç½²åˆ°æœåŠ¡å™¨
# é‡å¤ä¸Šè¿°éƒ¨ç½²æ­¥éª¤
```

### ä¸´æ—¶ç¦ç”¨é’©å­ï¼ˆç´§æ€¥æƒ…å†µï¼‰

```bash
# åœ¨æœåŠ¡å™¨ä¸Š
cd /path/to/repo.git/hooks
mv pre-receive pre-receive.disabled

# æ¨é€å®Œæˆåé‡æ–°å¯ç”¨
mv pre-receive.disabled pre-receive
```

### æŸ¥çœ‹é’©å­æ—¥å¿—

é’©å­è¾“å‡ºä¼šæ˜¾ç¤ºåœ¨æ¨é€çš„ stderr ä¸­ï¼š

```bash
git push origin feature/test
# è¾“å‡ºä¼šæ˜¾ç¤ºæ‰€æœ‰æ£€æŸ¥æ­¥éª¤å’Œç»“æœ
```

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: é’©å­æ²¡æœ‰æ‰§è¡Œ

**æ£€æŸ¥**:

```bash
# ç¡®è®¤é’©å­å­˜åœ¨
ls -la /path/to/repo.git/hooks/pre-receive

# ç¡®è®¤æ‰§è¡Œæƒé™
chmod +x /path/to/repo.git/hooks/pre-receive

# ç¡®è®¤ shebang æ­£ç¡®
head -1 /path/to/repo.git/hooks/pre-receive
# åº”è¯¥è¾“å‡º: #!/bin/bash
```

### é—®é¢˜ 2: æƒé™è¢«æ‹’ç»

```bash
# ç¡®è®¤é’©å­æ‰€æœ‰è€…
ls -la /path/to/repo.git/hooks/pre-receive

# ä¿®æ”¹æ‰€æœ‰è€…ï¼ˆå¦‚æœéœ€è¦ï¼‰
sudo chown git:git /path/to/repo.git/hooks/pre-receive
```

### é—®é¢˜ 3: é’©å­é”™è¯¯

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰‹åŠ¨æµ‹è¯•é’©å­
cd /path/to/repo.git
echo "old new refs/heads/test" | hooks/pre-receive
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Git é’©å­å®˜æ–¹æ–‡æ¡£](https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks)
- [Gitea é’©å­æŒ‡å—](https://docs.gitea.io/en-us/git-hooks/)
- [GitLab æœåŠ¡å™¨é’©å­](https://docs.gitlab.com/ee/administration/server_hooks.html)
- [GitHub Enterprise é’©å­](https://docs.github.com/en/enterprise-server/admin/policies/enforcing-policy-with-pre-receive-hooks)

## âš ï¸ é‡è¦æé†’

1. **æœ¬åœ°ä¸ä¼šè§¦å‘ pre-receive**ï¼šè¿™ä¸ªé’©å­åªåœ¨æœåŠ¡å™¨ç«¯è¿è¡Œ
2. **Husky ä¸ç®¡ç†æœåŠ¡å™¨é’©å­**ï¼šéœ€è¦æ‰‹åŠ¨éƒ¨ç½²åˆ°æœåŠ¡å™¨
3. **æµ‹è¯•åå†éƒ¨ç½²**ï¼šåœ¨æµ‹è¯•ä»“åº“å…ˆéªŒè¯é’©å­åŠŸèƒ½
4. **å¤‡ä»½åŸé’©å­**ï¼šéƒ¨ç½²å‰å¤‡ä»½æœåŠ¡å™¨ç°æœ‰çš„é’©å­
5. **æ–‡æ¡£åŒæ­¥**ï¼šæ›´æ–°é’©å­ååŒæ­¥æ›´æ–°æœ¬æ–‡æ¡£

## ğŸ¯ æœ€ä½³å®è·µ

1. **ç‰ˆæœ¬æ§åˆ¶**ï¼šå°†é’©å­è„šæœ¬æäº¤åˆ°ä»“åº“ï¼Œæ–¹ä¾¿è¿½è¸ªå˜æ›´
2. **æµ‹è¯•ç¯å¢ƒ**ï¼šå…ˆåœ¨æµ‹è¯•æœåŠ¡å™¨éƒ¨ç½²éªŒè¯
3. **æ¸è¿›å¼éƒ¨ç½²**ï¼šå…ˆå¯ç”¨è­¦å‘Šæ¨¡å¼ï¼Œå†å¯ç”¨å¼ºåˆ¶æ¨¡å¼
4. **ç›‘æ§æ—¥å¿—**ï¼šå®šæœŸæ£€æŸ¥é’©å­æ‰§è¡Œæ—¥å¿—
5. **å›¢é˜ŸåŸ¹è®­**ï¼šç¡®ä¿å›¢é˜Ÿäº†è§£æœåŠ¡å™¨ç«¯é’©å­çš„ä½œç”¨

---

**æ›´æ–°æ—¶é—´**: 2025-10-12
**ç»´æŠ¤äºº**: AI Assistant (Claude 3.5 Sonnet)
