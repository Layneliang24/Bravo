#!/bin/bash
# 一键本地测试快捷命令 - 纯Docker环境
cd "$(dirname "$0")"

# 检查Docker环境
if ! command -v docker &> /dev/null; then
    echo "❌ Docker未安装，无法执行本地验证"
    echo "请安装Docker后重试"
    exit 1
fi

# 🔧 方案A：预启动 + 连接验证架构
echo "🚀 预启动核心服务栈..."

# 检查并启动MySQL和Redis（测试必需服务）
echo "📦 启动MySQL和Redis服务..."
docker-compose up -d mysql redis >/dev/null 2>&1

# 等待服务就绪
echo "⏳ 等待MySQL和Redis就绪..."
for i in {1..30}; do
    if docker-compose exec -T mysql mysqladmin ping -h localhost >/dev/null 2>&1 && \
       docker-compose exec -T redis redis-cli ping >/dev/null 2>&1; then
        echo "✅ 核心服务已就绪"
        break
    fi
    echo "等待服务启动... ($i/30)"
    sleep 2
done

# 启动验证容器（连接现有服务）
echo "🚀 启动验证容器..."
docker-compose --profile validation up -d validator >/dev/null 2>&1

# 等待容器启动
sleep 2

# 在容器内执行验证
echo "🎯 在Docker容器内执行本地测试验证..."
docker-compose --profile validation exec validator validate "$@"
