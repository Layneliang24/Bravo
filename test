#!/bin/bash
# ä¸€é”®æœ¬åœ°æµ‹è¯•å¿«æ·å‘½ä»¤ - çº¯Dockerç¯å¢ƒ
cd "$(dirname "$0")"

# æ£€æŸ¥Dockerç¯å¢ƒ
if ! command -v docker &> /dev/null; then
    echo "âŒ Dockeræœªå®‰è£…ï¼Œæ— æ³•æ‰§è¡Œæœ¬åœ°éªŒè¯"
    echo "è¯·å®‰è£…Dockeråé‡è¯•"
    exit 1
fi

# ğŸ”§ æ–¹æ¡ˆAï¼šé¢„å¯åŠ¨ + è¿æ¥éªŒè¯æ¶æ„
echo "ğŸš€ é¢„å¯åŠ¨æ ¸å¿ƒæœåŠ¡æ ˆ..."

# æ£€æŸ¥å¹¶å¯åŠ¨MySQLå’ŒRedisï¼ˆæµ‹è¯•å¿…éœ€æœåŠ¡ï¼‰
echo "ğŸ“¦ å¯åŠ¨MySQLå’ŒRedisæœåŠ¡..."
docker-compose up -d mysql redis >/dev/null 2>&1

# ç­‰å¾…æœåŠ¡å°±ç»ª
echo "â³ ç­‰å¾…MySQLå’ŒRediså°±ç»ª..."
for i in {1..30}; do
    if docker-compose exec -T mysql mysqladmin ping -h localhost >/dev/null 2>&1 && \
       docker-compose exec -T redis redis-cli ping >/dev/null 2>&1; then
        echo "âœ… æ ¸å¿ƒæœåŠ¡å·²å°±ç»ª"
        break
    fi
    echo "ç­‰å¾…æœåŠ¡å¯åŠ¨... ($i/30)"
    sleep 2
done

# å¯åŠ¨éªŒè¯å®¹å™¨ï¼ˆè¿æ¥ç°æœ‰æœåŠ¡ï¼‰
echo "ğŸš€ å¯åŠ¨éªŒè¯å®¹å™¨..."
docker-compose --profile validation up -d validator >/dev/null 2>&1

# ç­‰å¾…å®¹å™¨å¯åŠ¨
sleep 2

# åœ¨å®¹å™¨å†…æ‰§è¡ŒéªŒè¯
echo "ğŸ¯ åœ¨Dockerå®¹å™¨å†…æ‰§è¡Œæœ¬åœ°æµ‹è¯•éªŒè¯..."
docker-compose --profile validation exec validator validate "$@"
