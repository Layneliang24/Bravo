name: Deploy to Dev Environment

on:
  # Âú®ÈïúÂÉèÊûÑÂª∫ÂÆåÊàêÂêéËá™Âä®Ëß¶Âèë
  workflow_run:
    workflows: ["üê≥ Build and Push Docker Images"]
    types:
      - completed
    branches: [dev]
  # ‰øùÁïôÊâãÂä®Ëß¶ÂèëÈÄâÈ°π
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Âè™ÊúâÂú®ÈïúÂÉèÊûÑÂª∫ÊàêÂäüÊó∂ÊâçÈÉ®ÁΩ≤
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: dev # Âº∫Âà∂ÊãâÂèñdevÂàÜÊîØÊúÄÊñ∞‰ª£Á†ÅÔºåÁ°Æ‰øù‰ΩøÁî®ÊúÄÊñ∞ÁöÑworkflowÂíåÂÅ•Â∫∑Ê£ÄÊü•ÈÄªËæë

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.TXYUN_SSH_KEY }}

      - name: SSH Connection Diagnostics
        env:
          HOST: ${{ secrets.TXYUN_HOST }}
          USER: ${{ secrets.TXYUN_USER }}
        run: |
          echo "üîç SSHËøûÊé•ËØäÊñ≠..."
          echo "=========================================="
          echo "1. Ëé∑ÂèñÂΩìÂâçGitHub Actions Runner IPÂú∞ÂùÄ"
          echo "=========================================="
          RUNNER_IP=$(curl -s https://api.ipify.org 2>/dev/null || curl -s https://ifconfig.me 2>/dev/null || echo "Êó†Ê≥ïËé∑Âèñ")
          echo "Runner IP: $RUNNER_IP"
          echo ""
          echo "=========================================="
          echo "2. ÊòæÁ§∫ÁõÆÊ†áÊúçÂä°Âô®‰ø°ÊÅØÔºàÈöêËóèÊïèÊÑüÈÉ®ÂàÜÔºâ"
          echo "=========================================="
          echo "ÁõÆÊ†á‰∏ªÊú∫: ${HOST:0:10}***"
          echo "ÁõÆÊ†áÁî®Êà∑: $USER"
          echo ""
          echo "=========================================="
          echo "3. ÊµãËØïÁΩëÁªúËøûÈÄöÊÄßÔºàÁ´ØÂè£22Ôºâ"
          echo "=========================================="
          # ‰ΩøÁî®timeoutÂíåbashÂÜÖÁΩÆÁöÑTCPËøûÊé•ÊµãËØï
          if command -v nc >/dev/null 2>&1; then
            timeout 5 nc -zv -w 3 $HOST 22 2>&1 || echo "‚ö†Ô∏è ncÊµãËØï: Á´ØÂè£22ËøûÊé•Â§±Ë¥•ÊàñË∂ÖÊó∂"
          else
            echo "‚ö†Ô∏è ncÂëΩ‰ª§‰∏çÂèØÁî®ÔºåË∑≥ËøáÁ´ØÂè£ÊµãËØï"
          fi
          # ‰ΩøÁî®bashÁöÑ/dev/tcpÊµãËØï
          if timeout 3 bash -c "echo > /dev/tcp/$HOST/22" 2>/dev/null; then
            echo "‚úÖ /dev/tcpÊµãËØï: Á´ØÂè£22ÂèØËææ"
          else
            echo "‚ö†Ô∏è /dev/tcpÊµãËØï: Á´ØÂè£22‰∏çÂèØËææÊàñË∂ÖÊó∂"
          fi
          echo ""
          echo "=========================================="
          echo "4. Ê£ÄÊü•SSHÂØÜÈí•ÊòØÂê¶Â∑≤Âä†ËΩΩ"
          echo "=========================================="
          ssh-add -l 2>&1 || echo "‚ö†Ô∏è SSHÂØÜÈí•Êú™Âä†ËΩΩÊàñssh-agentÊú™ËøêË°å"
          echo ""
          echo "=========================================="
          echo "5. ÊµãËØïSSHËøûÊé•ÔºàËØ¶ÁªÜÊ®°ÂºèÔºå10ÁßíË∂ÖÊó∂Ôºâ"
          echo "=========================================="
          ssh -vvv -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              -o ServerAliveInterval=30 \
              -o ServerAliveCountMax=3 \
              -o LogLevel=DEBUG \
              $USER@$HOST "echo '‚úÖ SSHËøûÊé•ÊµãËØïÊàêÂäü'" 2>&1 | head -50 || {
            echo ""
            echo "‚ùå SSHËøûÊé•Â§±Ë¥•"
            echo ""
            echo "=========================================="
            echo "ÂèØËÉΩÁöÑÂéüÂõ†Ôºö"
            echo "1. GitHub Actions IP ($RUNNER_IP) Êú™Âú®ÁôΩÂêçÂçï‰∏≠"
            echo "2. ÊúçÂä°Âô®SSHÊúçÂä°Êú™ÂêØÂä®ÊàñÁ´ØÂè£Ë¢´Èò≤ÁÅ´Â¢ôÈòªÊ≠¢"
            echo "3. SSHÂØÜÈí•ÈÖçÁΩÆ‰∏çÊ≠£Á°Æ"
            echo "4. ÁΩëÁªúË∑ØÁî±ÈóÆÈ¢ò"
            echo "=========================================="
            exit 1
          }
          echo ""
          echo "‚úÖ ËØäÊñ≠ÂÆåÊàêÔºåSSHËøûÊé•Ê≠£Â∏∏"

      - name: Setup GitHub SSH Key for Server
        run: |
          echo "üîë ÈÖçÁΩÆGitHub SSHÂØÜÈí•..."
          mkdir -p ~/.ssh
          echo "${{ secrets.GITHUB_DEPLOY_KEY }}" > ~/.ssh/github_deploy_key
          chmod 600 ~/.ssh/github_deploy_key
          ssh-add ~/.ssh/github_deploy_key || true

      - name: Deploy to dev server
        env:
          HOST: ${{ secrets.TXYUN_HOST }}
          USER: ${{ secrets.TXYUN_USER }}
          REGISTRY_USERNAME: ${{ secrets.ALIYUN_REGISTRY_USERNAME }}
          REGISTRY_PASSWORD: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}
          GITHUB_DEPLOY_KEY: ${{ secrets.GITHUB_DEPLOY_KEY }}
        run: |
          ssh -o StrictHostKeyChecking=no \
              -o ServerAliveInterval=30 \
              -o ServerAliveCountMax=30 \
              -o ForwardAgent=yes \
              $USER@$HOST bash -s << 'ENDSSH' "$REGISTRY_USERNAME" "$REGISTRY_PASSWORD" "$GITHUB_DEPLOY_KEY"
            set -e

            # Êé•Êî∂ÂèÇÊï∞
            REGISTRY_USERNAME="$1"
            REGISTRY_PASSWORD="$2"
            GITHUB_DEPLOY_KEY="$3"

            # ÈÖçÁΩÆGitHub SSHÂØÜÈí•ÔºàÂ¶ÇÊûúÊúâÔºâ
            if [ -n "$GITHUB_DEPLOY_KEY" ]; then
              echo "üîë ÈÖçÁΩÆGitHub SSHÂØÜÈí•..."
              mkdir -p ~/.ssh
              echo "$GITHUB_DEPLOY_KEY" > ~/.ssh/github_deploy_key
              chmod 600 ~/.ssh/github_deploy_key
              # ÈÖçÁΩÆSSH‰ΩøÁî®Ëøô‰∏™ÂØÜÈí•ËøûÊé•GitHub
              {
                echo "Host github.com"
                echo "  HostName github.com"
                echo "  User git"
                echo "  IdentityFile ~/.ssh/github_deploy_key"
                echo "  StrictHostKeyChecking no"
                echo "  IdentitiesOnly yes"
              } >> ~/.ssh/config
              chmod 600 ~/.ssh/config
              echo "‚úÖ GitHub SSHÂØÜÈí•Â∑≤ÈÖçÁΩÆ"
            fi

          echo "üìÅ ËøõÂÖ•È°πÁõÆÁõÆÂΩï..."
          # ÂÖàÁ°Æ‰øùÁà∂ÁõÆÂΩïÂ≠òÂú®Âπ∂ÊúâÊ≠£Á°ÆÊùÉÈôê
          echo "üîß Ê£ÄÊü•Âíå‰øÆÂ§çÁõÆÂΩïÊùÉÈôê..."
          sudo mkdir -p /home/layne/project 2>/dev/null || true
          sudo chown -R $USER:$USER /home/layne/project 2>/dev/null || true
          sudo chmod 755 /home/layne/project 2>/dev/null || true

          # Â¶ÇÊûúÈ°πÁõÆÁõÆÂΩï‰∏çÂ≠òÂú®ÔºåÂÖàÂàõÂª∫
          if [ ! -d "/home/layne/project/bravo-dev" ]; then
            echo "üìÅ ÂàõÂª∫È°πÁõÆÁõÆÂΩï..."
            sudo mkdir -p /home/layne/project/bravo-dev 2>/dev/null || true
          fi

          cd /home/layne/project/bravo-dev

          echo "üîß ‰øÆÂ§çÊùÉÈôêÈóÆÈ¢ò..."
          # Á°Æ‰øùÂΩìÂâçÁî®Êà∑Êã•ÊúâÈ°πÁõÆÁõÆÂΩïÊùÉÈôê
          sudo chown -R $USER:$USER /home/layne/project/bravo-dev 2>/dev/null || true
          sudo chmod -R 755 /home/layne/project/bravo-dev 2>/dev/null || true
          # Ê£ÄÊü•DockerÊùÉÈôêÂíådocker-composeÂèØÁî®ÊÄß
          echo "üîç Ê£ÄÊü•DockerÂíåDocker ComposeÂèØÁî®ÊÄß..."

          # Ê£ÄÊµãdocker-composeÂëΩ‰ª§Á±ªÂûãÔºàV1: docker-compose Êàñ V2: docker composeÔºâ
          DOCKER_COMPOSE_CMD=""
          if command -v docker-compose &>/dev/null; then
            DOCKER_COMPOSE_CMD="docker-compose"
            echo "‚úÖ ÂèëÁé∞docker-compose V1: $DOCKER_COMPOSE_CMD"
          elif docker compose version &>/dev/null 2>&1; then
            DOCKER_COMPOSE_CMD="docker compose"
            echo "‚úÖ ÂèëÁé∞docker compose V2: $DOCKER_COMPOSE_CMD"
          else
            # Â∞ùËØïÊü•Êâædocker-composeË∑ØÂæÑ
            DOCKER_COMPOSE_PATH=$(which docker-compose 2>/dev/null || find /usr -name docker-compose 2>/dev/null | head -1 || echo "")
            if [ -n "$DOCKER_COMPOSE_PATH" ]; then
              DOCKER_COMPOSE_CMD="$DOCKER_COMPOSE_PATH"
              echo "‚úÖ ÈÄöËøáË∑ØÂæÑÊâæÂà∞docker-compose: $DOCKER_COMPOSE_CMD"
            else
              echo "‚ùå docker-composeÂëΩ‰ª§‰∏çÂèØÁî®ÔºåÈÄÄÂá∫"
              exit 1
            fi
          fi

          # Ê£ÄÊü•DockerÊùÉÈôêÔºåÂ¶ÇÊûúÊ≤°ÊúâÊùÉÈôêÂàô‰ΩøÁî®sudoÂåÖË£Ö
          NEED_SUDO=false
          if ! docker ps &>/dev/null; then
            echo "‚ö†Ô∏è ÂΩìÂâçÁî®Êà∑Êó†DockerÊùÉÈôêÔºåÊ£ÄÊü•dockerÁªÑ..."
            if ! groups | grep -q docker; then
              echo "Â∞ÜÁî®Êà∑Ê∑ªÂä†Âà∞dockerÁªÑ..."
              sudo usermod -aG docker $USER 2>/dev/null || true
              echo "‚ö†Ô∏è Â∑≤Ê∑ªÂä†Áî®Êà∑Âà∞dockerÁªÑÔºå‰ΩÜÈúÄË¶ÅÈáçÊñ∞ÁôªÂΩïÊâçËÉΩÁîüÊïà"
              NEED_SUDO=true
            fi
          fi

          # ÂàõÂª∫dockerÂíådocker-composeÂåÖË£ÖÂáΩÊï∞ÔºàÁ°Æ‰øùÂú®ÊâÄÊúâÊÉÖÂÜµ‰∏ãÈÉΩÂèØÁî®Ôºâ
          if [ "$NEED_SUDO" = "true" ]; then
            echo "‰∏¥Êó∂‰ΩøÁî®sudoÊâßË°åDockerÂëΩ‰ª§..."
            docker() { sudo docker "$@"; }
            if [[ "$DOCKER_COMPOSE_CMD" == "docker compose" ]]; then
              docker-compose() { sudo docker compose "$@"; }
            else
              docker-compose() { sudo $DOCKER_COMPOSE_CMD "$@"; }
            fi
          else
            if [[ "$DOCKER_COMPOSE_CMD" == "docker compose" ]]; then
              # Docker Compose V2‰Ωú‰∏∫dockerÁöÑÂ≠êÂëΩ‰ª§
              docker-compose() { docker compose "$@"; }
            else
              # Docker Compose V1Áã¨Á´ãÂëΩ‰ª§
              docker-compose() { $DOCKER_COMPOSE_CMD "$@"; }
            fi
          fi

          # È™åËØÅdocker-composeÊòØÂê¶ÂèØÁî®
          echo "üß™ È™åËØÅdocker-composeÂëΩ‰ª§..."
          if docker-compose --version &>/dev/null; then
            echo "‚úÖ docker-composeÂëΩ‰ª§È™åËØÅÊàêÂäü: $(docker-compose --version 2>&1 | head -1)"
          else
            echo "‚ùå docker-composeÂëΩ‰ª§È™åËØÅÂ§±Ë¥•ÔºåÈÄÄÂá∫"
            exit 1
          fi

          # ÈÖçÁΩÆDockerÈïúÂÉèÂä†ÈÄüÂô®ÔºàÂõΩÂÜÖÊúçÂä°Âô®‰ºòÂåñÔºâ
          echo "üê≥ ÈÖçÁΩÆDockerÈïúÂÉèÂä†ÈÄüÂô®..."
          sudo mkdir -p /etc/docker
          if [ ! -f /etc/docker/daemon.json ] || ! grep -q "registry-mirrors" /etc/docker/daemon.json 2>/dev/null; then
            echo "ÈÖçÁΩÆDockerÂõΩÂÜÖÈïúÂÉèÂä†ÈÄüÂô®..."
            printf '%s\n' '{"registry-mirrors":["https://docker.mirrors.ustc.edu.cn","https://hub-mirror.c.163.com","https://mirror.ccs.tencentyun.com","https://registry.docker-cn.com"],"log-driver":"json-file","log-opts":{"max-size":"10m","max-file":"3"}}' | sudo tee /etc/docker/daemon.json > /dev/null
            echo "‚úÖ DockerÈïúÂÉèÂä†ÈÄüÂô®ÈÖçÁΩÆÂÆåÊàêÔºåÈáçÂêØDockerÊúçÂä°..."
            sudo systemctl daemon-reload
            sudo systemctl restart docker || true
            # Á≠âÂæÖDockerÈáçÂêØÂÆåÊàê
            sleep 5
            # È™åËØÅDockerÊòØÂê¶Ê≠£Â∏∏ËøêË°å
            if ! docker ps &>/dev/null; then
              echo "‚ö†Ô∏è DockerÈáçÂêØÂêéÈ™åËØÅÂ§±Ë¥•Ôºå‰ΩÜÁªßÁª≠ÊâßË°å..."
            else
              echo "‚úÖ DockerÊúçÂä°ÈáçÂêØÊàêÂäü"
            fi
          else
            echo "‚úÖ DockerÈïúÂÉèÂä†ÈÄüÂô®Â∑≤ÈÖçÁΩÆ"
          fi

          # ‰øÆÂ§ç.gitÁõÆÂΩïÊùÉÈôêÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
          if [ -d ".git" ]; then
            sudo chown -R $USER:$USER .git 2>/dev/null || true
          fi

          echo "üîÑ ÊãâÂèñÊúÄÊñ∞‰ª£Á†Å..."

          # GitÊìç‰ΩúÈáçËØïÂáΩÊï∞
          git_retry() {
            local cmd="$1"
            local max_retry=3
            local retry=0
            local delay=5

            while [ $retry -lt $max_retry ]; do
              echo "üîÑ ÊâßË°å: $cmd (Â∞ùËØï $((retry+1))/$max_retry)..."
              if eval "$cmd"; then
                echo "‚úÖ GitÊìç‰ΩúÊàêÂäü"
                return 0
              else
                retry=$((retry+1))
                if [ $retry -lt $max_retry ]; then
                  echo "‚ö†Ô∏è GitÊìç‰ΩúÂ§±Ë¥•Ôºå${delay}ÁßíÂêéÈáçËØï..."
                  sleep $delay
                  delay=$((delay + 5))  # ÈÄíÂ¢ûÂª∂Ëøü
                fi
              fi
            done

            echo "‚ùå GitÊìç‰ΩúÂ§±Ë¥•ÔºåÂ∑≤ÈáçËØï${max_retry}Ê¨°"
            return 1
          }

          if [ -d ".git" ] && [ -r ".git" ]; then
            echo "üìÅ .gitÁõÆÂΩïÂ≠òÂú®ÔºåÊõ¥Êñ∞‰ª£Á†Å..."

            # Âº∫Âà∂‰ΩøÁî®SSHËÄå‰∏çÊòØHTTPSÔºàÈÄüÂ∫¶Âø´ÔºåÊó†Ë∂ÖÊó∂ÈóÆÈ¢òÔºâ
            echo "üîë ÈÖçÁΩÆGit‰ΩøÁî®SSHËøûÊé•GitHub..."
            CURRENT_URL=$(git remote get-url origin 2>/dev/null || echo "")
            if [[ "$CURRENT_URL" == https://github.com/* ]]; then
              SSH_URL="git@github.com:${CURRENT_URL#https://github.com/}"
              echo "üîÑ ÂàáÊç¢GitËøúÁ®ãURLÂà∞SSH: $SSH_URL"
              git remote set-url origin "$SSH_URL"
              echo "‚úÖ GitËøúÁ®ãURLÂ∑≤ÂàáÊç¢Âà∞SSH"
            elif [[ "$CURRENT_URL" == git@github.com:* ]]; then
              echo "‚úÖ GitÂ∑≤‰ΩøÁî®SSH: $CURRENT_URL"
            else
              echo "‚ö†Ô∏è Êó†Ê≥ïËØÜÂà´ÁöÑGit URLÊ†ºÂºè: $CURRENT_URL"
            fi

            # ÈÖçÁΩÆSSHÔºà‰ΩøÁî®forwarded agentÔºâ
            mkdir -p ~/.ssh
            chmod 700 ~/.ssh
            # Ê∑ªÂä†GitHubÂà∞known_hostsÔºàÈÅøÂÖçÈ¶ñÊ¨°ËøûÊé•Á°ÆËÆ§Ôºâ
            ssh-keyscan -t rsa,ed25519 github.com >> ~/.ssh/known_hosts 2>/dev/null || true
            chmod 600 ~/.ssh/known_hosts 2>/dev/null || true

            # Âº∫Âà∂Êõ¥Êñ∞ÊâÄÊúâËøúÁ®ãÂàÜÊîØÂºïÁî®Ôºà‰ΩøÁî®SSHÔºåÂø´ÈÄüÔºâ
            echo "üîÑ Âº∫Âà∂Êõ¥Êñ∞ÊâÄÊúâËøúÁ®ãÂàÜÊîØÂºïÁî®Ôºà‰ΩøÁî®SSHÔºâ..."
            git_retry "git fetch --all --force --prune" || \
            git_retry "git fetch --all --force --prune" || \
            git fetch --all --force --prune

            # ÂÖàËé∑ÂèñËøúÁ®ãdevÂàÜÊîØÁöÑÊúÄÊñ∞‰ø°ÊÅØÔºàÂ∏¶ÈáçËØïÔºåÁ°Æ‰øùËé∑ÂèñÂà∞ÊúÄÊñ∞Ôºâ
            echo "üîÑ Ëé∑ÂèñËøúÁ®ãdevÂàÜÊîØÊúÄÊñ∞‰ø°ÊÅØ..."
            git_retry "git fetch origin dev:refs/remotes/origin/dev --force" || \
            git_retry "git fetch --force --prune origin dev" || \
            git fetch --force --prune origin dev

            # ÊòæÁ§∫ËøúÁ®ãdevÂàÜÊîØÁöÑHEAD‰ø°ÊÅØ
            echo "üìç ËøúÁ®ãdev HEAD: $(git rev-parse origin/dev 2>/dev/null || echo 'unknown')"
            REMOTE_DEV_HEAD=$(git rev-parse origin/dev 2>/dev/null || echo "")
            if [ -z "$REMOTE_DEV_HEAD" ]; then
              echo "‚ùå Êó†Ê≥ïËé∑ÂèñËøúÁ®ãdevÂàÜÊîØHEADÔºåÈÄÄÂá∫"
              exit 1
            fi

            # ÊòæÁ§∫ÂΩìÂâçÁä∂ÊÄÅ
            CURRENT_HEAD=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
            CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")
            echo "üìç ÂΩìÂâçHEAD: $CURRENT_HEAD"
            echo "üìç ÂΩìÂâçÂàÜÊîØ: $CURRENT_BRANCH"
            echo "üìç ËøúÁ®ãdev HEAD: $REMOTE_DEV_HEAD"

            # Â¶ÇÊûúÂΩìÂâçHEADÂ∑≤ÁªèÊòØËøúÁ®ãdevÁöÑÊúÄÊñ∞HEADÔºåÊ£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÂàáÊç¢ÂàÜÊîØ
            if [ "$CURRENT_HEAD" != "$REMOTE_DEV_HEAD" ]; then
              echo "‚ö†Ô∏è ÂΩìÂâçHEAD ($CURRENT_HEAD) ‰∏éËøúÁ®ãdev HEAD ($REMOTE_DEV_HEAD) ‰∏ç‰∏ÄËá¥ÔºåÈúÄË¶ÅÊõ¥Êñ∞"

              # Á°Æ‰øùÂΩìÂâçÂú®devÂàÜÊîØÔºåÂ¶ÇÊûú‰∏çÂú®ÂàôÂàáÊç¢
              if [ "$CURRENT_BRANCH" != "dev" ]; then
                echo "‚ö†Ô∏è ÂΩìÂâçÂàÜÊîØÊòØ $CURRENT_BRANCHÔºåÂàáÊç¢Âà∞devÂàÜÊîØ..."
                git checkout -B dev origin/dev 2>/dev/null || {
                  echo "‚ö†Ô∏è ÂàáÊç¢Â§±Ë¥•ÔºåÂº∫Âà∂ÈáçÁΩÆÂà∞dev..."
                  git fetch origin dev:dev --force || true
                  git checkout -f dev || true
                }
              fi

              # Ê∏ÖÁêÜÊâÄÊúâÊú™Êèê‰∫§ÁöÑÊîπÂä®ÂíåÊú™Ë∑üË∏™Êñá‰ª∂
              echo "üßπ Ê∏ÖÁêÜÊú¨Âú∞ÊîπÂä®..."
              git reset --hard HEAD || true
              git clean -fdx || true

              # Âº∫Âà∂ÈáçÁΩÆÂà∞ËøúÁ®ãdevÂàÜÊîØÊúÄÊñ∞‰ª£Á†ÅÔºàÁ°Æ‰øù‰ΩøÁî®devÂàÜÊîØÔºå‰∏çÊòØmainÔºâ
              echo "üîÑ ÈáçÁΩÆÂà∞ËøúÁ®ãdevÂàÜÊîØÊúÄÊñ∞‰ª£Á†Å..."
              git_retry "git reset --hard origin/dev" || git reset --hard origin/dev

              # È™åËØÅÊúÄÁªàHEADÊòØÂê¶‰∏éËøúÁ®ãdevÂàÜÊîØ‰∏ÄËá¥
              FINAL_HEAD=$(git rev-parse HEAD 2>/dev/null || echo "")
              echo "üìç ÊúÄÁªàHEAD: $FINAL_HEAD"
              echo "üìç ËøúÁ®ãdev HEAD: $REMOTE_DEV_HEAD"

              if [ "$FINAL_HEAD" != "$REMOTE_DEV_HEAD" ]; then
                echo "‚ùå HEAD‰∏éËøúÁ®ãdevÂàÜÊîØ‰ªçÁÑ∂‰∏ç‰∏ÄËá¥ÔºåÂ∞ùËØïÂº∫Âà∂ÂêåÊ≠•..."
                git fetch origin dev --force
                git reset --hard origin/dev
                FINAL_HEAD=$(git rev-parse HEAD 2>/dev/null || echo "")
                if [ "$FINAL_HEAD" != "$REMOTE_DEV_HEAD" ]; then
                  echo "‚ùå Âº∫Âà∂ÂêåÊ≠•Âêé‰ªçÁÑ∂‰∏ç‰∏ÄËá¥ÔºåÈÄÄÂá∫ÈÉ®ÁΩ≤"
                  echo "ÂΩìÂâçHEAD: $FINAL_HEAD"
                  echo "ÊúüÊúõHEAD: $REMOTE_DEV_HEAD"
                  exit 1
                fi
              fi
            else
              echo "‚úÖ ÂΩìÂâçHEADÂ∑≤ÁªèÊòØËøúÁ®ãdevÁöÑÊúÄÊñ∞HEADÔºåÊó†ÈúÄÊõ¥Êñ∞"
            fi

            # ÊòæÁ§∫ÊúÄÁªàÊèê‰∫§‰ø°ÊÅØ
            echo "‚úÖ ÊúÄÁªàHEAD: $(git rev-parse HEAD)"
            echo "‚úÖ ÂΩìÂâçÂàÜÊîØ: $(git rev-parse --abbrev-ref HEAD)"
            echo "‚úÖ ÊúÄÊñ∞Êèê‰∫§: $(git log -1 --oneline)"
          else
            # Â¶ÇÊûú.git‰∏çÂ≠òÂú®ÊàñÊó†Ê≥ïËÆøÈóÆÔºåÂà†Èô§ÁõÆÂΩïÈáçÊñ∞ÂÖãÈöÜ
            echo "‚ö†Ô∏è .gitÁõÆÂΩï‰∏çÂ≠òÂú®ÊàñÊùÉÈôê‰∏çË∂≥ÔºåÈáçÊñ∞ÂÖãÈöÜ..."
            cd /home/layne/project
            # ÂÖà‰øÆÂ§çÊùÉÈôêÂÜçÂà†Èô§ÔºåÁ°Æ‰øùÂèØ‰ª•Âà†Èô§
            sudo chown -R $USER:$USER bravo-dev 2>/dev/null || true
            rm -rf bravo-dev 2>/dev/null || sudo rm -rf bravo-dev 2>/dev/null || true

            # Âº∫Âà∂‰ΩøÁî®SSHÂÖãÈöÜÔºàÈÄüÂ∫¶Âø´ÔºåÊó†Ë∂ÖÊó∂ÈóÆÈ¢òÔºâ
            echo "üîë ‰ΩøÁî®SSHÂÖãÈöÜ‰ª£Á†ÅÂ∫ì..."

            # ÈÖçÁΩÆSSH
            mkdir -p ~/.ssh
            chmod 700 ~/.ssh
            # Ê∑ªÂä†GitHubÂà∞known_hostsÔºàÈÅøÂÖçÈ¶ñÊ¨°ËøûÊé•Á°ÆËÆ§Ôºâ
            ssh-keyscan -t rsa,ed25519 github.com >> ~/.ssh/known_hosts 2>/dev/null || true
            chmod 600 ~/.ssh/known_hosts 2>/dev/null || true

            # ‰ΩøÁî®SSH URLÂÖãÈöÜ
            git_retry "git clone -b dev --depth=1 git@github.com:Layneliang24/Bravo.git bravo-dev" || \
            git_retry "git clone -b dev git@github.com:Layneliang24/Bravo.git bravo-dev" || \
            git clone -b dev git@github.com:Layneliang24/Bravo.git bravo-dev

            cd bravo-dev
            # ‰øÆÂ§çÂÖãÈöÜÂêéÁöÑÊùÉÈôê
            sudo chown -R $USER:$USER . 2>/dev/null || true
            sudo chmod -R 755 . 2>/dev/null || true

            # ÊòæÁ§∫ÂÖãÈöÜÂêéÁöÑHEAD‰ø°ÊÅØ
            echo "‚úÖ ÂÖãÈöÜÂÆåÊàêÔºåHEAD: $(git rev-parse HEAD)"
            echo "‚úÖ ÊúÄÊñ∞Êèê‰∫§: $(git log -1 --oneline)"
          fi

          echo "‚èπÔ∏è  ÂÅúÊ≠¢ÊóßÂÆπÂô®..."
          COMPOSE_PROJECT_NAME=bravo-dev docker-compose -f docker-compose.prod.yml down || true

          echo "üîê ÁôªÂΩïÈòøÈáå‰∫ëÈïúÂÉè‰ªìÂ∫ì..."
          echo "${REGISTRY_PASSWORD}" | docker login crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com --username "${REGISTRY_USERNAME}" --password-stdin

          echo "üì¶ ÊãâÂèñÊúÄÊñ∞ÈïúÂÉè..."
          COMPOSE_PROJECT_NAME=bravo-dev IMAGE_TAG=dev docker-compose -f docker-compose.prod.yml pull

          echo "üöÄ ÂêØÂä®ÊúçÂä°..."
          # Ê£ÄÊü•ÊòØÂê¶ÈÖçÁΩÆ‰∫ÜSSLËØÅ‰π¶ÔºàÂüüÂêçÊ®°ÂºèÔºâ
          if [ -d "/etc/letsencrypt/live/dev.layneliang.com" ]; then
            echo "Ê£ÄÊµãÂà∞SSLËØÅ‰π¶Ôºå‰ΩøÁî®ÂüüÂêçÈÖçÁΩÆ..."
            if [ -f "frontend/nginx.domain-dev.conf" ]; then
              cp frontend/nginx.domain-dev.conf frontend/nginx.conf.tmp
              echo "‰ΩøÁî®ÂüüÂêçNginxÈÖçÁΩÆ"
            fi
            USE_DOMAIN=true
            DOMAIN_NAME=dev.layneliang.com
          else
            echo "Êú™Ê£ÄÊµãÂà∞SSLËØÅ‰π¶Ôºå‰ΩøÁî®IPÈÖçÁΩÆ..."
            USE_DOMAIN=false
            DOMAIN_NAME=""
          fi

          # ‰∏∫devÁéØÂ¢É‰ΩøÁî®‰∏çÂêåÁ´ØÂè£ÈÅøÂÖç‰∏éprodÂÜ≤Á™Å
          COMPOSE_PROJECT_NAME=bravo-dev \
          IMAGE_TAG=dev \
          USE_DOMAIN=$USE_DOMAIN \
          DOMAIN_NAME=$DOMAIN_NAME \
          MYSQL_PORT=3307 \
          REDIS_PORT=6380 \
          BACKEND_PORT=8001 \
          FRONTEND_HTTP_PORT=8080 \
          FRONTEND_HTTPS_PORT=8443 \
          DJANGO_SECRET_KEY="${DJANGO_SECRET_KEY:-dev-secret-$(date +%s)}" \
          docker-compose -f docker-compose.prod.yml up -d

          echo "‚è≥ Á≠âÂæÖÊúçÂä°Â∞±Áª™..."
          sleep 10

          echo "üîß ÈÖçÁΩÆNginx SSL..."
          # Â§çÂà∂ÂºÄÂèëÁéØÂ¢ÉSSLÈÖçÁΩÆÂà∞ÂÆπÂô®
          if [ -f "frontend/nginx.domain-dev.conf" ]; then
            docker cp frontend/nginx.domain-dev.conf bravo-dev-frontend:/etc/nginx/conf.d/default.conf
            docker exec bravo-dev-frontend nginx -t && docker exec bravo-dev-frontend nginx -s reload
            echo "‚úÖ ÂºÄÂèëÁéØÂ¢ÉSSLÈÖçÁΩÆÂ∑≤Â∫îÁî®Ôºàdev.layneliang.comÔºâ"
          else
            echo "‚ö†Ô∏è  Êú™ÊâæÂà∞nginx.domain-dev.confÔºåË∑≥ËøáSSLÈÖçÁΩÆ"
          fi

          echo "üìä Ê£ÄÊü•ÊúçÂä°Áä∂ÊÄÅ..."
          COMPOSE_PROJECT_NAME=bravo-dev docker-compose -f docker-compose.prod.yml ps

          echo "üîç È™åËØÅNginxÁ´ØÂè£..."
          docker exec bravo-dev-frontend netstat -tlnp | grep -E '(:80|:443)' || echo "NginxÁ´ØÂè£Ê£ÄÊü•ÂÆåÊàê"

          echo "üìÅ È™åËØÅÈùôÊÄÅÊñá‰ª∂..."
          echo "BackendÈïúÂÉèÂÜÖÁöÑÂéüÂßãÈùôÊÄÅÊñá‰ª∂:"
          docker exec bravo-dev-backend ls -la /app/staticfiles/ | head -20 || echo "‚ö†Ô∏è BackendÈïúÂÉèÂÜÖÈùôÊÄÅÊñá‰ª∂‰∏∫Á©∫"
          echo "BackendÂÆπÂô®ÂÖ±‰∫´Âç∑‰∏≠ÁöÑÈùôÊÄÅÊñá‰ª∂:"
          docker exec bravo-dev-backend ls -la /shared/static/ | head -20 || echo "‚ö†Ô∏è BackendÂÖ±‰∫´Âç∑‰∏∫Á©∫"
          echo "FrontendÂÆπÂô®ÂÜÖÁöÑÈùôÊÄÅÊñá‰ª∂:"
          docker exec bravo-dev-frontend ls -la /usr/share/nginx/html/static/ | head -20 || echo "‚ö†Ô∏è FrontendÈùôÊÄÅÊñá‰ª∂ÁõÆÂΩï‰∏∫Á©∫"
          echo "Ê£ÄÊü•adminÈùôÊÄÅÊñá‰ª∂:"
          docker exec bravo-dev-frontend ls -la /usr/share/nginx/html/static/admin/ | head -10 || echo "‚ö†Ô∏è AdminÈùôÊÄÅÊñá‰ª∂‰∏çÂ≠òÂú®"
          echo "Ê£ÄÊü•BackendÁöÑSTATIC_ROOTÈÖçÁΩÆ:"
          docker exec bravo-dev-backend python -c "from bravo.settings.production import STATIC_ROOT; print(f'STATIC_ROOT: {STATIC_ROOT}')" || echo "‚ö†Ô∏è Êó†Ê≥ïËé∑ÂèñSTATIC_ROOT"

          # Âú®ÈÉ®ÁΩ≤ÂâçÂ§á‰ªΩÂΩìÂâçËøêË°åÁöÑÈïúÂÉèÔºàÁî®‰∫éÂõûÊªöÔºâ
          echo "üì¶ Â§á‰ªΩÂΩìÂâçÈïúÂÉè‰Ωú‰∏∫ÂõûÊªöÁÇπ..."
          if docker images | grep -q bravo-dev-backend; then
            docker tag bravo-dev-backend:latest bravo-dev-backend-backup:latest || echo "Backend backup created"
          fi
          if docker images | grep -q bravo-dev-frontend; then
            docker tag bravo-dev-frontend:latest bravo-dev-frontend-backup:latest || echo "Frontend backup created"
          fi

          # ËÆ∞ÂΩïÈÉ®ÁΩ≤‰ø°ÊÅØ
          echo "DEPLOYED_AT=$(date '+%Y-%m-%d %H:%M:%S')" > .deployment-current
          echo "GITHUB_SHA=${{ github.sha }}" >> .deployment-current
          echo "GITHUB_RUN_ID=${{ github.run_id }}" >> .deployment-current

          echo "‚úÖ DevÁéØÂ¢ÉÈÉ®ÁΩ≤Ê≠•È™§ÂÆåÊàêÔºåÂáÜÂ§áÂÅ•Â∫∑Ê£ÄÊü•..."
          ENDSSH

      - name: Health Check with Auto Rollback
        id: health-check
        if: always()
        env:
          HOST: ${{ secrets.TXYUN_HOST }}
          USER: ${{ secrets.TXYUN_USER }}
          REGISTRY_USERNAME: ${{ secrets.TXYUN_REGISTRY_USERNAME }}
          REGISTRY_PASSWORD: ${{ secrets.TXYUN_REGISTRY_PASSWORD }}
        run: |
          ssh -o StrictHostKeyChecking=no $USER@$HOST bash -s << 'ENDSSH' "$REGISTRY_USERNAME" "$REGISTRY_PASSWORD"
            set -e

            REGISTRY_USERNAME="$1"
            REGISTRY_PASSWORD="$2"

            echo "üè• ÂºÄÂßãDevÁéØÂ¢ÉÂÅ•Â∫∑Ê£ÄÊü•..."
            cd /home/layne/project/bravo-dev

            # ÂÅ•Â∫∑Ê£ÄÊü•ÂáΩÊï∞
            check_health() {
              local retry=0
              local max_retry=3

              while [ $retry -lt $max_retry ]; do
                echo "üîç ÂÅ•Â∫∑Ê£ÄÊü• ($((retry+1))/$max_retry)..."

                # Ê£ÄÊü•ÂÆπÂô®Áä∂ÊÄÅ
                if ! docker ps | grep -q bravo-dev-backend; then
                  echo "‚ùå BackendÂÆπÂô®Êú™ËøêË°å"
                  retry=$((retry+1))
                  sleep 10
                  continue
                fi

                if ! docker ps | grep -q bravo-dev-frontend; then
                  echo "‚ùå FrontendÂÆπÂô®Êú™ËøêË°å"
                  retry=$((retry+1))
                  sleep 10
                  continue
                fi

                # Ê£ÄÊü•ÂâçÁ´ØÔºà‰ΩøÁî®devÁéØÂ¢ÉÁ´ØÂè£8080Ôºâ
                FRONTEND_STATUS=$(curl -L -s -o /dev/null -w "%{http_code}" http://localhost:8080/ || echo "000")
                if [ "$FRONTEND_STATUS" != "200" ]; then
                  echo "‚ö†Ô∏è ÂâçÁ´ØÂÅ•Â∫∑Ê£ÄÊü•Â§±Ë¥• (Áä∂ÊÄÅÁ†Å: $FRONTEND_STATUS)"
                  retry=$((retry+1))
                  sleep 10
                  continue
                fi

                # Ê£ÄÊü•ÂêéÁ´ØAPIÔºà‰ΩøÁî®devÁéØÂ¢ÉÁ´ØÂè£8001Ôºâ
                BACKEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8001/api/ || echo "000")
                if [ "$BACKEND_STATUS" != "200" ]; then
                  echo "‚ö†Ô∏è ÂêéÁ´ØAPIÂÅ•Â∫∑Ê£ÄÊü•Â§±Ë¥• (Áä∂ÊÄÅÁ†Å: $BACKEND_STATUS)"
                  retry=$((retry+1))
                  sleep 10
                  continue
                fi

                # ÊâÄÊúâÊ£ÄÊü•ÈÄöËøá
                echo "‚úÖ ÂÅ•Â∫∑Ê£ÄÊü•ÈÄöËøá"
                echo "  - Frontend (port 8080): $FRONTEND_STATUS"
                echo "  - Backend API (port 8001): $BACKEND_STATUS"
                return 0
              done

              echo "‚ùå ÂÅ•Â∫∑Ê£ÄÊü•Â§±Ë¥•ÔºàÈáçËØï${max_retry}Ê¨°Ôºâ"
              return 1
            }

            # ÊâßË°åÂÅ•Â∫∑Ê£ÄÊü•
            if check_health; then
              echo "üéâ DevÁéØÂ¢ÉÈÉ®ÁΩ≤ÊàêÂäüÔºÅ"

              # ÁôªÂΩïÈïúÂÉè‰ªìÂ∫ì‰ª•Êõ¥Êñ∞dev-stableÊ†áÁ≠æ
              echo "${REGISTRY_PASSWORD}" | docker login crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com --username "${REGISTRY_USERNAME}" --password-stdin

              # Êõ¥Êñ∞dev-stableÊ†áÁ≠æÔºàÊ†áËÆ∞‰∏∫devÁ®≥ÂÆöÁâàÊú¨Ôºâ
              echo "üè∑Ô∏è  Êõ¥Êñ∞dev-stableÊ†áÁ≠æ..."
              docker tag crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com/bravo-project/backend:dev \
                         crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com/bravo-project/backend:dev-stable || true
              docker tag crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com/bravo-project/frontend:dev \
                         crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com/bravo-project/frontend:dev-stable || true

              # Êé®ÈÄÅstableÊ†áÁ≠æÂà∞ËøúÁ®ã‰ªìÂ∫ìÔºàÁî®‰∫éËøúÁ®ãÂõûÊªöÔºâ
              docker push crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com/bravo-project/backend:dev-stable || echo "‚ö†Ô∏è Êé®ÈÄÅbackend dev-stableÊ†áÁ≠æÂ§±Ë¥•"
              docker push crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com/bravo-project/frontend:dev-stable || echo "‚ö†Ô∏è Êé®ÈÄÅfrontend dev-stableÊ†áÁ≠æÂ§±Ë¥•"

              # ËÆ∞ÂΩïÂà∞ÈÉ®ÁΩ≤ÂéÜÂè≤
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] DevÈÉ®ÁΩ≤ÊàêÂäü - GitHub SHA: ${{ github.sha }} - Run ID: ${{ github.run_id }}" >> .deployment-history

              exit 0
            else
              echo "üö® ÂÅ•Â∫∑Ê£ÄÊü•Â§±Ë¥•ÔºåÂºÄÂßãËá™Âä®ÂõûÊªö..."

              # Ê£ÄÊü•ÊòØÂê¶ÊúâÂ§á‰ªΩÂèØ‰ª•ÂõûÊªö
              if ! docker images | grep -q bravo-dev-backend-backup; then
                echo "‚ùå Ê≤°ÊúâÂèØÂõûÊªöÁöÑÂ§á‰ªΩÈïúÂÉè"
                echo "[$(date '+%Y-%m-%d %H:%M:%S')] DevÈÉ®ÁΩ≤Â§±Ë¥• - Êó†Ê≥ïÂõûÊªö - GitHub SHA: ${{ github.sha }}" >> .deployment-history
                exit 1
              fi

              echo "‚èπÔ∏è  ÂÅúÊ≠¢Â§±Ë¥•ÁöÑÂÆπÂô®..."
              COMPOSE_PROJECT_NAME=bravo-dev docker-compose -f docker-compose.prod.yml down

              echo "üîÑ ‰ΩøÁî®Â§á‰ªΩÈïúÂÉèÂõûÊªö..."
              # ‰ΩøÁî®backupÊ†áÁ≠æÊÅ¢Â§ç
              docker tag bravo-dev-backend-backup:latest crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com/bravo-project/backend:dev
              docker tag bravo-dev-frontend-backup:latest crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com/bravo-project/frontend:dev
              echo "‚úÖ Â∑≤ÊÅ¢Â§çÂ§á‰ªΩÈïúÂÉè"

              echo "üöÄ ÈáçÊñ∞ÂêØÂä®ÊúçÂä°Ôºà‰ΩøÁî®Â§á‰ªΩÁâàÊú¨Ôºâ..."
              COMPOSE_PROJECT_NAME=bravo-dev \
              IMAGE_TAG=dev \
              USE_DOMAIN=true \
              DOMAIN_NAME=dev.layneliang.com \
              MYSQL_PORT=3307 \
              REDIS_PORT=6380 \
              BACKEND_PORT=8001 \
              FRONTEND_HTTP_PORT=8080 \
              FRONTEND_HTTPS_PORT=8443 \
              DJANGO_SECRET_KEY="${DJANGO_SECRET_KEY:-dev-secret-$(date +%s)}" \
              docker-compose -f docker-compose.prod.yml up -d

              echo "‚è≥ Á≠âÂæÖÂõûÊªöÂêéÁöÑÊúçÂä°Â∞±Áª™..."
              sleep 15

              # ÈáçÊñ∞ÈÖçÁΩÆNginx SSL
              if [ -f "frontend/nginx.domain-dev.conf" ]; then
                docker cp frontend/nginx.domain-dev.conf bravo-dev-frontend:/etc/nginx/conf.d/default.conf
                docker exec bravo-dev-frontend nginx -t && docker exec bravo-dev-frontend nginx -s reload
                echo "‚úÖ ÂõûÊªöÂêéSSLÈÖçÁΩÆÂ∑≤Â∫îÁî®"
              fi

              echo "üîç È™åËØÅÂõûÊªöÂêéÁöÑÊúçÂä°..."
              if check_health; then
                echo "‚úÖ ÂõûÊªöÊàêÂäüÔºÅÊúçÂä°Â∑≤ÊÅ¢Â§çÂà∞‰∏ä‰∏Ä‰∏™Á®≥ÂÆöÁâàÊú¨"
                echo "[$(date '+%Y-%m-%d %H:%M:%S')] DevÈÉ®ÁΩ≤Â§±Ë¥• - Â∑≤Ëá™Âä®ÂõûÊªöÊàêÂäü - GitHub SHA: ${{ github.sha }}" >> .deployment-history
                exit 1  # ‰ªçÁÑ∂ËøîÂõûÂ§±Ë¥•Áä∂ÊÄÅÔºåË°®Á§∫Êú¨Ê¨°ÈÉ®ÁΩ≤Â§±Ë¥•‰∫Ü
              else
                echo "‚ùå ÂõûÊªöÂêéÂÅ•Â∫∑Ê£ÄÊü•‰ªçÁÑ∂Â§±Ë¥•"
                echo "[$(date '+%Y-%m-%d %H:%M:%S')] DevÈÉ®ÁΩ≤Â§±Ë¥• - ÂõûÊªö‰πüÂ§±Ë¥• - GitHub SHA: ${{ github.sha }}" >> .deployment-history
                exit 1
              fi
            fi
          ENDSSH
