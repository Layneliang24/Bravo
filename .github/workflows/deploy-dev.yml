name: Deploy to Dev Environment

on:
  # åœ¨é•œåƒæ„å»ºå®Œæˆåè‡ªåŠ¨è§¦å‘
  workflow_run:
    workflows: ["ğŸ³ Build and Push Docker Images"]
    types:
      - completed
    branches: [dev]
  # ä¿ç•™æ‰‹åŠ¨è§¦å‘é€‰é¡¹
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    # åªæœ‰åœ¨é•œåƒæ„å»ºæˆåŠŸæ—¶æ‰éƒ¨ç½²
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: dev # å¼ºåˆ¶æ‹‰å–devåˆ†æ”¯æœ€æ–°ä»£ç ï¼Œç¡®ä¿ä½¿ç”¨æœ€æ–°çš„workflowå’Œå¥åº·æ£€æŸ¥é€»è¾‘

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.TXYUN_SSH_KEY }}

      - name: SSH Connection Diagnostics
        env:
          HOST: ${{ secrets.TXYUN_HOST }}
          USER: ${{ secrets.TXYUN_USER }}
        run: |
          echo "ğŸ” SSHè¿æ¥è¯Šæ–­..."
          echo "=========================================="
          echo "1. è·å–å½“å‰GitHub Actions Runner IPåœ°å€"
          echo "=========================================="
          RUNNER_IP=$(curl -s https://api.ipify.org 2>/dev/null || curl -s https://ifconfig.me 2>/dev/null || echo "æ— æ³•è·å–")
          echo "Runner IP: $RUNNER_IP"
          echo ""
          echo "=========================================="
          echo "2. æ˜¾ç¤ºç›®æ ‡æœåŠ¡å™¨ä¿¡æ¯ï¼ˆéšè—æ•æ„Ÿéƒ¨åˆ†ï¼‰"
          echo "=========================================="
          echo "ç›®æ ‡ä¸»æœº: ${HOST:0:10}***"
          echo "ç›®æ ‡ç”¨æˆ·: $USER"
          echo ""
          echo "=========================================="
          echo "3. æµ‹è¯•ç½‘ç»œè¿é€šæ€§ï¼ˆç«¯å£22ï¼‰"
          echo "=========================================="
          # ä½¿ç”¨timeoutå’Œbashå†…ç½®çš„TCPè¿æ¥æµ‹è¯•
          if command -v nc >/dev/null 2>&1; then
            timeout 5 nc -zv -w 3 $HOST 22 2>&1 || echo "âš ï¸ ncæµ‹è¯•: ç«¯å£22è¿æ¥å¤±è´¥æˆ–è¶…æ—¶"
          else
            echo "âš ï¸ ncå‘½ä»¤ä¸å¯ç”¨ï¼Œè·³è¿‡ç«¯å£æµ‹è¯•"
          fi
          # ä½¿ç”¨bashçš„/dev/tcpæµ‹è¯•
          if timeout 3 bash -c "echo > /dev/tcp/$HOST/22" 2>/dev/null; then
            echo "âœ… /dev/tcpæµ‹è¯•: ç«¯å£22å¯è¾¾"
          else
            echo "âš ï¸ /dev/tcpæµ‹è¯•: ç«¯å£22ä¸å¯è¾¾æˆ–è¶…æ—¶"
          fi
          echo ""
          echo "=========================================="
          echo "4. æ£€æŸ¥SSHå¯†é’¥æ˜¯å¦å·²åŠ è½½"
          echo "=========================================="
          ssh-add -l 2>&1 || echo "âš ï¸ SSHå¯†é’¥æœªåŠ è½½æˆ–ssh-agentæœªè¿è¡Œ"
          echo ""
          echo "=========================================="
          echo "5. æµ‹è¯•SSHè¿æ¥ï¼ˆè¯¦ç»†æ¨¡å¼ï¼Œ10ç§’è¶…æ—¶ï¼‰"
          echo "=========================================="
          ssh -vvv -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              -o ServerAliveInterval=30 \
              -o ServerAliveCountMax=3 \
              -o LogLevel=DEBUG \
              $USER@$HOST "echo 'âœ… SSHè¿æ¥æµ‹è¯•æˆåŠŸ'" 2>&1 | head -50 || {
            echo ""
            echo "âŒ SSHè¿æ¥å¤±è´¥"
            echo ""
            echo "=========================================="
            echo "å¯èƒ½çš„åŸå› ï¼š"
            echo "1. GitHub Actions IP ($RUNNER_IP) æœªåœ¨ç™½åå•ä¸­"
            echo "2. æœåŠ¡å™¨SSHæœåŠ¡æœªå¯åŠ¨æˆ–ç«¯å£è¢«é˜²ç«å¢™é˜»æ­¢"
            echo "3. SSHå¯†é’¥é…ç½®ä¸æ­£ç¡®"
            echo "4. ç½‘ç»œè·¯ç”±é—®é¢˜"
            echo "=========================================="
            exit 1
          }
          echo ""
          echo "âœ… è¯Šæ–­å®Œæˆï¼ŒSSHè¿æ¥æ­£å¸¸"

      - name: Deploy to dev server
        env:
          HOST: ${{ secrets.TXYUN_HOST }}
          USER: ${{ secrets.TXYUN_USER }}
          REGISTRY_USERNAME: ${{ secrets.ALIYUN_REGISTRY_USERNAME }}
          REGISTRY_PASSWORD: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}
        run: |
          ssh -o StrictHostKeyChecking=no \
              -o ServerAliveInterval=30 \
              -o ServerAliveCountMax=30 \
              $USER@$HOST bash -s << 'ENDSSH' "$REGISTRY_USERNAME" "$REGISTRY_PASSWORD"
            set -e

            # æ¥æ”¶å‚æ•°
            REGISTRY_USERNAME="$1"
            REGISTRY_PASSWORD="$2"

          echo "ğŸ“ è¿›å…¥é¡¹ç›®ç›®å½•..."
          # å…ˆç¡®ä¿çˆ¶ç›®å½•å­˜åœ¨å¹¶æœ‰æ­£ç¡®æƒé™
          echo "ğŸ”§ æ£€æŸ¥å’Œä¿®å¤ç›®å½•æƒé™..."
          sudo mkdir -p /home/layne/project 2>/dev/null || true
          sudo chown -R $USER:$USER /home/layne/project 2>/dev/null || true
          sudo chmod 755 /home/layne/project 2>/dev/null || true

          # å¦‚æœé¡¹ç›®ç›®å½•ä¸å­˜åœ¨ï¼Œå…ˆåˆ›å»º
          if [ ! -d "/home/layne/project/bravo-dev" ]; then
            echo "ğŸ“ åˆ›å»ºé¡¹ç›®ç›®å½•..."
            sudo mkdir -p /home/layne/project/bravo-dev 2>/dev/null || true
          fi

          cd /home/layne/project/bravo-dev

          echo "ğŸ”§ ä¿®å¤æƒé™é—®é¢˜..."
          # ç¡®ä¿å½“å‰ç”¨æˆ·æ‹¥æœ‰é¡¹ç›®ç›®å½•æƒé™
          sudo chown -R $USER:$USER /home/layne/project/bravo-dev 2>/dev/null || true
          sudo chmod -R 755 /home/layne/project/bravo-dev 2>/dev/null || true
          # æ£€æŸ¥Dockeræƒé™ï¼Œå¦‚æœæ²¡æœ‰æƒé™åˆ™ä½¿ç”¨sudoåŒ…è£…
          if ! docker ps &>/dev/null; then
            echo "âš ï¸ å½“å‰ç”¨æˆ·æ— Dockeræƒé™ï¼Œæ£€æŸ¥dockerç»„..."
            if ! groups | grep -q docker; then
              echo "å°†ç”¨æˆ·æ·»åŠ åˆ°dockerç»„..."
              sudo usermod -aG docker $USER 2>/dev/null || true
              echo "âš ï¸ å·²æ·»åŠ ç”¨æˆ·åˆ°dockerç»„ï¼Œä½†éœ€è¦é‡æ–°ç™»å½•æ‰èƒ½ç”Ÿæ•ˆ"
              echo "ä¸´æ—¶ä½¿ç”¨sudoæ‰§è¡ŒDockerå‘½ä»¤..."
              # åˆ›å»ºdockerå‘½ä»¤çš„sudoåŒ…è£…å‡½æ•°
              docker() { sudo docker "$@"; }
              docker-compose() { sudo docker-compose "$@"; }
            fi
          fi
          # ä¿®å¤.gitç›®å½•æƒé™ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -d ".git" ]; then
            sudo chown -R $USER:$USER .git 2>/dev/null || true
          fi

          echo "ğŸ”„ æ‹‰å–æœ€æ–°ä»£ç ..."

          # Gitæ“ä½œé‡è¯•å‡½æ•°
          git_retry() {
            local cmd="$1"
            local max_retry=3
            local retry=0
            local delay=5

            while [ $retry -lt $max_retry ]; do
              echo "ğŸ”„ æ‰§è¡Œ: $cmd (å°è¯• $((retry+1))/$max_retry)..."
              if eval "$cmd"; then
                echo "âœ… Gitæ“ä½œæˆåŠŸ"
                return 0
              else
                retry=$((retry+1))
                if [ $retry -lt $max_retry ]; then
                  echo "âš ï¸ Gitæ“ä½œå¤±è´¥ï¼Œ${delay}ç§’åé‡è¯•..."
                  sleep $delay
                  delay=$((delay + 5))  # é€’å¢å»¶è¿Ÿ
                fi
              fi
            done

            echo "âŒ Gitæ“ä½œå¤±è´¥ï¼Œå·²é‡è¯•${max_retry}æ¬¡"
            return 1
          }

          if [ -d ".git" ] && [ -r ".git" ]; then
            echo "ğŸ“ .gitç›®å½•å­˜åœ¨ï¼Œæ›´æ–°ä»£ç ..."

            # é…ç½®Gitä½¿ç”¨æ›´ç¨³å®šçš„ç½‘ç»œè®¾ç½®
            git config --global http.postBuffer 524288000
            git config --global http.lowSpeedLimit 1000
            git config --global http.lowSpeedTime 300
            git config --global http.version HTTP/1.1

            # å…ˆè·å–è¿œç¨‹devåˆ†æ”¯çš„æœ€æ–°ä¿¡æ¯ï¼ˆå¸¦é‡è¯•ï¼‰
            echo "ğŸ”„ è·å–è¿œç¨‹devåˆ†æ”¯æœ€æ–°ä¿¡æ¯..."
            git_retry "git fetch --force --prune origin dev" || \
            git_retry "git fetch --force --prune origin dev" || \
            git fetch --force --prune origin dev

            # æ˜¾ç¤ºè¿œç¨‹devåˆ†æ”¯çš„HEADä¿¡æ¯
            echo "ğŸ“ è¿œç¨‹dev HEAD: $(git rev-parse origin/dev 2>/dev/null || echo 'unknown')"
            REMOTE_DEV_HEAD=$(git rev-parse origin/dev 2>/dev/null || echo "")
            if [ -z "$REMOTE_DEV_HEAD" ]; then
              echo "âŒ æ— æ³•è·å–è¿œç¨‹devåˆ†æ”¯HEADï¼Œé€€å‡º"
              exit 1
            fi

            # ç¡®ä¿å½“å‰åœ¨devåˆ†æ”¯ï¼Œå¦‚æœä¸åœ¨åˆ™åˆ‡æ¢
            CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "")
            if [ "$CURRENT_BRANCH" != "dev" ]; then
              echo "âš ï¸ å½“å‰åˆ†æ”¯æ˜¯ $CURRENT_BRANCHï¼Œåˆ‡æ¢åˆ°devåˆ†æ”¯..."
              git checkout -B dev origin/dev 2>/dev/null || {
                echo "âš ï¸ åˆ‡æ¢å¤±è´¥ï¼Œå¼ºåˆ¶é‡ç½®åˆ°dev..."
                git fetch origin dev:dev --force || true
                git checkout -f dev || true
              }
            fi

            # å…ˆæ¸…ç†æ‰€æœ‰æœªæäº¤çš„æ”¹åŠ¨å’Œæœªè·Ÿè¸ªæ–‡ä»¶
            git reset --hard HEAD || true
            git clean -fdx || true

            # å¼ºåˆ¶é‡ç½®åˆ°è¿œç¨‹devåˆ†æ”¯æœ€æ–°ä»£ç ï¼ˆç¡®ä¿ä½¿ç”¨devåˆ†æ”¯ï¼Œä¸æ˜¯mainï¼‰
            echo "ğŸ”„ é‡ç½®åˆ°è¿œç¨‹devåˆ†æ”¯æœ€æ–°ä»£ç ..."
            git_retry "git reset --hard origin/dev" || git reset --hard origin/dev

            # éªŒè¯æœ€ç»ˆHEADæ˜¯å¦ä¸è¿œç¨‹devåˆ†æ”¯ä¸€è‡´
            FINAL_HEAD=$(git rev-parse HEAD 2>/dev/null || echo "")
            echo "ğŸ“ æœ€ç»ˆHEAD: $FINAL_HEAD"
            echo "ğŸ“ è¿œç¨‹dev HEAD: $REMOTE_DEV_HEAD"

            if [ "$FINAL_HEAD" != "$REMOTE_DEV_HEAD" ]; then
              echo "âš ï¸ HEADä¸è¿œç¨‹devåˆ†æ”¯ä¸ä¸€è‡´ï¼Œå¼ºåˆ¶åŒæ­¥..."
              git reset --hard origin/dev
            fi

            # æ˜¾ç¤ºæœ€ç»ˆæäº¤ä¿¡æ¯
            echo "âœ… æœ€ç»ˆHEAD: $(git rev-parse HEAD)"
            echo "âœ… å½“å‰åˆ†æ”¯: $(git rev-parse --abbrev-ref HEAD)"
            echo "âœ… æœ€æ–°æäº¤: $(git log -1 --oneline)"
          else
            # å¦‚æœ.gitä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®ï¼Œåˆ é™¤ç›®å½•é‡æ–°å…‹éš†
            echo "âš ï¸ .gitç›®å½•ä¸å­˜åœ¨æˆ–æƒé™ä¸è¶³ï¼Œé‡æ–°å…‹éš†..."
            cd /home/layne/project
            # å…ˆä¿®å¤æƒé™å†åˆ é™¤ï¼Œç¡®ä¿å¯ä»¥åˆ é™¤
            sudo chown -R $USER:$USER bravo-dev 2>/dev/null || true
            rm -rf bravo-dev 2>/dev/null || sudo rm -rf bravo-dev 2>/dev/null || true

            # é…ç½®Gitä½¿ç”¨æ›´ç¨³å®šçš„ç½‘ç»œè®¾ç½®
            git config --global http.postBuffer 524288000
            git config --global http.lowSpeedLimit 1000
            git config --global http.lowSpeedTime 300
            git config --global http.version HTTP/1.1

            # ç¡®ä¿ç›®å½•æƒé™æ­£ç¡®åå…‹éš†ï¼ˆå¸¦é‡è¯•ï¼‰
            git_retry "git clone -b dev --depth=1 https://github.com/Layneliang24/Bravo.git bravo-dev" || \
            git_retry "git clone -b dev https://github.com/Layneliang24/Bravo.git bravo-dev" || \
            git clone -b dev https://github.com/Layneliang24/Bravo.git bravo-dev

            cd bravo-dev
            # ä¿®å¤å…‹éš†åçš„æƒé™
            sudo chown -R $USER:$USER . 2>/dev/null || true
            sudo chmod -R 755 . 2>/dev/null || true

            # æ˜¾ç¤ºå…‹éš†åçš„HEADä¿¡æ¯
            echo "âœ… å…‹éš†å®Œæˆï¼ŒHEAD: $(git rev-parse HEAD)"
            echo "âœ… æœ€æ–°æäº¤: $(git log -1 --oneline)"
          fi

          echo "â¹ï¸  åœæ­¢æ—§å®¹å™¨..."
          COMPOSE_PROJECT_NAME=bravo-dev docker-compose -f docker-compose.prod.yml down || true

          echo "ğŸ” ç™»å½•é˜¿é‡Œäº‘é•œåƒä»“åº“..."
          echo "${REGISTRY_PASSWORD}" | docker login crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com --username "${REGISTRY_USERNAME}" --password-stdin

          echo "ğŸ“¦ æ‹‰å–æœ€æ–°é•œåƒ..."
          COMPOSE_PROJECT_NAME=bravo-dev IMAGE_TAG=dev docker-compose -f docker-compose.prod.yml pull

          echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
          # æ£€æŸ¥æ˜¯å¦é…ç½®äº†SSLè¯ä¹¦ï¼ˆåŸŸåæ¨¡å¼ï¼‰
          if [ -d "/etc/letsencrypt/live/dev.layneliang.com" ]; then
            echo "æ£€æµ‹åˆ°SSLè¯ä¹¦ï¼Œä½¿ç”¨åŸŸåé…ç½®..."
            if [ -f "frontend/nginx.domain-dev.conf" ]; then
              cp frontend/nginx.domain-dev.conf frontend/nginx.conf.tmp
              echo "ä½¿ç”¨åŸŸåNginxé…ç½®"
            fi
            USE_DOMAIN=true
            DOMAIN_NAME=dev.layneliang.com
          else
            echo "æœªæ£€æµ‹åˆ°SSLè¯ä¹¦ï¼Œä½¿ç”¨IPé…ç½®..."
            USE_DOMAIN=false
            DOMAIN_NAME=""
          fi

          # ä¸ºdevç¯å¢ƒä½¿ç”¨ä¸åŒç«¯å£é¿å…ä¸prodå†²çª
          COMPOSE_PROJECT_NAME=bravo-dev \
          IMAGE_TAG=dev \
          USE_DOMAIN=$USE_DOMAIN \
          DOMAIN_NAME=$DOMAIN_NAME \
          MYSQL_PORT=3307 \
          REDIS_PORT=6380 \
          BACKEND_PORT=8001 \
          FRONTEND_HTTP_PORT=8080 \
          FRONTEND_HTTPS_PORT=8443 \
          DJANGO_SECRET_KEY="${DJANGO_SECRET_KEY:-dev-secret-$(date +%s)}" \
          docker-compose -f docker-compose.prod.yml up -d

          echo "â³ ç­‰å¾…æœåŠ¡å°±ç»ª..."
          sleep 10

          echo "ğŸ”§ é…ç½®Nginx SSL..."
          # å¤åˆ¶å¼€å‘ç¯å¢ƒSSLé…ç½®åˆ°å®¹å™¨
          if [ -f "frontend/nginx.domain-dev.conf" ]; then
            docker cp frontend/nginx.domain-dev.conf bravo-dev-frontend:/etc/nginx/conf.d/default.conf
            docker exec bravo-dev-frontend nginx -t && docker exec bravo-dev-frontend nginx -s reload
            echo "âœ… å¼€å‘ç¯å¢ƒSSLé…ç½®å·²åº”ç”¨ï¼ˆdev.layneliang.comï¼‰"
          else
            echo "âš ï¸  æœªæ‰¾åˆ°nginx.domain-dev.confï¼Œè·³è¿‡SSLé…ç½®"
          fi

          echo "ğŸ“Š æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
          COMPOSE_PROJECT_NAME=bravo-dev docker-compose -f docker-compose.prod.yml ps

          echo "ğŸ” éªŒè¯Nginxç«¯å£..."
          docker exec bravo-dev-frontend netstat -tlnp | grep -E '(:80|:443)' || echo "Nginxç«¯å£æ£€æŸ¥å®Œæˆ"

          echo "ğŸ“ éªŒè¯é™æ€æ–‡ä»¶..."
          echo "Backendé•œåƒå†…çš„åŸå§‹é™æ€æ–‡ä»¶:"
          docker exec bravo-dev-backend ls -la /app/staticfiles/ | head -20 || echo "âš ï¸ Backendé•œåƒå†…é™æ€æ–‡ä»¶ä¸ºç©º"
          echo "Backendå®¹å™¨å…±äº«å·ä¸­çš„é™æ€æ–‡ä»¶:"
          docker exec bravo-dev-backend ls -la /shared/static/ | head -20 || echo "âš ï¸ Backendå…±äº«å·ä¸ºç©º"
          echo "Frontendå®¹å™¨å†…çš„é™æ€æ–‡ä»¶:"
          docker exec bravo-dev-frontend ls -la /usr/share/nginx/html/static/ | head -20 || echo "âš ï¸ Frontendé™æ€æ–‡ä»¶ç›®å½•ä¸ºç©º"
          echo "æ£€æŸ¥adminé™æ€æ–‡ä»¶:"
          docker exec bravo-dev-frontend ls -la /usr/share/nginx/html/static/admin/ | head -10 || echo "âš ï¸ Adminé™æ€æ–‡ä»¶ä¸å­˜åœ¨"
          echo "æ£€æŸ¥Backendçš„STATIC_ROOTé…ç½®:"
          docker exec bravo-dev-backend python -c "from bravo.settings.production import STATIC_ROOT; print(f'STATIC_ROOT: {STATIC_ROOT}')" || echo "âš ï¸ æ— æ³•è·å–STATIC_ROOT"

          # åœ¨éƒ¨ç½²å‰å¤‡ä»½å½“å‰è¿è¡Œçš„é•œåƒï¼ˆç”¨äºå›æ»šï¼‰
          echo "ğŸ“¦ å¤‡ä»½å½“å‰é•œåƒä½œä¸ºå›æ»šç‚¹..."
          if docker images | grep -q bravo-dev-backend; then
            docker tag bravo-dev-backend:latest bravo-dev-backend-backup:latest || echo "Backend backup created"
          fi
          if docker images | grep -q bravo-dev-frontend; then
            docker tag bravo-dev-frontend:latest bravo-dev-frontend-backup:latest || echo "Frontend backup created"
          fi

          # è®°å½•éƒ¨ç½²ä¿¡æ¯
          echo "DEPLOYED_AT=$(date '+%Y-%m-%d %H:%M:%S')" > .deployment-current
          echo "GITHUB_SHA=${{ github.sha }}" >> .deployment-current
          echo "GITHUB_RUN_ID=${{ github.run_id }}" >> .deployment-current

          echo "âœ… Devç¯å¢ƒéƒ¨ç½²æ­¥éª¤å®Œæˆï¼Œå‡†å¤‡å¥åº·æ£€æŸ¥..."
          ENDSSH

      - name: Health Check with Auto Rollback
        id: health-check
        if: always()
        env:
          HOST: ${{ secrets.TXYUN_HOST }}
          USER: ${{ secrets.TXYUN_USER }}
          REGISTRY_USERNAME: ${{ secrets.TXYUN_REGISTRY_USERNAME }}
          REGISTRY_PASSWORD: ${{ secrets.TXYUN_REGISTRY_PASSWORD }}
        run: |
          ssh -o StrictHostKeyChecking=no $USER@$HOST bash -s << 'ENDSSH' "$REGISTRY_USERNAME" "$REGISTRY_PASSWORD"
            set -e

            REGISTRY_USERNAME="$1"
            REGISTRY_PASSWORD="$2"

            echo "ğŸ¥ å¼€å§‹Devç¯å¢ƒå¥åº·æ£€æŸ¥..."
            cd /home/layne/project/bravo-dev

            # å¥åº·æ£€æŸ¥å‡½æ•°
            check_health() {
              local retry=0
              local max_retry=3

              while [ $retry -lt $max_retry ]; do
                echo "ğŸ” å¥åº·æ£€æŸ¥ ($((retry+1))/$max_retry)..."

                # æ£€æŸ¥å®¹å™¨çŠ¶æ€
                if ! docker ps | grep -q bravo-dev-backend; then
                  echo "âŒ Backendå®¹å™¨æœªè¿è¡Œ"
                  retry=$((retry+1))
                  sleep 10
                  continue
                fi

                if ! docker ps | grep -q bravo-dev-frontend; then
                  echo "âŒ Frontendå®¹å™¨æœªè¿è¡Œ"
                  retry=$((retry+1))
                  sleep 10
                  continue
                fi

                # æ£€æŸ¥å‰ç«¯ï¼ˆä½¿ç”¨devç¯å¢ƒç«¯å£8080ï¼‰
                FRONTEND_STATUS=$(curl -L -s -o /dev/null -w "%{http_code}" http://localhost:8080/ || echo "000")
                if [ "$FRONTEND_STATUS" != "200" ]; then
                  echo "âš ï¸ å‰ç«¯å¥åº·æ£€æŸ¥å¤±è´¥ (çŠ¶æ€ç : $FRONTEND_STATUS)"
                  retry=$((retry+1))
                  sleep 10
                  continue
                fi

                # æ£€æŸ¥åç«¯APIï¼ˆä½¿ç”¨devç¯å¢ƒç«¯å£8001ï¼‰
                BACKEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8001/api/ || echo "000")
                if [ "$BACKEND_STATUS" != "200" ]; then
                  echo "âš ï¸ åç«¯APIå¥åº·æ£€æŸ¥å¤±è´¥ (çŠ¶æ€ç : $BACKEND_STATUS)"
                  retry=$((retry+1))
                  sleep 10
                  continue
                fi

                # æ‰€æœ‰æ£€æŸ¥é€šè¿‡
                echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
                echo "  - Frontend (port 8080): $FRONTEND_STATUS"
                echo "  - Backend API (port 8001): $BACKEND_STATUS"
                return 0
              done

              echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼ˆé‡è¯•${max_retry}æ¬¡ï¼‰"
              return 1
            }

            # æ‰§è¡Œå¥åº·æ£€æŸ¥
            if check_health; then
              echo "ğŸ‰ Devç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼"

              # ç™»å½•é•œåƒä»“åº“ä»¥æ›´æ–°dev-stableæ ‡ç­¾
              echo "${REGISTRY_PASSWORD}" | docker login crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com --username "${REGISTRY_USERNAME}" --password-stdin

              # æ›´æ–°dev-stableæ ‡ç­¾ï¼ˆæ ‡è®°ä¸ºdevç¨³å®šç‰ˆæœ¬ï¼‰
              echo "ğŸ·ï¸  æ›´æ–°dev-stableæ ‡ç­¾..."
              docker tag crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com/bravo-project/backend:dev \
                         crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com/bravo-project/backend:dev-stable || true
              docker tag crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com/bravo-project/frontend:dev \
                         crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com/bravo-project/frontend:dev-stable || true

              # æ¨é€stableæ ‡ç­¾åˆ°è¿œç¨‹ä»“åº“ï¼ˆç”¨äºè¿œç¨‹å›æ»šï¼‰
              docker push crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com/bravo-project/backend:dev-stable || echo "âš ï¸ æ¨é€backend dev-stableæ ‡ç­¾å¤±è´¥"
              docker push crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com/bravo-project/frontend:dev-stable || echo "âš ï¸ æ¨é€frontend dev-stableæ ‡ç­¾å¤±è´¥"

              # è®°å½•åˆ°éƒ¨ç½²å†å²
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] Devéƒ¨ç½²æˆåŠŸ - GitHub SHA: ${{ github.sha }} - Run ID: ${{ github.run_id }}" >> .deployment-history

              exit 0
            else
              echo "ğŸš¨ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå¼€å§‹è‡ªåŠ¨å›æ»š..."

              # æ£€æŸ¥æ˜¯å¦æœ‰å¤‡ä»½å¯ä»¥å›æ»š
              if ! docker images | grep -q bravo-dev-backend-backup; then
                echo "âŒ æ²¡æœ‰å¯å›æ»šçš„å¤‡ä»½é•œåƒ"
                echo "[$(date '+%Y-%m-%d %H:%M:%S')] Devéƒ¨ç½²å¤±è´¥ - æ— æ³•å›æ»š - GitHub SHA: ${{ github.sha }}" >> .deployment-history
                exit 1
              fi

              echo "â¹ï¸  åœæ­¢å¤±è´¥çš„å®¹å™¨..."
              COMPOSE_PROJECT_NAME=bravo-dev docker-compose -f docker-compose.prod.yml down

              echo "ğŸ”„ ä½¿ç”¨å¤‡ä»½é•œåƒå›æ»š..."
              # ä½¿ç”¨backupæ ‡ç­¾æ¢å¤
              docker tag bravo-dev-backend-backup:latest crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com/bravo-project/backend:dev
              docker tag bravo-dev-frontend-backup:latest crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com/bravo-project/frontend:dev
              echo "âœ… å·²æ¢å¤å¤‡ä»½é•œåƒ"

              echo "ğŸš€ é‡æ–°å¯åŠ¨æœåŠ¡ï¼ˆä½¿ç”¨å¤‡ä»½ç‰ˆæœ¬ï¼‰..."
              COMPOSE_PROJECT_NAME=bravo-dev \
              IMAGE_TAG=dev \
              USE_DOMAIN=true \
              DOMAIN_NAME=dev.layneliang.com \
              MYSQL_PORT=3307 \
              REDIS_PORT=6380 \
              BACKEND_PORT=8001 \
              FRONTEND_HTTP_PORT=8080 \
              FRONTEND_HTTPS_PORT=8443 \
              DJANGO_SECRET_KEY="${DJANGO_SECRET_KEY:-dev-secret-$(date +%s)}" \
              docker-compose -f docker-compose.prod.yml up -d

              echo "â³ ç­‰å¾…å›æ»šåçš„æœåŠ¡å°±ç»ª..."
              sleep 15

              # é‡æ–°é…ç½®Nginx SSL
              if [ -f "frontend/nginx.domain-dev.conf" ]; then
                docker cp frontend/nginx.domain-dev.conf bravo-dev-frontend:/etc/nginx/conf.d/default.conf
                docker exec bravo-dev-frontend nginx -t && docker exec bravo-dev-frontend nginx -s reload
                echo "âœ… å›æ»šåSSLé…ç½®å·²åº”ç”¨"
              fi

              echo "ğŸ” éªŒè¯å›æ»šåçš„æœåŠ¡..."
              if check_health; then
                echo "âœ… å›æ»šæˆåŠŸï¼æœåŠ¡å·²æ¢å¤åˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬"
                echo "[$(date '+%Y-%m-%d %H:%M:%S')] Devéƒ¨ç½²å¤±è´¥ - å·²è‡ªåŠ¨å›æ»šæˆåŠŸ - GitHub SHA: ${{ github.sha }}" >> .deployment-history
                exit 1  # ä»ç„¶è¿”å›å¤±è´¥çŠ¶æ€ï¼Œè¡¨ç¤ºæœ¬æ¬¡éƒ¨ç½²å¤±è´¥äº†
              else
                echo "âŒ å›æ»šåå¥åº·æ£€æŸ¥ä»ç„¶å¤±è´¥"
                echo "[$(date '+%Y-%m-%d %H:%M:%S')] Devéƒ¨ç½²å¤±è´¥ - å›æ»šä¹Ÿå¤±è´¥ - GitHub SHA: ${{ github.sha }}" >> .deployment-history
                exit 1
              fi
            fi
          ENDSSH
