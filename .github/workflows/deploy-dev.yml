name: Deploy to Dev Environment

on:
  push:
    branches: [dev]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ALIYUN_SSH_KEY }}

      - name: Deploy to dev server
        env:
          HOST: ${{ secrets.ALIYUN_HOST }}
          USER: ${{ secrets.ALIYUN_USER }}
          REGISTRY_USERNAME: ${{ secrets.ALIYUN_REGISTRY_USERNAME }}
          REGISTRY_PASSWORD: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}
        run: |
          ssh -o StrictHostKeyChecking=no \
              -o ServerAliveInterval=30 \
              -o ServerAliveCountMax=30 \
              $USER@$HOST bash -s << 'ENDSSH' "$REGISTRY_USERNAME" "$REGISTRY_PASSWORD"
            set -e

            # æŽ¥æ”¶å‚æ•°
            REGISTRY_USERNAME="$1"
            REGISTRY_PASSWORD="$2"

          echo "ðŸ“ è¿›å…¥é¡¹ç›®ç›®å½•..."
          cd /home/layne/project/bravo-dev

          echo "ðŸ”„ æ‹‰å–æœ€æ–°ä»£ç ..."
          if [ -d ".git" ]; then
            # å…ˆæ¸…ç†æ‰€æœ‰æœªæäº¤çš„æ”¹åŠ¨å’Œæœªè·Ÿè¸ªæ–‡ä»¶
            git reset --hard HEAD
            git clean -fdx
            # æ‹‰å–æœ€æ–°ä»£ç 
            git fetch origin dev
            git reset --hard origin/dev
          else
            git clone -b dev https://github.com/Layneliang24/Bravo.git .
          fi

          echo "â¹ï¸  åœæ­¢æ—§å®¹å™¨..."
          COMPOSE_PROJECT_NAME=bravo-dev docker-compose -f docker-compose.prod.yml down || true

          echo "ðŸ” ç™»å½•é˜¿é‡Œäº‘é•œåƒä»“åº“..."
          echo "${REGISTRY_PASSWORD}" | docker login crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com --username "${REGISTRY_USERNAME}" --password-stdin

          echo "ðŸ“¦ æ‹‰å–æœ€æ–°é•œåƒ..."
          COMPOSE_PROJECT_NAME=bravo-dev IMAGE_TAG=dev docker-compose -f docker-compose.prod.yml pull

          echo "ðŸš€ å¯åŠ¨æœåŠ¡..."
          # æ£€æŸ¥æ˜¯å¦é…ç½®äº†SSLè¯ä¹¦ï¼ˆåŸŸåæ¨¡å¼ï¼‰
          if [ -d "/etc/letsencrypt/live/dev.layneliang.com" ]; then
            echo "æ£€æµ‹åˆ°SSLè¯ä¹¦ï¼Œä½¿ç”¨åŸŸåé…ç½®..."
            if [ -f "frontend/nginx.domain-dev.conf" ]; then
              cp frontend/nginx.domain-dev.conf frontend/nginx.conf.tmp
              echo "ä½¿ç”¨åŸŸåNginxé…ç½®"
            fi
            USE_DOMAIN=true
            DOMAIN_NAME=dev.layneliang.com
          else
            echo "æœªæ£€æµ‹åˆ°SSLè¯ä¹¦ï¼Œä½¿ç”¨IPé…ç½®..."
            USE_DOMAIN=false
            DOMAIN_NAME=""
          fi

          # ä¸ºdevçŽ¯å¢ƒä½¿ç”¨ä¸åŒç«¯å£é¿å…ä¸Žprodå†²çª
          COMPOSE_PROJECT_NAME=bravo-dev \
          IMAGE_TAG=dev \
          USE_DOMAIN=$USE_DOMAIN \
          DOMAIN_NAME=$DOMAIN_NAME \
          MYSQL_PORT=3307 \
          REDIS_PORT=6380 \
          BACKEND_PORT=8001 \
          FRONTEND_HTTP_PORT=8080 \
          FRONTEND_HTTPS_PORT=8443 \
          DJANGO_SECRET_KEY="${DJANGO_SECRET_KEY:-dev-secret-$(date +%s)}" \
          docker-compose -f docker-compose.prod.yml up -d

          echo "â³ ç­‰å¾…æœåŠ¡å°±ç»ª..."
          sleep 10

          echo "ðŸ”§ é…ç½®Nginx SSL..."
          # å¤åˆ¶SSLé…ç½®åˆ°å®¹å™¨
          if [ -f "frontend/nginx.ssl.conf" ]; then
            docker cp frontend/nginx.ssl.conf bravo-dev-frontend:/etc/nginx/conf.d/ssl.conf
            docker exec bravo-dev-frontend nginx -t && docker exec bravo-dev-frontend nginx -s reload
            echo "âœ… SSLé…ç½®å·²åº”ç”¨"
          else
            echo "âš ï¸  æœªæ‰¾åˆ°nginx.ssl.confï¼Œè·³è¿‡SSLé…ç½®"
          fi

          echo "ðŸ“Š æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
          COMPOSE_PROJECT_NAME=bravo-dev docker-compose -f docker-compose.prod.yml ps

          echo "ðŸ” éªŒè¯Nginxç«¯å£..."
          docker exec bravo-dev-frontend netstat -tlnp | grep -E '(:80|:443)' || echo "Nginxç«¯å£æ£€æŸ¥å®Œæˆ"

          echo "âœ… DevçŽ¯å¢ƒéƒ¨ç½²å®Œæˆ"
          ENDSSH
