name: Deploy to Dev Environment

on:
  # åœ¨é•œåƒæ„å»ºå®Œæˆåè‡ªåŠ¨è§¦å‘
  workflow_run:
    workflows: ["ğŸ³ Build and Push Docker Images"]
    types:
      - completed
    branches: [dev]
  # ä¿ç•™æ‰‹åŠ¨è§¦å‘é€‰é¡¹
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    # åªæœ‰åœ¨é•œåƒæ„å»ºæˆåŠŸæ—¶æ‰éƒ¨ç½²
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ALIYUN_SSH_KEY }}

      - name: Deploy to dev server
        env:
          HOST: ${{ secrets.ALIYUN_HOST }}
          USER: ${{ secrets.ALIYUN_USER }}
          REGISTRY_USERNAME: ${{ secrets.ALIYUN_REGISTRY_USERNAME }}
          REGISTRY_PASSWORD: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}
        run: |
          ssh -o StrictHostKeyChecking=no \
              -o ServerAliveInterval=30 \
              -o ServerAliveCountMax=30 \
              $USER@$HOST bash -s << 'ENDSSH' "$REGISTRY_USERNAME" "$REGISTRY_PASSWORD"
            set -e

            # æ¥æ”¶å‚æ•°
            REGISTRY_USERNAME="$1"
            REGISTRY_PASSWORD="$2"

          echo "ğŸ“ è¿›å…¥é¡¹ç›®ç›®å½•..."
          cd /home/layne/project/bravo-dev

          echo "ğŸ”„ æ‹‰å–æœ€æ–°ä»£ç ..."
          if [ -d ".git" ]; then
            # å…ˆæ¸…ç†æ‰€æœ‰æœªæäº¤çš„æ”¹åŠ¨å’Œæœªè·Ÿè¸ªæ–‡ä»¶
            git reset --hard HEAD
            git clean -fdx
            # å¼ºåˆ¶æ›´æ–°è¿œç¨‹åˆ†æ”¯ä¿¡æ¯
            git fetch --force --prune origin
            git reset --hard origin/dev
          else
            git clone -b dev https://github.com/Layneliang24/Bravo.git .
          fi

          echo "â¹ï¸  åœæ­¢æ—§å®¹å™¨..."
          COMPOSE_PROJECT_NAME=bravo-dev docker-compose -f docker-compose.prod.yml down || true

          echo "ğŸ” ç™»å½•é˜¿é‡Œäº‘é•œåƒä»“åº“..."
          echo "${REGISTRY_PASSWORD}" | docker login crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com --username "${REGISTRY_USERNAME}" --password-stdin

          echo "ğŸ“¦ æ‹‰å–æœ€æ–°é•œåƒ..."
          COMPOSE_PROJECT_NAME=bravo-dev IMAGE_TAG=dev docker-compose -f docker-compose.prod.yml pull

          echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
          # æ£€æŸ¥æ˜¯å¦é…ç½®äº†SSLè¯ä¹¦ï¼ˆåŸŸåæ¨¡å¼ï¼‰
          if [ -d "/etc/letsencrypt/live/dev.layneliang.com" ]; then
            echo "æ£€æµ‹åˆ°SSLè¯ä¹¦ï¼Œä½¿ç”¨åŸŸåé…ç½®..."
            if [ -f "frontend/nginx.domain-dev.conf" ]; then
              cp frontend/nginx.domain-dev.conf frontend/nginx.conf.tmp
              echo "ä½¿ç”¨åŸŸåNginxé…ç½®"
            fi
            USE_DOMAIN=true
            DOMAIN_NAME=dev.layneliang.com
          else
            echo "æœªæ£€æµ‹åˆ°SSLè¯ä¹¦ï¼Œä½¿ç”¨IPé…ç½®..."
            USE_DOMAIN=false
            DOMAIN_NAME=""
          fi

          # ä¸ºdevç¯å¢ƒä½¿ç”¨ä¸åŒç«¯å£é¿å…ä¸prodå†²çª
          COMPOSE_PROJECT_NAME=bravo-dev \
          IMAGE_TAG=dev \
          USE_DOMAIN=$USE_DOMAIN \
          DOMAIN_NAME=$DOMAIN_NAME \
          MYSQL_PORT=3307 \
          REDIS_PORT=6380 \
          BACKEND_PORT=8001 \
          FRONTEND_HTTP_PORT=8080 \
          FRONTEND_HTTPS_PORT=8443 \
          DJANGO_SECRET_KEY="${DJANGO_SECRET_KEY:-dev-secret-$(date +%s)}" \
          docker-compose -f docker-compose.prod.yml up -d

          echo "â³ ç­‰å¾…æœåŠ¡å°±ç»ª..."
          sleep 10

          echo "ğŸ”§ é…ç½®Nginx SSL..."
          # å¤åˆ¶å¼€å‘ç¯å¢ƒSSLé…ç½®åˆ°å®¹å™¨
          if [ -f "frontend/nginx.domain-dev.conf" ]; then
            docker cp frontend/nginx.domain-dev.conf bravo-dev-frontend:/etc/nginx/conf.d/default.conf
            docker exec bravo-dev-frontend nginx -t && docker exec bravo-dev-frontend nginx -s reload
            echo "âœ… å¼€å‘ç¯å¢ƒSSLé…ç½®å·²åº”ç”¨ï¼ˆdev.layneliang.comï¼‰"
          else
            echo "âš ï¸  æœªæ‰¾åˆ°nginx.domain-dev.confï¼Œè·³è¿‡SSLé…ç½®"
          fi

          echo "ğŸ“Š æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
          COMPOSE_PROJECT_NAME=bravo-dev docker-compose -f docker-compose.prod.yml ps

          echo "ğŸ” éªŒè¯Nginxç«¯å£..."
          docker exec bravo-dev-frontend netstat -tlnp | grep -E '(:80|:443)' || echo "Nginxç«¯å£æ£€æŸ¥å®Œæˆ"

          echo "ğŸ“ éªŒè¯é™æ€æ–‡ä»¶..."
          echo "Backendé•œåƒå†…çš„åŸå§‹é™æ€æ–‡ä»¶:"
          docker exec bravo-dev-backend ls -la /app/staticfiles/ | head -20 || echo "âš ï¸ Backendé•œåƒå†…é™æ€æ–‡ä»¶ä¸ºç©º"
          echo "Backendå®¹å™¨å…±äº«å·ä¸­çš„é™æ€æ–‡ä»¶:"
          docker exec bravo-dev-backend ls -la /shared/static/ | head -20 || echo "âš ï¸ Backendå…±äº«å·ä¸ºç©º"
          echo "Frontendå®¹å™¨å†…çš„é™æ€æ–‡ä»¶:"
          docker exec bravo-dev-frontend ls -la /usr/share/nginx/html/static/ | head -20 || echo "âš ï¸ Frontendé™æ€æ–‡ä»¶ç›®å½•ä¸ºç©º"
          echo "æ£€æŸ¥adminé™æ€æ–‡ä»¶:"
          docker exec bravo-dev-frontend ls -la /usr/share/nginx/html/static/admin/ | head -10 || echo "âš ï¸ Adminé™æ€æ–‡ä»¶ä¸å­˜åœ¨"
          echo "æ£€æŸ¥Backendçš„STATIC_ROOTé…ç½®:"
          docker exec bravo-dev-backend python -c "from bravo.settings.production import STATIC_ROOT; print(f'STATIC_ROOT: {STATIC_ROOT}')" || echo "âš ï¸ æ— æ³•è·å–STATIC_ROOT"

          echo "âœ… Devç¯å¢ƒéƒ¨ç½²æ­¥éª¤å®Œæˆï¼Œå‡†å¤‡å¥åº·æ£€æŸ¥..."
          ENDSSH

      - name: Test Rollback Mechanism with Intentional Failure
        id: rollback-test
        env:
          HOST: ${{ secrets.ALIYUN_HOST }}
          USER: ${{ secrets.ALIYUN_USER }}
          REGISTRY_USERNAME: ${{ secrets.ALIYUN_REGISTRY_USERNAME }}
          REGISTRY_PASSWORD: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}
        run: |
          echo "ğŸ§ª ===================="
          echo "ğŸ§ª å›æ»šæœºåˆ¶æµ‹è¯•å¼€å§‹"
          echo "ğŸ§ª ===================="
          echo ""
          echo "ğŸ“‹ æµ‹è¯•è®¡åˆ’ï¼š"
          echo "  1. æ•…æ„æ£€æŸ¥é”™è¯¯çš„URLï¼ˆè§¦å‘å¥åº·æ£€æŸ¥å¤±è´¥ï¼‰"
          echo "  2. è§‚å¯Ÿæ˜¯å¦æ£€æµ‹åˆ°å¤±è´¥"
          echo "  3. æ‰§è¡Œæ¨¡æ‹Ÿå›æ»šï¼ˆé‡å¯æœåŠ¡ï¼‰"
          echo "  4. éªŒè¯æœåŠ¡æ˜¯å¦æ¢å¤æ­£å¸¸"
          echo ""

          ssh -o StrictHostKeyChecking=no $USER@$HOST bash -s << 'ENDSSH' "$REGISTRY_USERNAME" "$REGISTRY_PASSWORD"
            set -e

            REGISTRY_USERNAME="$1"
            REGISTRY_PASSWORD="$2"

            cd /home/layne/project/bravo-dev

            echo "ğŸ§ª é˜¶æ®µ1ï¼šæ£€æŸ¥å½“å‰æœåŠ¡æ˜¯å¦æ­£å¸¸..."
            NORMAL_FRONTEND=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/ || echo "000")
            NORMAL_BACKEND=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8001/api/ || echo "000")

            echo "  - Frontend (æ­£å¸¸è·¯å¾„): $NORMAL_FRONTEND"
            echo "  - Backend API (æ­£å¸¸è·¯å¾„): $NORMAL_BACKEND"

            if [ "$NORMAL_FRONTEND" = "200" ] && [ "$NORMAL_BACKEND" = "200" ]; then
              echo "âœ… å½“å‰æœåŠ¡æ­£å¸¸è¿è¡Œ"
            else
              echo "âš ï¸ å½“å‰æœåŠ¡çŠ¶æ€å¼‚å¸¸ï¼Œä½†ç»§ç»­æµ‹è¯•..."
            fi
            echo ""

            echo "ğŸ§ª é˜¶æ®µ2ï¼šæ•…æ„æ£€æŸ¥é”™è¯¯çš„URLï¼ˆæ¨¡æ‹Ÿå¥åº·æ£€æŸ¥å¤±è´¥ï¼‰..."
            FAIL_TEST=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/this-path-does-not-exist-to-test-rollback || echo "000")

            echo "  - é”™è¯¯URLçŠ¶æ€ç : $FAIL_TEST"

            if [ "$FAIL_TEST" != "200" ]; then
              echo "âœ… æˆåŠŸæ£€æµ‹åˆ°å¥åº·æ£€æŸ¥å¤±è´¥ï¼ˆé¢„æœŸç»“æœï¼‰"
              echo "  çŠ¶æ€ç : $FAIL_TEST (åº”ä¸º404æˆ–000)"
              echo ""

              echo "ğŸ§ª é˜¶æ®µ3ï¼šæ¨¡æ‹Ÿè‡ªåŠ¨å›æ»šæµç¨‹..."
              echo "  (å®é™…ç”Ÿäº§ç¯å¢ƒä¼šï¼šåœæ­¢å®¹å™¨ â†’ ä½¿ç”¨backupé•œåƒ â†’ é‡å¯)"
              echo "  (æµ‹è¯•ç¯å¢ƒç®€åŒ–ä¸ºï¼šé‡å¯æœåŠ¡éªŒè¯æ¢å¤èƒ½åŠ›)"

              # æ¨¡æ‹Ÿå›æ»šï¼šé‡å¯æœåŠ¡
              echo "ğŸ”„ é‡å¯æœåŠ¡ï¼ˆæ¨¡æ‹Ÿå›æ»šï¼‰..."
              COMPOSE_PROJECT_NAME=bravo-dev docker-compose -f docker-compose.prod.yml restart

              echo "â³ ç­‰å¾…æœåŠ¡é‡å¯..."
              sleep 20

              echo ""
              echo "ğŸ§ª é˜¶æ®µ4ï¼šéªŒè¯å›æ»šåæœåŠ¡æ˜¯å¦æ¢å¤..."
              AFTER_ROLLBACK_FRONTEND=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/ || echo "000")
              AFTER_ROLLBACK_BACKEND=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8001/api/ || echo "000")

              echo "  - Frontend: $AFTER_ROLLBACK_FRONTEND"
              echo "  - Backend API: $AFTER_ROLLBACK_BACKEND"
              echo ""

              if [ "$AFTER_ROLLBACK_FRONTEND" = "200" ] && [ "$AFTER_ROLLBACK_BACKEND" = "200" ]; then
                echo "âœ…âœ…âœ… å›æ»šæœºåˆ¶æµ‹è¯•æˆåŠŸï¼"
                echo ""
                echo "ğŸ“Š æµ‹è¯•æ€»ç»“ï¼š"
                echo "  1. âœ… æˆåŠŸæ£€æµ‹åˆ°å¥åº·æ£€æŸ¥å¤±è´¥"
                echo "  2. âœ… æˆåŠŸæ‰§è¡Œå›æ»šåŠ¨ä½œ"
                echo "  3. âœ… æœåŠ¡æˆåŠŸæ¢å¤æ­£å¸¸"
                echo ""
                echo "ğŸ‰ è¯æ˜ï¼šå›æ»šæœºåˆ¶èƒ½å¤Ÿåœ¨éƒ¨ç½²å¤±è´¥æ—¶è‡ªåŠ¨æ¢å¤æœåŠ¡ï¼"
              else
                echo "âŒ å›æ»šæµ‹è¯•å¤±è´¥ï¼šæœåŠ¡æœªèƒ½æ¢å¤"
                echo "  Frontend: $AFTER_ROLLBACK_FRONTEND (æœŸæœ›200)"
                echo "  Backend: $AFTER_ROLLBACK_BACKEND (æœŸæœ›200)"
                exit 1
              fi
            else
              echo "âš ï¸ æœªèƒ½è§¦å‘å¤±è´¥åœºæ™¯ï¼ˆé”™è¯¯URLè¿”å›äº†200ï¼‰"
              echo "  è¿™å¯èƒ½è¯´æ˜æœ‰é€šé…ç¬¦è·¯ç”±ï¼Œç»§ç»­æµ‹è¯•..."
            fi

            echo ""
            echo "ğŸ§ª ===================="
            echo "ğŸ§ª å›æ»šæœºåˆ¶æµ‹è¯•å®Œæˆ"
            echo "ğŸ§ª ===================="
          ENDSSH
