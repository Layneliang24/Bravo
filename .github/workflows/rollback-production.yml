name: ðŸ”„ Rollback Production Deployment

on:
  workflow_dispatch:
    inputs:
      rollback-type:
        description: "å›žæ»šç±»åž‹"
        required: true
        type: choice
        options:
          - "previous" # å›žæ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
          - "stable" # å›žæ»šåˆ°æœ€åŽç¨³å®šç‰ˆæœ¬
          - "specific" # å›žæ»šåˆ°æŒ‡å®šç‰ˆæœ¬
      specific-version:
        description: "æŒ‡å®šç‰ˆæœ¬ï¼ˆä»…å½“é€‰æ‹©specificæ—¶éœ€è¦ï¼Œæ ¼å¼ï¼š2025.01.19-135959-abc123efï¼‰"
        required: false
        type: string
      reason:
        description: "å›žæ»šåŽŸå› ï¼ˆå¿…å¡«ï¼Œç”¨äºŽå®¡è®¡ï¼‰"
        required: true
        type: string

# ç¡®ä¿åªæœ‰ä¸€ä¸ªå›žæ»šåœ¨è¿è¡Œ
concurrency:
  group: production-rollback
  cancel-in-progress: false

jobs:
  confirm-rollback:
    name: ç¡®è®¤å›žæ»šæ“ä½œ
    runs-on: ubuntu-latest
    steps:
      - name: Display Rollback Info
        run: |
          echo "## ðŸ”„ ç”Ÿäº§çŽ¯å¢ƒå›žæ»šç¡®è®¤" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å›žæ»šç±»åž‹**: ${{ inputs.rollback-type }}" >> $GITHUB_STEP_SUMMARY
          echo "**æ“ä½œäºº**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**å›žæ»šåŽŸå› **: ${{ inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "**æ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.rollback-type }}" = "specific" ]; then
            echo "**ç›®æ ‡ç‰ˆæœ¬**: ${{ inputs.specific-version }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **è­¦å‘Š**: è¿™å°†å½±å“ç”Ÿäº§çŽ¯å¢ƒï¼Œè¯·ç¡®è®¤æ“ä½œæ— è¯¯ï¼" >> $GITHUB_STEP_SUMMARY

  rollback:
    name: æ‰§è¡Œå›žæ»š
    needs: confirm-rollback
    runs-on: ubuntu-latest
    environment:
      name: production
      url: http://8.129.16.190

    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ALIYUN_SSH_KEY }}

      - name: Execute Rollback
        env:
          HOST: ${{ secrets.ALIYUN_HOST }}
          USER: ${{ secrets.ALIYUN_USER }}
          REGISTRY_USERNAME: ${{ secrets.ALIYUN_REGISTRY_USERNAME }}
          REGISTRY_PASSWORD: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}
          ROLLBACK_TYPE: ${{ inputs.rollback-type }}
          SPECIFIC_VERSION: ${{ inputs.specific-version }}
          REASON: ${{ inputs.reason }}
        run: |
          ssh -o StrictHostKeyChecking=no $USER@$HOST bash -s << 'ENDSSH' \
            "$REGISTRY_USERNAME" "$REGISTRY_PASSWORD" "$ROLLBACK_TYPE" "$SPECIFIC_VERSION" "$REASON"

            set -e

            REGISTRY_USERNAME="$1"
            REGISTRY_PASSWORD="$2"
            ROLLBACK_TYPE="$3"
            SPECIFIC_VERSION="$4"
            REASON="$5"

            echo "ðŸ”„ å¼€å§‹å›žæ»šæ“ä½œ..."
            echo "  ç±»åž‹: $ROLLBACK_TYPE"
            echo "  åŽŸå› : $REASON"
            cd /home/layne/project/bravo-prod

            # ç™»å½•é•œåƒä»“åº“
            echo "ðŸ” ç™»å½•é˜¿é‡Œäº‘é•œåƒä»“åº“..."
            echo "${REGISTRY_PASSWORD}" | docker login crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com \
              --username "${REGISTRY_USERNAME}" --password-stdin

            # æ ¹æ®å›žæ»šç±»åž‹ç¡®å®šç›®æ ‡ç‰ˆæœ¬
            case "$ROLLBACK_TYPE" in
              "previous")
                echo "ðŸ“‹ å›žæ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬..."
                if [ ! -f .deployment-previous ]; then
                  echo "âŒ æ²¡æœ‰æ‰¾åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ä¿¡æ¯"
                  exit 1
                fi

                # ä½¿ç”¨backupæ ‡ç­¾
                if docker images | grep -q bravo-backend-backup; then
                  TARGET_BACKEND="bravo-backend-backup:latest"
                  TARGET_FRONTEND="bravo-frontend-backup:latest"
                  echo "âœ… ä½¿ç”¨æœ¬åœ°å¤‡ä»½é•œåƒ"
                else
                  echo "âŒ æœ¬åœ°å¤‡ä»½é•œåƒä¸å­˜åœ¨ï¼Œå°è¯•ä½¿ç”¨stableç‰ˆæœ¬"
                  docker pull crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com/bravo-project/backend:prod-stable
                  docker pull crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com/bravo-project/frontend:prod-stable
                  TARGET_BACKEND="crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com/bravo-project/backend:prod-stable"
                  TARGET_FRONTEND="crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com/bravo-project/frontend:prod-stable"
                fi
                ;;

              "stable")
                echo "ðŸ“‹ å›žæ»šåˆ°æœ€åŽç¨³å®šç‰ˆæœ¬..."
                echo "â¬‡ï¸ æ‹‰å–prod-stableé•œåƒ..."
                docker pull crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com/bravo-project/backend:prod-stable
                docker pull crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com/bravo-project/frontend:prod-stable
                TARGET_BACKEND="crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com/bravo-project/backend:prod-stable"
                TARGET_FRONTEND="crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com/bravo-project/frontend:prod-stable"
                ;;

              "specific")
                if [ -z "$SPECIFIC_VERSION" ]; then
                  echo "âŒ æœªæŒ‡å®šç‰ˆæœ¬å·"
                  exit 1
                fi

                echo "ðŸ“‹ å›žæ»šåˆ°æŒ‡å®šç‰ˆæœ¬: $SPECIFIC_VERSION ..."
                echo "â¬‡ï¸ æ‹‰å–æŒ‡å®šç‰ˆæœ¬é•œåƒ..."

                if ! docker pull crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com/bravo-project/backend:${SPECIFIC_VERSION}; then
                  echo "âŒ æŒ‡å®šçš„ç‰ˆæœ¬ä¸å­˜åœ¨: $SPECIFIC_VERSION"
                  echo "å¯ç”¨çš„é•œåƒæ ‡ç­¾ï¼š"
                  echo "è¯·åœ¨GitHub Container Registryæˆ–é˜¿é‡Œäº‘æŽ§åˆ¶å°æŸ¥çœ‹å¯ç”¨ç‰ˆæœ¬"
                  exit 1
                fi

                docker pull crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com/bravo-project/frontend:${SPECIFIC_VERSION}
                TARGET_BACKEND="crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com/bravo-project/backend:${SPECIFIC_VERSION}"
                TARGET_FRONTEND="crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com/bravo-project/frontend:${SPECIFIC_VERSION}"
                ;;

              *)
                echo "âŒ æœªçŸ¥çš„å›žæ»šç±»åž‹: $ROLLBACK_TYPE"
                exit 1
                ;;
            esac

            echo "ðŸŽ¯ ç›®æ ‡é•œåƒ:"
            echo "  Backend:  $TARGET_BACKEND"
            echo "  Frontend: $TARGET_FRONTEND"

            # åœæ­¢å½“å‰å®¹å™¨
            echo "â¹ï¸  åœæ­¢å½“å‰æœåŠ¡..."
            COMPOSE_PROJECT_NAME=bravo-prod docker-compose -f docker-compose.prod.yml down

            # é‡æ–°æ ‡è®°é•œåƒä¸ºlatest
            echo "ðŸ·ï¸  é‡æ–°æ ‡è®°é•œåƒ..."
            docker tag $TARGET_BACKEND crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com/bravo-project/backend:latest
            docker tag $TARGET_FRONTEND crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com/bravo-project/frontend:latest

            # å¯åŠ¨å›žæ»šç‰ˆæœ¬
            echo "ðŸš€ å¯åŠ¨å›žæ»šç‰ˆæœ¬..."
            COMPOSE_PROJECT_NAME=bravo-prod IMAGE_TAG=latest docker-compose -f docker-compose.prod.yml up -d

            sleep 30

            # å¥åº·æ£€æŸ¥
            echo "ðŸ¥ å¥åº·æ£€æŸ¥..."
            HEALTH_OK=true

            # æ£€æŸ¥å®¹å™¨è¿è¡ŒçŠ¶æ€
            if ! docker ps | grep -q bravo-prod-backend; then
              echo "âŒ Backendå®¹å™¨æœªè¿è¡Œ"
              HEALTH_OK=false
            fi

            if ! docker ps | grep -q bravo-prod-frontend; then
              echo "âŒ Frontendå®¹å™¨æœªè¿è¡Œ"
              HEALTH_OK=false
            fi

            # æ£€æŸ¥æœåŠ¡å“åº”
            FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/ || echo "000")
            BACKEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/api/ || echo "000")

            if [ "$FRONTEND_STATUS" = "200" ] && [ "$BACKEND_STATUS" = "200" ]; then
              echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
              echo "  - Frontend: $FRONTEND_STATUS"
              echo "  - Backend: $BACKEND_STATUS"
            else
              echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
              echo "  - Frontend: $FRONTEND_STATUS"
              echo "  - Backend: $BACKEND_STATUS"
              HEALTH_OK=false
            fi

            if [ "$HEALTH_OK" = "true" ]; then
              echo "âœ… å›žæ»šæˆåŠŸï¼æœåŠ¡æ­£å¸¸è¿è¡Œ"

              # è®°å½•å›žæ»šæ—¥å¿—
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] æ‰‹åŠ¨å›žæ»šæˆåŠŸ - ç±»åž‹:${ROLLBACK_TYPE} - åŽŸå› :${REASON} - æ“ä½œäºº:${{ github.actor }}" >> .deployment-history

              # æ›´æ–°å½“å‰ç‰ˆæœ¬ä¿¡æ¯
              {
                echo "DEPLOY_TIME=$(date +%Y-%m-%d_%H:%M:%S)"
                echo "BACKEND_IMAGE=$TARGET_BACKEND"
                echo "FRONTEND_IMAGE=$TARGET_FRONTEND"
                echo "ROLLBACK_TYPE=$ROLLBACK_TYPE"
                echo "ROLLBACK_REASON=$REASON"
                echo "ROLLBACK_BY=${{ github.actor }}"
                echo "ROLLBACK_AT=$(date)"
              } > .deployment-current

            else
              echo "âŒ å›žæ»šåŽå¥åº·æ£€æŸ¥å¤±è´¥"
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] å›žæ»šå¤±è´¥ - å¥åº·æ£€æŸ¥æœªé€šè¿‡ - ç±»åž‹:${ROLLBACK_TYPE}" >> .deployment-history
              exit 1
            fi
          ENDSSH

      - name: Verify Rollback
        env:
          HOST: ${{ secrets.ALIYUN_HOST }}
        run: |
          echo "ðŸ” éªŒè¯å›žæ»šç»“æžœ..."
          sleep 10

          FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://$HOST/ || echo "000")
          BACKEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://$HOST:8000/api/ || echo "000")

          if [ "$FRONTEND_STATUS" = "200" ] && [ "$BACKEND_STATUS" = "200" ]; then
            echo "âœ… è¿œç¨‹éªŒè¯é€šè¿‡"
            echo "  - Frontend: $FRONTEND_STATUS"
            echo "  - Backend: $BACKEND_STATUS"
          else
            echo "âŒ è¿œç¨‹éªŒè¯å¤±è´¥"
            echo "  - Frontend: $FRONTEND_STATUS"
            echo "  - Backend: $BACKEND_STATUS"
            exit 1
          fi

      - name: Rollback Summary
        if: always()
        run: |
          echo "## ðŸŽ¯ å›žæ»šå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**çŠ¶æ€**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**å›žæ»šç±»åž‹**: ${{ inputs.rollback-type }}" >> $GITHUB_STEP_SUMMARY
          echo "**å›žæ»šåŽŸå› **: ${{ inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "**æ“ä½œäºº**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**æ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… ç”Ÿäº§çŽ¯å¢ƒå·²æˆåŠŸå›žæ»š" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### åŽç»­æ“ä½œå»ºè®®ï¼š" >> $GITHUB_STEP_SUMMARY
            echo "1. âœ… ç¡®è®¤æœåŠ¡åŠŸèƒ½æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
            echo "2. ðŸ” åˆ†æžå¯¼è‡´å›žæ»šçš„åŽŸå› " >> $GITHUB_STEP_SUMMARY
            echo "3. ðŸ› ä¿®å¤é—®é¢˜åŽé‡æ–°éƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
            echo "4. ðŸ“Š æ£€æŸ¥éƒ¨ç½²åŽ†å²ï¼šæŸ¥çœ‹ .deployment-history æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ å›žæ»šå¤±è´¥ï¼Œè¯·ç«‹å³æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ç´§æ€¥å¤„ç†æ­¥éª¤ï¼š" >> $GITHUB_STEP_SUMMARY
            echo "1. ðŸš¨ SSHç™»å½•æœåŠ¡å™¨æ£€æŸ¥çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
            echo "2. ðŸ“‹ æŸ¥çœ‹å®¹å™¨æ—¥å¿—ï¼šdocker-compose logs" >> $GITHUB_STEP_SUMMARY
            echo "3. ðŸ’¬ è”ç³»è¿ç»´å›¢é˜Ÿ" >> $GITHUB_STEP_SUMMARY
          fi
