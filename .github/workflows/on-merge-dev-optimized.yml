name: Dev Branch - Optimized Post-Merge Validation

on:
  push:
    branches: [dev]
  workflow_dispatch:
    inputs:
      force-full-validation:
        description: 'Force full validation (including slow E2E)'
        type: boolean
        default: false

concurrency:
  group: dev-merge-optimized-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ç¬¬ä¸€æ­¥ï¼šå¿«é€Ÿæ£€æµ‹åˆå¹¶ç±»å‹
  detect-merge:
    name: Detect Merge Type
    runs-on: ubuntu-latest
    timeout-minutes: 1
    outputs:
      is-merge: ${{ steps.check.outputs.is-merge }}
      validation-type: ${{ steps.check.outputs.validation-type }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 5

      - name: Determine Validation Level
        id: check
        run: |
          if git show --format="%P" -s HEAD | wc -w | grep -q "2"; then
            echo "is-merge=true" >> $GITHUB_OUTPUT
            
            # æ™ºèƒ½é€‰æ‹©éªŒè¯çº§åˆ«
            COMMIT_MSG=$(git log -1 --pretty=%s)
            if [[ "$COMMIT_MSG" =~ (hotfix|critical|urgent) ]] || [[ "${{ github.event.inputs.force-full-validation }}" == "true" ]]; then
              echo "validation-type=full" >> $GITHUB_OUTPUT
              echo "ğŸ”¥ æ£€æµ‹åˆ°å…³é”®ä¿®å¤ï¼Œè¿è¡Œå®Œæ•´éªŒè¯"
            else
              echo "validation-type=fast" >> $GITHUB_OUTPUT  
              echo "âš¡ å¸¸è§„åˆå¹¶ï¼Œè¿è¡Œå¿«é€ŸéªŒè¯"
            fi
          else
            echo "is-merge=false" >> $GITHUB_OUTPUT
            echo "validation-type=skip" >> $GITHUB_OUTPUT
          fi

  # ç¬¬äºŒæ­¥ï¼šå¿«é€ŸéªŒè¯ï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰
  fast-validation:
    name: Fast Validation Pipeline
    needs: detect-merge
    if: needs.detect-merge.outputs.is-merge == 'true'
    uses: ./.github/workflows/fast-validation.yml
    with:
      skip-e2e: ${{ needs.detect-merge.outputs.validation-type == 'fast' }}

  # ç¬¬ä¸‰æ­¥ï¼šå…³é”®é—®é¢˜æ£€æŸ¥ï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰
  critical-checks:
    needs: detect-merge
    if: needs.detect-merge.outputs.is-merge == 'true'
    strategy:
      fail-fast: false
      matrix:
        check: ["conflicts", "dependencies", "security"]
        
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@v4
        
      - name: Run Critical Check
        run: |
          case "${{ matrix.check }}" in
            "conflicts")
              echo "ğŸ” æ£€æŸ¥åˆå¹¶å†²çªæ ‡è®°..."
              # æ£€æŸ¥åˆå¹¶å†²çªæ ‡è®°
              conflict_files=$(find . -name "*.py" -o -name "*.js" -o -name "*.vue" -o -name "*.ts" | head -20 | xargs grep -l "<<<<<<< HEAD\|>>>>>>> \|=======" 2>/dev/null || true)
              if [ -n "$conflict_files" ]; then
                echo "âŒ å‘ç°åˆå¹¶å†²çªæ ‡è®°: $conflict_files" && exit 1
              fi
              # æ£€æŸ¥å¤‡ä»½æ–‡ä»¶
              backup_files=$(find . -maxdepth 3 -name "*.orig" -o -name "*.rej" -o -name "*.bak" 2>/dev/null | head -5 || true)
              if [ -n "$backup_files" ]; then
                echo "âŒ å‘ç°å†²çªå¤‡ä»½æ–‡ä»¶: $backup_files" && exit 1
              fi
              echo "âœ… æ— å†²çªæ ‡è®°å’Œå¤‡ä»½æ–‡ä»¶"
              ;;
            "dependencies")
              echo "ğŸ“¦ å¿«é€Ÿä¾èµ–æ£€æŸ¥..."
              npm audit --audit-level=critical --production || echo "âš ï¸ ä¾èµ–è­¦å‘Š"
              ;;
            "security") 
              echo "ğŸ” åŸºç¡€å®‰å…¨æ‰«æ..."
              # æ£€æŸ¥æ•æ„Ÿæ–‡ä»¶
              if find . -name "*.key" -o -name "*.pem" -o -name ".env" -type f | head -1; then
                echo "âš ï¸ å‘ç°æ•æ„Ÿæ–‡ä»¶ï¼Œè¯·æ£€æŸ¥"
              fi
              ;;
          esac

  # ç¬¬å››æ­¥ï¼šéªŒè¯æ±‡æ€»ï¼ˆä»…åœ¨éœ€è¦æ—¶è¿è¡Œå®Œæ•´éªŒè¯ï¼‰
  validation-summary:
    name: Validation Summary 
    needs: [detect-merge, fast-validation, critical-checks]
    if: always() && needs.detect-merge.outputs.is-merge == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          echo "## âš¡ Optimized Dev Merge Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Validation Type**: ${{ needs.detect-merge.outputs.validation-type }}" >> $GITHUB_STEP_SUMMARY  
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          FAST_STATUS="${{ needs.fast-validation.result }}"
          CRITICAL_STATUS="${{ needs.critical-checks.result }}"
          
          echo "| Component | Status | Time Saved |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Fast Validation | $FAST_STATUS | ~45min â†’ ~12min |" >> $GITHUB_STEP_SUMMARY
          echo "| Critical Checks | $CRITICAL_STATUS | ~10min â†’ ~3min |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "$FAST_STATUS" == "success" && "$CRITICAL_STATUS" == "success" ]]; then
            echo "âœ… **éªŒè¯é€šè¿‡ï¼æ€»è€—æ—¶çº¦15åˆ†é’Ÿ (vs åŸæ¥60+åˆ†é’Ÿ)**" >> $GITHUB_STEP_SUMMARY
            echo "ğŸš€ devåˆ†æ”¯å¯ä»¥ç»§ç»­å¼€å‘" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **éªŒè¯å¤±è´¥ï¼éœ€è¦ä¿®å¤å…³é”®é—®é¢˜**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
