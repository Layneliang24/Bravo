name: Frontend Unit Tests

on:
  workflow_call:
    inputs:
      coverage:
        description: "Generate coverage report"
        type: boolean
        default: false
      timeout:
        description: "Job timeout in minutes"
        type: number
        default: 8

env:
  NODE_VERSION: "20"

jobs:
  frontend-unit-tests:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.timeout }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Cache Node Modules (Phase 4)
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            frontend/node_modules
            ~/.npm
          key: frontend-deps-v4-phase4-${{ runner.os }}-${{ env.NODE_VERSION }}-${{ hashFiles('package-lock.json', 'frontend/package-lock.json') }}
          restore-keys: |
            frontend-deps-v4-phase4-${{ runner.os }}-${{ env.NODE_VERSION }}-
            frontend-deps-v4-${{ runner.os }}-${{ env.NODE_VERSION }}-
            frontend-deps-v3-${{ runner.os }}-

      - name: Install Dependencies (Optimized)
        run: |
          echo "ğŸš€ Phase 4: ä¼˜åŒ–ä¾èµ–install..."
          if [ ! -d "node_modules" ] || [ ! -d "frontend/node_modules" ]; then
            echo "Installing workspace dependencies (cache miss)..."
            npm ci --prefer-offline --no-audit --ignore-scripts
            echo "Installing frontend dependencies..."
            npm --prefix frontend ci --prefer-offline --no-audit --ignore-scripts
          else
            echo "âœ… Using cached dependencies"
          fi

      - name: Run Unit Tests (Phase 4 Optimized)
        working-directory: ./frontend
        run: |
          echo "ğŸš€ Phase 4: è¿è¡Œä¼˜åŒ–çš„å‰ç«¯å•å…ƒtest..."

          # ğŸ¯ Phase 4ä¼˜åŒ–ï¼šæ™ºèƒ½testæ¨¡å¼é€‰æ‹©
          if [ "${{ inputs.coverage }}" == "true" ]; then
            echo "Running tests with coverage (optimized)..."
            # ä½¿ç”¨vitestçš„ä¼˜åŒ–é…ç½®ï¼Œå¯ç”¨å¹¶å‘å’Œç¼“å­˜
            npm run test:ci -- --reporter=verbose --threads --no-watch --run
          else
            echo "Running fast unit tests..."
            # å¿«é€Ÿæ¨¡å¼ï¼šè·³è¿‡è¦†ç›–ç‡ï¼Œæœ€å¤§åŒ–å¹¶å‘
            npm run test:unit:fast -- --reporter=dot --threads --no-watch
          fi

          echo "âœ… å‰ç«¯å•å…ƒtestå®Œæˆ (Phase 4ä¼˜åŒ–)"

      - name: Upload Coverage Report (Phase 4 Optimized)
        if: inputs.coverage && always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-unit-coverage
          path: frontend/coverage/
          retention-days: 3 # ğŸš€ Phase 4: å‡å°‘ä¿ç•™æœŸä»¥åŠ å¿«ä¸Šä¼ 
          compression-level: 9 # æœ€å¤§å‹ç¼©
          if-no-files-found: warn

      - name: Upload Test Results (Phase 4 Optimized)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-unit-results
          path: frontend/test-results/
          retention-days: 1 # ğŸš€ Phase 4: æœ€çŸ­ä¿ç•™æœŸ
          compression-level: 9
          if-no-files-found: ignore # å¿½ç•¥ç¼ºå¤±æ–‡ä»¶ä»¥é¿å…å»¶è¿Ÿ
