name: "Push Validation Pipeline"

on:
  push:
    branches:
      - feature/*
      - hotfix/*
      - bugfix/*
      - release/*
      - dev
      - main
  workflow_dispatch:
    inputs:
      force-full-validation:
        description: "Force full validation regardless of branch"
        type: boolean
        default: false

concurrency:
  group: push-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20"
  PYTHON_VERSION: "3.11"

jobs:
  # æ™ºèƒ½åˆ†æ”¯æ£€æµ‹å’ŒéªŒè¯çº§åˆ«ç¡®å®š
  detect-branch-context:
    name: "Detect Branch & Validation Context"
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      branch-type: ${{ steps.detect.outputs.branch-type }}
      validation-level: ${{ steps.detect.outputs.validation-level }}
      test-level: ${{ steps.detect.outputs.test-level }}
      quality-level: ${{ steps.detect.outputs.quality-level }}
      coverage-required: ${{ steps.detect.outputs.coverage-required }}
      is-merge-commit: ${{ steps.detect.outputs.is-merge-commit }}
      skip-validation: ${{ steps.detect.outputs.skip-validation }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 5

      - name: Analyze Branch and Commit Context
        id: detect
        env:
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          # ä½¿ç”¨ç¯å¢ƒå˜é‡å®‰å…¨å¤„ç†å¤šè¡Œæäº¤æ¶ˆæ¯
          COMMIT_MSG="$COMMIT_MESSAGE"
          FORCE_FULL="${{ github.event.inputs.force-full-validation }}"

          echo "ğŸ” Analyzing push context:"
          echo "  Branch: $BRANCH_NAME"
          echo "  Commit: ${{ github.sha }}"
          echo "  Author: ${{ github.event.head_commit.author.name }}"
          echo "  Message: $(echo "$COMMIT_MSG" | head -c 100)"

          # æ£€æŸ¥æ˜¯å¦æ˜¯åˆå¹¶æäº¤
          IS_MERGE="false"
          if git show --format="%P" -s HEAD | wc -w | grep -q "2"; then
            IS_MERGE="true"
            echo "  Type: Merge commit detected"
          else
            echo "  Type: Regular commit"
          fi
          echo "is-merge-commit=$IS_MERGE" >> $GITHUB_OUTPUT

          # æ ¹æ®åˆ†æ”¯ç±»å‹ç¡®å®šéªŒè¯ç­–ç•¥
          if [[ "$BRANCH_NAME" == "main" ]]; then
            echo "branch-type=main" >> $GITHUB_OUTPUT
            echo "validation-level=production" >> $GITHUB_OUTPUT
            echo "test-level=full" >> $GITHUB_OUTPUT
            echo "quality-level=strict" >> $GITHUB_OUTPUT
            echo "coverage-required=90" >> $GITHUB_OUTPUT
            echo "skip-validation=false" >> $GITHUB_OUTPUT
            echo "ğŸ­ MAIN branch push detected - PRODUCTION validation"

          elif [[ "$BRANCH_NAME" == "dev" ]]; then
            if [[ "$IS_MERGE" == "true" ]]; then
              echo "branch-type=dev-merge" >> $GITHUB_OUTPUT
              echo "validation-level=integration" >> $GITHUB_OUTPUT
              echo "test-level=medium" >> $GITHUB_OUTPUT
              echo "quality-level=standard" >> $GITHUB_OUTPUT
              echo "coverage-required=85" >> $GITHUB_OUTPUT
              echo "skip-validation=false" >> $GITHUB_OUTPUT
              echo "ğŸ”„ DEV branch merge detected - INTEGRATION validation"
            else
              echo "branch-type=dev-direct" >> $GITHUB_OUTPUT
              echo "validation-level=warning" >> $GITHUB_OUTPUT
              echo "test-level=fast" >> $GITHUB_OUTPUT
              echo "quality-level=basic" >> $GITHUB_OUTPUT
              echo "coverage-required=75" >> $GITHUB_OUTPUT
              echo "skip-validation=false" >> $GITHUB_OUTPUT
              echo "âš ï¸ DEV branch direct push detected - WARNING validation"
            fi

          elif [[ "$BRANCH_NAME" =~ ^hotfix/ ]]; then
            echo "branch-type=hotfix" >> $GITHUB_OUTPUT
            echo "validation-level=urgent" >> $GITHUB_OUTPUT
            echo "test-level=medium" >> $GITHUB_OUTPUT
            echo "quality-level=standard" >> $GITHUB_OUTPUT
            echo "coverage-required=80" >> $GITHUB_OUTPUT
            echo "skip-validation=false" >> $GITHUB_OUTPUT
            echo "ğŸš¨ HOTFIX branch push detected - URGENT validation"

          elif [[ "$BRANCH_NAME" =~ ^bugfix/ ]]; then
            echo "branch-type=bugfix" >> $GITHUB_OUTPUT
            echo "validation-level=bugfix" >> $GITHUB_OUTPUT
            echo "test-level=medium" >> $GITHUB_OUTPUT
            echo "quality-level=standard" >> $GITHUB_OUTPUT
            echo "coverage-required=75" >> $GITHUB_OUTPUT
            echo "skip-validation=false" >> $GITHUB_OUTPUT
            echo "ğŸ› BUGFIX branch push detected - STANDARD validation"

          elif [[ "$BRANCH_NAME" =~ ^release/ ]]; then
            echo "branch-type=release" >> $GITHUB_OUTPUT
            echo "validation-level=release" >> $GITHUB_OUTPUT
            echo "test-level=full" >> $GITHUB_OUTPUT
            echo "quality-level=strict" >> $GITHUB_OUTPUT
            echo "coverage-required=85" >> $GITHUB_OUTPUT
            echo "skip-validation=false" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ RELEASE branch push detected - FULL validation"

          elif [[ "$BRANCH_NAME" =~ ^feature/ ]]; then
            if [[ "$COMMIT_MSG" =~ (WIP|wip|work in progress) ]]; then
              echo "branch-type=feature-wip" >> $GITHUB_OUTPUT
              echo "validation-level=minimal" >> $GITHUB_OUTPUT
              echo "test-level=fast" >> $GITHUB_OUTPUT
              echo "quality-level=basic" >> $GITHUB_OUTPUT
              echo "coverage-required=70" >> $GITHUB_OUTPUT
              echo "skip-validation=false" >> $GITHUB_OUTPUT
              echo "ğŸš§ FEATURE WIP push detected - MINIMAL validation"
            else
              echo "branch-type=feature-ready" >> $GITHUB_OUTPUT
              echo "validation-level=development" >> $GITHUB_OUTPUT
              echo "test-level=full" >> $GITHUB_OUTPUT
              echo "quality-level=strict" >> $GITHUB_OUTPUT
              echo "coverage-required=30" >> $GITHUB_OUTPUT
              echo "skip-validation=false" >> $GITHUB_OUTPUT
              echo "ğŸš€ FEATURE ready push detected - ENHANCED validation (full tests + strict quality)"
            fi
          else
            echo "branch-type=other" >> $GITHUB_OUTPUT
            echo "validation-level=basic" >> $GITHUB_OUTPUT
            echo "test-level=fast" >> $GITHUB_OUTPUT
            echo "quality-level=basic" >> $GITHUB_OUTPUT
            echo "coverage-required=70" >> $GITHUB_OUTPUT
            echo "skip-validation=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ OTHER branch push detected - BASIC validation"
          fi

          # å¼ºåˆ¶å®Œæ•´éªŒè¯é€‰é¡¹
          if [[ "$FORCE_FULL" == "true" ]]; then
            echo "validation-level=forced-full" >> $GITHUB_OUTPUT
            echo "test-level=full" >> $GITHUB_OUTPUT
            echo "quality-level=strict" >> $GITHUB_OUTPUT
            echo "coverage-required=90" >> $GITHUB_OUTPUT
            echo "ğŸ”§ FORCED full validation requested"
          fi

  # åˆ†æ”¯ä¿æŠ¤å’Œå·¥ä½œæµéªŒè¯
  branch-protection-check:
    name: "Branch Protection & Workflow Validation"
    needs: detect-branch-context
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate Branch Rules
        run: |
          echo "ğŸ”’ Validating branch protection and workflow rules..."

          BRANCH_TYPE="${{ needs.detect-branch-context.outputs.branch-type }}"
          IS_MERGE="${{ needs.detect-branch-context.outputs.is-merge-commit }}"

          case "$BRANCH_TYPE" in
            "main")
              echo "ğŸ­ Main branch validation:"
              if [[ "$IS_MERGE" != "true" ]]; then
                echo "âŒ CRITICAL: Direct push to main branch detected!"
                echo "   Only merge commits should appear on main branch"
                echo "   This indicates a bypass of the PR process"
                echo ""
                echo "ğŸ”‘ DOUBLE KEY SYSTEM VIOLATION:"
                echo "   - Key A: Only dev branch should merge to main"
                echo "   - Key B: Only through approved PRs"
                echo ""
                echo "ğŸ“‹ Correct process:"
                echo "   1. Create feature branch"
                echo "   2. PR to dev branch"
                echo "   3. PR from dev to main"
                exit 1
              fi
              echo "âœ… Main branch merge commit validated"
              ;;

            "dev-direct")
              echo "âš ï¸ Dev branch direct push warning:"
              echo "   Direct pushes to dev branch discourage PR workflow"
              echo "   Consider using feature branches for better collaboration"
              echo ""
              echo "ğŸ“‹ Recommended workflow:"
              echo "   1. git checkout -b feature/your-feature"
              echo "   2. Make changes and commit"
              echo "   3. git push origin feature/your-feature"
              echo "   4. Create PR to dev branch"
              echo ""
              echo "ğŸŸ¡ Proceeding with validation but workflow is not optimal"
              ;;

            "dev-merge")
              echo "âœ… Dev branch merge detected - this is the expected workflow"
              ;;

            "feature-"*)
              echo "âœ… Feature branch push - development workflow"
              ;;

            *)
              echo "â„¹ï¸ Other branch type - basic validation"
              ;;
          esac

      - name: Check for Sensitive Changes
        run: |
          echo "ğŸ” Checking for sensitive file changes..."

          # æ£€æŸ¥å…³é”®é…ç½®æ–‡ä»¶
          SENSITIVE_FILES=$(git diff --name-only HEAD~1 2>/dev/null | grep -E '\.(env|key|pem|p12|pfx|jks)$|secrets|passwords' || true)
          if [ -n "$SENSITIVE_FILES" ]; then
            echo "âš ï¸ Sensitive files detected in commit:"
            echo "$SENSITIVE_FILES"
            echo "Please verify these changes are intentional and secure"
          fi

          # æ£€æŸ¥å…³é”®å·¥ä½œæµæ–‡ä»¶å˜æ›´
          WORKFLOW_FILES=$(git diff --name-only HEAD~1 2>/dev/null | grep -E '^\.github/workflows/' || true)
          if [ -n "$WORKFLOW_FILES" ]; then
            echo "ğŸ”§ Workflow files changed:"
            echo "$WORKFLOW_FILES"
            echo "These changes will be extra scrutinized in validation"
          fi

          echo "âœ… Sensitive file check completed"

  # å¿«é€Ÿå¥åº·æ£€æŸ¥ (æ‰€æœ‰åˆ†æ”¯)
  quick-health-check:
    name: "Quick Health Check"
    needs: [detect-branch-context, branch-protection-check]
    if: needs.detect-branch-context.outputs.skip-validation != 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-cached-env

      - name: Basic Health Validation
        run: |
          echo "âš¡ Running quick health check..."
          echo "Branch: ${{ needs.detect-branch-context.outputs.branch-type }}"
          echo "Validation: ${{ needs.detect-branch-context.outputs.validation-level }}"

          # æ£€æŸ¥åŸºæœ¬è¯­æ³•
          echo "Checking basic syntax..."
          npm run lint:frontend -- --quiet || echo "âš ï¸ Frontend syntax issues"

          cd backend && source .venv/bin/activate
          flake8 . --select=E9,F63,F7,F82 --exclude=migrations,__pycache__,.venv || echo "âš ï¸ Backend syntax issues"

          echo "âœ… Quick health check completed"

  # æ¡ä»¶æµ‹è¯•æ‰§è¡Œ (åŸºäºåˆ†æ”¯ç±»å‹)
  conditional-test-execution:
    name: "Conditional Test Execution"
    needs:
      [detect-branch-context, quick-health-check, compliance-check-and-rollback]
    if: needs.detect-branch-context.outputs.skip-validation != 'true'
    uses: ./.github/workflows/test-suite.yml
    with:
      test-level: ${{ needs.detect-branch-context.outputs.test-level }}
      target-branch: ${{ github.ref_name }}
      coverage-required: ${{ needs.detect-branch-context.outputs.coverage-required }}

  # æ¡ä»¶è´¨é‡æ£€æŸ¥ (åŸºäºåˆ†æ”¯ç±»å‹)
  conditional-quality-check:
    name: "Conditional Quality Check"
    needs: [detect-branch-context, quick-health-check]
    if: needs.detect-branch-context.outputs.skip-validation != 'true'
    uses: ./.github/workflows/quality-gates.yml
    with:
      quality-level: ${{ needs.detect-branch-context.outputs.quality-level }}
      min-coverage: ${{ needs.detect-branch-context.outputs.coverage-required }}
      target-branch: ${{ github.ref_name }}

  # V4åˆè§„å¼•æ“éªŒè¯å’Œè‡ªåŠ¨å›æ»š
  compliance-check-and-rollback:
    name: "V4 Compliance Check & Auto Rollback"
    needs: [detect-branch-context, branch-protection-check]
    if: needs.detect-branch-context.outputs.skip-validation != 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 5

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install pyyaml -q

      - name: Run V4 Compliance Check
        id: compliance
        run: |
          echo "ğŸ” Running V4 compliance validation..."

          if [ -f ".compliance/runner.py" ]; then
            # è·å–æ¨é€ä¸­ä¿®æ”¹çš„æ–‡ä»¶
            PREV_SHA=$(git rev-parse HEAD~1 2>/dev/null || echo "")
            if [ -n "$PREV_SHA" ]; then
              CHANGED_FILES=$(git diff --name-only --diff-filter=ACM $PREV_SHA...HEAD || echo "")
            else
              CHANGED_FILES=$(git diff --name-only --diff-filter=ACM HEAD~1...HEAD || echo "")
            fi

            if [ -n "$CHANGED_FILES" ]; then
              echo "ğŸ“‹ Changed files:"
              echo "$CHANGED_FILES" | head -20

              # è¿è¡Œåˆè§„æ£€æŸ¥
              python .compliance/runner.py $(echo "$CHANGED_FILES" | tr '\n' ' ') || {
                echo "compliance_failed=true" >> $GITHUB_OUTPUT
                echo ""
                echo "âŒ V4 Compliance validation failed!"
                exit 1
              }
              echo "compliance_failed=false" >> $GITHUB_OUTPUT
            else
              echo "â„¹ï¸ No changed files to validate"
              echo "compliance_failed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "â„¹ï¸ Compliance engine not installed, skipping validation"
            echo "compliance_failed=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for Unauthorized Deletions
        id: check_deletions
        run: |
          echo "ğŸ” Checking for unauthorized function deletions..."

          # æ£€æŸ¥æ˜¯å¦æœ‰ä»£ç æ–‡ä»¶è¢«åˆ é™¤
          PREV_SHA=$(git rev-parse HEAD~1 2>/dev/null || echo "")
          if [ -n "$PREV_SHA" ]; then
            DELETED_FILES=$(git diff --name-only --diff-filter=D $PREV_SHA...HEAD | grep -E '\.(py|vue|ts|js)$' || echo "")
          else
            DELETED_FILES=$(git diff --name-only --diff-filter=D HEAD~1...HEAD | grep -E '\.(py|vue|ts|js)$' || echo "")
          fi

          if [ -n "$DELETED_FILES" ]; then
            echo "âš ï¸ Code files deleted:"
            echo "$DELETED_FILES"
            echo ""
            echo "ğŸ” Checking if deletions are authorized by PRD..."

            # æ£€æŸ¥æäº¤æ¶ˆæ¯ä¸­æ˜¯å¦æåˆ°åˆ é™¤åŸå› 
            COMMIT_MSG=$(git log -1 --format="%B")
            if echo "$COMMIT_MSG" | grep -qiE "(remove|delete|deprecate|refactor|cleanup)"; then
              echo "âœ… Deletion mentioned in commit message"
              echo "deletion_authorized=true" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ Deletion not clearly explained in commit message"
              echo "deletion_authorized=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âœ… No code files deleted"
            echo "deletion_authorized=true" >> $GITHUB_OUTPUT
          fi

      - name: Check for Severe Violations
        id: check_violations
        run: |
          echo "ğŸ” Checking for severe violations using rollback.py..."

          CURRENT_SHA="${{ github.sha }}"

          # ä½¿ç”¨rollback.pyæ£€æŸ¥ä¸¥é‡è¿è§„
          if [ -f ".compliance/rollback.py" ]; then
            python .compliance/rollback.py "$CURRENT_SHA" || {
              VIOLATION_EXIT_CODE=$?
              if [ $VIOLATION_EXIT_CODE -eq 1 ]; then
                echo "severe_violation=true" >> $GITHUB_OUTPUT
                echo "âŒ Severe violation detected by rollback.py"
              else
                echo "severe_violation=false" >> $GITHUB_OUTPUT
                echo "âœ… No severe violations detected"
              fi
            }
          else
            echo "âš ï¸ rollback.py not found, using basic checks"
            echo "severe_violation=false" >> $GITHUB_OUTPUT
          fi

          # æ£€æŸ¥åˆè§„æ£€æŸ¥ç»“æœ
          if [ "${{ steps.compliance.outputs.compliance_failed }}" == "true" ]; then
            echo "severe_violation=true" >> $GITHUB_OUTPUT
            echo "âŒ Compliance check failed"
          fi

          # æ£€æŸ¥åˆ é™¤æˆæƒ
          if [ "${{ steps.check_deletions.outputs.deletion_authorized }}" == "false" ]; then
            echo "severe_violation=true" >> $GITHUB_OUTPUT
            echo "âŒ Unauthorized deletion detected"
          fi

      - name: Auto Rollback on Violation
        if: steps.compliance.outputs.compliance_failed == 'true' || steps.check_deletions.outputs.deletion_authorized == 'false' || steps.check_violations.outputs.severe_violation == 'true'
        run: |
          echo "ğŸš¨ V4 Compliance violation detected!"
          echo ""
          echo "ğŸ“‹ Violation details:"
          echo "  - Compliance check: ${{ steps.compliance.outputs.compliance_failed }}"
          echo "  - Deletion authorized: ${{ steps.check_deletions.outputs.deletion_authorized }}"
          echo "  - Severe violation: ${{ steps.check_violations.outputs.severe_violation }}"
          echo ""

          CURRENT_SHA="${{ github.sha }}"
          BRANCH_NAME="${{ github.ref_name }}"

          # å¯¹äºmainå’Œdevåˆ†æ”¯çš„åˆå¹¶æäº¤ï¼Œæ‰§è¡Œæ›´ä¸¥æ ¼çš„æ£€æŸ¥
          if [[ "$BRANCH_NAME" == "main" || "$BRANCH_NAME" == "dev" ]]; then
            echo "ğŸš¨ CRITICAL: Violation on protected branch ($BRANCH_NAME)"
            echo ""
            echo "ğŸ“‹ V4æ¶æ„è¦æ±‚ï¼š"
            echo "  - æ‰€æœ‰ä»£ç å¿…é¡»å…³è”PRD"
            echo "  - æ‰€æœ‰ä»£ç å¿…é¡»æœ‰æµ‹è¯•æ–‡ä»¶"
            echo "  - æ‰€æœ‰ä»£ç å¿…é¡»æœ‰Task-Masterä»»åŠ¡"
            echo "  - åˆ é™¤åŠŸèƒ½å¿…é¡»è·å¾—PRDæˆæƒ"
            echo ""
            echo "ğŸ”„ è‡ªåŠ¨å›æ»šæœºåˆ¶ï¼š"

            # å°è¯•ä½¿ç”¨rollback.pyæ‰§è¡Œå›æ»š
            if [ -f ".compliance/rollback.py" ]; then
              echo "  ä½¿ç”¨rollback.pyæ‰§è¡Œå›æ»š..."
              python .compliance/rollback.py "$CURRENT_SHA" && {
                echo "âœ… è‡ªåŠ¨å›æ»šæˆåŠŸ"
                echo ""
                echo "ğŸ“‹ å›æ»šåçš„æ“ä½œï¼š"
                echo "  1. ä¿®å¤åˆè§„é—®é¢˜"
                echo "  2. æ›´æ–°PRDï¼ˆå¦‚éœ€è¦ï¼‰"
                echo "  3. é‡æ–°æäº¤"
              } || {
                echo "âš ï¸ è‡ªåŠ¨å›æ»šå¤±è´¥ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†"
                echo ""
                echo "ğŸ“‹ æ‰‹åŠ¨å›æ»šæ­¥éª¤ï¼š"
                echo "  git revert $CURRENT_SHA"
                echo "  git push origin $BRANCH_NAME"
              }
            else
              echo "âš ï¸ rollback.py not found, providing manual instructions"
              echo ""
              echo "ğŸ“‹ æ‰‹åŠ¨å›æ»šæ­¥éª¤ï¼š"
              echo "  git revert $CURRENT_SHA"
              echo "  git push origin $BRANCH_NAME"
            fi

            # è®°å½•åˆ°å®¡è®¡æ—¥å¿—
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] V4åˆè§„è¿è§„ - åˆ†æ”¯:$BRANCH_NAME - æäº¤:$CURRENT_SHA - æ“ä½œäºº:${{ github.actor }}" >> .compliance/audit.log || true

            exit 1
          else
            # å¯¹äºfeatureåˆ†æ”¯ï¼Œåªè­¦å‘Š
            echo "âš ï¸ Compliance violation on feature branch"
            echo "   This will block PR merge"
            echo ""
            echo "ğŸ“‹ ä¿®å¤å»ºè®®ï¼š"
            echo "  1. æ£€æŸ¥PRDå…ƒæ•°æ®æ˜¯å¦å®Œæ•´"
            echo "  2. ç¡®ä¿æœ‰å¯¹åº”çš„æµ‹è¯•æ–‡ä»¶"
            echo "  3. ç¡®ä¿æœ‰Task-Masterä»»åŠ¡"
            echo "  4. å¦‚æœåˆ é™¤åŠŸèƒ½ï¼Œæ›´æ–°PRDçš„deletableå­—æ®µ"
            exit 1
          fi

  # åˆ†æ”¯ç‰¹å®šçš„é¢å¤–æ£€æŸ¥
  branch-specific-checks:
    name: "Branch-Specific Additional Checks"
    needs:
      [
        detect-branch-context,
        conditional-test-execution,
        compliance-check-and-rollback,
      ]
    if: needs.detect-branch-context.outputs.branch-type == 'main'
    runs-on: ubuntu-latest
    timeout-minutes: 8

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Production Readiness Check
        run: |
          echo "ğŸ­ Running production readiness checks..."

          # æ£€æŸ¥ç‰ˆæœ¬æ ‡ç­¾
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "none")
          echo "Latest tag: $LATEST_TAG"

          # æ£€æŸ¥ç”Ÿäº§é…ç½®
          if [ ! -f "backend/bravo/settings/production.py" ]; then
            echo "âŒ Production settings file missing"
            exit 1
          fi

          # æ£€æŸ¥æ•°æ®åº“è¿ç§»
          echo "Checking for pending migrations..."
          cd backend && source .venv/bin/activate
          python manage.py makemigrations --check --settings=bravo.settings.test || {
            echo "âŒ Pending migrations detected"
            exit 1
          }

          echo "âœ… Production readiness checks passed"

      - name: Generate Release Notes
        run: |
          echo "ğŸ“ Generating release notes..."

          # è·å–ä¸Šæ¬¡å‘å¸ƒä»¥æ¥çš„æäº¤
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "HEAD~10")
          COMMITS=$(git log --oneline --no-merges $LAST_TAG..HEAD)

          echo "## Release Notes (Auto-generated)" > release-notes.md
          echo "**Date**: $(date)" >> release-notes.md
          echo "**Commit**: ${{ github.sha }}" >> release-notes.md
          echo "" >> release-notes.md
          echo "### Changes since $LAST_TAG:" >> release-notes.md
          echo "$COMMITS" | while read line; do
            echo "- $line" >> release-notes.md
          done

          cat release-notes.md

      - name: Upload Release Notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: release-notes.md
          retention-days: 30

  # æ¨é€éªŒè¯æ±‡æ€»
  push-validation-summary:
    name: "Push Validation Summary"
    needs:
      [
        detect-branch-context,
        conditional-test-execution,
        conditional-quality-check,
        branch-specific-checks,
      ]
    if: always() && needs.detect-branch-context.outputs.skip-validation != 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Generate Push Summary
        run: |
          echo "## ğŸš€ Push Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Push Information:**" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }} (${{ needs.detect-branch-context.outputs.branch-type }})" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- Author: ${{ github.event.head_commit.author.name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Message: $(echo '${{ github.event.head_commit.message }}' | tr -d '()' | head -c 100)" >> $GITHUB_STEP_SUMMARY
          echo "- Merge Commit: ${{ needs.detect-branch-context.outputs.is-merge-commit }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "**Validation Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "- Level: ${{ needs.detect-branch-context.outputs.validation-level }}" >> $GITHUB_STEP_SUMMARY
          echo "- Test Level: ${{ needs.detect-branch-context.outputs.test-level }}" >> $GITHUB_STEP_SUMMARY
          echo "- Quality Level: ${{ needs.detect-branch-context.outputs.quality-level }}" >> $GITHUB_STEP_SUMMARY
          echo "- Coverage Required: ${{ needs.detect-branch-context.outputs.coverage-required }}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æ”¶é›†éªŒè¯ç»“æœ
          TEST_RESULT="${{ needs.conditional-test-execution.result }}"
          TEST_OUTPUT="${{ needs.conditional-test-execution.outputs.test-results }}"
          QUALITY_RESULT="${{ needs.conditional-quality-check.result }}"
          QUALITY_SCORE="${{ needs.conditional-quality-check.outputs.quality-score }}"
          BRANCH_CHECKS_RESULT="${{ needs.branch-specific-checks.result }}"

          echo "**Validation Results:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | $TEST_RESULT | ${{ needs.detect-branch-context.outputs.test-level }} level |" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Gates | $QUALITY_RESULT | Score: $QUALITY_SCORE/100 |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch-Specific | $BRANCH_CHECKS_RESULT | Extra checks |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # åˆ¤æ–­æ€»ä½“ç»“æœ
          OVERALL_SUCCESS=true

          if [[ "$TEST_RESULT" != "success" || "$TEST_OUTPUT" != "success" ]]; then
            OVERALL_SUCCESS=false
          fi

          if [[ "$QUALITY_RESULT" != "success" ]]; then
            OVERALL_SUCCESS=false
          fi

          if [[ "${{ needs.detect-branch-context.outputs.branch-type }}" == "main" && "$BRANCH_CHECKS_RESULT" != "success" ]]; then
            OVERALL_SUCCESS=false
          fi

          if [[ "$OVERALL_SUCCESS" == "true" ]]; then
            echo "## âœ… Push Validation PASSED!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            case "${{ needs.detect-branch-context.outputs.branch-type }}" in
              "main")
                echo "ğŸ­ **PRODUCTION**: All production readiness checks passed" >> $GITHUB_STEP_SUMMARY
                echo "ğŸš€ Ready for deployment to production environment" >> $GITHUB_STEP_SUMMARY
                ;;
              "dev-merge")
                echo "ğŸ”„ **INTEGRATION**: All integration tests passed" >> $GITHUB_STEP_SUMMARY
                echo "âœ… Dev branch is stable and ready for production promotion" >> $GITHUB_STEP_SUMMARY
                ;;
              "dev-direct")
                echo "âš ï¸ **WARNING**: Direct dev push completed but not recommended" >> $GITHUB_STEP_SUMMARY
                echo "ğŸ“‹ Consider using feature branches for better collaboration" >> $GITHUB_STEP_SUMMARY
                ;;
              "feature-ready")
                echo "ğŸš€ **FEATURE**: Ready for integration via PR to dev" >> $GITHUB_STEP_SUMMARY
                echo "ğŸ“ Create PR to dev branch when ready" >> $GITHUB_STEP_SUMMARY
                ;;
              "feature-wip")
                echo "ğŸš§ **WIP**: Work in progress validation passed" >> $GITHUB_STEP_SUMMARY
                echo "âš¡ Minimal checks for development efficiency" >> $GITHUB_STEP_SUMMARY
                ;;
            esac
          else
            echo "## âŒ Push Validation FAILED!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸš« Some validations failed. Please review and fix the issues." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [[ "${{ needs.detect-branch-context.outputs.branch-type }}" == "main" ]]; then
              echo "ğŸš¨ **CRITICAL**: Production validation failed!" >> $GITHUB_STEP_SUMMARY
              echo "âš ï¸ **DO NOT DEPLOY** until issues are resolved" >> $GITHUB_STEP_SUMMARY
            fi

            exit 1
          fi

  # é€šçŸ¥å’Œåç»­å¤„ç†
  post-validation-actions:
    name: "Post-Validation Actions"
    needs: [detect-branch-context, push-validation-summary]
    if: always() && needs.detect-branch-context.outputs.branch-type == 'main'
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Deployment Readiness
        if: needs.push-validation-summary.result == 'success'
        run: |
          echo "ğŸ¯ Main branch validation passed - triggering deployment readiness"
          echo "This could trigger:"
          echo "  - Docker image build"
          echo "  - Staging deployment"
          echo "  - Release tag creation"
          echo "  - Notification to operations team"

      - name: Alert on Production Issues
        if: needs.push-validation-summary.result == 'failure'
        run: |
          echo "ğŸš¨ PRODUCTION VALIDATION FAILED!"
          echo "Immediate actions required:"
          echo "  - Investigate validation failures"
          echo "  - Consider emergency rollback if needed"
          echo "  - Alert operations team"
          echo "  - Block production deployment"
