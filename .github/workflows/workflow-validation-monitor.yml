name: Workflow Validation Monitor

# ç›‘æ§å·¥ä½œæµæ–‡ä»¶å˜æ›´å¹¶è‡ªåŠ¨éªŒè¯
on:
  pull_request:
    paths:
      - ".github/workflows/**"
  push:
    branches:
      - main
      - dev
    paths:
      - ".github/workflows/**"

jobs:
  detect-workflow-changes:
    name: "Detect Workflow Changes"
    runs-on: ubuntu-latest
    outputs:
      changed-workflows: ${{ steps.detect.outputs.workflows }}
      has-changes: ${{ steps.detect.outputs.has_changes }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect Changed Workflows
        id: detect
        run: |
          echo "ğŸ” æ£€æµ‹å·¥ä½œæµæ–‡ä»¶å˜æ›´..."

          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
          fi

          CHANGED_WORKFLOWS=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep "^.github/workflows/.*\.yml$" || true)

          if [ -n "$CHANGED_WORKFLOWS" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "workflows<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_WORKFLOWS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            echo "ğŸ“‹ æ£€æµ‹åˆ°ä»¥ä¸‹å·¥ä½œæµå˜æ›´:"
            echo "$CHANGED_WORKFLOWS" | while read -r file; do
              echo "  - $file"
            done
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "workflows=" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  æœªæ£€æµ‹åˆ°å·¥ä½œæµæ–‡ä»¶å˜æ›´"
          fi

  validate-syntax:
    name: "Validate Workflow Syntax"
    needs: detect-workflow-changes
    if: needs.detect-workflow-changes.outputs.has-changes == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup act
        run: |
          echo "ğŸ“¦ å®‰è£…act..."
          curl -s https://raw.githubusercontent.com/nektos/act/master/install.sh | sudo bash
          act --version

      - name: Validate with act
        run: |
          echo "ğŸ§ª ä½¿ç”¨actéªŒè¯å·¥ä½œæµè¯­æ³•..."
          echo ""

          FAILED=0
          echo "${{ needs.detect-workflow-changes.outputs.changed-workflows }}" | while read -r workflow; do
            if [ -n "$workflow" ]; then
              echo "éªŒè¯: $workflow"
              echo "---"

              # åˆ—å‡ºjobs
              if act -l -W "$workflow" > /tmp/act-list.txt 2>&1; then
                JOB_COUNT=$(grep -c "^[0-9]" /tmp/act-list.txt || echo "0")
                echo "âœ“ å‘ç° $JOB_COUNT ä¸ªjobs"
              else
                echo "âœ— æ— æ³•åˆ—å‡ºjobs"
                FAILED=1
              fi

              echo ""
            fi
          done

          if [ $FAILED -eq 0 ]; then
            echo "âœ… æ‰€æœ‰å·¥ä½œæµè¯­æ³•éªŒè¯é€šè¿‡"
          else
            echo "âŒ å·¥ä½œæµè¯­æ³•éªŒè¯å¤±è´¥"
            exit 1
          fi

  validate-structure:
    name: "Validate Workflow Structure"
    needs: detect-workflow-changes
    if: needs.detect-workflow-changes.outputs.has-changes == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Validate Structure
        run: |
          echo "ğŸ” éªŒè¯å·¥ä½œæµç»“æ„..."
          echo ""

          FAILED=0
          echo "${{ needs.detect-workflow-changes.outputs.changed-workflows }}" | while read -r workflow; do
            if [ -n "$workflow" ]; then
              echo "éªŒè¯: $workflow"
              echo "---"

              # æ£€æŸ¥å¿…è¦å­—æ®µ
              ERRORS=0

              if ! grep -q "^name:" "$workflow"; then
                echo "âœ— ç¼ºå°‘ 'name' å­—æ®µ"
                ERRORS=1
              fi

              if ! grep -q "^on:" "$workflow" && ! grep -q "^\"on\":" "$workflow"; then
                echo "âœ— ç¼ºå°‘ 'on' è§¦å‘å™¨"
                ERRORS=1
              fi

              if ! grep -q "^jobs:" "$workflow"; then
                echo "âœ— ç¼ºå°‘ 'jobs' å®šä¹‰"
                ERRORS=1
              fi

              if [ $ERRORS -eq 0 ]; then
                echo "âœ“ ç»“æ„å®Œæ•´"
              else
                FAILED=1
              fi

              echo ""
            fi
          done

          if [ $FAILED -eq 0 ]; then
            echo "âœ… æ‰€æœ‰å·¥ä½œæµç»“æ„éªŒè¯é€šè¿‡"
          else
            echo "âŒ å·¥ä½œæµç»“æ„éªŒè¯å¤±è´¥"
            exit 1
          fi

  compare-with-documentation:
    name: "Compare with Documentation"
    needs: [detect-workflow-changes, validate-syntax, validate-structure]
    if: needs.detect-workflow-changes.outputs.has-changes == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check Documentation Update
        run: |
          echo "ğŸ“š æ£€æŸ¥æ–‡æ¡£æ˜¯å¦éœ€è¦æ›´æ–°..."

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡æ¡£æ›´æ–°
          CHANGED_DOCS=$(git diff --name-only HEAD~1 | grep "docs/workflow/" || true)

          if [ -z "$CHANGED_DOCS" ]; then
            echo "âš ï¸  è­¦å‘Š: å·¥ä½œæµå·²ä¿®æ”¹ï¼Œä½†æœªå‘ç°æ–‡æ¡£æ›´æ–°"
            echo ""
            echo "ğŸ’¡ å»ºè®®:"
            echo "  â€¢ æ£€æŸ¥ docs/workflow/ ä¸‹çš„æ–‡æ¡£æ˜¯å¦éœ€è¦æ›´æ–°"
            echo "  â€¢ æ›´æ–°åœºæ™¯éªŒè¯æ–‡æ¡£ä¸­çš„æ£€æŸ¥é¡¹åˆ—è¡¨"
            echo "  â€¢ è¿è¡Œå®é™…éªŒè¯ç¡®è®¤æ–‡æ¡£å‡†ç¡®æ€§"
            echo ""
            echo "æ­¤æ£€æŸ¥ä»…ä¸ºæé†’ï¼Œä¸ä¼šé˜»æ­¢åˆå¹¶"
          else
            echo "âœ“ æ£€æµ‹åˆ°æ–‡æ¡£æ›´æ–°: $CHANGED_DOCS"
          fi

  validation-summary:
    name: "Validation Summary"
    needs: [validate-syntax, validate-structure, compare-with-documentation]
    if: always() && needs.detect-workflow-changes.outputs.has-changes == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Generate Summary
        run: |
          echo "# å·¥ä½œæµéªŒè¯æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## éªŒè¯ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.validate-syntax.result }}" == "success" ]; then
            echo "âœ… è¯­æ³•éªŒè¯: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ è¯­æ³•éªŒè¯: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.validate-structure.result }}" == "success" ]; then
            echo "âœ… ç»“æ„éªŒè¯: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ ç»“æ„éªŒè¯: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## å˜æ›´çš„å·¥ä½œæµ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.detect-workflow-changes.outputs.changed-workflows }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

          # æ£€æŸ¥æ˜¯å¦æœ‰å¤±è´¥
          if [ "${{ needs.validate-syntax.result }}" != "success" ] || [ "${{ needs.validate-structure.result }}" != "success" ]; then
            echo "âŒ å·¥ä½œæµéªŒè¯å¤±è´¥"
            exit 1
          else
            echo "âœ… æ‰€æœ‰éªŒè¯é€šè¿‡"
          fi

  # æé†’éœ€è¦å®Œæ•´éªŒè¯
  remind-full-validation:
    name: "Remind Full Validation"
    needs: validation-summary
    if: success()
    runs-on: ubuntu-latest

    steps:
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## âœ… å·¥ä½œæµéªŒè¯é€šè¿‡\n\n' +
                    '**è‡ªåŠ¨éªŒè¯å®Œæˆ:**\n' +
                    '- âœ… è¯­æ³•éªŒè¯ï¼ˆactï¼‰\n' +
                    '- âœ… ç»“æ„éªŒè¯\n\n' +
                    '**ğŸ’¡ å»ºè®®:**\n' +
                    '- åˆå¹¶åï¼Œç›‘æ§å®é™…è¿è¡Œç»“æœç¡®è®¤å‡†ç¡®æ€§\n' +
                    '- æ£€æŸ¥è§¦å‘çš„jobsæ•°é‡å’Œæ£€æŸ¥é¡¹æ˜¯å¦ç¬¦åˆé¢„æœŸ\n' +
                    '- æ›´æ–°æ–‡æ¡£è®°å½•ä»»ä½•å˜æ›´\n\n' +
                    '**ğŸ“Š æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š:**\n' +
                    'æŸ¥çœ‹ Actions æ ‡ç­¾é¡µçš„ Summary éƒ¨åˆ†'
            })
