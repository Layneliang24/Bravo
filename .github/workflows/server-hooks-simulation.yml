name: Server-Side Hooks Simulation

# ğŸ¯ GitHub Actions æ¨¡æ‹ŸæœåŠ¡å™¨ç«¯ Pre-Receive é’©å­
# ç”¨é€”ï¼šGitHub.com ä¸æ”¯æŒè‡ªå®šä¹‰ pre-receiveï¼Œä½¿ç”¨ Actions æ¨¡æ‹Ÿ
# è§¦å‘ï¼šæ‰€æœ‰æ¨é€åˆ°åˆ†æ”¯ï¼ˆfeatureã€devã€mainï¼‰

on:
  push:
    branches: ["**"]
  pull_request:
    branches: [dev, main]

concurrency:
  group: server-hooks-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # æ¨¡æ‹Ÿ Pre-Receive æ£€æŸ¥
  pre-receive-simulation:
    name: Pre-Receive Checks Simulation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ç”¨äºæ£€æŸ¥

      - name: Setup Environment
        run: |
          echo "ğŸ›¡ï¸ Server-Side Hooks Simulation"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Event: ${{ github.event_name }}"

      # æ£€æŸ¥1ï¼šåˆ†æ”¯ä¿æŠ¤
      - name: Check 1 - Branch Protection
        if: github.event_name == 'push'
        run: |
          BRANCH="${{ github.ref_name }}"

          if [[ "$BRANCH" == "main" || "$BRANCH" == "dev" ]]; then
            echo "âŒ æ£€æµ‹åˆ°ç›´æ¥æ¨é€åˆ°å—ä¿æŠ¤åˆ†æ”¯: $BRANCH"
            echo "âš ï¸ è¿™è¿åäº†åˆ†æ”¯ä¿æŠ¤ç­–ç•¥"
            echo "ğŸ’¡ æ­£ç¡®æµç¨‹ï¼š"
            echo "  1. åˆ›å»º feature åˆ†æ”¯"
            echo "  2. æäº¤å˜æ›´"
            echo "  3. åˆ›å»º Pull Request åˆ° $BRANCH"
            echo ""
            echo "âš ï¸ æ³¨æ„ï¼šGitHub Actions åªèƒ½è­¦å‘Šï¼Œæ— æ³•é˜»æ­¢æ¨é€"
            echo "âš ï¸ è¯·é…ç½® Branch Protection Rules æ¥å¼ºåˆ¶æ‰§è¡Œ"
            exit 1
          fi

          echo "âœ… åˆ†æ”¯ä¿æŠ¤æ£€æŸ¥é€šè¿‡"

      # æ£€æŸ¥2ï¼šç¦æ­¢çš„æ–‡ä»¶
      - name: Check 2 - Forbidden Files
        run: |
          echo "ğŸ” æ£€æŸ¥ç¦æ­¢çš„æ–‡ä»¶æ¨¡å¼..."

          FORBIDDEN_PATTERNS=(
            "\.env$"
            "\.env\.local$"
            "\.env\.production$"
            "\.(key|pem|p12|pfx|jks)$"
            "id_rsa"
            "id_dsa"
          )

          FORBIDDEN_FOUND=false

          for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
            FILES=$(git diff --name-only HEAD~1..HEAD 2>/dev/null | grep -E "$pattern" || true)
            if [ -n "$FILES" ]; then
              echo "âŒ æ£€æµ‹åˆ°ç¦æ­¢çš„æ–‡ä»¶æ¨¡å¼: $pattern"
              echo "$FILES"
              FORBIDDEN_FOUND=true
            fi
          done

          if [ "$FORBIDDEN_FOUND" = true ]; then
            echo ""
            echo "ğŸ’¡ è¯·ç§»é™¤æ•æ„Ÿæ–‡ä»¶åé‡æ–°æäº¤"
            exit 1
          fi

          echo "âœ… ç¦æ­¢çš„æ–‡ä»¶æ£€æŸ¥é€šè¿‡"

      # æ£€æŸ¥3ï¼šå¤§æ–‡ä»¶
      - name: Check 3 - Large Files
        run: |
          echo "ğŸ” æ£€æŸ¥å¤§æ–‡ä»¶ï¼ˆ>10MBï¼‰..."

          MAX_SIZE=$((10 * 1024 * 1024))
          LARGE_FILES=$(git diff-tree -r --no-commit-id --name-only HEAD 2>/dev/null | \
            while read file; do
              if [ -f "$file" ]; then
                SIZE=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null || echo 0)
                if [ "$SIZE" -gt "$MAX_SIZE" ]; then
                  echo "$file ($(($SIZE / 1024 / 1024))MB)"
                fi
              fi
            done)

          if [ -n "$LARGE_FILES" ]; then
            echo "âŒ æ£€æµ‹åˆ°å¤§æ–‡ä»¶ï¼š"
            echo "$LARGE_FILES"
            echo ""
            echo "ğŸ’¡ è¯·ä½¿ç”¨ Git LFS ç®¡ç†å¤§æ–‡ä»¶"
            exit 1
          fi

          echo "âœ… å¤§æ–‡ä»¶æ£€æŸ¥é€šè¿‡"

      # æ£€æŸ¥4ï¼šåˆå¹¶å†²çªæ ‡è®°
      - name: Check 4 - Merge Conflict Markers
        run: |
          echo "ğŸ” æ£€æŸ¥åˆå¹¶å†²çªæ ‡è®°..."

          # æ’é™¤æµ‹è¯•æ–‡ä»¶ã€æ–‡æ¡£å’Œå·¥ä½œæµä¸­çš„ç¤ºä¾‹ä»£ç 
          CONFLICTS=$(git diff HEAD~1..HEAD | \
            grep -v 'server-hooks/test-pre-receive.sh' | \
            grep -v 'server-hooks/pre-receive' | \
            grep -v 'ENHANCEMENTS.md' | \
            grep -v 'TEST_RESULTS.md' | \
            grep -v '.github/workflows/server-hooks-simulation.yml' | \
            grep -E '^[+].*<<<<<<<|^[+].*>>>>>>>' || true)

          if [ -n "$CONFLICTS" ]; then
            echo "âŒ æ£€æµ‹åˆ°æœªè§£å†³çš„åˆå¹¶å†²çªæ ‡è®°"
            echo "$CONFLICTS"
            exit 1
          fi

          echo "âœ… åˆå¹¶å†²çªæ ‡è®°æ£€æŸ¥é€šè¿‡"

      # æ£€æŸ¥5ï¼šæ ¹ç›®å½•å®ˆå«
      - name: Check 5 - Root Directory Guard
        run: |
          echo "ğŸ” æ£€æŸ¥æ ¹ç›®å½•æ–‡ä»¶..."

          ROOT_FILES=$(git diff --name-only --diff-filter=AM HEAD~1..HEAD 2>/dev/null | grep -E '^[^/]+\.' || true)

          if [ -z "$ROOT_FILES" ]; then
            echo "âœ… æ ¹ç›®å½•å®ˆå«æ£€æŸ¥é€šè¿‡"
            exit 0
          fi

          ALLOWED_PATTERNS=(
            "^\."
            "^package\.json$"
            "^package-lock\.json$"
            "^docker-compose.*\.yml$"
            "^Dockerfile.*"
            "^Makefile$"
            "^(setup|install|configure|build|deploy|test|safe-push|passport)\.(sh|py|js)$"
            "^(README|LICENSE|CHANGELOG|CODE_OF_CONDUCT|CONTRIBUTING|SECURITY)\.md$"
            "^(requirements|Pipfile|Gemfile).*"
          )

          FORBIDDEN=""
          while read -r file; do
            [ -z "$file" ] && continue

            ALLOWED=false
            for pattern in "${ALLOWED_PATTERNS[@]}"; do
              if echo "$file" | grep -qE "$pattern"; then
                ALLOWED=true
                break
              fi
            done

            if [ "$ALLOWED" = false ]; then
              FORBIDDEN="$FORBIDDEN\n  - $file"
            fi
          done <<< "$ROOT_FILES"

          if [ -n "$FORBIDDEN" ]; then
            echo "âŒ æ£€æµ‹åˆ°æ ¹ç›®å½•ä¸å…è®¸çš„æ–‡ä»¶ï¼š"
            echo -e "$FORBIDDEN"
            echo ""
            echo "ğŸ’¡ è¯·å°†æ–‡ä»¶ç§»åŠ¨åˆ°åˆé€‚çš„ç›®å½•"
            exit 1
          fi

          echo "âœ… æ ¹ç›®å½•å®ˆå«æ£€æŸ¥é€šè¿‡"

      # æ£€æŸ¥6ï¼šNPM Workspaces ä¿æŠ¤
      - name: Check 6 - NPM Workspaces Protection
        run: |
          echo "ğŸ” æ£€æŸ¥ NPM Workspaces æ¶æ„..."

          VIOLATIONS=""

          # æ£€æŸ¥å­ç›®å½• package-lock.json
          SUB_LOCKS=$(git diff --name-only HEAD~1..HEAD 2>/dev/null | \
            grep -E '^(frontend|backend)/[^/]+/package-lock\.json$' || true)

          if [ -n "$SUB_LOCKS" ]; then
            VIOLATIONS="${VIOLATIONS}âŒ æ£€æµ‹åˆ°å­ç›®å½•çš„ package-lock.json å˜æ›´\n"
            VIOLATIONS="${VIOLATIONS}   è¿™ä¼šç ´å npm workspaces ä¾èµ–ç»“æ„\n"
            echo "$SUB_LOCKS"
          fi

          # æ£€æŸ¥å·¥ä½œæµæ–‡ä»¶
          WORKFLOW_FILES=$(git diff --name-only HEAD~1..HEAD 2>/dev/null | \
            grep -E '\.github/workflows/.*\.yml$' || true)

          if [ -n "$WORKFLOW_FILES" ]; then
            while read -r workflow; do
              [ -z "$workflow" ] && continue
              if grep -qE 'cd\s+(frontend|backend)/[^/]+.*npm\s+(ci|install)' "$workflow" 2>/dev/null; then
                VIOLATIONS="${VIOLATIONS}âŒ å·¥ä½œæµæ–‡ä»¶åŒ…å«å­ç›®å½• npm ci/install: $workflow\n"
              fi
            done <<< "$WORKFLOW_FILES"
          fi

          if [ -n "$VIOLATIONS" ]; then
            echo -e "$VIOLATIONS"
            echo ""
            echo "ğŸ’¡ æ­£ç¡®åšæ³•ï¼š"
            echo "  1. åªåœ¨æ ¹ç›®å½•è¿è¡Œ 'npm ci'"
            echo "  2. å­ç›®å½•åªè¿è¡Œ 'npm run build/test'"
            exit 1
          fi

          echo "âœ… NPM Workspaces æ¶æ„ä¿æŠ¤é€šè¿‡"

      # æ£€æŸ¥7ï¼šScripts-Golden ä¿æŠ¤
      - name: Check 7 - Scripts-Golden Protection
        run: |
          echo "ğŸ” æ£€æŸ¥ Scripts-Golden ç›®å½•..."

          GOLDEN_CHANGES=$(git diff --name-only HEAD~1..HEAD 2>/dev/null | \
            grep '^scripts-golden/' || true)

          if [ -n "$GOLDEN_CHANGES" ]; then
            echo "âš ï¸ æ£€æµ‹åˆ° scripts-golden ç›®å½•çš„ä¿®æ”¹ï¼š"
            echo "$GOLDEN_CHANGES"
            echo ""
            echo "âš ï¸ scripts-golden ç›®å½•åŒ…å«æ ¸å¿ƒå®‰å…¨è„šæœ¬"
            echo "ğŸ’¡ ä¿®æ”¹è¿™äº›è„šæœ¬éœ€è¦ï¼š"
            echo "  1. å®‰å…¨å®¡æŸ¥"
            echo "  2. å›¢é˜Ÿæ‰¹å‡†"
            echo "  3. è¯¦ç»†çš„å˜æ›´è¯´æ˜"
            echo ""
            echo "âš ï¸ è¿™æ˜¯è­¦å‘Šï¼Œä½†å¼ºçƒˆå»ºè®®å®¡æŸ¥è¿™äº›å˜æ›´"
          else
            echo "âœ… Scripts-Golden ä¿æŠ¤æ£€æŸ¥é€šè¿‡"
          fi

      # æ€»ç»“
      - name: Summary
        if: success()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âœ… æ‰€æœ‰æœåŠ¡å™¨ç«¯æ£€æŸ¥æ¨¡æ‹Ÿé€šè¿‡ï¼                          â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š å·²æ‰§è¡Œçš„æ£€æŸ¥ï¼š"
          echo "  âœ… åˆ†æ”¯ä¿æŠ¤æ£€æŸ¥"
          echo "  âœ… ç¦æ­¢çš„æ–‡ä»¶æ£€æŸ¥"
          echo "  âœ… å¤§æ–‡ä»¶æ£€æŸ¥"
          echo "  âœ… åˆå¹¶å†²çªæ ‡è®°æ£€æŸ¥"
          echo "  âœ… æ ¹ç›®å½•å®ˆå«æ£€æŸ¥"
          echo "  âœ… NPM Workspaces ä¿æŠ¤"
          echo "  âœ… Scripts-Golden ä¿æŠ¤"
          echo ""
          echo "âš ï¸ æ³¨æ„ï¼šGitHub Actions åªèƒ½åœ¨æ¨é€åæ£€æŸ¥"
          echo "âš ï¸ æ— æ³•åƒæœåŠ¡å™¨ç«¯é’©å­ä¸€æ ·é˜»æ­¢æ¨é€"
          echo "ğŸ’¡ è¯·é…ç½® Branch Protection Rules ä»¥å¼ºåˆ¶æ‰§è¡Œè§„åˆ™"

      - name: Failed Summary
        if: failure()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âŒ æœåŠ¡å™¨ç«¯æ£€æŸ¥æ¨¡æ‹Ÿå¤±è´¥ï¼                              â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ’¡ è¯·æ ¹æ®ä¸Šè¿°é”™è¯¯ä¿¡æ¯ä¿®å¤é—®é¢˜"
          echo "ğŸ’¡ ä¿®å¤åé‡æ–°æ¨é€æˆ–æ›´æ–° Pull Request"
