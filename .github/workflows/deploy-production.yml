name: Deploy to Production

on:
  push:
    branches: [main]
    paths-ignore:
      - "docs/**"
      - "*.md"
  workflow_dispatch:
    inputs:
      force_deploy:
        description: "å¼ºåˆ¶éƒ¨ç½²"
        required: false
        default: "false"

# ç¡®ä¿åªæœ‰ä¸€ä¸ªéƒ¨ç½²åœ¨è¿è¡Œ
concurrency:
  group: production-deploy
  cancel-in-progress: false

jobs:
  # éƒ¨ç½²å‰æ£€æŸ¥
  pre-deploy:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if should deploy
        id: check
        run: |
          if [[ "${{ github.event.inputs.force_deploy }}" == "true" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "ðŸš€ å¼ºåˆ¶éƒ¨ç½²è§¦å‘"
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            # æ£€æŸ¥æ˜¯å¦æœ‰å®žè´¨æ€§å˜æ›´
            if git diff --quiet HEAD~1 HEAD -- '*.py' '*.js' '*.vue' '*.ts' '*.tsx' 'docker-compose.prod-optimized.yml' 'Dockerfile*'; then
              echo "should-deploy=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ æ²¡æœ‰å®žè´¨æ€§ä»£ç å˜æ›´ï¼Œè·³è¿‡éƒ¨ç½²"
            else
              echo "should-deploy=true" >> $GITHUB_OUTPUT
              echo "âœ… æ£€æµ‹åˆ°ä»£ç å˜æ›´ï¼Œå‡†å¤‡éƒ¨ç½²"
            fi
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi

  # ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    needs: pre-deploy
    if: needs.pre-deploy.outputs.should-deploy == 'true'
    environment:
      name: production
      url: http://8.129.16.190

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ALIYUN_SSH_KEY }}

      - name: Deploy to production server
        env:
          HOST: ${{ secrets.ALIYUN_HOST }}
          USER: ${{ secrets.ALIYUN_USER }}
        run: |
          ssh -o StrictHostKeyChecking=no \
              -o ServerAliveInterval=30 \
              -o ServerAliveCountMax=30 \
              $USER@$HOST << 'ENDSSH'
            set -e

            echo "ðŸ“ è¿›å…¥é¡¹ç›®ç›®å½•..."
            cd /home/layne/project/bravo-prod

            echo "ðŸ”„ æ‹‰å–æœ€æ–°ä»£ç ..."
            git pull origin main || git clone -b main https://github.com/Layneliang24/Bravo.git .

            echo "â¹ï¸  åœæ­¢æ—§å®¹å™¨..."
            docker-compose -f docker-compose.prod-optimized.yml down || true

            echo "ðŸ“¦ æ‹‰å–é•œåƒ..."
            docker-compose -f docker-compose.prod-optimized.yml pull || echo "é•œåƒæ‹‰å–å®Œæˆæˆ–éƒ¨åˆ†å¤±è´¥ï¼Œç»§ç»­..."

            echo "ðŸš€ å¯åŠ¨æœåŠ¡ï¼ˆä½¿ç”¨prodç«¯å£é…ç½®ï¼‰..."
            # ä½¿ç”¨.env.prodä¸­çš„ç«¯å£é…ç½®
            if [ -f .env.prod ]; then
              set -a && source .env.prod && set +a
            fi
            COMPOSE_PROJECT_NAME=bravo-prod \
            FRONTEND_HTTP_PORT=8080 \
            FRONTEND_HTTPS_PORT=8443 \
            BACKEND_PORT=8001 \
            MYSQL_PORT=3307 \
            REDIS_PORT=6380 \
            docker-compose -f docker-compose.prod-optimized.yml up -d

            echo "â³ ç­‰å¾…æœåŠ¡å°±ç»ª..."
            sleep 10

            echo "ðŸ“Š æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
            docker-compose -f docker-compose.prod-optimized.yml ps

            echo "âœ… ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²å®Œæˆ"
          ENDSSH

      - name: Health check
        env:
          HOST: ${{ secrets.ALIYUN_HOST }}
        run: |
          sleep 20
          curl -f http://$HOST:8080/health || echo "âš ï¸ å‰ç«¯å¥åº·æ£€æŸ¥å¤±è´¥"
          curl -f http://$HOST:8001/health/ || echo "âš ï¸ åŽç«¯å¥åº·æ£€æŸ¥å¤±è´¥"

  # éƒ¨ç½²åŽæµ‹è¯•
  post-deploy-tests:
    name: Post-deployment Tests
    runs-on: ubuntu-latest
    needs: deploy
    if: always() && needs.deploy.result == 'success'

    steps:
      - name: API Health Check
        env:
          HOST: ${{ secrets.ALIYUN_HOST }}
        run: |
          curl -f http://$HOST:8001/api/ || exit 1
          curl -f http://$HOST:8080/admin/ || exit 1

      - name: Frontend Check
        env:
          HOST: ${{ secrets.ALIYUN_HOST }}
        run: |
          curl -f http://$HOST:8080/ || exit 1

      - name: Create deployment summary
        env:
          HOST: ${{ secrets.ALIYUN_HOST }}
        run: |
          echo "## ðŸš€ ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**éƒ¨ç½²æ—¶é—´:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**éƒ¨ç½²åˆ†æ”¯:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**æäº¤SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**éƒ¨ç½²çŠ¶æ€:** âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ æœåŠ¡åœ°å€" >> $GITHUB_STEP_SUMMARY
          echo "- **å‰ç«¯:** http://$HOST:8080" >> $GITHUB_STEP_SUMMARY
          echo "- **åŽç«¯API:** http://$HOST:8001/api" >> $GITHUB_STEP_SUMMARY
          echo "- **ç®¡ç†åŽå°:** http://$HOST:8080/admin" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… å¥åº·æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "- å‰ç«¯æœåŠ¡: æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
          echo "- åŽç«¯æœåŠ¡: æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
          echo "- æ•°æ®åº“: æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
