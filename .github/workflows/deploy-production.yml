name: Deploy to Production

on:
  push:
    branches: [main]
    paths-ignore:
      - "docs/**"
      - "*.md"
  workflow_dispatch:
    inputs:
      force_deploy:
        description: "å¼ºåˆ¶éƒ¨ç½²"
        required: false
        default: "false"

# ç¡®ä¿åªæœ‰ä¸€ä¸ªéƒ¨ç½²åœ¨è¿è¡Œ
concurrency:
  group: production-deploy
  cancel-in-progress: false

jobs:
  # éƒ¨ç½²å‰æ£€æŸ¥
  pre-deploy:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if should deploy
        id: check
        run: |
          if [[ "${{ github.event.inputs.force_deploy }}" == "true" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "ðŸš€ å¼ºåˆ¶éƒ¨ç½²è§¦å‘"
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            # æ£€æŸ¥æ˜¯å¦æœ‰å®žè´¨æ€§å˜æ›´
            if git diff --quiet HEAD~1 HEAD -- '*.py' '*.js' '*.vue' '*.ts' '*.tsx' 'docker-compose.production.yml' 'Dockerfile*'; then
              echo "should-deploy=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ æ²¡æœ‰å®žè´¨æ€§ä»£ç å˜æ›´ï¼Œè·³è¿‡éƒ¨ç½²"
            else
              echo "should-deploy=true" >> $GITHUB_OUTPUT
              echo "âœ… æ£€æµ‹åˆ°ä»£ç å˜æ›´ï¼Œå‡†å¤‡éƒ¨ç½²"
            fi
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi

  # ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    needs: pre-deploy
    if: needs.pre-deploy.outputs.should-deploy == 'true'
    environment:
      name: production
      url: http://8.129.16.190

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Test server connection
        run: |
          ssh -o ConnectTimeout=10 ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} "echo 'Connection successful'"

      - name: Deploy to server
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SSH_USER: ${{ secrets.SSH_USER }}
          PROJECT_PATH: ${{ secrets.PROJECT_PATH }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_ROOT_PASSWORD: ${{ secrets.DB_ROOT_PASSWORD }}
          DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
        run: |
          # åˆ›å»ºçŽ¯å¢ƒæ–‡ä»¶
          cat > .env.production << EOF
          DB_NAME=bravo_production
          DB_USER=bravo
          DB_PASSWORD=${DB_PASSWORD}
          DB_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
          DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY}
          DEBUG=False
          REDIS_HOST=redis
          REDIS_PORT=6379
          ALLOWED_HOSTS=${SERVER_IP},localhost,127.0.0.1
          CSRF_TRUSTED_ORIGINS=https://${SERVER_IP}
          EOF

          # åŒæ­¥ä»£ç åˆ°æœåŠ¡å™¨
          rsync -avz --delete --exclude='.git' --exclude='node_modules' --exclude='__pycache__' \
            -e "ssh -o StrictHostKeyChecking=no" \
            . ${SSH_USER}@${SERVER_IP}:${PROJECT_PATH}/

          # åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œéƒ¨ç½²
          ssh ${SSH_USER}@${SERVER_IP} << 'EOF'
            cd ${{ secrets.PROJECT_PATH }}

            # å¤‡ä»½å½“å‰ç‰ˆæœ¬
            if [ -d "backup" ]; then
              rm -rf backup.old
              mv backup backup.old
            fi
            mkdir -p backup

            # å¦‚æžœæœåŠ¡æ­£åœ¨è¿è¡Œï¼Œå¤‡ä»½æ•°æ®åº“
            if docker-compose -f docker-compose.production.yml ps | grep -q "Up"; then
              echo "ðŸ—„ï¸ å¤‡ä»½æ•°æ®åº“..."
              docker-compose -f docker-compose.production.yml exec -T mysql mysqldump -u root -p${DB_ROOT_PASSWORD} bravo_production > backup/database.sql
              docker-compose -f docker-compose.production.yml down
            fi

            # æ¸…ç†æ—§èµ„æº
            docker system prune -f

            # æž„å»ºæ–°é•œåƒ
            echo "ðŸ”¨ æž„å»ºç”Ÿäº§é•œåƒ..."
            docker-compose -f docker-compose.production.yml build --no-cache

            # å¯åŠ¨æœåŠ¡
            echo "ðŸš€ å¯åŠ¨æœåŠ¡..."
            docker-compose -f docker-compose.production.yml up -d

            # ç­‰å¾…æ•°æ®åº“å¯åŠ¨
            echo "â³ ç­‰å¾…æ•°æ®åº“å¯åŠ¨..."
            sleep 45

            # æ‰§è¡Œæ•°æ®åº“è¿ç§»
            echo "ðŸ—„ï¸ æ‰§è¡Œæ•°æ®åº“è¿ç§»..."
            docker-compose -f docker-compose.production.yml exec -T backend python manage.py migrate

            # æ”¶é›†é™æ€æ–‡ä»¶
            echo "ðŸ“¦ æ”¶é›†é™æ€æ–‡ä»¶..."
            docker-compose -f docker-compose.production.yml exec -T backend python manage.py collectstatic --noinput

            # é‡å¯æœåŠ¡ç¡®ä¿é…ç½®ç”Ÿæ•ˆ
            echo "ðŸ”„ é‡å¯æœåŠ¡..."
            docker-compose -f docker-compose.production.yml restart

            echo "âœ… éƒ¨ç½²å®Œæˆ"
          EOF

      - name: Health check
        run: |
          # ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
          sleep 60

          # æ£€æŸ¥æœåŠ¡çŠ¶æ€
          MAX_ATTEMPTS=10
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if curl -f http://${{ secrets.SERVER_IP }}/health > /dev/null 2>&1; then
              echo "âœ… å‰ç«¯æœåŠ¡æ­£å¸¸"
              break
            fi
            ATTEMPT=$((ATTEMPT + 1))
            echo "â³ ç­‰å¾…å‰ç«¯æœåŠ¡å¯åŠ¨... ($ATTEMPT/$MAX_ATTEMPTS)"
            sleep 30
          done

          ATTEMPT=0
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if curl -f http://${{ secrets.SERVER_IP }}:8000/health/ > /dev/null 2>&1; then
              echo "âœ… åŽç«¯æœåŠ¡æ­£å¸¸"
              break
            fi
            ATTEMPT=$((ATTEMPT + 1))
            echo "â³ ç­‰å¾…åŽç«¯æœåŠ¡å¯åŠ¨... ($ATTEMPT/$MAX_ATTEMPTS)"
            sleep 30
          done

      - name: Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "ðŸŽ‰ ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²æˆåŠŸï¼"
            echo ""
            echo "ðŸ“ è®¿é—®åœ°å€:"
            echo "  å‰ç«¯: http://${{ secrets.SERVER_IP }}"
            echo "  åŽç«¯API: http://${{ secrets.SERVER_IP }}:8000/api"
            echo "  ç®¡ç†åŽå°: http://${{ secrets.SERVER_IP }}:8000/admin"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          fi

  # éƒ¨ç½²åŽæµ‹è¯•
  post-deploy-tests:
    name: Post-deployment Tests
    runs-on: ubuntu-latest
    needs: deploy
    if: always() && needs.deploy.result == 'success'

    steps:
      - name: API Health Check
        run: |
          # æµ‹è¯•APIç«¯ç‚¹
          curl -f http://${{ secrets.SERVER_IP }}:8000/health/ || exit 1
          curl -f http://${{ secrets.SERVER_IP }}:8000/api/ || exit 1

      - name: Frontend Check
        run: |
          # æµ‹è¯•å‰ç«¯
          curl -f http://${{ secrets.SERVER_IP }}/health || exit 1
          curl -f http://${{ secrets.SERVER_IP }}/ || exit 1

      - name: Create deployment summary
        run: |
          echo "## ðŸš€ ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**éƒ¨ç½²æ—¶é—´:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**éƒ¨ç½²åˆ†æ”¯:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**æäº¤SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**éƒ¨ç½²çŠ¶æ€:** âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ æœåŠ¡åœ°å€" >> $GITHUB_STEP_SUMMARY
          echo "- **å‰ç«¯:** http://${{ secrets.SERVER_IP }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åŽç«¯API:** http://${{ secrets.SERVER_IP }}:8000/api" >> $GITHUB_STEP_SUMMARY
          echo "- **ç®¡ç†åŽå°:** http://${{ secrets.SERVER_IP }}:8000/admin" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… å¥åº·æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "- å‰ç«¯æœåŠ¡: æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
          echo "- åŽç«¯æœåŠ¡: æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
          echo "- æ•°æ®åº“: æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
