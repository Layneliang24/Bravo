
name: ğŸš€ Gate - Comprehensive Test Suite (Optimized)

# ä¼˜åŒ–è§¦å‘æ¡ä»¶ï¼Œé¿å…ä¸branch-protectioné‡å¤
'on':
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_call:
    secrets:
      CODECOV_TOKEN:
        required: false

# å¹¶å‘æ§åˆ¶ï¼Œé¿å…é‡å¤è¿è¡Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # å…¨å±€ç¯å¢ƒå˜é‡
  NODE_VERSION: "20.x"
  PYTHON_VERSION: "3.11"
  MYSQL_DATABASE: bravo_test
  MYSQL_USER: bravo_user
  MYSQL_PASSWORD: bravo_password
  MYSQL_ROOT_PASSWORD: root_password

jobs:
  # ==========================================
  # Job 1: æ™ºèƒ½ä¾èµ–ç®¡ç† (Smart Dependencies)
  # ==========================================
  smart-dependencies:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    
    outputs:
      frontend-cache-hit: ${{ steps.frontend-cache.outputs.cache-hit }}
      backend-cache-hit: ${{ steps.backend-cache.outputs.cache-hit }}
      e2e-cache-hit: ${{ steps.e2e-cache.outputs.cache-hit }}
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: bravo_test
          MYSQL_USER: bravo_user
          MYSQL_PASSWORD: bravo_password
          MYSQL_ROOT_PASSWORD: root_password
        options: --health-cmd="mysqladmin ping -h 127.0.0.1 -P 3306 -u root -proot_password" --health-interval=10s --health-timeout=5s --health-retries=10
        ports:
          - 3306:3306
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Configure China Mirrors
        uses: ./.github/actions/configure-china-mirrors

      # æ™ºèƒ½å‰ç«¯ä¾èµ–ç¼“å­˜
      - name: Cache Frontend Dependencies
        id: frontend-cache
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.npm
          key: frontend-deps-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            frontend-deps-${{ runner.os }}-

      - name: Install Frontend Dependencies (if cache miss)
        if: steps.frontend-cache.outputs.cache-hit != 'true'
        run: |
          echo "ğŸ“¦ å®‰è£…ä¾èµ– (ç¼“å­˜æœªå‘½ä¸­)..."
          npm ci --prefer-offline --no-audit
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      # æ™ºèƒ½E2Eä¾èµ–ç¼“å­˜
      - name: Cache E2E Dependencies
        id: e2e-cache
        uses: actions/cache@v3
        with:
          path: |
            e2e/node_modules
            ~/.npm
          key: e2e-deps-${{ runner.os }}-${{ hashFiles('e2e/package-lock.json') }}
          restore-keys: |
            e2e-deps-${{ runner.os }}-

      - name: Install E2E Dependencies (if cache miss)
        if: steps.e2e-cache.outputs.cache-hit != 'true'
        working-directory: ./e2e
        run: |
          echo "ğŸ§ª å®‰è£…E2Eæµ‹è¯•ä¾èµ– (ç¼“å­˜æœªå‘½ä¸­)..."
          npm install --prefer-offline --no-audit
          echo "âœ… E2Eä¾èµ–å®‰è£…å®Œæˆ"

      # æ™ºèƒ½åç«¯ä¾èµ–ç¼“å­˜
      - name: Cache Backend Dependencies
        id: backend-cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            backend/.venv
          key: backend-deps-${{ runner.os }}-${{ hashFiles('backend/requirements/base.txt', 'backend/requirements/test.txt') }}
          restore-keys: |
            backend-deps-${{ runner.os }}-

      - name: Install Backend Dependencies (if cache miss)
        if: steps.backend-cache.outputs.cache-hit != 'true'
        working-directory: ./backend
        run: |
          echo "ğŸ å®‰è£…åç«¯ä¾èµ– (ç¼“å­˜æœªå‘½ä¸­)..."
          python -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements/base.txt
          pip install -r requirements/test.txt
          echo "âœ… åç«¯ä¾èµ–å®‰è£…å®Œæˆ"

      # MySQLé…ç½®
      - name: Configure MySQL
        run: |
          echo "ğŸ”§ é…ç½®MySQL..."
          mysql -h 127.0.0.1 -P 3306 -u root -proot_password -e "
            CREATE DATABASE IF NOT EXISTS bravo_test;
            CREATE USER IF NOT EXISTS 'bravo_user'@'%' IDENTIFIED BY 'bravo_password';
            GRANT ALL PRIVILEGES ON bravo_test.* TO 'bravo_user'@'%';
            FLUSH PRIVILEGES;
          "
          echo "âœ… MySQLé…ç½®å®Œæˆ"

  # ==========================================
  # Job 2: å‰ç«¯æµ‹è¯• (Frontend Tests)
  # ==========================================
  frontend-tests:
    needs: smart-dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore Frontend Dependencies
        id: frontend-cache-restore
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.npm
          key: frontend-deps-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            frontend-deps-${{ runner.os }}-

      - name: Install Frontend Dependencies (fallback)
        if: steps.frontend-cache-restore.outputs.cache-hit != 'true'
        run: |
          echo "ğŸ“¦ å®‰è£…ä¾èµ– (ç¼“å­˜æœªå‘½ä¸­ï¼Œæ‰§è¡Œfallbackå®‰è£…)..."
          npm ci --prefer-offline --no-audit
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: Run Frontend Tests
        run: |
          echo "ğŸ§ª è¿è¡Œå‰ç«¯æµ‹è¯•..."
          npm run test:coverage --workspace=frontend
          echo "âœ… å‰ç«¯æµ‹è¯•å®Œæˆ"

      - name: Upload Frontend Coverage
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage/
          retention-days: 7

  # ==========================================
  # Job 3: åç«¯æµ‹è¯• (Backend Tests)
  # ==========================================
  backend-tests:
    needs: smart-dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: bravo_test
          MYSQL_USER: bravo_user
          MYSQL_PASSWORD: bravo_password
          MYSQL_ROOT_PASSWORD: root_password
        options: --health-cmd="mysqladmin ping -h 127.0.0.1 -P 3306 -u root -proot_password" --health-interval=10s --health-timeout=5s --health-retries=10
        ports:
          - 3306:3306

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Restore Backend Dependencies
        id: backend-cache-restore
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            backend/.venv
          key: backend-deps-${{ runner.os }}-${{ hashFiles('backend/requirements/base.txt', 'backend/requirements/test.txt') }}
          restore-keys: |
            backend-deps-${{ runner.os }}-

      - name: Install Backend Dependencies (fallback)
        if: steps.backend-cache-restore.outputs.cache-hit != 'true'
        working-directory: ./backend
        run: |
          echo "ğŸ å®‰è£…åç«¯ä¾èµ– (ç¼“å­˜æœªå‘½ä¸­ï¼Œæ‰§è¡Œfallbackå®‰è£…)..."
          python -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements/base.txt
          pip install -r requirements/test.txt
          echo "âœ… åç«¯ä¾èµ–å®‰è£…å®Œæˆ"

      - name: Create Backend Logs Directory
        working-directory: ./backend
        run: |
          echo "ğŸ“ åˆ›å»ºlogsç›®å½•..."
          mkdir -p logs
          chmod 755 logs
          echo "âœ… logsç›®å½•åˆ›å»ºå®Œæˆ"

      - name: Run Backend Tests
        working-directory: ./backend
        run: |
          echo "ğŸ§ª è¿è¡Œåç«¯æµ‹è¯•..."
          source .venv/bin/activate
          python manage.py test --settings=bravo.settings.test --keepdb
          echo "âœ… åç«¯æµ‹è¯•å®Œæˆ"
        env:
          DATABASE_URL: mysql://${{ env.MYSQL_USER }}:${{ env.MYSQL_PASSWORD }}@127.0.0.1:3306/${{ env.MYSQL_DATABASE }}
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_NAME: ${{ env.MYSQL_DATABASE }}
          DB_USER: ${{ env.MYSQL_USER }}
          DB_PASSWORD: ${{ env.MYSQL_PASSWORD }}
          DJANGO_SETTINGS_MODULE: bravo.settings.test

  # ==========================================
  # Job 4: E2Eæµ‹è¯• (E2E Tests) - ä¼˜åŒ–ç‰ˆ
  # ==========================================
  e2e-tests:
    needs: smart-dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: bravo_test
          MYSQL_USER: bravo_user
          MYSQL_PASSWORD: bravo_password
          MYSQL_ROOT_PASSWORD: root_password
        options: --health-cmd="mysqladmin ping -h 127.0.0.1 -P 3306 -u root -proot_password" --health-interval=10s --health-timeout=5s --health-retries=10
        ports:
          - 3306:3306

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Restore All Dependencies
        uses: actions/cache@v3
        with:
          path: |
            frontend/node_modules
            e2e/node_modules
            ~/.cache/pip
            backend/.venv
            ~/.npm
          key: all-deps-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json', 'e2e/package-lock.json', 'backend/requirements/base.txt') }}
          restore-keys: |
            frontend-deps-${{ runner.os }}-
            e2e-deps-${{ runner.os }}-
            backend-deps-${{ runner.os }}-

      - name: Install Playwright Browsers
        working-directory: ./e2e
        run: |
          echo "ğŸ­ å®‰è£…Playwrightæµè§ˆå™¨..."
          npx playwright install --with-deps chromium
          echo "âœ… Playwrightæµè§ˆå™¨å®‰è£…å®Œæˆ"

      - name: Build Frontend
        working-directory: ./frontend
        run: |
          echo "ğŸ—ï¸ æ„å»ºå‰ç«¯..."
          npm run build
          echo "âœ… å‰ç«¯æ„å»ºå®Œæˆ"

      - name: Start Backend Server
        working-directory: ./backend
        run: |
          echo "ğŸš€ å¯åŠ¨åç«¯æœåŠ¡å™¨..."
          source .venv/bin/activate
          python manage.py runserver 8000 &
          echo $! > backend.pid
          echo "âœ… åç«¯æœåŠ¡å™¨å·²å¯åŠ¨"
        env:
          DATABASE_URL: mysql://${{ env.MYSQL_USER }}:${{ env.MYSQL_PASSWORD }}@127.0.0.1:3306/${{ env.MYSQL_DATABASE }}
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_NAME: ${{ env.MYSQL_DATABASE }}
          DB_USER: ${{ env.MYSQL_USER }}
          DB_PASSWORD: ${{ env.MYSQL_PASSWORD }}
          DJANGO_SETTINGS_MODULE: bravo.settings.test

      # ä¸æ‰‹åŠ¨å¯åŠ¨å‰ç«¯æœåŠ¡å™¨ï¼Œè®©Playwrightè‡ªå·±ç®¡ç†
      - name: Run E2E Tests (Playwright manages server)
        working-directory: ./e2e
        run: |
          echo "ğŸ§ª è¿è¡ŒE2Eæµ‹è¯• (Playwrightç®¡ç†æœåŠ¡å™¨)..."
          npx playwright test --project=chromium --workers=1 --max-failures=3
          echo "âœ… E2Eæµ‹è¯•å®Œæˆ"
        env:
          CI: true
          PLAYWRIGHT_JUNIT_OUTPUT_NAME: e2e-results.xml

      - name: Upload E2E Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: |
            e2e/test-results/
            e2e/playwright-report/
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ æ¸…ç†è¿›ç¨‹..."
          [ -f backend/backend.pid ] && kill $(cat backend/backend.pid) 2>/dev/null || true
          echo "âœ… æ¸…ç†å®Œæˆ"
