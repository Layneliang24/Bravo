name: Dev Branch - Post-Merge Validation

on:
  push:
    branches: [dev]
    # åªåœ¨åˆå¹¶æäº¤æ—¶è§¦å‘
  workflow_dispatch:

# å¹¶å‘æ§åˆ¶
concurrency:
  group: dev-merge-${{ github.ref }}
  cancel-in-progress: false # åˆå¹¶åéªŒè¯ä¸åº”è¯¥è¢«å–æ¶ˆ

jobs:
  # Devåˆ†æ”¯éªŒè¯ï¼ˆç§»é™¤å¤æ‚çš„åˆå¹¶æ£€æµ‹ï¼Œç›´æ¥å¯¹æ‰€æœ‰devæ¨é€è¿è¡ŒéªŒè¯ï¼‰

  # åˆå¹¶åçš„å¿«é€ŸçƒŸé›¾æµ‹è¯•
  post-merge-smoke:
    name: Post-Merge Smoke Tests
    if: github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest
    timeout-minutes: 8

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: bravo_test
          MYSQL_USER: bravo_user
          MYSQL_PASSWORD: bravo_password
          MYSQL_ROOT_PASSWORD: root_password
        options: --health-cmd="mysqladmin ping -h 127.0.0.1 -P 3306 -u root -proot_password" --health-interval=10s --health-timeout=5s --health-retries=5
        ports:
          - 3306:3306

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install Dependencies
        run: |
          echo "ğŸ“¦ å¿«é€Ÿå®‰è£…ä¾èµ–..."
          npm ci --workspace=frontend
          cd backend && pip install -r requirements/test.txt

      - name: Quick Frontend Test
        run: |
          echo "ğŸ§ª å¿«é€Ÿå‰ç«¯æµ‹è¯•..."
          npm run test:ci --workspace=frontend

      - name: Quick Backend Test
        working-directory: ./backend
        run: |
          echo "ğŸ§ª å¿«é€Ÿåç«¯æµ‹è¯•..."
          # ç­‰å¾…æ•°æ®åº“å‡†å¤‡å°±ç»ª
          until mysqladmin ping -h 127.0.0.1 -P 3306 -u bravo_user -pbravo_password --silent; do
            echo "ç­‰å¾…MySQLå¯åŠ¨..."
            sleep 2
          done
          # è¿è¡Œè¿ç§»
          python manage.py migrate --noinput --settings=bravo.settings.test
          # è¿è¡Œæµ‹è¯•
          python manage.py test --settings=bravo.settings.test --keepdb --parallel 2 tests.quick
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_NAME: bravo_test
          DB_USER: bravo_user
          DB_PASSWORD: bravo_password

      - name: Integration Smoke Test
        run: |
          echo "ğŸ§ª é›†æˆçƒŸé›¾æµ‹è¯•..."
          # ç­‰å¾…æ•°æ®åº“å®Œå…¨å‡†å¤‡å°±ç»ª
          echo "â³ ç­‰å¾…æ•°æ®åº“è¿æ¥..."
          until mysqladmin ping -h 127.0.0.1 -P 3306 -u bravo_user -pbravo_password --silent; do
            echo "ç­‰å¾…MySQLå¯åŠ¨..."
            sleep 2
          done
          echo "âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ"

          # è¿è¡Œæ•°æ®åº“è¿ç§»
          cd backend
          echo "ğŸ”„ è¿è¡Œæ•°æ®åº“è¿ç§»..."
          python manage.py migrate --noinput

          # å¯åŠ¨æœåŠ¡
          echo "ğŸš€ å¯åŠ¨DjangoæœåŠ¡..."
          python manage.py runserver 8000 &
          SERVER_PID=$!

          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          for i in {1..30}; do
            if curl -s http://localhost:8000/health/ > /dev/null; then
              echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸ"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "âŒ æœåŠ¡å¯åŠ¨è¶…æ—¶"
              kill $SERVER_PID 2>/dev/null || true
              exit 1
            fi
            sleep 1
          done

          # åŸºæœ¬APIæµ‹è¯•
          curl -f http://localhost:8000/health/ || exit 1
          echo "âœ… æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"

          # æ¸…ç†
          kill $SERVER_PID 2>/dev/null || true
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_NAME: bravo_test
          DB_USER: bravo_user
          DB_PASSWORD: bravo_password

  # åˆå¹¶å†²çªæ£€æµ‹
  conflict-detection:
    name: Merge Conflict Detection
    if: github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for Merge Conflicts Markers
        run: |
          echo "ğŸ” æ£€æŸ¥åˆå¹¶å†²çªæ ‡è®°..."

          # æ£€æŸ¥æ˜¯å¦æœ‰åˆå¹¶å†²çªæ ‡è®°æ®‹ç•™
          if grep -r "<<<<<<< HEAD\|>>>>>>> \|=======" --include="*.py" --include="*.js" --include="*.vue" --include="*.ts" .; then
            echo "âŒ å‘ç°åˆå¹¶å†²çªæ ‡è®°æ®‹ç•™!"
            echo "è¯·æ‰‹åŠ¨è§£å†³è¿™äº›å†²çªæ ‡è®°"
            exit 1
          else
            echo "âœ… æœªå‘ç°åˆå¹¶å†²çªæ ‡è®°"
          fi

      - name: Check File Conflicts
        run: |
          echo "ğŸ” æ£€æŸ¥æ½œåœ¨æ–‡ä»¶å†²çª..."

          # æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤çš„æ–‡ä»¶ï¼ˆæ¯”å¦‚ file.py å’Œ file.py.origï¼‰
          duplicates=$(find . -name "*.orig" -o -name "*.rej" -o -name "*.bak")
          if [ -n "$duplicates" ]; then
            echo "âŒ å‘ç°å†²çªå¤‡ä»½æ–‡ä»¶:"
            echo "$duplicates"
            echo "è¯·æ¸…ç†è¿™äº›æ–‡ä»¶"
            exit 1
          else
            echo "âœ… æœªå‘ç°å†²çªå¤‡ä»½æ–‡ä»¶"
          fi

  # ä¾èµ–å†²çªæ£€æµ‹
  dependency-validation:
    name: Dependency Conflict Check
    if: github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest
    timeout-minutes: 6
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Check NPM Dependencies
        working-directory: ./frontend
        run: |
          echo "ğŸ“¦ æ£€æŸ¥NPMä¾èµ–å†²çª..."

          # æ£€æŸ¥å‰ç«¯ä¾èµ–
          npm ci --dry-run

          # æ£€æŸ¥ä¾èµ–æ¼æ´
          npm audit --audit-level=high

          echo "âœ… NPMä¾èµ–æ£€æŸ¥å®Œæˆ"

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Check Python Dependencies
        working-directory: ./backend
        run: |
          echo "ğŸ“¦ æ£€æŸ¥Pythonä¾èµ–å†²çª..."

          # æ£€æŸ¥requirementsæ–‡ä»¶
          pip install --dry-run -r requirements/base.txt
          pip install --dry-run -r requirements/test.txt

          # æ£€æŸ¥ä¾èµ–å†²çª
          pip check || echo "âš ï¸ å‘ç°Pythonä¾èµ–å†²çª"

          echo "âœ… Pythonä¾èµ–æ£€æŸ¥å®Œæˆ"

  # ä»£ç è´¨é‡ä¸‹é™æ£€æµ‹
  quality-regression:
    name: Quality Regression Check
    if: github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Analysis Tools
        run: |
          npm install -g jscpd # ä»£ç é‡å¤æ£€æµ‹
          pip install flake8 pylint # Pythonä»£ç è´¨é‡

      - name: Code Duplication Check
        run: |
          echo "ğŸ” æ£€æŸ¥ä»£ç é‡å¤..."

          # æ£€æŸ¥å‰ç«¯ä»£ç é‡å¤
          jscpd frontend/src --threshold 5 --format html --output ./duplication-report.html

          # æ£€æŸ¥åç«¯ä»£ç é‡å¤
          # Pythoné‡å¤æ£€æµ‹å¯ä»¥ç”¨å…¶ä»–å·¥å…·

          echo "âœ… ä»£ç é‡å¤æ£€æŸ¥å®Œæˆ"

      - name: Code Complexity Check
        working-directory: ./backend
        run: |
          echo "ğŸ” æ£€æŸ¥ä»£ç å¤æ‚åº¦..."

          # ä½¿ç”¨flake8æ£€æŸ¥å¤æ‚åº¦
          flake8 --max-complexity=10 . || echo "âš ï¸ å‘ç°é«˜å¤æ‚åº¦ä»£ç "

          echo "âœ… ä»£ç å¤æ‚åº¦æ£€æŸ¥å®Œæˆ"

  # åˆå¹¶åæ±‡æ€»æŠ¥å‘Š
  merge-validation-summary:
    name: Dev Validation Summary
    runs-on: ubuntu-latest
    needs:
      [
        post-merge-smoke,
        conflict-detection,
        dependency-validation,
        quality-regression,
      ]
    if: always() && github.ref == 'refs/heads/dev'
    steps:
      - name: Generate Merge Report
        run: |
          echo "## ğŸ”„ Dev Branch Merge Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Merge Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Ref:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "**Merged By:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æ”¶é›†éªŒè¯ç»“æœ
          SMOKE_STATUS="${{ needs.post-merge-smoke.result }}"
          CONFLICT_STATUS="${{ needs.conflict-detection.result }}"
          DEPENDENCY_STATUS="${{ needs.dependency-validation.result }}"
          QUALITY_STATUS="${{ needs.quality-regression.result }}"

          echo "| Validation Check | Status | Impact |" >> $GITHUB_STEP_SUMMARY
          echo "|------------------|---------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Post-Merge Smoke Tests | $SMOKE_STATUS | ğŸ”¥ Critical |" >> $GITHUB_STEP_SUMMARY
          echo "| Conflict Detection | $CONFLICT_STATUS | ğŸ”¥ Critical |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Validation | $DEPENDENCY_STATUS | âš ï¸ Important |" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Regression | $QUALITY_STATUS | ğŸ“Š Monitor |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # åˆ¤æ–­åˆå¹¶éªŒè¯ç»“æœ
          if [[ "$SMOKE_STATUS" == "success" && "$CONFLICT_STATUS" == "success" ]]; then
            echo "âœ… **Merge validation PASSED!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‰ åˆå¹¶æˆåŠŸï¼Œdevåˆ†æ”¯çŠ¶æ€è‰¯å¥½" >> $GITHUB_STEP_SUMMARY
            echo "ğŸš€ å¯ä»¥ç»§ç»­åœ¨devåˆ†æ”¯ä¸Šå¼€å‘" >> $GITHUB_STEP_SUMMARY

            if [[ "$DEPENDENCY_STATUS" != "success" ]]; then
              echo "âš ï¸ ä¾èµ–éªŒè¯æœ‰è­¦å‘Šï¼Œè¯·æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
            fi

            if [[ "$QUALITY_STATUS" != "success" ]]; then
              echo "ğŸ“Š ä»£ç è´¨é‡æœ‰ä¸‹é™ï¼Œå»ºè®®æ”¹è¿›" >> $GITHUB_STEP_SUMMARY
            fi

            echo "Merge validation completed successfully"
          else
            echo "âŒ **Merge validation FAILED!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ’¥ åˆå¹¶åéªŒè¯å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "ğŸš¨ éœ€è¦ç«‹å³ä¿®å¤å…³é”®é—®é¢˜" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ”§ å»ºè®®åˆ›å»ºç´§æ€¥ä¿®å¤PR" >> $GITHUB_STEP_SUMMARY
            echo "Merge validation failed"
            exit 1
          fi

      - name: Merge Status Notification
        run: |
          echo "ğŸ“ Dev Branch Merge Summary:"
          echo "   - Merge Commit: ${{ github.sha }}"
          echo "   - Branch: ${{ github.ref_name }}"
          echo "   - Actor: ${{ github.actor }}"
          echo "   - Status: Validation completed"
