name: Dev Branch - Post-Merge Validation

on:
  push:
    branches: [dev]
    # åªåœ¨åˆå¹¶æäº¤æ—¶è§¦å‘
  workflow_dispatch:

# å¹¶å‘æ§åˆ¶
concurrency:
  group: dev-merge-${{ github.ref }}
  cancel-in-progress: false # åˆå¹¶åéªŒè¯ä¸åº”è¯¥è¢«å–æ¶ˆ

jobs:
  # æ£€æµ‹æ˜¯å¦æ˜¯åˆå¹¶æäº¤
  detect-merge:
    name: Detect Merge Commit
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      is-merge: ${{ steps.check.outputs.is-merge }}
      source-branch: ${{ steps.check.outputs.source-branch }}
      pr-number: ${{ steps.check.outputs.pr-number }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 10 # è·å–è¶³å¤Ÿçš„å†å²è®°å½•

      - name: Check if Merge Commit
        id: check
        run: |
          echo "ğŸ” æ£€æµ‹åˆå¹¶æäº¤..."

          # æ£€æŸ¥æœ€æ–°æäº¤æ˜¯å¦æ˜¯åˆå¹¶æäº¤
          if git show --format="%P" -s HEAD | wc -w | grep -q "2"; then
            echo "âœ… æ£€æµ‹åˆ°åˆå¹¶æäº¤"
            echo "is-merge=true" >> $GITHUB_OUTPUT

            # å°è¯•è·å–åˆå¹¶ä¿¡æ¯
            COMMIT_MSG=$(git log -1 --pretty=%B)
            echo "æäº¤ä¿¡æ¯: $COMMIT_MSG"

            # æå–PRç¼–å·
            if [[ "$COMMIT_MSG" =~ Merge\ pull\ request\ #([0-9]+) ]]; then
              PR_NUMBER="${BASH_REMATCH[1]}"
              echo "pr-number=$PR_NUMBER" >> $GITHUB_OUTPUT
              echo "âœ… æ£€æµ‹åˆ°PR #$PR_NUMBER"
            fi

            # æå–æºåˆ†æ”¯
            if [[ "$COMMIT_MSG" =~ from\ .*/(.+) ]]; then
              SOURCE_BRANCH="${BASH_REMATCH[1]}"
              echo "source-branch=$SOURCE_BRANCH" >> $GITHUB_OUTPUT
              echo "âœ… æºåˆ†æ”¯: $SOURCE_BRANCH"
            fi
          else
            echo "â„¹ï¸ éåˆå¹¶æäº¤ï¼Œè·³è¿‡åˆå¹¶åéªŒè¯"
            echo "is-merge=false" >> $GITHUB_OUTPUT
          fi

  # åˆå¹¶åçš„å¿«é€ŸçƒŸé›¾æµ‹è¯•
  post-merge-smoke:
    name: Post-Merge Smoke Tests
    needs: detect-merge
    if: needs.detect-merge.outputs.is-merge == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 8

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: bravo_test
          MYSQL_USER: bravo_user
          MYSQL_PASSWORD: bravo_password
          MYSQL_ROOT_PASSWORD: root_password
        options: --health-cmd="mysqladmin ping -h 127.0.0.1 -P 3306 -u root -proot_password" --health-interval=10s --health-timeout=5s --health-retries=5
        ports:
          - 3306:3306

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install Dependencies
        run: |
          echo "ğŸ“¦ å¿«é€Ÿå®‰è£…ä¾èµ–..."
          npm ci --workspace=frontend
          cd backend && pip install -r requirements/test.txt

      - name: Quick Frontend Test
        run: |
          echo "ğŸ§ª å¿«é€Ÿå‰ç«¯æµ‹è¯•..."
          npm run test:coverage-check --workspace=frontend

      - name: Quick Backend Test
        working-directory: ./backend
        run: |
          echo "ğŸ§ª å¿«é€Ÿåç«¯æµ‹è¯•..."
          python manage.py test --settings=bravo.settings.test --keepdb --parallel 2 tests.quick
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_NAME: bravo_test
          DB_USER: bravo_user
          DB_PASSWORD: bravo_password

      - name: Integration Smoke Test
        run: |
          echo "ğŸ§ª é›†æˆçƒŸé›¾æµ‹è¯•..."
          # å¯åŠ¨æœåŠ¡
          cd backend && python manage.py runserver 8000 &
          sleep 5

          # åŸºæœ¬APIæµ‹è¯•
          curl -f http://localhost:8000/health/ || exit 1
          echo "âœ… æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"

  # åˆå¹¶å†²çªæ£€æµ‹
  conflict-detection:
    name: Merge Conflict Detection
    needs: detect-merge
    if: needs.detect-merge.outputs.is-merge == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for Merge Conflicts Markers
        run: |
          echo "ğŸ” æ£€æŸ¥åˆå¹¶å†²çªæ ‡è®°..."

          # æ£€æŸ¥æ˜¯å¦æœ‰åˆå¹¶å†²çªæ ‡è®°æ®‹ç•™
          if grep -r "<<<<<<< HEAD\|>>>>>>> \|=======" --include="*.py" --include="*.js" --include="*.vue" --include="*.ts" .; then
            echo "âŒ å‘ç°åˆå¹¶å†²çªæ ‡è®°æ®‹ç•™!"
            echo "è¯·æ‰‹åŠ¨è§£å†³è¿™äº›å†²çªæ ‡è®°"
            exit 1
          else
            echo "âœ… æœªå‘ç°åˆå¹¶å†²çªæ ‡è®°"
          fi

      - name: Check File Conflicts
        run: |
          echo "ğŸ” æ£€æŸ¥æ½œåœ¨æ–‡ä»¶å†²çª..."

          # æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤çš„æ–‡ä»¶ï¼ˆæ¯”å¦‚ file.py å’Œ file.py.origï¼‰
          duplicates=$(find . -name "*.orig" -o -name "*.rej" -o -name "*.bak")
          if [ -n "$duplicates" ]; then
            echo "âŒ å‘ç°å†²çªå¤‡ä»½æ–‡ä»¶:"
            echo "$duplicates"
            echo "è¯·æ¸…ç†è¿™äº›æ–‡ä»¶"
            exit 1
          else
            echo "âœ… æœªå‘ç°å†²çªå¤‡ä»½æ–‡ä»¶"
          fi

  # ä¾èµ–å†²çªæ£€æµ‹
  dependency-validation:
    name: Dependency Conflict Check
    needs: detect-merge
    if: needs.detect-merge.outputs.is-merge == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 6
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Check NPM Dependencies
        run: |
          echo "ğŸ“¦ æ£€æŸ¥NPMä¾èµ–å†²çª..."

          # æ£€æŸ¥package-lock.jsonæ˜¯å¦æœ‰å†²çª
          npm ci --dry-run

          # æ£€æŸ¥ä¾èµ–æ¼æ´
          npm audit --audit-level=high

          echo "âœ… NPMä¾èµ–æ£€æŸ¥å®Œæˆ"

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Check Python Dependencies
        working-directory: ./backend
        run: |
          echo "ğŸ“¦ æ£€æŸ¥Pythonä¾èµ–å†²çª..."

          # æ£€æŸ¥requirementsæ–‡ä»¶
          pip install --dry-run -r requirements/base.txt
          pip install --dry-run -r requirements/test.txt

          # æ£€æŸ¥ä¾èµ–å†²çª
          pip check || echo "âš ï¸ å‘ç°Pythonä¾èµ–å†²çª"

          echo "âœ… Pythonä¾èµ–æ£€æŸ¥å®Œæˆ"

  # ä»£ç è´¨é‡ä¸‹é™æ£€æµ‹
  quality-regression:
    name: Quality Regression Check
    needs: detect-merge
    if: needs.detect-merge.outputs.is-merge == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Analysis Tools
        run: |
          npm install -g jscpd # ä»£ç é‡å¤æ£€æµ‹
          pip install flake8 pylint # Pythonä»£ç è´¨é‡

      - name: Code Duplication Check
        run: |
          echo "ğŸ” æ£€æŸ¥ä»£ç é‡å¤..."

          # æ£€æŸ¥å‰ç«¯ä»£ç é‡å¤
          jscpd frontend/src --threshold 5 --format html --output ./duplication-report.html

          # æ£€æŸ¥åç«¯ä»£ç é‡å¤
          # Pythoné‡å¤æ£€æµ‹å¯ä»¥ç”¨å…¶ä»–å·¥å…·

          echo "âœ… ä»£ç é‡å¤æ£€æŸ¥å®Œæˆ"

      - name: Code Complexity Check
        working-directory: ./backend
        run: |
          echo "ğŸ” æ£€æŸ¥ä»£ç å¤æ‚åº¦..."

          # ä½¿ç”¨flake8æ£€æŸ¥å¤æ‚åº¦
          flake8 --max-complexity=10 . || echo "âš ï¸ å‘ç°é«˜å¤æ‚åº¦ä»£ç "

          echo "âœ… ä»£ç å¤æ‚åº¦æ£€æŸ¥å®Œæˆ"

  # åˆå¹¶åæ±‡æ€»æŠ¥å‘Š
  merge-validation-summary:
    name: Merge Validation Summary
    runs-on: ubuntu-latest
    needs:
      [
        detect-merge,
        post-merge-smoke,
        conflict-detection,
        dependency-validation,
        quality-regression,
      ]
    if: always() && needs.detect-merge.outputs.is-merge == 'true'
    steps:
      - name: Generate Merge Report
        run: |
          echo "## ğŸ”„ Dev Branch Merge Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Merge Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Source Branch:** ${{ needs.detect-merge.outputs.source-branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**PR Number:** #${{ needs.detect-merge.outputs.pr-number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Merged By:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æ”¶é›†éªŒè¯ç»“æœ
          SMOKE_STATUS="${{ needs.post-merge-smoke.result }}"
          CONFLICT_STATUS="${{ needs.conflict-detection.result }}"
          DEPENDENCY_STATUS="${{ needs.dependency-validation.result }}"
          QUALITY_STATUS="${{ needs.quality-regression.result }}"

          echo "| Validation Check | Status | Impact |" >> $GITHUB_STEP_SUMMARY
          echo "|------------------|---------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Post-Merge Smoke Tests | $SMOKE_STATUS | ğŸ”¥ Critical |" >> $GITHUB_STEP_SUMMARY
          echo "| Conflict Detection | $CONFLICT_STATUS | ğŸ”¥ Critical |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Validation | $DEPENDENCY_STATUS | âš ï¸ Important |" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Regression | $QUALITY_STATUS | ğŸ“Š Monitor |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # åˆ¤æ–­åˆå¹¶éªŒè¯ç»“æœ
          if [[ "$SMOKE_STATUS" == "success" && "$CONFLICT_STATUS" == "success" ]]; then
            echo "âœ… **Merge validation PASSED!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‰ åˆå¹¶æˆåŠŸï¼Œdevåˆ†æ”¯çŠ¶æ€è‰¯å¥½" >> $GITHUB_STEP_SUMMARY
            echo "ğŸš€ å¯ä»¥ç»§ç»­åœ¨devåˆ†æ”¯ä¸Šå¼€å‘" >> $GITHUB_STEP_SUMMARY

            if [[ "$DEPENDENCY_STATUS" != "success" ]]; then
              echo "âš ï¸ ä¾èµ–éªŒè¯æœ‰è­¦å‘Šï¼Œè¯·æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
            fi

            if [[ "$QUALITY_STATUS" != "success" ]]; then
              echo "ğŸ“Š ä»£ç è´¨é‡æœ‰ä¸‹é™ï¼Œå»ºè®®æ”¹è¿›" >> $GITHUB_STEP_SUMMARY
            fi

            echo "Merge validation completed successfully"
          else
            echo "âŒ **Merge validation FAILED!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ’¥ åˆå¹¶åéªŒè¯å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "ğŸš¨ éœ€è¦ç«‹å³ä¿®å¤å…³é”®é—®é¢˜" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ”§ å»ºè®®åˆ›å»ºç´§æ€¥ä¿®å¤PR" >> $GITHUB_STEP_SUMMARY
            echo "Merge validation failed"
            exit 1
          fi

      - name: Merge Status Notification
        run: |
          echo "ğŸ“ Dev Branch Merge Summary:"
          echo "   - Merge Commit: ${{ github.sha }}"
          echo "   - Source: ${{ needs.detect-merge.outputs.source-branch }}"
          echo "   - PR: #${{ needs.detect-merge.outputs.pr-number }}"
          echo "   - Status: Validation completed"
