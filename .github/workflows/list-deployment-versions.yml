name: ğŸ“‹ List Deployment Versions

on:
  workflow_dispatch:
    inputs:
      show-images:
        description: "æ˜¯å¦æ˜¾ç¤ºæœ¬åœ°é•œåƒåˆ—è¡¨"
        required: false
        type: boolean
        default: true

  # ä¹Ÿå¯ä»¥å®šæœŸè¿è¡Œ
  schedule:
    - cron: "0 0 * * 0" # æ¯å‘¨æ—¥ UTC 0ç‚¹è¿è¡Œ

jobs:
  list-versions:
    name: æŸ¥çœ‹éƒ¨ç½²ä¿¡æ¯
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ALIYUN_SSH_KEY }}

      - name: Get Deployment Info
        env:
          HOST: ${{ secrets.ALIYUN_HOST }}
          USER: ${{ secrets.ALIYUN_USER }}
          SHOW_IMAGES: ${{ inputs.show-images || 'true' }}
        run: |
          ssh -o StrictHostKeyChecking=no $USER@$HOST bash -s << 'ENDSSH' "$SHOW_IMAGES"

            SHOW_IMAGES="$1"

            cd /home/layne/project/bravo-prod

            echo "## ğŸ“‹ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ä¿¡æ¯"
            echo ""

            # å½“å‰è¿è¡Œç‰ˆæœ¬
            echo "### ğŸš€ å½“å‰è¿è¡Œç‰ˆæœ¬"
            echo ""
            if [ -f .deployment-current ]; then
              echo '```'
              cat .deployment-current
              echo '```'

              # æ˜¾ç¤ºå®é™…è¿è¡Œçš„å®¹å™¨
              echo ""
              echo "**è¿è¡Œçš„å®¹å™¨:**"
              echo '```'
              docker ps --filter "name=bravo-prod" --format "table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}"
              echo '```'
            else
              echo "æ— éƒ¨ç½²è®°å½•"
            fi
            echo ""

            # ä¸Šä¸€ä¸ªç‰ˆæœ¬
            echo "### ğŸ”„ ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼ˆå¯å¿«é€Ÿå›æ»šï¼‰"
            echo ""
            if [ -f .deployment-previous ]; then
              echo '```'
              cat .deployment-previous
              echo '```'
            else
              echo "æ— å¤‡ä»½ç‰ˆæœ¬"
            fi
            echo ""

            # æœ¬åœ°å¯ç”¨é•œåƒ
            if [ "$SHOW_IMAGES" = "true" ]; then
              echo "### ğŸ’¾ æœåŠ¡å™¨æœ¬åœ°é•œåƒ"
              echo ""
              echo '```'
              docker images --filter "reference=*bravo*" --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}"
              echo '```'
              echo ""
            fi

            # éƒ¨ç½²å†å²ï¼ˆæœ€è¿‘10æ¡ï¼‰
            echo "### ğŸ“œ éƒ¨ç½²å†å²ï¼ˆæœ€è¿‘10æ¡ï¼‰"
            echo ""
            if [ -f .deployment-history ]; then
              echo '```'
              tail -n 10 .deployment-history
              echo '```'

              # ç»Ÿè®¡
              TOTAL_DEPLOYS=$(wc -l < .deployment-history)
              SUCCESS_DEPLOYS=$(grep -c "éƒ¨ç½²æˆåŠŸ" .deployment-history || echo "0")
              FAILED_DEPLOYS=$(grep -c "éƒ¨ç½²å¤±è´¥" .deployment-history || echo "0")
              ROLLBACK_DEPLOYS=$(grep -c "å›æ»š" .deployment-history || echo "0")

              echo ""
              echo "**ç»Ÿè®¡ä¿¡æ¯:**"
              echo "- æ€»éƒ¨ç½²æ¬¡æ•°: $TOTAL_DEPLOYS"
              echo "- æˆåŠŸéƒ¨ç½²: $SUCCESS_DEPLOYS"
              echo "- å¤±è´¥éƒ¨ç½²: $FAILED_DEPLOYS"
              echo "- å›æ»šæ¬¡æ•°: $ROLLBACK_DEPLOYS"
            else
              echo "æ— å†å²è®°å½•"
            fi
            echo ""

            # ç£ç›˜ä½¿ç”¨æƒ…å†µ
            echo "### ğŸ’¿ ç£ç›˜ä½¿ç”¨æƒ…å†µ"
            echo ""
            echo '```'
            df -h /home/layne/project/bravo-prod
            echo ""
            echo "Dockeré•œåƒå ç”¨:"
            docker system df
            echo '```'
            echo ""

            # ä¿å­˜åˆ°æ–‡ä»¶ä¾›ä¸‹è½½
            {
              echo "# Bravoç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŠ¥å‘Š"
              echo ""
              echo "ç”Ÿæˆæ—¶é—´: $(date)"
              echo ""
              echo "## å½“å‰è¿è¡Œç‰ˆæœ¬"
              echo ""
              if [ -f .deployment-current ]; then
                cat .deployment-current
              fi
              echo ""
              echo "## éƒ¨ç½²å†å²"
              echo ""
              if [ -f .deployment-history ]; then
                tail -n 20 .deployment-history
              fi
            } > /tmp/deployment-report.md

            cat /tmp/deployment-report.md
          ENDSSH

      - name: Create Summary
        run: |
          echo "## ğŸ“Š éƒ¨ç½²ç‰ˆæœ¬æŸ¥è¯¢å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æŸ¥è¯¢æ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**æœåŠ¡å™¨**: ${{ secrets.ALIYUN_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### å¿«é€Ÿæ“ä½œï¼š" >> $GITHUB_STEP_SUMMARY
          echo "- [æ‰‹åŠ¨å›æ»š](https://github.com/${{ github.repository }}/actions/workflows/rollback-production.yml)" >> $GITHUB_STEP_SUMMARY
          echo "- [æŸ¥çœ‹éƒ¨ç½²å†å²](https://github.com/${{ github.repository }}/actions/workflows/list-deployment-versions.yml)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ å¦‚ä½•å›æ»šï¼š" >> $GITHUB_STEP_SUMMARY
          echo "1. ç‚¹å‡»ä¸Šæ–¹ã€Œæ‰‹åŠ¨å›æ»šã€é“¾æ¥" >> $GITHUB_STEP_SUMMARY
          echo "2. é€‰æ‹©å›æ»šç±»å‹ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "   - **previous**: å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼ˆæœ€å¿«ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "   - **stable**: å›æ»šåˆ°æœ€åç¨³å®šç‰ˆæœ¬" >> $GITHUB_STEP_SUMMARY
          echo "   - **specific**: å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬ï¼ˆéœ€è¦ç‰ˆæœ¬å·ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "3. å¡«å†™å›æ»šåŸå› ï¼ˆå¿…å¡«ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "4. ç‚¹å‡»ã€ŒRun workflowã€æ‰§è¡Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **æ³¨æ„**: å›æ»šæ“ä½œä¼šå½±å“ç”Ÿäº§ç¯å¢ƒï¼Œè¯·è°¨æ…æ“ä½œï¼" >> $GITHUB_STEP_SUMMARY
