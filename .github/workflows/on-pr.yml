name: PR Validation - Fast Track

# åŽŸå­åŒ–æž¶æž„ - å¿«é€Ÿåé¦ˆworkflow
# ðŸ”¥ ç´§æ€¥ä¿®å¤ï¼šå¿…é¡»å¯¹æ‰€æœ‰PRè¿›è¡ŒéªŒè¯ï¼Œç¡®ä¿ä»£ç è´¨é‡
on:
  pull_request:
    branches: [main, dev]
    types: [opened, synchronize, reopened]
    # ðŸš¨ é‡è¦ï¼šæ‰€æœ‰PRéƒ½å¿…é¡»é€šè¿‡è¿™äº›æ£€æŸ¥æ‰èƒ½åˆå¹¶
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘ç”¨äºŽè°ƒè¯•

# å¹¶å‘æŽ§åˆ¶ï¼Œé¿å…é‡å¤è¿è¡Œ
concurrency:
  group: pr-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ç¬¬ä¸€æ­¥ï¼šè®¾ç½®ç¼“å­˜ (å¹¶è¡ŒåŸºç¡€)
  setup:
    name: Setup Cache & Environment
    # å¿«é€Ÿåé¦ˆæ¨¡å¼ï¼Œä¸ºæ‰€æœ‰PRæä¾›è½»é‡çº§éªŒè¯
    uses: ./.github/workflows/setup-cache.yml

  # ç¬¬äºŒæ­¥ï¼šå¿«é€Ÿå¹¶è¡Œæµ‹è¯• (ä¾èµ–setup)
  unit-tests-backend:
    name: Backend Unit Tests
    needs: setup
    uses: ./.github/workflows/test-unit-backend.yml
    with:
      coverage: true
      timeout: 10

  unit-tests-frontend:
    name: Frontend Unit Tests
    needs: setup
    uses: ./.github/workflows/test-unit-frontend.yml
    with:
      coverage: true
      timeout: 8

  # ç¬¬ä¸‰æ­¥ï¼šé›†æˆæµ‹è¯• (ä¾èµ–å•å…ƒæµ‹è¯•)
  integration-tests:
    name: Integration Tests
    needs: [unit-tests-backend, unit-tests-frontend]
    uses: ./.github/workflows/test-integration.yml
    with:
      timeout: 12

  # ç¬¬å››æ­¥ï¼šçƒŸé›¾E2Eæµ‹è¯• (ä¾èµ–é›†æˆæµ‹è¯•) - ä½¿ç”¨ç»Ÿä¸€çš„DockerçŽ¯å¢ƒ
  e2e-smoke:
    name: E2E Smoke Tests (Docker)
    needs: integration-tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      # ä½¿ç”¨ä¸Žpost-mergeç›¸åŒçš„Dockerå®¹å™¨çŽ¯å¢ƒ
      - name: Run E2E with Docker Container
        run: |
          echo "ðŸš€ PRéªŒè¯ä½¿ç”¨ç»Ÿä¸€çš„Dockerå®¹å™¨çŽ¯å¢ƒ..."

          # ðŸŽ¯ æœ€ä¼˜æ–¹æ¡ˆï¼šä½¿ç”¨è‡ªç»™è‡ªè¶³å®¹å™¨æž¶æž„ï¼Œä¸Žpost-mergeå®Œå…¨ç›¸åŒ
          if command -v docker-compose >/dev/null 2>&1; then
            echo "å¯åŠ¨DockeræœåŠ¡..."
            # ðŸŽ¯ ç§»é™¤çŽ¯å¢ƒå˜é‡ä¼ é€’ï¼Œå®¹å™¨è‡ªç»™è‡ªè¶³
            docker-compose -f docker-compose.test.yml up --build -d

            echo "ç­‰å¾…E2Eæµ‹è¯•å®Œæˆ..."
            # ðŸŽ¯ å½»åº•ä¿®å¤ï¼šä½¿ç”¨ç›´æŽ¥çš„å®¹å™¨é€€å‡ºç æ£€æµ‹
            echo "ç­‰å¾…E2Eå®¹å™¨å®Œæˆ..."
            docker-compose -f docker-compose.test.yml logs -f e2e-tests || true

            # ç›´æŽ¥èŽ·å–å®¹å™¨é€€å‡ºç ï¼Œä¸ä¾èµ–ifåˆ†æ”¯
            E2E_CID=$(docker-compose -f docker-compose.test.yml ps -q e2e-tests)
            echo "E2Eå®¹å™¨ID: $E2E_CID"

            if [ -n "$E2E_CID" ]; then
              # ç­‰å¾…å®¹å™¨å®Œå…¨åœæ­¢
              docker wait "$E2E_CID" > /dev/null 2>&1 || true
              E2E_EXIT_CODE=$(docker inspect --format='{{.State.ExitCode}}' "$E2E_CID" 2>/dev/null || echo "1")
            else
              echo "âŒ æ— æ³•èŽ·å–E2Eå®¹å™¨ID"
              E2E_EXIT_CODE=1
            fi

            echo "E2Eæµ‹è¯•çœŸå®žé€€å‡ºç : $E2E_EXIT_CODE"

            echo "ðŸ“¦ æ”¶é›†E2Eæµ‹è¯•äº§ç‰©..."
            mkdir -p e2e-artifacts || true
            if [ -n "$E2E_CID" ]; then
              docker cp "$E2E_CID:/app/test-results" e2e-artifacts/test-results 2>/dev/null || true
              docker cp "$E2E_CID:/app/playwright-report" e2e-artifacts/playwright-report 2>/dev/null || true
            fi

            echo "æ¸…ç†DockeræœåŠ¡..."
            docker-compose -f docker-compose.test.yml down

            exit $E2E_EXIT_CODE
          else
            echo "docker-compose not found, using 'docker compose' instead..."
            # ðŸŽ¯ ç§»é™¤çŽ¯å¢ƒå˜é‡ä¼ é€’ï¼Œå®¹å™¨è‡ªç»™è‡ªè¶³
            docker compose -f docker-compose.test.yml up --build -d

            echo "ç­‰å¾…E2Eæµ‹è¯•å®Œæˆ..."
            # ðŸŽ¯ ç¬¬23è½®ä¿®å¤ï¼šåœ¨å®¹å™¨å¯åŠ¨åŽç«‹å³èŽ·å–IDï¼Œé¿å…è¢«æ¸…ç†åŽæ— æ³•èŽ·å–
            sleep 2 # ç­‰å¾…å®¹å™¨å®Œå…¨å¯åŠ¨
            E2E_CID=$(docker compose -f docker-compose.test.yml ps -q e2e-tests)
            echo "E2Eå®¹å™¨ID: $E2E_CID"

            if [ -n "$E2E_CID" ]; then
              echo "ç­‰å¾…E2Eå®¹å™¨å®Œæˆ..."
              # ç­‰å¾…å®¹å™¨å®Œå…¨åœæ­¢å¹¶èŽ·å–é€€å‡ºç 
              docker wait "$E2E_CID" > /dev/null 2>&1 || true
              E2E_EXIT_CODE=$(docker inspect --format='{{.State.ExitCode}}' "$E2E_CID" 2>/dev/null || echo "1")
              echo "ðŸ“‹ æ˜¾ç¤ºE2Eæµ‹è¯•æ—¥å¿—..."
              docker compose -f docker-compose.test.yml logs e2e-tests || true
            else
              echo "âŒ æ— æ³•èŽ·å–E2Eå®¹å™¨IDï¼Œå›žé€€åˆ°æ—¥å¿—ç­‰å¾…æ¨¡å¼"
              docker compose -f docker-compose.test.yml logs -f e2e-tests || true
              E2E_EXIT_CODE=1
            fi

            echo "E2Eæµ‹è¯•çœŸå®žé€€å‡ºç : $E2E_EXIT_CODE"

            echo "ðŸ“¦ æ”¶é›†E2Eæµ‹è¯•äº§ç‰©..."
            mkdir -p e2e-artifacts || true
            if [ -n "$E2E_CID" ]; then
              docker cp "$E2E_CID:/app/test-results" e2e-artifacts/test-results 2>/dev/null || true
              docker cp "$E2E_CID:/app/playwright-report" e2e-artifacts/playwright-report 2>/dev/null || true
              docker cp "$E2E_CID:/app/e2e-results.xml" e2e-artifacts/e2e-results.xml 2>/dev/null || true
            fi

            echo "æ¸…ç†DockeræœåŠ¡..."
            docker compose -f docker-compose.test.yml down

            exit $E2E_EXIT_CODE
          fi

      - name: Upload E2E Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-smoke-results-chromium
          path: |
            e2e-artifacts/test-results/
            e2e-artifacts/playwright-report/
          retention-days: 3

  # ç¬¬äº”æ­¥ï¼šè´¨é‡é—¨ç¦ (å¹¶è¡Œ)
  directory-guard:
    name: Directory Protection
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check Directory Rules
        run: |
          echo "Checking directory protection rules..."

          # æ£€æŸ¥æ ¹ç›®å½•æ–°å¢žæ–‡ä»¶
          forbidden_files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '^[^/]+\.(md|txt|test_.*\.py|.*_test\.py|\.keep|\.example)$' || true)
          if [ -n "$forbidden_files" ]; then
            echo "ERROR: Root directory clutter detected:"
            echo "$forbidden_files"
            echo "Please move documentation to docs/ and tests to appropriate directories"
            exit 1
          fi

          echo "Directory protection check passed"

  # ç¬¬å…­æ­¥ï¼šPRéªŒè¯æ±‡æ€» - ðŸ”¥ ç´§æ€¥ä¿®å¤ï¼šæ‰€æœ‰PRéƒ½å¿…é¡»éªŒè¯ï¼
  pr-validation-summary:
    name: PR Validation Summary
    if: always() # ç§»é™¤drafté™åˆ¶ - æ‰€æœ‰PRéƒ½å¿…é¡»é€šè¿‡éªŒè¯ï¼
    runs-on: ubuntu-latest
    needs:
      [
        unit-tests-backend,
        unit-tests-frontend,
        integration-tests,
        e2e-smoke,
        directory-guard,
      ]
    steps:
      - name: Check All Results
        run: |
          echo "## PR Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æ£€æŸ¥å„ä¸ªæµ‹è¯•ç»“æžœ
          BACKEND_STATUS="${{ needs.unit-tests-backend.result }}"
          FRONTEND_STATUS="${{ needs.unit-tests-frontend.result }}"
          INTEGRATION_STATUS="${{ needs.integration-tests.result }}"
          E2E_STATUS="${{ needs.e2e-smoke.result }}"
          DIRECTORY_STATUS="${{ needs.directory-guard.result }}"

          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Unit Tests | $BACKEND_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Unit Tests | $FRONTEND_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | $INTEGRATION_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Smoke Tests | $E2E_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Directory Guard | $DIRECTORY_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # åˆ¤æ–­æ•´ä½“ç»“æžœ
          if [[ "$BACKEND_STATUS" == "success" && \
                "$FRONTEND_STATUS" == "success" && \
                "$INTEGRATION_STATUS" == "success" && \
                "$E2E_STATUS" == "success" && \
                "$DIRECTORY_STATUS" == "success" ]]; then
            echo "âœ… **All PR validations passed!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This PR is ready for review and can be safely merged." >> $GITHUB_STEP_SUMMARY
            echo "PR validation completed successfully"
          else
            echo "âŒ **Some validations failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the failed tests above and fix the issues before merging." >> $GITHUB_STEP_SUMMARY
            echo "PR validation failed - please fix issues"
            exit 1
          fi
