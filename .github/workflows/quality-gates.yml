name: "Quality Gates Component"

on:
  workflow_call:
    inputs:
      quality-level:
        description: "Quality check level: basic, standard, strict"
        type: string
        required: true
      min-coverage:
        description: "Minimum code coverage percentage"
        type: string
        required: false
        default: "80"
      target-branch:
        description: "Target branch for quality checks"
        type: string
        required: false
        default: "dev"
    outputs:
      quality-score:
        description: "Overall quality score (0-100)"
        value: ${{ jobs.quality-summary.outputs.score }}
      gates-passed:
        description: "Whether all quality gates passed"
        value: ${{ jobs.quality-summary.outputs.passed }}

env:
  NODE_VERSION: "20"
  PYTHON_VERSION: "3.11"

jobs:
  # å¹¶è¡ŒåŸºç¡€è´¨é‡æ£€æŸ¥
  basic-checks:
    strategy:
      fail-fast: false
      matrix:
        check: ["lint-frontend", "lint-backend", "type-check", "audit-deps"]

    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-cached-env

      - name: Run Basic Check
        run: |
          echo "ğŸ” Running ${{ matrix.check }}..."

          case "${{ matrix.check }}" in
            "lint-frontend")
              echo "Linting frontend code..."
              npm run lint:frontend || exit 1
              echo "âœ… Frontend lint passed"
              ;;
            "lint-backend")
              echo "Linting backend code..."
              cd backend && source .venv/bin/activate
              # ä¸¥æ ¼çš„è¯­æ³•æ£€æŸ¥
              flake8 . --select=E9,F63,F7,F82 --exclude=migrations,__pycache__,.venv
              # æ›´å®½æ¾çš„ä»£ç é£æ ¼æ£€æŸ¥
              flake8 . --max-line-length=120 --exclude=migrations,__pycache__,.venv --exit-zero
              echo "âœ… Backend lint passed"
              ;;
            "type-check")
              echo "Checking TypeScript types..."
              npm run type-check || exit 1
              echo "âœ… Type check passed"
              ;;
            "audit-deps")
              echo "Auditing dependencies..."
              npm audit --audit-level=high --production
              echo "âœ… Dependency audit passed"
              ;;
          esac

  # ä»£ç å¤æ‚åº¦æ£€æŸ¥ (standard+)
  code-complexity:
    if: inputs.quality-level != 'basic'
    runs-on: ubuntu-latest
    timeout-minutes: 8

    steps:
      - uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-cached-env

      - name: Analyze Code Complexity
        run: |
          echo "ğŸ“Š Analyzing code complexity..."

          # Pythonå¤æ‚åº¦åˆ†æ
          cd backend && source .venv/bin/activate
          pip install radon xenon

          # ç”Ÿæˆå¤æ‚åº¦æŠ¥å‘Š
          radon cc . --json > ../reports/radon-cc.json || true
          radon mi . --json > ../reports/radon-mi.json || true

          # æ£€æŸ¥å¤æ‚åº¦é˜ˆå€¼
          xenon --max-absolute C --max-modules B --max-average A . || echo "âš ï¸ High complexity detected"

          cd ..

          # TypeScriptå¤æ‚åº¦æ£€æŸ¥ï¼ˆå¦‚æœæœ‰å·¥å…·ï¼‰
          if command -v ts-complexity &> /dev/null; then
            ts-complexity frontend/src/ || echo "âš ï¸ Frontend complexity analysis failed"
          fi

          echo "âœ… Complexity analysis completed"

      - name: Upload Complexity Reports
        uses: actions/upload-artifact@v4
        with:
          name: complexity-reports
          path: reports/
          retention-days: 7

  # å®‰å…¨æ‰«æ (standard+)
  security-scan:
    if: inputs.quality-level != 'basic'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-cached-env

      - name: Security Scan - Dependencies
        run: |
          echo "ğŸ” Scanning dependencies for vulnerabilities..."

          # Node.jsä¾èµ–å®‰å…¨æ‰«æ
          npm audit --audit-level=moderate --production

          # Pythonä¾èµ–å®‰å…¨æ‰«æ
          cd backend && source .venv/bin/activate
          pip install safety
          safety check --json --output ../reports/security/safety-report.json || true

          echo "âœ… Dependency security scan completed"

      - name: Security Scan - Code
        run: |
          echo "ğŸ” Scanning code for security issues..."

          cd backend && source .venv/bin/activate
          pip install bandit

          # è¿è¡Œbanditå®‰å…¨æ‰«æ
          bandit -r . \
            -f json \
            -o ../reports/security/bandit-report.json \
            --exclude ./migrations,./venv,./.venv \
            --skip B101,B601 \
            || true

          # æ£€æŸ¥æ•æ„Ÿä¿¡æ¯
          echo "Checking for sensitive information..."
          if grep -r "password\|secret\|key" --include="*.py" --include="*.js" --include="*.ts" . | grep -v test | grep -v migration; then
            echo "âš ï¸ Potential sensitive information found in code"
          fi

          echo "âœ… Code security scan completed"

      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: reports/security/
          retention-days: 30

      - name: Upload to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('reports/security/bandit-report.json') != ''
        with:
          sarif_file: reports/security/bandit-report.json

  # æ€§èƒ½å®¡è®¡ (strict only)
  performance-audit:
    if: inputs.quality-level == 'strict'
    runs-on: ubuntu-latest
    timeout-minutes: 12

    steps:
      - uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-cached-env

      - name: Build for Performance Audit
        run: |
          echo "ğŸ—ï¸ Building optimized version for audit..."

          # æ„å»ºç”Ÿäº§ç‰ˆæœ¬
          npm run build:frontend

          # æ£€æŸ¥æ„å»ºäº§ç‰©å¤§å°
          cd frontend/dist
          du -sh * | sort -hr > ../../reports/build-size.txt

          # æ£€æŸ¥æ˜¯å¦æœ‰è¿‡å¤§çš„æ–‡ä»¶
          find . -size +500k -type f | while read file; do
            echo "âš ï¸ Large file detected: $file ($(du -h "$file" | cut -f1))"
          done

          cd ../..
          echo "âœ… Build completed for audit"

      - name: Run Lighthouse Performance Audit
        run: |
          echo "âš¡ Running Lighthouse performance audit..."

          # åˆ›å»ºæµ‹è¯•é¡µé¢
          mkdir -p frontend/dist
          cat > frontend/dist/perf-test.html << 'EOF'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Bravo - Performance Test</title>
              <meta name="description" content="Bravo performance audit test page">
              <style>
                  body { font-family: system-ui, sans-serif; margin: 0; padding: 20px; }
                  .container { max-width: 1200px; margin: 0 auto; }
                  .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px 20px; text-align: center; }
                  .features { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 40px 0; }
                  .feature { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>Bravo æ™ºèƒ½å­¦ä¹ å¹³å°</h1>
                      <p>æ€§èƒ½æµ‹è¯•é¡µé¢</p>
                  </div>
                  <div class="features">
                      <div class="feature"><h3>ğŸ“ åšå®¢ç³»ç»Ÿ</h3><p>é«˜æ€§èƒ½åšå®¢ç®¡ç†</p></div>
                      <div class="feature"><h3>ğŸŒ è‹±è¯­å­¦ä¹ </h3><p>AIé©±åŠ¨å­¦ä¹ ç³»ç»Ÿ</p></div>
                      <div class="feature"><h3>ğŸ’¼ æ±‚èŒåŠ©æ‰‹</h3><p>æ™ºèƒ½ç®€å†ä¼˜åŒ–</p></div>
                  </div>
              </div>
          </body>
          </html>
          EOF

          # é…ç½®Lighthouse
          cat > lighthouserc.json << 'EOF'
          {
            "ci": {
              "collect": {
                "staticDistDir": "./frontend/dist",
                "url": ["perf-test.html"],
                "numberOfRuns": 3,
                "settings": {
                  "chromeFlags": "--no-sandbox --disable-dev-shm-usage --disable-gpu --disable-web-security --headless",
                  "maxWaitForFcp": 30000,
                  "maxWaitForLoad": 60000,
                  "pauseAfterFcpMs": 1000,
                  "pauseAfterLoadMs": 1000,
                  "networkQuietThresholdMs": 1000,
                  "cpuQuietThresholdMs": 1000,
                  "emulatedFormFactor": "desktop"
                }
              },
              "assert": {
                "assertions": {
                  "categories:performance": ["warn", {"minScore": 0.75}],
                  "categories:accessibility": ["warn", {"minScore": 0.85}],
                  "categories:best-practices": ["warn", {"minScore": 0.85}],
                  "categories:seo": ["warn", {"minScore": 0.80}]
                }
              },
              "upload": {
                "target": "temporary-public-storage"
              }
            }
          }
          EOF

          # è¿è¡ŒLighthouse
          npx lhci autorun || echo "âš ï¸ Performance audit completed with warnings"

          echo "âœ… Performance audit completed"

  # ä»£ç è¦†ç›–ç‡æ£€æŸ¥
  coverage-check:
    if: inputs.quality-level != 'basic'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Check Coverage Requirements
        run: |
          echo "ğŸ“Š Checking coverage requirements..."
          echo "Minimum required coverage: ${{ inputs.min-coverage }}%"
          echo "Target branch: ${{ inputs.target-branch }}"

          # è¿™é‡Œä¼šä¸test-suiteçš„ç»“æœè¿›è¡Œé›†æˆ
          # å®é™…çš„è¦†ç›–ç‡æ£€æŸ¥åœ¨test-suite.ymlä¸­å®Œæˆ
          echo "âœ… Coverage check configured"

  # è´¨é‡é—¨ç¦æ±‡æ€»
  quality-summary:
    if: always()
    needs:
      [
        basic-checks,
        code-complexity,
        security-scan,
        performance-audit,
        coverage-check,
      ]
    runs-on: ubuntu-latest
    outputs:
      score: ${{ steps.calculate.outputs.score }}
      passed: ${{ steps.calculate.outputs.passed }}

    steps:
      - name: Calculate Quality Score
        id: calculate
        run: |
          echo "## ğŸ¯ Quality Gates Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Quality Level**: ${{ inputs.quality-level }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target Branch**: ${{ inputs.target-branch }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # è·å–å„ç»„ä»¶çŠ¶æ€
          BASIC_STATUS="${{ needs.basic-checks.result }}"
          COMPLEXITY_STATUS="${{ needs.code-complexity.result }}"
          SECURITY_STATUS="${{ needs.security-scan.result }}"
          PERFORMANCE_STATUS="${{ needs.performance-audit.result }}"
          COVERAGE_STATUS="${{ needs.coverage-check.result }}"

          echo "| Quality Gate | Status | Weight | Level |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|--------|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Basic Checks | $BASIC_STATUS | 40% | Always |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Complexity | $COMPLEXITY_STATUS | 15% | Standard+ |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | $SECURITY_STATUS | 25% | Standard+ |" >> $GITHUB_STEP_SUMMARY
          echo "| Performance Audit | $PERFORMANCE_STATUS | 20% | Strict Only |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # è®¡ç®—è´¨é‡åˆ†æ•°
          SCORE=0

          # åŸºç¡€æ£€æŸ¥ (40åˆ†)
          if [[ "$BASIC_STATUS" == "success" ]]; then
            SCORE=$((SCORE + 40))
          fi

          # å¤æ‚åº¦æ£€æŸ¥ (15åˆ†, standard+)
          if [[ "${{ inputs.quality-level }}" != "basic" ]]; then
            if [[ "$COMPLEXITY_STATUS" == "success" ]]; then
              SCORE=$((SCORE + 15))
            fi
          else
            SCORE=$((SCORE + 15)) # basicçº§åˆ«è‡ªåŠ¨ç»™åˆ†
          fi

          # å®‰å…¨æ‰«æ (25åˆ†, standard+)
          if [[ "${{ inputs.quality-level }}" != "basic" ]]; then
            if [[ "$SECURITY_STATUS" == "success" ]]; then
              SCORE=$((SCORE + 25))
            fi
          else
            SCORE=$((SCORE + 25)) # basicçº§åˆ«è‡ªåŠ¨ç»™åˆ†
          fi

          # æ€§èƒ½å®¡è®¡ (20åˆ†, strict only)
          if [[ "${{ inputs.quality-level }}" == "strict" ]]; then
            if [[ "$PERFORMANCE_STATUS" == "success" ]]; then
              SCORE=$((SCORE + 20))
            fi
          else
            SCORE=$((SCORE + 20)) # éstrictçº§åˆ«è‡ªåŠ¨ç»™åˆ†
          fi

          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "**Overall Quality Score: $SCORE/100**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # åˆ¤æ–­æ˜¯å¦é€šè¿‡
          PASS_THRESHOLD=70
          if [[ "${{ inputs.quality-level }}" == "strict" ]]; then
            PASS_THRESHOLD=85
          elif [[ "${{ inputs.quality-level }}" == "standard" ]]; then
            PASS_THRESHOLD=75
          fi

          if [[ $SCORE -ge $PASS_THRESHOLD ]]; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "âœ… **Quality gates PASSED!**" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ¯ Score: $SCORE/100 (â‰¥$PASS_THRESHOLD required for ${{ inputs.quality-level }} level)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‰ Code quality meets the required standards for ${{ inputs.quality-level }} level validation." >> $GITHUB_STEP_SUMMARY
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "âŒ **Quality gates FAILED!**" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“Š Score: $SCORE/100 (â‰¥$PASS_THRESHOLD required for ${{ inputs.quality-level }} level)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ”§ Please address the quality issues above to meet the required standards." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ’¡ Improvement Suggestions:" >> $GITHUB_STEP_SUMMARY

            if [[ "$BASIC_STATUS" != "success" ]]; then
              echo "- Fix linting and basic code quality issues" >> $GITHUB_STEP_SUMMARY
            fi
            if [[ "$COMPLEXITY_STATUS" != "success" && "${{ inputs.quality-level }}" != "basic" ]]; then
              echo "- Reduce code complexity and improve maintainability" >> $GITHUB_STEP_SUMMARY
            fi
            if [[ "$SECURITY_STATUS" != "success" && "${{ inputs.quality-level }}" != "basic" ]]; then
              echo "- Address security vulnerabilities and remove sensitive data" >> $GITHUB_STEP_SUMMARY
            fi
            if [[ "$PERFORMANCE_STATUS" != "success" && "${{ inputs.quality-level }}" == "strict" ]]; then
              echo "- Optimize performance and reduce bundle size" >> $GITHUB_STEP_SUMMARY
            fi

            exit 1
          fi
