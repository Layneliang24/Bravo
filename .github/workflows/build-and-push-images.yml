name: ğŸ³ Build and Push Docker Images

# åœ¨ä»£ç åˆå¹¶åˆ°devæˆ–mainåæ„å»ºå¹¶æ¨é€é•œåƒ
on:
  push:
    branches:
      - dev
      - main
    paths:
      - "backend/**"
      - "frontend/**"
      - "docker-compose.prod.yml"
      - ".github/workflows/build-and-push-images.yml"
      - ".github/workflows/deploy-dev.yml"
      - ".github/workflows/deploy-production.yml"

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      environment:
        description: "ç›®æ ‡ç¯å¢ƒ"
        required: true
        type: choice
        options:
          - dev
          - production

env:
  REGISTRY: crpi-noqbdktswju6cuew.cn-shenzhen.personal.cr.aliyuncs.com
  NAMESPACE: bravo-project

jobs:
  build-and-push:
    name: æ„å»ºå¹¶æ¨é€Dockeré•œåƒ
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: è®¾ç½®é•œåƒæ ‡ç­¾
        id: tags
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          FULL_SHA=${GITHUB_SHA}
          SHORT_SHA=${GITHUB_SHA::8}
          TIMESTAMP=$(date -u +%Y.%m.%d-%H%M%S)

          if [ "$BRANCH_NAME" = "main" ]; then
            # ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨Commit SHAä½œä¸ºä¸»è¦æ ‡ç­¾ï¼ˆä¸å¯å˜ï¼‰ï¼ŒåŒæ—¶ä¿ç•™latestå’Œprod-stableä½œä¸ºè¾…åŠ©æ ‡ç­¾
            # ä¸»è¦æ ‡ç­¾ï¼š${FULL_SHA}ï¼ˆç¡®ä¿100%æ˜¯æ–°ä»£ç ï¼‰
            # è¾…åŠ©æ ‡ç­¾ï¼šlatest, prod-stableï¼ˆç”¨äºå¿«é€Ÿå¼•ç”¨ï¼‰
            BACKEND_TAGS="${REGISTRY}/${NAMESPACE}/backend:${FULL_SHA},${REGISTRY}/${NAMESPACE}/backend:latest,${REGISTRY}/${NAMESPACE}/backend:prod-stable"
            FRONTEND_TAGS="${REGISTRY}/${NAMESPACE}/frontend:${FULL_SHA},${REGISTRY}/${NAMESPACE}/frontend:latest,${REGISTRY}/${NAMESPACE}/frontend:prod-stable"
            VERSION=${FULL_SHA}
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            # å¼€å‘ç¯å¢ƒï¼šä½¿ç”¨Commit SHAä½œä¸ºä¸»è¦æ ‡ç­¾ï¼ˆä¸å¯å˜ï¼‰ï¼ŒåŒæ—¶ä¿ç•™devå’Œdev-stableä½œä¸ºè¾…åŠ©æ ‡ç­¾
            # ä¸»è¦æ ‡ç­¾ï¼šdev-${FULL_SHA}ï¼ˆç¡®ä¿100%æ˜¯æ–°ä»£ç ï¼‰
            # è¾…åŠ©æ ‡ç­¾ï¼šdev, dev-stableï¼ˆç”¨äºå¿«é€Ÿå¼•ç”¨ï¼‰
            BACKEND_TAGS="${REGISTRY}/${NAMESPACE}/backend:dev-${FULL_SHA},${REGISTRY}/${NAMESPACE}/backend:dev,${REGISTRY}/${NAMESPACE}/backend:dev-stable"
            FRONTEND_TAGS="${REGISTRY}/${NAMESPACE}/frontend:dev-${FULL_SHA},${REGISTRY}/${NAMESPACE}/frontend:dev,${REGISTRY}/${NAMESPACE}/frontend:dev-stable"
            VERSION=dev-${FULL_SHA}
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi

          echo "backend_tags=${BACKEND_TAGS}" >> $GITHUB_OUTPUT
          echo "frontend_tags=${FRONTEND_TAGS}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "commit_sha=${FULL_SHA}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT

          echo "ğŸ“¦ Backendé•œåƒæ ‡ç­¾: ${BACKEND_TAGS}"
          echo "ğŸ“¦ Frontendé•œåƒæ ‡ç­¾: ${FRONTEND_TAGS}"
          echo "ğŸ·ï¸  ç‰ˆæœ¬å·ï¼ˆCommit SHAï¼‰: ${VERSION}"
          echo "ğŸ”– çŸ­SHA: ${SHORT_SHA}"

      - name: è®¾ç½®Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ALIYUN_REGISTRY_USERNAME }}
          password: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}

      - name: æ„å»ºå¹¶æ¨é€Backendé•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile.prod
          push: true
          tags: ${{ steps.tags.outputs.backend_tags }}
          labels: |
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.version=${{ steps.tags.outputs.version }}

      - name: æ„å»ºå¹¶æ¨é€Frontendé•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile.prod
          push: true
          tags: ${{ steps.tags.outputs.frontend_tags }}
          labels: |
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.version=${{ steps.tags.outputs.version }}

      - name: é•œåƒæ„å»ºæˆåŠŸé€šçŸ¥
        run: |
          echo "âœ… é•œåƒæ„å»ºæˆåŠŸï¼"
          echo ""
          echo "ğŸ·ï¸  ç‰ˆæœ¬: ${{ steps.tags.outputs.version }}"
          echo "ğŸŒ ç¯å¢ƒ: ${{ steps.tags.outputs.environment }}"
          echo ""
          echo "ğŸ“¦ Backendé•œåƒ:"
          echo "   ${{ steps.tags.outputs.backend_tags }}"
          echo ""
          echo "ğŸ“¦ Frontendé•œåƒ:"
          echo "   ${{ steps.tags.outputs.frontend_tags }}"
          echo ""
          echo "ğŸš€ è§¦å‘éƒ¨ç½²æµç¨‹..."

      - name: è§¦å‘éƒ¨ç½²å·¥ä½œæµ
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branch = context.ref.replace('refs/heads/', '');
            const environment = '${{ steps.tags.outputs.environment }}';
            
            console.log(`ğŸ“Œ å½“å‰åˆ†æ”¯: ${branch}`);
            console.log(`ğŸŒ ç›®æ ‡ç¯å¢ƒ: ${environment}`);
            
            if (branch === 'dev' && environment === 'dev') {
              console.log('ğŸš€ è§¦å‘å¼€å‘ç¯å¢ƒéƒ¨ç½²...');
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'deploy-dev.yml',
                ref: 'dev'
              });
              console.log('âœ… å¼€å‘ç¯å¢ƒéƒ¨ç½²å·¥ä½œæµå·²è§¦å‘');
            } else if (branch === 'main' && environment === 'production') {
              console.log('ğŸš€ è§¦å‘ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²...');
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'deploy-production.yml',
                ref: 'main'
              });
              console.log('âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å·¥ä½œæµå·²è§¦å‘');
            } else {
              console.log(`â­ï¸  è·³è¿‡éƒ¨ç½²ï¼ˆåˆ†æ”¯: ${branch}, ç¯å¢ƒ: ${environment}ï¼‰`);
            }
