name: "PR Validation Pipeline"

on:
  pull_request:
    branches:
      - dev
      - main
      - hotfix/*
      - release/*
    types: [opened, synchronize, reopened]

concurrency:
  group: pr-${{ github.ref }}-${{ github.base_ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20"
  PYTHON_VERSION: "3.11"

jobs:
  # æ™ºèƒ½æ£€æµ‹PRç±»å‹å’ŒéªŒè¯çº§åˆ«
  detect-pr-type:
    name: "Detect PR Type & Validation Level"
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      pr-type: ${{ steps.detect.outputs.type }}
      validation-level: ${{ steps.detect.outputs.level }}
      test-level: ${{ steps.detect.outputs.test-level }}
      quality-level: ${{ steps.detect.outputs.quality-level }}
      coverage-required: ${{ steps.detect.outputs.coverage-required }}

    steps:
      - name: Analyze PR Context
        id: detect
        run: |
          echo "ğŸ” Analyzing PR: ${{ github.head_ref }} â†’ ${{ github.base_ref }}"
          echo "PR Title: ${{ github.event.pull_request.title }}"
          echo "PR Body Length: $(echo '${{ github.event.pull_request.body }}' | wc -c)"

          # åˆ†æPRæ ‡é¢˜å’Œåˆ†æ”¯ååˆ¤æ–­ç±»å‹
          PR_TITLE="${{ github.event.pull_request.title }}"
          HEAD_BRANCH="${{ github.head_ref }}"
          BASE_BRANCH="${{ github.base_ref }}"

          if [[ "$BASE_BRANCH" == "main" ]]; then
            if [[ "$HEAD_BRANCH" == "dev" ]]; then
              # dev â†’ main: ç”Ÿäº§å‘å¸ƒ
              echo "type=production-release" >> $GITHUB_OUTPUT
              echo "level=strict" >> $GITHUB_OUTPUT
              echo "test-level=full" >> $GITHUB_OUTPUT
              echo "quality-level=strict" >> $GITHUB_OUTPUT
              echo "coverage-required=90" >> $GITHUB_OUTPUT
              echo "ğŸ­ Production Release PR detected"
              echo "   - Full test suite required"
              echo "   - Strict quality gates"
              echo "   - 90% coverage requirement"
            else
              # hotfix/emergency â†’ main: ç´§æ€¥ä¿®å¤
              echo "type=emergency-hotfix" >> $GITHUB_OUTPUT
              echo "level=emergency" >> $GITHUB_OUTPUT
              echo "test-level=medium" >> $GITHUB_OUTPUT
              echo "quality-level=standard" >> $GITHUB_OUTPUT
              echo "coverage-required=80" >> $GITHUB_OUTPUT
              echo "ğŸš¨ Emergency Hotfix PR detected"
              echo "   - Medium test suite"
              echo "   - Standard quality gates"
              echo "   - 80% coverage requirement"
            fi
          elif [[ "$BASE_BRANCH" == "dev" ]]; then
            # feature â†’ dev: åŠŸèƒ½é›†æˆ
            if [[ "$PR_TITLE" =~ (hotfix|urgent|critical|fix) ]] || [[ "$HEAD_BRANCH" =~ (hotfix|urgent|critical|fix) ]]; then
              echo "type=urgent-fix" >> $GITHUB_OUTPUT
              echo "level=urgent" >> $GITHUB_OUTPUT
              echo "test-level=medium" >> $GITHUB_OUTPUT
              echo "quality-level=standard" >> $GITHUB_OUTPUT
              echo "coverage-required=75" >> $GITHUB_OUTPUT
              echo "ğŸ”¥ Urgent Fix PR detected"
            else
              # æ£€æŸ¥æ˜¯å¦ä¸ºæ–‡æ¡£/é…ç½®PRï¼ˆé€šè¿‡PRæ ‡é¢˜åˆ¤æ–­ï¼‰
              if [[ "$PR_TITLE" =~ ^(docs|doc|chore|config): ]]; then
                echo "type=docs-config-pr" >> $GITHUB_OUTPUT
                echo "level=standard" >> $GITHUB_OUTPUT
                echo "test-level=medium" >> $GITHUB_OUTPUT
                echo "quality-level=standard" >> $GITHUB_OUTPUT
                echo "coverage-required=50" >> $GITHUB_OUTPUT
                echo "ğŸ“ Documentation/Config PR detected - Lower coverage requirement (50%)"
              else
                echo "type=feature-integration" >> $GITHUB_OUTPUT
                echo "level=standard" >> $GITHUB_OUTPUT
                echo "test-level=medium" >> $GITHUB_OUTPUT
                echo "quality-level=standard" >> $GITHUB_OUTPUT
                echo "coverage-required=80" >> $GITHUB_OUTPUT
                echo "ğŸš€ Feature Integration PR detected"
              fi
            fi
            echo "   - Medium test suite"
            echo "   - Standard quality gates"
            echo "   - Coverage requirement: ${{ steps.detect.outputs.coverage-required }}%"
          elif [[ "$BASE_BRANCH" =~ ^hotfix/ ]]; then
            # â†’ hotfix/*: ç´§æ€¥ä¿®å¤åˆ†æ”¯çš„PR
            echo "type=hotfix-pr" >> $GITHUB_OUTPUT
            echo "level=urgent" >> $GITHUB_OUTPUT
            echo "test-level=medium" >> $GITHUB_OUTPUT
            echo "quality-level=standard" >> $GITHUB_OUTPUT
            echo "coverage-required=80" >> $GITHUB_OUTPUT
            echo "ğŸš¨ Hotfix Branch PR detected"
            echo "   - Medium test suite"
            echo "   - Standard quality gates"
            echo "   - 80% coverage requirement"
          elif [[ "$BASE_BRANCH" =~ ^release/ ]]; then
            # â†’ release/*: å‘å¸ƒåˆ†æ”¯çš„PR
            echo "type=release-pr" >> $GITHUB_OUTPUT
            echo "level=strict" >> $GITHUB_OUTPUT
            echo "test-level=full" >> $GITHUB_OUTPUT
            echo "quality-level=strict" >> $GITHUB_OUTPUT
            echo "coverage-required=85" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Release Branch PR detected"
            echo "   - Full test suite"
            echo "   - Strict quality gates"
            echo "   - 85% coverage requirement"
          else
            # å…¶ä»–åˆ†æ”¯: è½»é‡éªŒè¯
            echo "type=other" >> $GITHUB_OUTPUT
            echo "level=basic" >> $GITHUB_OUTPUT
            echo "test-level=fast" >> $GITHUB_OUTPUT
            echo "quality-level=basic" >> $GITHUB_OUTPUT
            echo "coverage-required=70" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Other PR type detected - basic validation"
          fi

  # åˆ†æ”¯ä¿æŠ¤éªŒè¯
  branch-protection:
    name: "Branch Protection Validation"
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate Branch Protection Rules
        run: |
          echo "ğŸ”’ Validating branch protection rules..."

          # éªŒè¯mainåˆ†æ”¯åªèƒ½ä»devåˆ†æ”¯æ¥æ”¶PR
          if [[ "${{ github.base_ref }}" == "main" && "${{ github.head_ref }}" != "dev" ]]; then
            echo "âŒ BRANCH PROTECTION VIOLATION!"
            echo "   Only 'dev' branch is allowed to create PRs to 'main'"
            echo "   Source: ${{ github.head_ref }}"
            echo "   Target: ${{ github.base_ref }}"
            echo ""
            echo "ğŸ”‘ DOUBLE KEY SYSTEM:"
            echo "   - Key A: Cursor can only push to 'dev' branch"
            echo "   - Key B: Only 'dev' can create PRs to 'main'"
            echo ""
            echo "ğŸ“‹ Correct workflow:"
            echo "   1. Create feature branch from dev"
            echo "   2. Develop and test on feature branch"
            echo "   3. Create PR: feature â†’ dev"
            echo "   4. After merge, create PR: dev â†’ main"
            exit 1
          fi

          # æ£€æŸ¥æ˜¯å¦æœ‰åˆå¹¶å†²çªæ ‡è®°
          echo "Checking for conflict markers..."
          if find . -name "*.py" -o -name "*.js" -o -name "*.vue" -o -name "*.ts" | head -20 | xargs grep -l "<<<<<<< HEAD\|>>>>>>> \|=======" 2>/dev/null; then
            echo "âŒ Merge conflict markers detected in code!"
            echo "Please resolve all conflicts before proceeding."
            exit 1
          fi

          echo "âœ… Branch protection rules satisfied"

  # å¿«é€Ÿé¢„æ£€æŸ¥ (å¹¶è¡Œæ‰§è¡Œ)
  quick-validation:
    name: "Quick Pre-validation"
    needs: [detect-pr-type, branch-protection]
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-cached-env

      - name: Quick Syntax & Style Check
        run: |
          echo "âš¡ Running quick pre-validation checks..."

          # æ£€æŸ¥åŸºæœ¬è¯­æ³•é”™è¯¯
          echo "Checking frontend syntax..."
          npm run lint:frontend -- --quiet || echo "âš ï¸ Frontend lint issues detected"

          echo "Checking backend syntax..."
          cd backend && source .venv/bin/activate
          # åªæ£€æŸ¥ä¸¥é‡çš„è¯­æ³•é”™è¯¯
          flake8 . --select=E9,F63,F7,F82 --exclude=migrations,__pycache__,.venv || echo "âš ï¸ Backend syntax issues detected"

          echo "âœ… Quick validation completed"

      - name: Check PR Readiness
        run: |
          echo "ğŸ“‹ Checking PR readiness..."

          # æ£€æŸ¥PRæè¿°
          PR_BODY_LENGTH=$(echo '${{ github.event.pull_request.body }}' | wc -c)
          if [[ $PR_BODY_LENGTH -lt 50 ]]; then
            echo "âš ï¸ PR description is very short ($PR_BODY_LENGTH chars)"
            echo "Consider adding more details about the changes"
          fi

          # æ£€æŸ¥æ–‡ä»¶å˜æ›´æ•°é‡
          FILES_CHANGED=$(echo '${{ github.event.pull_request.changed_files }}')
          if [[ $FILES_CHANGED -gt 50 ]]; then
            echo "âš ï¸ Large PR detected: $FILES_CHANGED files changed"
            echo "Consider splitting into smaller PRs for easier review"
          fi

          echo "PR Analysis:"
          echo "  - Files changed: $FILES_CHANGED"
          echo "  - Description length: $PR_BODY_LENGTH chars"
          echo "  - Type: ${{ needs.detect-pr-type.outputs.pr-type }}"
          echo "  - Validation level: ${{ needs.detect-pr-type.outputs.validation-level }}"

  # V4åˆè§„å¼•æ“éªŒè¯
  compliance-validation:
    name: "V4 Compliance Validation"
    needs: [detect-pr-type, quick-validation]
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install pyyaml -q

      - name: Run V4 Compliance Check
        run: |
          echo "ğŸ” Running V4 compliance validation..."

          if [ -f ".compliance/runner.py" ]; then
            # è·å–PRä¸­ä¿®æ”¹çš„æ–‡ä»¶
            git fetch origin ${{ github.base_ref }}:${{ github.base_ref }} --depth=1
            CHANGED_FILES=$(git diff --name-only --diff-filter=ACM origin/${{ github.base_ref }}...HEAD || echo "")

            if [ -n "$CHANGED_FILES" ]; then
              echo "ğŸ“‹ Changed files:"
              echo "$CHANGED_FILES" | head -20

              # è¿è¡Œåˆè§„æ£€æŸ¥
              python .compliance/runner.py $(echo "$CHANGED_FILES" | tr '\n' ' ') || {
                echo ""
                echo "âŒ V4 Compliance validation failed!"
                echo ""
                echo "ğŸ“‹ å¸¸è§é—®é¢˜ï¼š"
                echo "  1. ä»£ç æ–‡ä»¶ç¼ºå°‘REQ-IDå…³è”"
                echo "  2. ä»£ç æ–‡ä»¶ç¼ºå°‘å¯¹åº”çš„æµ‹è¯•æ–‡ä»¶"
                echo "  3. ä»£ç æ–‡ä»¶ç¼ºå°‘Task-Masterä»»åŠ¡"
                echo "  4. PRDå…ƒæ•°æ®ä¸å®Œæ•´"
                echo "  5. åˆ é™¤åŠŸèƒ½æœªè·å¾—PRDæˆæƒ"
                echo ""
                echo "ğŸ’¡ ä¿®å¤å»ºè®®ï¼š"
                echo "  - åœ¨ä»£ç æ–‡ä»¶å¤´éƒ¨æ·»åŠ REQ-IDæ³¨é‡Š"
                echo "  - åˆ›å»ºå¯¹åº”çš„æµ‹è¯•æ–‡ä»¶"
                echo "  - è¿è¡ŒTask-Masterç”Ÿæˆä»»åŠ¡"
                echo "  - æ›´æ–°PRDå…ƒæ•°æ®"
                echo "  - å¦‚æœåˆ é™¤åŠŸèƒ½ï¼Œæ›´æ–°PRDçš„deletableå­—æ®µ"
                exit 1
              }
              echo "âœ… V4 Compliance validation passed"
            else
              echo "â„¹ï¸ No changed files to validate"
            fi
          else
            echo "â„¹ï¸ Compliance engine not installed, skipping validation"
          fi

      - name: Validate Traceability
        run: |
          echo "ğŸ”— Validating traceability chain..."

          # æ£€æŸ¥æäº¤æ¶ˆæ¯ä¸­æ˜¯å¦åŒ…å«REQ-ID
          COMMIT_MESSAGES=$(git log --format="%B" origin/${{ github.base_ref }}...HEAD)

          if echo "$COMMIT_MESSAGES" | grep -qE '\[REQ-\d{4}-\d{3}-[a-z0-9-]+\]'; then
            echo "âœ… REQ-ID found in commit messages"
          else
            echo "âš ï¸ No REQ-ID found in commit messages"
            echo "   Consider using format: [REQ-YYYY-NNN-slug] Task-X description"
          fi

  # è°ƒç”¨æµ‹è¯•å¥—ä»¶ç»„ä»¶
  test-execution:
    name: "Test Suite Execution"
    needs: [detect-pr-type, quick-validation, compliance-validation]
    uses: ./.github/workflows/test-suite.yml
    with:
      test-level: ${{ needs.detect-pr-type.outputs.test-level }}
      target-branch: ${{ github.base_ref }}
      coverage-required: ${{ needs.detect-pr-type.outputs.coverage-required }}

  # è°ƒç”¨è´¨é‡é—¨ç¦ç»„ä»¶
  quality-validation:
    name: "Quality Gates Validation"
    needs: [detect-pr-type, quick-validation]
    uses: ./.github/workflows/quality-gates.yml
    with:
      quality-level: ${{ needs.detect-pr-type.outputs.quality-level }}
      min-coverage: ${{ needs.detect-pr-type.outputs.coverage-required }}
      target-branch: ${{ github.base_ref }}

  # ç›®å½•ä¿æŠ¤æ£€æŸ¥
  directory-protection:
    name: "Directory Protection Check"
    needs: detect-pr-type
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check Directory Rules
        run: |
          echo "ğŸ“ Checking directory protection rules..."

          # æ£€æŸ¥æ ¹ç›®å½•æ–°å¢æ–‡ä»¶ï¼ˆå…è®¸åˆ é™¤ï¼‰
          # ä½¿ç”¨ --diff-filter=A åªæ£€æµ‹æ–°å¢æ–‡ä»¶
          BASE_REF="${{ github.base_ref || 'main' }}"
          echo "ğŸ“‹ æ¯”è¾ƒåŸºå‡†åˆ†æ”¯: origin/$BASE_REF"

          forbidden_files=$(git diff --name-only --diff-filter=A origin/$BASE_REF...HEAD | grep -E '^[^/]+\.(md|txt|test_.*\.py|.*_test\.py|\.keep|\.example)$' || true)
          if [ -n "$forbidden_files" ]; then
            echo "âŒ Root directory clutter detected:"
            echo "$forbidden_files"
            echo ""
            echo "ğŸ“‹ Please move files to appropriate directories:"
            echo "  - Documentation: docs/"
            echo "  - Tests: tests/ or */tests/"
            echo "  - Examples: examples/"
            exit 1
          fi

          # åˆ é™¤æ ¹ç›®å½•è¿è§„æ–‡ä»¶æ˜¯é¼“åŠ±çš„
          deleted_files=$(git diff --name-only --diff-filter=D origin/$BASE_REF...HEAD | grep -E '^[^/]+\.(md|txt|test_.*\.py|.*_test\.py|\.keep|\.example)$' || true)
          if [ -n "$deleted_files" ]; then
            echo "âœ… æ£€æµ‹åˆ°åˆ é™¤æ ¹ç›®å½•è¿è§„æ–‡ä»¶ï¼ˆé¼“åŠ±ï¼‰:"
            echo "$deleted_files"
          fi

          # æ£€æŸ¥å…³é”®æ–‡ä»¶ä¿®æ”¹
          protected_files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '^\.github/workflows/(pr-validation|push-validation|release-pipeline|test-suite|quality-gates)\.yml$' || true)
          if [ -n "$protected_files" ]; then
            echo "âš ï¸ Critical workflow files modified:"
            echo "$protected_files"
            echo ""
            echo "ğŸ” These files require extra review attention."
          fi

          echo "âœ… Directory protection check passed"

  # æœ€ç»ˆå®¡æ‰¹é—¨ç¦
  approval-gate:
    name: "Final Approval Gate"
    needs:
      [
        detect-pr-type,
        test-execution,
        quality-validation,
        directory-protection,
        compliance-validation,
      ]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Collect Validation Results
        run: |
          echo "## ğŸ¯ PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR Information:**" >> $GITHUB_STEP_SUMMARY
          echo "- Type: ${{ needs.detect-pr-type.outputs.pr-type }}" >> $GITHUB_STEP_SUMMARY
          echo "- Source â†’ Target: ${{ github.head_ref }} â†’ ${{ github.base_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- Validation Level: ${{ needs.detect-pr-type.outputs.validation-level }}" >> $GITHUB_STEP_SUMMARY
          echo "- Author: ${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æ”¶é›†å„ç»„ä»¶ç»“æœ
          TEST_RESULT="${{ needs.test-execution.result }}"
          TEST_OUTPUT="${{ needs.test-execution.outputs.test-results }}"
          QUALITY_RESULT="${{ needs.quality-validation.result }}"
          QUALITY_SCORE="${{ needs.quality-validation.outputs.quality-score }}"
          QUALITY_PASSED="${{ needs.quality-validation.outputs.gates-passed }}"
          DIRECTORY_RESULT="${{ needs.directory-protection.result }}"

          echo "**Validation Results:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | $TEST_RESULT | Level: ${{ needs.detect-pr-type.outputs.test-level }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Gates | $QUALITY_RESULT | Score: $QUALITY_SCORE/100 |" >> $GITHUB_STEP_SUMMARY
          echo "| Directory Protection | $DIRECTORY_RESULT | Rules validated |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # è®¡ç®—æ€»ä½“ç»“æœ
          OVERALL_SUCCESS=true

          if [[ "$TEST_RESULT" != "success" || "$TEST_OUTPUT" != "success" ]]; then
            OVERALL_SUCCESS=false
            echo "âŒ Test suite validation failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "$QUALITY_RESULT" != "success" || "$QUALITY_PASSED" != "true" ]]; then
            OVERALL_SUCCESS=false
            echo "âŒ Quality gates validation failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "$DIRECTORY_RESULT" != "success" ]]; then
            OVERALL_SUCCESS=false
            echo "âŒ Directory protection validation failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "$OVERALL_SUCCESS" == "true" ]]; then
            echo "## âœ… PR Validation PASSED!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‰ All automated validations have passed successfully." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ“‹ Next Steps:" >> $GITHUB_STEP_SUMMARY

            if [[ "${{ needs.detect-pr-type.outputs.pr-type }}" == "production-release" ]]; then
              echo "- **PRODUCTION RELEASE**: This PR requires manual review by a senior maintainer" >> $GITHUB_STEP_SUMMARY
              echo "- All quality gates passed with strict validation" >> $GITHUB_STEP_SUMMARY
              echo "- Human approval is mandatory before merge" >> $GITHUB_STEP_SUMMARY
            elif [[ "${{ needs.detect-pr-type.outputs.pr-type }}" == "emergency-hotfix" ]]; then
              echo "- **EMERGENCY HOTFIX**: Expedited review process" >> $GITHUB_STEP_SUMMARY
              echo "- Consider immediate deployment after merge" >> $GITHUB_STEP_SUMMARY
              echo "- Monitor production closely after deployment" >> $GITHUB_STEP_SUMMARY
            else
              echo "- Request review from team members" >> $GITHUB_STEP_SUMMARY
              echo "- Address any review feedback" >> $GITHUB_STEP_SUMMARY
              echo "- Merge when approved" >> $GITHUB_STEP_SUMMARY
            fi

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ›¡ï¸ Validation Details:" >> $GITHUB_STEP_SUMMARY
            echo "- Test Level: ${{ needs.detect-pr-type.outputs.test-level }}" >> $GITHUB_STEP_SUMMARY
            echo "- Quality Level: ${{ needs.detect-pr-type.outputs.quality-level }}" >> $GITHUB_STEP_SUMMARY
            echo "- Coverage Requirement: ${{ needs.detect-pr-type.outputs.coverage-required }}%" >> $GITHUB_STEP_SUMMARY
            echo "- Quality Score: $QUALITY_SCORE/100" >> $GITHUB_STEP_SUMMARY

            echo "PR validation completed successfully"
          else
            echo "## âŒ PR Validation FAILED!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸš« Some automated validations have failed. Please address the issues above." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ”§ Recommended Actions:" >> $GITHUB_STEP_SUMMARY

            if [[ "$TEST_RESULT" != "success" ]]; then
              echo "- Fix failing tests in the test suite" >> $GITHUB_STEP_SUMMARY
              echo "- Ensure test coverage meets the ${{ needs.detect-pr-type.outputs.coverage-required }}% requirement" >> $GITHUB_STEP_SUMMARY
            fi

            if [[ "$QUALITY_RESULT" != "success" ]]; then
              echo "- Address code quality issues (lint, security, performance)" >> $GITHUB_STEP_SUMMARY
              echo "- Improve quality score to meet ${{ needs.detect-pr-type.outputs.quality-level }} level requirements" >> $GITHUB_STEP_SUMMARY
            fi

            if [[ "$DIRECTORY_RESULT" != "success" ]]; then
              echo "- Move files to appropriate directories" >> $GITHUB_STEP_SUMMARY
              echo "- Follow project directory structure guidelines" >> $GITHUB_STEP_SUMMARY
            fi

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ’¡ After fixing the issues, push new commits to automatically re-run validation." >> $GITHUB_STEP_SUMMARY

            echo "PR validation failed - please fix issues"
            exit 1
          fi

  # PRæ ‡ç­¾ç®¡ç†
  manage-pr-labels:
    name: "Manage PR Labels"
    needs: [detect-pr-type, approval-gate]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Add PR Labels
        uses: actions/github-script@v7
        with:
          script: |
            const prType = '${{ needs.detect-pr-type.outputs.pr-type }}';
            const validationLevel = '${{ needs.detect-pr-type.outputs.validation-level }}';
            const overallSuccess = '${{ needs.approval-gate.result }}' === 'success';

            const labels = [];

            // æ·»åŠ ç±»å‹æ ‡ç­¾
            switch(prType) {
              case 'production-release':
                labels.push('ğŸ­ production-release', 'ğŸ”¥ critical');
                break;
              case 'emergency-hotfix':
                labels.push('ğŸš¨ hotfix', 'âš¡ urgent');
                break;
              case 'urgent-fix':
                labels.push('ğŸ”¥ urgent-fix');
                break;
              case 'feature-integration':
                labels.push('âœ¨ feature');
                break;
            }

            // æ·»åŠ çŠ¶æ€æ ‡ç­¾
            if (overallSuccess) {
              labels.push('âœ… validation-passed');
            } else {
              labels.push('âŒ validation-failed');
            }

            // æ·»åŠ éªŒè¯çº§åˆ«æ ‡ç­¾
            labels.push(`ğŸ¯ ${validationLevel}-validation`);

            console.log('Adding labels:', labels);

            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labels
              });
            } catch (error) {
              console.log('Error adding labels:', error.message);
              // ä¸å› ä¸ºæ ‡ç­¾å¤±è´¥è€Œå¯¼è‡´æ•´ä¸ªå·¥ä½œæµå¤±è´¥
            }
