name: Integration Tests - Optimized

on:
  workflow_call:
    inputs:
      timeout:
        description: "Job timeout in minutes"
        type: number
        default: 8

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"
  MYSQL_DATABASE: bravo_test
  MYSQL_USER: bravo_user
  MYSQL_PASSWORD: bravo_password
  MYSQL_ROOT_PASSWORD: root_password

jobs:
  # ğŸš€ Phase 2 ä¼˜åŒ–ï¼šå…±äº«æœåŠ¡å¯åŠ¨
  setup-services:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      services-ready: ${{ steps.services.outputs.ready }}

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: bravo_test
          MYSQL_USER: bravo_user
          MYSQL_PASSWORD: bravo_password
          MYSQL_ROOT_PASSWORD: root_password
        options: --health-cmd="mysqladmin ping -h 127.0.0.1 -P 3306 -u root -proot_password" --health-interval=5s --health-timeout=3s --health-retries=20
        ports:
          - 3306:3306

      redis:
        image: redis:7-alpine
        options: --health-cmd="redis-cli ping" --health-interval=5s --health-timeout=3s --health-retries=10
        ports:
          - 6379:6379

    steps:
      - name: Verify Services
        id: services
        run: |
          echo "Services are ready via health checks!"
          echo "ready=true" >> $GITHUB_OUTPUT

  # ğŸš€ Phase 2 ä¼˜åŒ–ï¼šå¹¶è¡Œæ‰§è¡ŒBackendé›†æˆæµ‹è¯•
  backend-integration:
    needs: setup-services
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.timeout }}

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: bravo_test
          MYSQL_USER: bravo_user
          MYSQL_PASSWORD: bravo_password
          MYSQL_ROOT_PASSWORD: root_password
        options: --health-cmd="mysqladmin ping -h 127.0.0.1 -P 3306 -u root -proot_password" --health-interval=5s --health-timeout=3s --health-retries=10
        ports:
          - 3306:3306

      redis:
        image: redis:7-alpine
        options: --health-cmd="redis-cli ping" --health-interval=5s --health-timeout=3s --health-retries=5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Restore Backend Dependencies
        uses: actions/cache@v4
        with:
          path: |
            backend/.venv
            ~/.cache/pip
          key: backend-deps-v3-${{ runner.os }}-${{ hashFiles('backend/requirements/*.txt') }}
          restore-keys: |
            backend-deps-v3-${{ runner.os }}-

      - name: Install Backend Dependencies
        working-directory: ./backend
        run: |
          if [ ! -d ".venv" ]; then
            echo "Installing backend dependencies..."
            python -m venv .venv
            source .venv/bin/activate
            pip install --upgrade pip wheel
            pip install -r requirements/base.txt -r requirements/test.txt
          else
            echo "Using cached backend dependencies"
          fi

      - name: Setup Test Database (Optimized)
        run: |
          echo "Setting up test database with optimized settings..."
          mysql -h 127.0.0.1 -P 3306 -u root -proot_password -e "
            CREATE DATABASE IF NOT EXISTS bravo_test
            CHARACTER SET utf8mb4
            COLLATE utf8mb4_unicode_ci;
            GRANT ALL PRIVILEGES ON bravo_test.* TO 'bravo_user'@'%';
            FLUSH PRIVILEGES;
          "

      - name: Run Database Migrations (Cached)
        working-directory: ./backend
        run: |
          source .venv/bin/activate
          echo "Running optimized Django migrations..."
          python manage.py migrate --settings=bravo.settings.test --run-syncdb
          echo "Database migrations completed"
        env:
          DATABASE_URL: mysql://bravo_user:bravo_password@127.0.0.1:3306/bravo_test

      - name: Run Backend Integration Tests
        working-directory: ./backend
        run: |
          source .venv/bin/activate
          echo "Running backend integration tests..."

          python -m pytest tests/integration/ \
            --cov=apps --cov-report=xml \
            --maxfail=3 -v --tb=short
        env:
          DATABASE_URL: mysql://bravo_user:bravo_password@127.0.0.1:3306/bravo_test
          REDIS_URL: redis://127.0.0.1:6379/0
          DJANGO_SETTINGS_MODULE: bravo.settings.test

      - name: Upload Backend Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-integration-results
          path: |
            backend/coverage.xml
            backend/htmlcov/
          retention-days: 3

  # ğŸš€ Phase 2 ä¼˜åŒ–ï¼šå¹¶è¡Œæ‰§è¡ŒFrontendé›†æˆæµ‹è¯•
  frontend-integration:
    needs: setup-services
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.timeout }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore Dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            frontend/node_modules
            ~/.npm
          key: frontend-deps-v3-${{ runner.os }}-${{ hashFiles('package-lock.json', 'frontend/package-lock.json') }}
          restore-keys: |
            frontend-deps-v3-${{ runner.os }}-

      - name: Install Dependencies
        run: |
          if [ ! -d "node_modules" ]; then
            echo "Installing npm workspaces dependencies..."
            npm ci --prefer-offline --no-audit
          else
            echo "Using cached frontend dependencies"
          fi

      - name: Build Frontend (Cached)
        run: |
          echo "Building frontend for integration tests..."
          npm run build:frontend

      - name: Run Frontend Integration Tests
        run: |
          echo "Running frontend integration tests..."
          npm run test:frontend -- --reporter=json --outputFile=frontend-results.json

      - name: Upload Frontend Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-integration-results
          path: |
            frontend/coverage/
            frontend-results.json
          retention-days: 3

  # ğŸš€ Phase 2 ä¼˜åŒ–ï¼šè½»é‡åŒ–APIæµ‹è¯•
  api-integration:
    needs: [backend-integration, frontend-integration]
    runs-on: ubuntu-latest
    timeout-minutes: 3

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: bravo_test
          MYSQL_USER: bravo_user
          MYSQL_PASSWORD: bravo_password
          MYSQL_ROOT_PASSWORD: root_password
        options: --health-cmd="mysqladmin ping -h 127.0.0.1 -P 3306 -u root -proot_password" --health-interval=5s --health-timeout=3s --health-retries=10
        ports:
          - 3306:3306

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Restore Backend Dependencies
        uses: actions/cache@v4
        with:
          path: |
            backend/.venv
            ~/.cache/pip
          key: backend-deps-v3-${{ runner.os }}-${{ hashFiles('backend/requirements/*.txt') }}

      - name: Quick API Health Test
        working-directory: ./backend
        run: |
          source .venv/bin/activate

          # å¤ç”¨ä¹‹å‰çš„æ•°æ®åº“çŠ¶æ€ï¼Œåªè¿è¡Œå¿…è¦çš„è¿ç§»
          python manage.py migrate --settings=bravo.settings.test --fake-initial

          # å¯åŠ¨æœåŠ¡å™¨ç”¨äºAPIæµ‹è¯•
          python manage.py runserver 8000 --settings=bravo.settings.test &
          SERVER_PID=$!

          # ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨ (ä¼˜åŒ–ç­‰å¾…ç­–ç•¥)
          for i in {1..15}; do
            if curl -s http://localhost:8000/health/ > /dev/null; then
              echo "âœ… Server is ready after ${i} attempts"
              break
            fi
            sleep 1
          done

          # è¿è¡Œæ ¸å¿ƒAPIæµ‹è¯•
          echo "Running essential API integration tests..."
          curl -f http://localhost:8000/health/ || exit 1
          curl -f http://localhost:8000/api-info/ || echo "API-info endpoint not available"

          # æ¸…ç†
          kill $SERVER_PID 2>/dev/null || true
          echo "âœ… API integration tests completed"
        env:
          DATABASE_URL: mysql://bravo_user:bravo_password@127.0.0.1:3306/bravo_test
          DJANGO_SETTINGS_MODULE: bravo.settings.test

  # æ±‡æ€»ç»“æœ
  integration-summary:
    needs: [backend-integration, frontend-integration, api-integration]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 1

    steps:
      - name: Integration Test Summary
        run: |
          echo "ğŸš€ Phase 2 Optimized Integration Test Summary:"
          echo "- âš¡ Parallel execution: Backend + Frontend simultaneously"
          echo "- ğŸ”§ Optimized database operations and caching"
          echo "- ğŸš€ Enhanced service startup with better health checks"
          echo "- ğŸ’¾ Improved dependency caching strategies"
          echo ""
          echo "Backend Status: ${{ needs.backend-integration.result }}"
          echo "Frontend Status: ${{ needs.frontend-integration.result }}"
          echo "API Status: ${{ needs.api-integration.result }}"

          # æ£€æŸ¥æ•´ä½“ç»“æœ
          if [[ "${{ needs.backend-integration.result }}" == "success" && \
                "${{ needs.frontend-integration.result }}" == "success" && \
                "${{ needs.api-integration.result }}" == "success" ]]; then
            echo "âœ… All integration tests passed!"
            exit 0
          else
            echo "âŒ Some integration tests failed"
            exit 1
          fi
