name: Regression Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œå›å½’æµ‹è¯•
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      test_type:
        description: "æµ‹è¯•ç±»å‹"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - api
          - ui
          - db
      update_baselines:
        description: "æ›´æ–°åŸºçº¿å¿«ç…§"
        required: false
        default: false
        type: boolean

jobs:
  regression-tests:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: bravo_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:6
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Install Python dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Install Node.js dependencies
        run: |
          cd frontend
          npm ci
          cd ../e2e
          npm ci
          npm install -g playwright

      - name: Install Playwright browsers
        run: |
          cd e2e
          npx playwright install --with-deps

      - name: Setup test database
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/bravo_test
        run: |
          cd backend
          python manage.py migrate
          python manage.py loaddata fixtures/test_data.json

      - name: Start backend server
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/bravo_test
          REDIS_URL: redis://localhost:6379/0
          DEBUG: true
        run: |
          cd backend
          python manage.py runserver 8000 &
          sleep 10

      - name: Start frontend server
        run: |
          cd frontend
          npm run build
          npm run preview &
          sleep 10

      - name: Wait for servers to be ready
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:8000/api/health; do sleep 2; done'
          timeout 60 bash -c 'until curl -f http://localhost:3000; do sleep 2; done'

      - name: Run regression tests (All)
        if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == ''
        run: |
          node tests/regression/run-regression.js ${{ github.event.inputs.update_baselines == 'true' && '--update-snapshots' || '' }}

      - name: Run API regression tests
        if: github.event.inputs.test_type == 'api'
        run: |
          node tests/regression/run-regression.js --api-only ${{ github.event.inputs.update_baselines == 'true' && '--update-snapshots' || '' }}

      - name: Run UI regression tests
        if: github.event.inputs.test_type == 'ui'
        run: |
          node tests/regression/run-regression.js --ui-only ${{ github.event.inputs.update_baselines == 'true' && '--update-snapshots' || '' }}

      - name: Run Database regression tests
        if: github.event.inputs.test_type == 'db'
        run: |
          node tests/regression/run-regression.js --db-only ${{ github.event.inputs.update_baselines == 'true' && '--update-snapshots' || '' }}

      - name: Upload regression test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: regression-test-reports-node-${{ matrix.node-version }}
          path: |
            tests/regression/reports/
            tests/regression/data/snapshots/
          retention-days: 30

      - name: Upload Playwright traces
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-traces-node-${{ matrix.node-version }}
          path: tests/regression/reports/playwright-traces/
          retention-days: 7

      - name: Comment PR with regression test results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = './tests/regression/reports/regression-report.json';

            if (fs.existsSync(path)) {
              const report = JSON.parse(fs.readFileSync(path, 'utf8'));
              const summary = report.summary;

              const body = `## ğŸ§ª å›å½’æµ‹è¯•ç»“æœ

              **æµ‹è¯•ç¯å¢ƒ**: Node.js ${{ matrix.node-version }}
              **æµ‹è¯•æ—¶é—´**: ${report.timestamp}

              ### ğŸ“Š æµ‹è¯•ç»Ÿè®¡
              - âœ… **é€šè¿‡**: ${summary.passed}
              - âŒ **å¤±è´¥**: ${summary.failed}
              - âš ï¸ **é”™è¯¯**: ${summary.errors}
              - ğŸ“¸ **æ–°åŸºçº¿**: ${summary.baselines}
              - ğŸ“ˆ **æ€»è®¡**: ${summary.total}

              ### ğŸ“‹ æµ‹è¯•è¯¦æƒ…
              ${summary.failed > 0 || summary.errors > 0 ?
                'âš ï¸ **å­˜åœ¨å¤±è´¥çš„æµ‹è¯•ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š**' :
                'ğŸ‰ **æ‰€æœ‰å›å½’æµ‹è¯•é€šè¿‡ï¼**'
              }

              [æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              `;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }

      - name: Fail job if regression tests failed
        run: |
          if [ -f "tests/regression/reports/regression-report.json" ]; then
            FAILED=$(cat tests/regression/reports/regression-report.json | jq '.summary.failed + .summary.errors')
            if [ "$FAILED" -gt 0 ]; then
              echo "âŒ Regression tests failed: $FAILED test(s)"
              exit 1
            fi
          fi

  # åŸºçº¿æ›´æ–°ä½œä¸šï¼ˆä»…åœ¨æ‰‹åŠ¨è§¦å‘ä¸”é€‰æ‹©æ›´æ–°åŸºçº¿æ—¶è¿è¡Œï¼‰
  update-baselines:
    runs-on: ubuntu-latest
    if: github.event.inputs.update_baselines == 'true' && github.event_name == 'workflow_dispatch'
    needs: regression-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download regression test artifacts
        uses: actions/download-artifact@v4
        with:
          name: regression-test-reports-node-20.x
          path: ./artifacts/

      - name: Update baselines
        run: |
          # å¤åˆ¶æ–°çš„å¿«ç…§åˆ°åŸºçº¿ç›®å½•
          if [ -d "./artifacts/tests/regression/data/snapshots" ]; then
            cp -r ./artifacts/tests/regression/data/snapshots/* tests/regression/config/baselines/ || true
          fi

      - name: Commit updated baselines
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          if [ -n "$(git status --porcelain)" ]; then
            git add tests/regression/config/baselines/
            git commit -m "chore: update regression test baselines [skip ci]"
            git push
          else
            echo "No baseline changes to commit"
          fi

  # æ€§èƒ½è¶‹åŠ¿åˆ†æï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
  performance-analysis:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    needs: regression-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download regression test reports
        uses: actions/download-artifact@v4
        with:
          name: regression-test-reports-node-20.x
          path: ./reports/

      - name: Analyze performance trends
        run: |
          # è¿™é‡Œå¯ä»¥æ·»åŠ æ€§èƒ½è¶‹åŠ¿åˆ†æè„šæœ¬
          echo "ğŸ“ˆ Performance trend analysis would run here"
          # ä¾‹å¦‚ï¼šæ¯”è¾ƒAPIå“åº”æ—¶é—´ã€UIæ¸²æŸ“æ—¶é—´ç­‰

      - name: Create performance report
        run: |
          echo "ğŸ“Š Creating performance trend report..."
          # ç”Ÿæˆæ€§èƒ½è¶‹åŠ¿æŠ¥å‘Š

      - name: Upload performance report
        uses: actions/upload-artifact@v4
        with:
          name: performance-trend-report
          path: ./reports/performance-trend.json
          retention-days: 90
