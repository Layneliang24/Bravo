# ğŸ”’ é»„é‡‘testä¿æŠ¤å·¥ä½œæµ
# æ­¤å·¥ä½œæµç¡®ä¿é»„é‡‘testç›®å½•ä¸è¢«æ„å¤–ä¿®æ”¹

name: ğŸ”’ Golden Test Protection

on:
  pull_request:
    branches: [main, develop]
    paths:
      - "tests-golden/**"
  push:
    branches: [main, develop]
    paths:
      - "tests-golden/**"

jobs:
  golden-test-guard:
    name: ğŸ›¡ï¸ é»„é‡‘testä¿æŠ¤æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ä»¥è¿›è¡Œå·®å¼‚æ¯”è¾ƒ

      - name: ğŸ” æ£€æŸ¥é»„é‡‘testä¿®æ”¹
        run: |
          echo "ğŸ” æ£€æŸ¥é»„é‡‘testç›®å½•çš„ä¿®æ”¹..."

          # è·å–ä¿®æ”¹çš„æ–‡ä»¶åˆ—è¡¨
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          fi

          echo "ä¿®æ”¹çš„æ–‡ä»¶ï¼š"
          echo "$CHANGED_FILES"

          # æ£€æŸ¥æ˜¯å¦æœ‰å¯¹é»„é‡‘testçš„ä¿®æ”¹
          GOLDEN_CHANGES=$(echo "$CHANGED_FILES" | grep "^tests-golden/" || true)

          if [ -n "$GOLDEN_CHANGES" ]; then
            echo "âŒ detectåˆ°å¯¹é»„é‡‘testç›®å½•çš„ä¿®æ”¹ï¼"
            echo ""
            echo "ğŸ”’ é»„é‡‘testç›®å½•å—åˆ°ä¿æŠ¤ï¼Œä¸å…è®¸é€šè¿‡è‡ªåŠ¨åŒ–æµç¨‹ä¿®æ”¹ã€‚"
            echo ""
            echo "è¢«ä¿®æ”¹çš„é»„é‡‘testæ–‡ä»¶ï¼š"
            echo "$GOLDEN_CHANGES" | sed 's/^/  - /'
            echo ""
            echo "å¦‚æœè¿™æ˜¯å¿…è¦çš„ä¿®æ”¹ï¼Œè¯·ï¼š"
            echo "1. ç¡®ä¿ä¿®æ”¹ç»è¿‡å……åˆ†çš„ä»£ç å®¡æŸ¥"
            echo "2. åœ¨ PR æè¿°ä¸­è¯¦ç»†è¯´æ˜ä¿®æ”¹åŸå› "
            echo "3. è·å¾—é¡¹ç›®ç»´æŠ¤è€…çš„æ˜ç¡®æ‰¹å‡†"
            echo ""

            # æ£€æŸ¥ PR æè¿°æ˜¯å¦åŒ…å«é»„é‡‘testä¿®æ”¹è¯´æ˜
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              PR_BODY="${{ github.event.pull_request.body }}"
              if [[ "$PR_BODY" == *"[GOLDEN-TEST]"* ]] || [[ "$PR_BODY" == *"é»„é‡‘test"* ]]; then
                echo "âœ… PR æè¿°ä¸­åŒ…å«é»„é‡‘testä¿®æ”¹è¯´æ˜"
                echo "âš ï¸  è¯·ç¡®ä¿å·²è·å¾—ç»´æŠ¤è€…æ‰¹å‡†"
              else
                echo "âŒ PR æè¿°ä¸­ç¼ºå°‘é»„é‡‘testä¿®æ”¹è¯´æ˜"
                echo "è¯·åœ¨ PR æè¿°ä¸­æ·»åŠ  [GOLDEN-TEST] æ ‡ç­¾å¹¶è¯´æ˜ä¿®æ”¹åŸå› "
                exit 1
              fi
            fi
          else
            echo "âœ… æœªdetectåˆ°å¯¹é»„é‡‘testçš„ä¿®æ”¹"
          fi

      - name: ğŸ§ª validateé»„é‡‘testå®Œæ•´æ€§
        run: |
          echo "ğŸ§ª validateé»„é‡‘testæ–‡ä»¶å®Œæ•´æ€§..."

          # æ£€æŸ¥å¿…éœ€çš„é»„é‡‘testæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          REQUIRED_FILES=(
            "tests-golden/README.md"
            "tests-golden/config/playwright.config.ts"
            "tests-golden/e2e/blog.spec.ts"
            "tests-golden/backend/test_user_core.py"
            "tests-golden/frontend/auth-components.test.tsx"
          )

          MISSING_FILES=()
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              MISSING_FILES+=("$file")
            fi
          done

          if [ ${#MISSING_FILES[@]} -gt 0 ]; then
            echo "âŒ detectåˆ°ç¼ºå¤±çš„é»„é‡‘testæ–‡ä»¶ï¼š"
            printf '  - %s\n' "${MISSING_FILES[@]}"
            echo ""
            echo "é»„é‡‘testæ–‡ä»¶ä¸èƒ½è¢«åˆ é™¤ï¼"
            exit 1
          fi

          echo "âœ… é»„é‡‘testæ–‡ä»¶å®Œæ•´æ€§validateé€šè¿‡"

      - name: ğŸ“Š ç”Ÿæˆé»„é‡‘testæŠ¥å‘Š
        if: github.event_name == 'pull_request'
        run: |
          echo "ğŸ“Š ç”Ÿæˆé»„é‡‘testä¿æŠ¤æŠ¥å‘Š..."

          # ç»Ÿè®¡é»„é‡‘testæ–‡ä»¶æ•°é‡
          TOTAL_FILES=$(find tests-golden -type f -name "*.ts" -o -name "*.tsx" -o -name "*.py" -o -name "*.js" | wc -l)
          E2E_FILES=$(find tests-golden/e2e -type f -name "*.spec.ts" 2>/dev/null | wc -l || echo 0)
          BACKEND_FILES=$(find tests-golden/backend -type f -name "*.py" 2>/dev/null | wc -l || echo 0)
          FRONTEND_FILES=$(find tests-golden/frontend -type f -name "*.test.*" 2>/dev/null | wc -l || echo 0)

          echo "## ğŸ”’ é»„é‡‘testä¿æŠ¤æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ç±»å‹ | æ–‡ä»¶æ•°é‡ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| æ€»è®¡ | $TOTAL_FILES |" >> $GITHUB_STEP_SUMMARY
          echo "| E2Etest | $E2E_FILES |" >> $GITHUB_STEP_SUMMARY
          echo "| åç«¯test | $BACKEND_FILES |" >> $GITHUB_STEP_SUMMARY
          echo "| å‰ç«¯test | $FRONTEND_FILES |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… é»„é‡‘testä¿æŠ¤æ£€æŸ¥é€šè¿‡" >> $GITHUB_STEP_SUMMARY

  # å¦‚æœæœ‰é»„é‡‘testä¿®æ”¹ï¼Œéœ€è¦é¢å¤–çš„å®¡æŸ¥
  require-approval:
    name: ğŸ” éœ€è¦ç‰¹æ®Šå®¡æ‰¹
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: golden-test-guard

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” æ£€æŸ¥æ˜¯å¦éœ€è¦ç‰¹æ®Šå®¡æ‰¹
        run: |
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
          GOLDEN_CHANGES=$(echo "$CHANGED_FILES" | grep "^tests-golden/" || true)

          if [ -n "$GOLDEN_CHANGES" ]; then
            echo "âš ï¸  æ­¤ PR ä¿®æ”¹äº†é»„é‡‘testï¼Œéœ€è¦é¡¹ç›®ç»´æŠ¤è€…çš„ç‰¹æ®Šå®¡æ‰¹"
            echo "è¯·ç¡®ä¿ï¼š"
            echo "1. ä¿®æ”¹å·²ç»è¿‡å……åˆ†çš„ä»£ç å®¡æŸ¥"
            echo "2. ä¿®æ”¹åŸå› å·²åœ¨ PR ä¸­è¯¦ç»†è¯´æ˜"
            echo "3. è·å¾—äº†é¡¹ç›®ç»´æŠ¤è€…çš„æ˜ç¡®æ‰¹å‡†"

            # è¿™é‡Œå¯ä»¥æ·»åŠ è‡ªåŠ¨è¯·æ±‚å®¡æŸ¥è€…çš„é€»è¾‘
            # æˆ–è€…è®¾ç½®ç‰¹å®šçš„æ ‡ç­¾
          else
            echo "âœ… æ­¤ PR æœªä¿®æ”¹é»„é‡‘testï¼Œæ— éœ€ç‰¹æ®Šå®¡æ‰¹"
          fi
