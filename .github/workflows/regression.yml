name: Regression Gate

# å›å½’æµ‹è¯•é—¨ç¦ - ç¡®ä¿æ–°åŠŸèƒ½ä¸ä¼šç ´åå·²æœ‰åŠŸèƒ½
# ä»»ä½•PRéƒ½å¿…é¡»é€šè¿‡å›å½’æµ‹è¯•æ‰èƒ½åˆå¹¶

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]
  # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œå›å½’æµ‹è¯•
  schedule:
    - cron: "0 2 * * *"

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20.x"
  MYSQL_DATABASE: bravo_test
  MYSQL_USER: bravo_user
  MYSQL_PASSWORD: bravo_password

jobs:
  # åç«¯å›å½’æµ‹è¯• - æ ¸å¿ƒåŠŸèƒ½ä¿æŠ¤
  backend-regression:
    name: ğŸ”’ Backend Regression Tests
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: bravo_test
          MYSQL_USER: bravo_user
          MYSQL_PASSWORD: bravo_password
          MYSQL_ROOT_PASSWORD: root_password
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
        ports:
          - 3306:3306

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: ğŸ”§ Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: ğŸ—„ï¸ Setup database
        working-directory: ./backend
        env:
          DATABASE_URL: mysql://bravo_user:bravo_password@127.0.0.1:3306/bravo_test
        run: |
          python manage.py migrate --settings=config.settings.test

      - name: ğŸ”’ Run REGRESSION TESTS ONLY
        working-directory: ./backend
        env:
          DATABASE_URL: mysql://bravo_user:bravo_password@127.0.0.1:3306/bravo_test
          DJANGO_SETTINGS_MODULE: config.settings.test
        run: |
          echo "ğŸš¨ Running REGRESSION TESTS - Core functionality protection"
          echo "ğŸ“‹ These tests MUST pass for PR to be merged"

          # åªè¿è¡Œå›å½’æµ‹è¯•æ–‡ä»¶
          python -m pytest tests/test_regression.py -v \
            --tb=short \
            --strict-markers \
            --disable-warnings \
            --maxfail=1 \
            --junit-xml=regression-results.xml

          echo "âœ… All regression tests passed!"

      - name: ğŸ“Š Upload regression test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: backend-regression-results
          path: backend/regression-results.xml

  # å‰ç«¯å›å½’æµ‹è¯•
  frontend-regression:
    name: ğŸ”’ Frontend Regression Tests
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: ğŸ“¦ Install dependencies
        working-directory: ./frontend
        run: npm install --ignore-scripts

      - name: ğŸ”’ Run Frontend Regression Tests
        working-directory: ./frontend
        run: |
          echo "ğŸš¨ Running FRONTEND REGRESSION TESTS"
          echo "ğŸ“‹ Testing core UI functionality"

          # è¿è¡Œæ ‡è®°ä¸ºå›å½’æµ‹è¯•çš„ç”¨ä¾‹
          npm run test -- --reporter=junit --outputFile=regression-results.xml --testNamePattern="regression|æ ¸å¿ƒ|core"

          echo "âœ… Frontend regression tests passed!"

      - name: ğŸ“Š Upload frontend regression results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: frontend-regression-results
          path: frontend/regression-results.xml

  # E2Eå›å½’æµ‹è¯•
  e2e-regression:
    name: ğŸ”’ E2E Regression Tests
    runs-on: ubuntu-latest
    needs: [backend-regression, frontend-regression]

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: bravo_test
          MYSQL_USER: bravo_user
          MYSQL_PASSWORD: bravo_password
          MYSQL_ROOT_PASSWORD: root_password
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
        ports:
          - 3306:3306

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸŸ¢ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ”§ Install backend dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ“¦ Install E2E dependencies
        working-directory: ./e2e
        run: |
          npm install
          npx playwright install --with-deps

      - name: ğŸ—„ï¸ Setup test database
        working-directory: ./backend
        env:
          DATABASE_URL: mysql://bravo_user:bravo_password@127.0.0.1:3306/bravo_test
        run: |
          python manage.py migrate --settings=config.settings.test

      - name: ğŸš€ Start backend server
        working-directory: ./backend
        env:
          DATABASE_URL: mysql://bravo_user:bravo_password@127.0.0.1:3306/bravo_test
          DJANGO_SETTINGS_MODULE: config.settings.test
        run: |
          python manage.py runserver 8000 &
          sleep 10

      - name: ğŸ”’ Run E2E Regression Tests
        working-directory: ./e2e
        run: |
          echo "ğŸš¨ Running E2E REGRESSION TESTS"
          echo "ğŸ“‹ Testing critical user journeys"

          # åªè¿è¡Œæ ‡è®°ä¸ºå›å½’æµ‹è¯•çš„E2Eç”¨ä¾‹
          npx playwright test --grep="@regression|æ ¸å¿ƒ|critical" \
            --reporter=junit \
            --output-dir=test-results

          echo "âœ… E2E regression tests passed!"

      - name: ğŸ“Š Upload E2E regression results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: e2e-regression-results
          path: e2e/test-results/

  # å›å½’æµ‹è¯•ç»“æœæ±‡æ€»
  regression-summary:
    name: ğŸ“‹ Regression Test Summary
    runs-on: ubuntu-latest
    needs: [backend-regression, frontend-regression, e2e-regression]
    if: always()

    steps:
      - name: ğŸ“¥ Download all regression results
        uses: actions/download-artifact@v3

      - name: ğŸ“Š Generate regression summary
        run: |
          echo "# ğŸ”’ å›å½’æµ‹è¯•é—¨ç¦ç»“æœ" > regression-summary.md
          echo "" >> regression-summary.md
          echo "## æµ‹è¯•ç»“æœæ¦‚è§ˆ" >> regression-summary.md
          echo "" >> regression-summary.md

          # æ£€æŸ¥å„ä¸ªæµ‹è¯•ç»“æœ
          if [ -f "backend-regression-results/regression-results.xml" ]; then
            echo "- âœ… åç«¯å›å½’æµ‹è¯•ï¼šé€šè¿‡" >> regression-summary.md
          else
            echo "- âŒ åç«¯å›å½’æµ‹è¯•ï¼šå¤±è´¥" >> regression-summary.md
          fi

          if [ -f "frontend-regression-results/regression-results.xml" ]; then
            echo "- âœ… å‰ç«¯å›å½’æµ‹è¯•ï¼šé€šè¿‡" >> regression-summary.md
          else
            echo "- âŒ å‰ç«¯å›å½’æµ‹è¯•ï¼šå¤±è´¥" >> regression-summary.md
          fi

          if [ -d "e2e-regression-results" ]; then
            echo "- âœ… E2Eå›å½’æµ‹è¯•ï¼šé€šè¿‡" >> regression-summary.md
          else
            echo "- âŒ E2Eå›å½’æµ‹è¯•ï¼šå¤±è´¥" >> regression-summary.md
          fi

          echo "" >> regression-summary.md
          echo "## ğŸš¨ é‡è¦æé†’" >> regression-summary.md
          echo "" >> regression-summary.md
          echo "- å›å½’æµ‹è¯•å¤±è´¥æ„å‘³ç€æ–°ä»£ç å¯èƒ½ç ´åäº†ç°æœ‰åŠŸèƒ½" >> regression-summary.md
          echo "- è¯·æ£€æŸ¥æµ‹è¯•ç»“æœï¼Œä¿®å¤é—®é¢˜åé‡æ–°æäº¤" >> regression-summary.md
          echo "- ç¦æ­¢ä¿®æ”¹å›å½’æµ‹è¯•æ–‡ä»¶æ¥"é€šè¿‡"æµ‹è¯•" >> regression-summary.md

          cat regression-summary.md

      - name: ğŸ’¬ Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('regression-summary.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

      - name: âŒ Fail if any regression test failed
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•å›å½’æµ‹è¯•å¤±è´¥
          FAILED=0

          if [ ! -f "backend-regression-results/regression-results.xml" ]; then
            echo "âŒ Backend regression tests failed"
            FAILED=1
          fi

          if [ ! -f "frontend-regression-results/regression-results.xml" ]; then
            echo "âŒ Frontend regression tests failed"
            FAILED=1
          fi

          if [ ! -d "e2e-regression-results" ]; then
            echo "âŒ E2E regression tests failed"
            FAILED=1
          fi

          if [ $FAILED -eq 1 ]; then
            echo "ğŸ’¥ å›å½’æµ‹è¯•å¤±è´¥ - PRä¸èƒ½åˆå¹¶ï¼"
            echo "è¯·ä¿®å¤é—®é¢˜åé‡æ–°æäº¤ï¼Œç¦æ­¢ä¿®æ”¹å›å½’æµ‹è¯•æ–‡ä»¶"
            exit 1
          else
            echo "ğŸ‰ æ‰€æœ‰å›å½’æµ‹è¯•é€šè¿‡ - PRå¯ä»¥åˆå¹¶ï¼"
          fi
