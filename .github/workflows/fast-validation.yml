name: Fast Validation Pipeline

on:
  workflow_call:
    inputs:
      skip-e2e:
        description: "Skip E2E tests for faster feedback"
        type: boolean
        default: false

env:
  NODE_VERSION: "20"
  PYTHON_VERSION: "3.11"

jobs:
  # ç¬¬ä¸€æ­¥ï¼šå¹¶è¡Œçš„å¿«é€Ÿæ£€æŸ¥
  quick-checks:
    strategy:
      fail-fast: false
      matrix:
        check: ["lint-frontend", "lint-backend", "type-check", "security-scan"]

    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      # å¤ç”¨å…¨å±€ç¼“å­˜
      - name: Restore Dependencies Cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            frontend/node_modules
            ~/.cache/pip
          key: deps-v5-${{ runner.os }}-${{ hashFiles('**/package-lock.json', 'backend/requirements/*.txt') }}

      - name: Setup Environment
        uses: ./.github/actions/setup-cached-env

      - name: Run Check
        run: |
          case "${{ matrix.check }}" in
          "lint-frontend")
            npm run lint:frontend
            ;;
          "lint-backend")
            cd backend && source .venv/bin/activate && python -m flake8 . --select=E9,F63,F7,F82 --exclude=migrations,__pycache__,.venv
            ;;
          "type-check")
            npm run test:frontend
            ;;
          "security-scan")
            npm audit --audit-level=high --production
            ;;
          esac

  # ç¬¬äºŒæ­¥ï¼šå¹¶è¡Œçš„æ ¸å¿ƒæµ‹è¯•
  core-tests:
    needs: quick-checks
    strategy:
      fail-fast: false
      matrix:
        test-type: ["backend-unit", "frontend-unit", "integration-smoke"]

    runs-on: ubuntu-latest
    timeout-minutes: 8

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: bravo_test
          MYSQL_USER: bravo_user
          MYSQL_PASSWORD: bravo_password
          MYSQL_ROOT_PASSWORD: root_password
        options: --health-cmd="mysqladmin ping" --health-interval=5s --health-timeout=3s --health-retries=10
        ports:
          - 3306:3306

    steps:
      - uses: actions/checkout@v4

      # å¿«é€ŸçŽ¯å¢ƒè®¾ç½®
      - name: Setup Fast Environment
        uses: ./.github/actions/setup-cached-env

      - name: Run Test Matrix
        run: |
          case "${{ matrix.test-type }}" in
            "backend-unit")
              # ç­‰å¾…æ•°æ®åº“å‡†å¤‡å°±ç»ª
              until mysqladmin ping -h 127.0.0.1 -P 3306 -u bravo_user -pbravo_password --silent; do
                echo "ç­‰å¾…MySQLå¯åŠ¨..."
                sleep 2
              done
              cd backend && source .venv/bin/activate
              python manage.py migrate --noinput --settings=bravo.settings.test
              python -m pytest tests/unit/ --maxfail=5 -x
              ;;
            "frontend-unit")
              npm run test:frontend
              ;;
            "integration-smoke")
              # ç­‰å¾…æ•°æ®åº“å‡†å¤‡å°±ç»ª
              until mysqladmin ping -h 127.0.0.1 -P 3306 -u root -proot_password --silent; do
                echo "ç­‰å¾…MySQLå¯åŠ¨..."
                sleep 2
              done

              # æŽˆäºˆbravo_useråˆ›å»ºæµ‹è¯•æ•°æ®åº“çš„æƒé™
              mysql -h 127.0.0.1 -P 3306 -u root -proot_password -e "
                CREATE DATABASE IF NOT EXISTS bravo_test;
                CREATE USER IF NOT EXISTS 'bravo_user'@'%' IDENTIFIED BY 'bravo_password';
                GRANT ALL PRIVILEGES ON bravo_test.* TO 'bravo_user'@'%';
                GRANT ALL PRIVILEGES ON *.* TO 'bravo_user'@'%';
                FLUSH PRIVILEGES;
              "
              echo "âœ… å·²æŽˆäºˆbravo_useråˆ›å»ºæµ‹è¯•æ•°æ®åº“çš„æƒé™"

              # æœ€å°é›†æˆæµ‹è¯•
              cd backend && source .venv/bin/activate
              python manage.py migrate --noinput --settings=bravo.settings.test
              python manage.py test tests.quick --parallel 4
              ;;
          esac
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_NAME: bravo_test
          DB_USER: bravo_user
          DB_PASSWORD: bravo_password

  # ç¬¬ä¸‰æ­¥ï¼šæ¡ä»¶æ€§E2Eï¼ˆä»…åœ¨éœ€è¦æ—¶è¿è¡Œï¼‰ - ðŸš€ Phase 5.2ç¼“å­˜ä¼˜åŒ–
  e2e-critical:
    if: ${{ !inputs.skip-e2e }}
    needs: [quick-checks, core-tests]
    runs-on: ubuntu-latest
    timeout-minutes: 8 # ðŸš€ Phase 5.2: æ¢å¤åˆç†æ—¶é—´ï¼Œæž¶æž„ä¼˜åŒ–æ¶ˆé™¤ä¸‹è½½

    steps:
      - uses: actions/checkout@v4

      # ðŸš€ Phase 5.2: æ¢å¤Playwrightæµè§ˆå™¨ç¼“å­˜ (å…³é”®ä¼˜åŒ–)
      - name: Restore Playwright Browsers Cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-browsers-v3-${{ runner.os }}-${{ hashFiles('e2e/package-lock.json') }}
          restore-keys: |
            playwright-browsers-v3-${{ runner.os }}-

      # ðŸš€ Phase 5.2: ä½¿ç”¨ç¼“å­˜ä¼˜åŒ–çš„Dockerå®¹å™¨
      - name: Run E2E with Container (Cache Optimized)
        run: |
          echo "ðŸš€ ä½¿ç”¨å®¹å™¨åŒ–E2Eæµ‹è¯•..."

          # å¯åŠ¨æ‰€æœ‰æœåŠ¡
          if command -v docker-compose >/dev/null 2>&1; then
            echo "å¯åŠ¨DockeræœåŠ¡..."
            # ðŸŽ¯ æœ€ä¼˜æ–¹æ¡ˆï¼šç§»é™¤çŽ¯å¢ƒå˜é‡ä¼ é€’ï¼Œå®¹å™¨è‡ªç»™è‡ªè¶³
            docker compose -f docker-compose.test.yml up --build -d

            echo "ç­‰å¾…E2Eæµ‹è¯•å®Œæˆ..."
            # ðŸŽ¯ ç¬¬26è½®ä¿®å¤ï¼šåœ¨å®¹å™¨å¯åŠ¨åŽç«‹å³èŽ·å–IDï¼Œé¿å…è¢«æ¸…ç†åŽæ— æ³•èŽ·å–
            sleep 1 # ðŸš€ Phase 5: å‡å°‘ç­‰å¾…æ—¶é—´ 2s â†’ 1s
            E2E_CID=$(docker compose -f docker-compose.test.yml ps -q e2e-tests)
            echo "E2Eå®¹å™¨ID: $E2E_CID"

            if [ -n "$E2E_CID" ]; then
              # ç­‰å¾…å®¹å™¨å®Œå…¨åœæ­¢å¹¶èŽ·å–é€€å‡ºç 
              E2E_EXIT_CODE=$(docker wait "$E2E_CID" 2>/dev/null || echo "1")
              echo "E2Eæµ‹è¯•çœŸå®žé€€å‡ºç : $E2E_EXIT_CODE"
            else
              echo "âŒ æ— æ³•èŽ·å–E2Eå®¹å™¨IDï¼Œå¯èƒ½å®¹å™¨å¯åŠ¨å¤±è´¥æˆ–è¿‡æ—©é€€å‡ºã€‚"
              E2E_EXIT_CODE=1
            fi

            echo "ðŸ“¦ æ”¶é›†E2Eæµ‹è¯•äº§ç‰©..."
            mkdir -p e2e-artifacts || true
            if [ -n "$E2E_CID" ]; then
              docker cp "$E2E_CID:/app/test-results" e2e-artifacts/test-results 2>/dev/null || true
              docker cp "$E2E_CID:/app/playwright-report" e2e-artifacts/playwright-report 2>/dev/null || true
              docker cp "$E2E_CID:/app/e2e-results.xml" e2e-artifacts/e2e-results.xml 2>/dev/null || true
            fi

            echo "æ¸…ç†DockeræœåŠ¡..."
            docker compose -f docker-compose.test.yml down

            exit $E2E_EXIT_CODE
          else
            echo "docker-compose not found, using 'docker compose' instead..."
            # ðŸŽ¯ æœ€ä¼˜æ–¹æ¡ˆï¼šç§»é™¤çŽ¯å¢ƒå˜é‡ä¼ é€’ï¼Œå®¹å™¨è‡ªç»™è‡ªè¶³
            docker compose -f docker-compose.test.yml up --build -d

            echo "ç­‰å¾…E2Eæµ‹è¯•å®Œæˆ..."
            # ðŸŽ¯ ç¬¬26è½®ä¿®å¤ï¼šåœ¨å®¹å™¨å¯åŠ¨åŽç«‹å³èŽ·å–IDï¼Œé¿å…è¢«æ¸…ç†åŽæ— æ³•èŽ·å–
            sleep 1 # ðŸš€ Phase 5: å‡å°‘ç­‰å¾…æ—¶é—´ 2s â†’ 1s
            E2E_CID=$(docker compose -f docker-compose.test.yml ps -q e2e-tests)
            echo "E2Eå®¹å™¨ID: $E2E_CID"

            if [ -n "$E2E_CID" ]; then
              # ç­‰å¾…å®¹å™¨å®Œå…¨åœæ­¢å¹¶èŽ·å–é€€å‡ºç 
              E2E_EXIT_CODE=$(docker wait "$E2E_CID" 2>/dev/null || echo "1")
              echo "E2Eæµ‹è¯•çœŸå®žé€€å‡ºç : $E2E_EXIT_CODE"
            else
              echo "âŒ æ— æ³•èŽ·å–E2Eå®¹å™¨IDï¼Œå¯èƒ½å®¹å™¨å¯åŠ¨å¤±è´¥æˆ–è¿‡æ—©é€€å‡ºã€‚"
              E2E_EXIT_CODE=1
            fi

            echo "ðŸ“¦ æ”¶é›†E2Eæµ‹è¯•äº§ç‰©..."
            mkdir -p e2e-artifacts || true
            if [ -n "$E2E_CID" ]; then
              docker cp "$E2E_CID:/app/test-results" e2e-artifacts/test-results 2>/dev/null || true
              docker cp "$E2E_CID:/app/playwright-report" e2e-artifacts/playwright-report 2>/dev/null || true
              docker cp "$E2E_CID:/app/e2e-results.xml" e2e-artifacts/e2e-results.xml 2>/dev/null || true
            fi

            echo "æ¸…ç†DockeræœåŠ¡..."
            docker compose -f docker-compose.test.yml down

            exit $E2E_EXIT_CODE
          fi

      - name: Upload E2E Artifacts (fast-validation)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-critical-artifacts
          path: |
            e2e-artifacts/test-results/**
            e2e-artifacts/playwright-report/**
            e2e-artifacts/e2e-results.xml
          retention-days: 7

  # æ±‡æ€»ç»“æžœ
  validation-summary:
    needs: [quick-checks, core-tests, e2e-critical]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Validation Summary
        run: |
          echo "## âš¡ Fast Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status | Duration |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Quick Checks | ${{ needs.quick-checks.result }} | ~2min |" >> $GITHUB_STEP_SUMMARY
          echo "| Core Tests | ${{ needs.core-tests.result }} | ~5min |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Critical | ${{ needs.e2e-critical.result }} | ~8min |" >> $GITHUB_STEP_SUMMARY

          # æ€»è€—æ—¶ç›®æ ‡ï¼š15åˆ†é’Ÿä»¥å†…
          echo "ðŸŽ¯ **ç›®æ ‡æ€»è€—æ—¶**: <15åˆ†é’Ÿ (vs ä¹‹å‰60+åˆ†é’Ÿ)"
