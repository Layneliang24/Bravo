name: Setup Cached Environment
description: "Fast environment setup with aggressive caching"

runs:
  using: "composite"
  steps:
    - name: Setup Node.js with Cache
      uses: actions/setup-node@v4
      with:
        node-version: "20"
        cache: "npm"
        cache-dependency-path: |
          package-lock.json
          frontend/package-lock.json
          e2e/package-lock.json

    - name: Setup Python with Cache
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
        cache: "pip"
        cache-dependency-path: "backend/requirements/*.txt"

    - name: Restore Full Dependency Cache
      uses: actions/cache/restore@v4
      with:
        path: |
          node_modules
          ~/.cache/pip
          backend/.venv
          ~/.cache/ms-playwright
        key: full-deps-v5-${{ runner.os }}-${{ hashFiles('**/package-lock.json', 'backend/requirements/*.txt', 'e2e/package-lock.json') }}
        restore-keys: |
          full-deps-v5-${{ runner.os }}-

    - name: Install Missing Dependencies
      shell: bash
      run: |
        echo "ğŸš€ æ£€æŸ¥å¹¶å®‰è£…ç¼ºå¤±ä¾èµ–..."

        # æ£€æŸ¥æ ¹ä¾èµ–
        if [ ! -d "node_modules" ]; then
          echo "å®‰è£…æ ¹ä¾èµ–..."
          npm ci --prefer-offline --no-audit
        fi

        # å‰ç«¯ä¾èµ–é€šè¿‡æ ¹ç›®å½•npm workspacesç®¡ç†
        echo "âœ… Frontend dependencies managed via root npm workspaces"

        # æ£€æŸ¥åç«¯ä¾èµ– - ä¿®å¤ç¼“å­˜é—®é¢˜ï¼šæ£€æŸ¥å…³é”®åŒ…æ˜¯å¦å­˜åœ¨
        cd backend
        if [ ! -d ".venv" ]; then
          echo "ğŸ†• åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
          python -m venv .venv
          NEED_INSTALL=true
        else
          echo "ğŸ” æ£€æŸ¥ç°æœ‰è™šæ‹Ÿç¯å¢ƒä¸­çš„å…³é”®ä¾èµ–..."
          source .venv/bin/activate
          # æ£€æŸ¥å¤šä¸ªå…³é”®ä¾èµ–åŒ…
          MISSING_PACKAGES=""

          # æ£€æŸ¥django_extensions
          if ! python -c "import django_extensions" 2>/dev/null; then
            MISSING_PACKAGES="$MISSING_PACKAGES django_extensions"
          fi

          # æ£€æŸ¥silk (æ€§èƒ½åˆ†æå·¥å…·)
          if ! python -c "import silk" 2>/dev/null; then
            MISSING_PACKAGES="$MISSING_PACKAGES silk"
          fi

          # æ£€æŸ¥debug_toolbar
          if ! python -c "import debug_toolbar" 2>/dev/null; then
            MISSING_PACKAGES="$MISSING_PACKAGES debug_toolbar"
          fi

          if [ -n "$MISSING_PACKAGES" ]; then
            echo "âŒ å…³é”®ä¾èµ–ç¼ºå¤±:$MISSING_PACKAGES"
            echo "éœ€è¦é‡æ–°å®‰è£…ä¾èµ–ç¡®ä¿ç¯å¢ƒå®Œæ•´"
            NEED_INSTALL=true
          else
            echo "âœ… æ‰€æœ‰å…³é”®ä¾èµ–å­˜åœ¨ï¼Œè·³è¿‡å®‰è£…"
            NEED_INSTALL=false
          fi
        fi

        if [ "$NEED_INSTALL" = "true" ]; then
          echo "ğŸ“¦ å®‰è£…/æ›´æ–°åç«¯ä¾èµ–..."
          source .venv/bin/activate
          pip install --upgrade pip wheel

          # ğŸ”§ ä¿®å¤ç¼–ç é—®é¢˜ï¼šå¼ºåˆ¶ä½¿ç”¨UTF-8ç¼–ç è¯»å–requirementsæ–‡ä»¶
          export PYTHONIOENCODING=utf-8
          export LC_ALL=C.UTF-8
          export LANG=C.UTF-8

          echo "ğŸ“¦ å®‰è£…requirementsï¼ˆå¼ºåˆ¶UTF-8ç¼–ç ï¼‰..."
          pip install -r requirements/base.txt -r requirements/test.txt
        fi
        cd ..

        # æ£€æŸ¥å’Œå®‰è£…Playwrightæµè§ˆå™¨ç¼“å­˜
        echo "ğŸ­ æ£€æŸ¥Playwrightæµè§ˆå™¨ç¼“å­˜..."
        if [ ! -d "$HOME/.cache/ms-playwright" ] || [ -z "$(ls -A $HOME/.cache/ms-playwright 2>/dev/null)" ]; then
          echo "ğŸ“¦ Playwrightæµè§ˆå™¨ç¼“å­˜ä¸å­˜åœ¨ï¼Œé¢„å®‰è£…åˆ°GitHub Actionsç¼“å­˜..."
          # ç¡®ä¿e2eä¾èµ–å·²å®‰è£…
          if [ ! -d "e2e/node_modules" ]; then
            echo "å®‰è£…e2eä¾èµ–..."
            cd e2e && npm ci --prefer-offline --no-audit && cd ..
          fi
          # ä¸‹è½½æµè§ˆå™¨åˆ°GitHub Actionsç¼“å­˜ç›®å½•
          cd e2e && npx playwright install chromium && cd ..
        else
          echo "âœ… Playwrightæµè§ˆå™¨ç¼“å­˜å·²å­˜åœ¨ï¼Œè·³è¿‡ä¸‹è½½"
        fi

        echo "âœ… ä¾èµ–æ£€æŸ¥å®Œæˆ"

    - name: Save Full Dependency Cache
      uses: actions/cache/save@v4
      if: always()
      with:
        path: |
          node_modules
          ~/.cache/pip
          backend/.venv
          ~/.cache/ms-playwright
        key: full-deps-v5-${{ runner.os }}-${{ hashFiles('**/package-lock.json', 'backend/requirements/*.txt', 'e2e/package-lock.json') }}
