# GitHub Actions å®Œå…¨æ¨¡æ‹Ÿå™¨
# åˆ›å»ºä¸€ä¸ªå®Œå…¨ç‹¬ç«‹çš„å®¹å™¨ç¯å¢ƒï¼Œæ¨¡æ‹ŸGitHub Actionsçš„Ubuntu runner
# æ‰€æœ‰æ“ä½œéƒ½åœ¨å®¹å™¨å†…è¿›è¡Œï¼ŒåŒ…æ‹¬MySQLæ•°æ®åº“

FROM ubuntu:22.04

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV DEBIAN_FRONTEND=noninteractive
ENV CI=true
ENV GITHUB_ACTIONS=true
ENV PYTHONUNBUFFERED=1

# æš‚æ—¶ä»¥rootç”¨æˆ·è¿è¡Œï¼Œé¿å…sudoé…ç½®å†²çª

# é…ç½®å›½å†…æºåŠ é€Ÿ
RUN sed -i 's/archive.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list && \
    sed -i 's/security.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list && \
    apt-get update

# å®‰è£…åŸºç¡€å·¥å…·
RUN apt-get install -y --no-install-recommends \
    curl \
    wget \
    git \
    unzip \
    ca-certificates \
    gnupg \
    lsb-release \
    jq \
    software-properties-common \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£…MySQL Serverï¼ˆå®Œå…¨åœ¨å®¹å™¨å†…ï¼‰
RUN apt-get update && \
    apt-get install -y mysql-server mysql-client && \
    rm -rf /var/lib/apt/lists/*

# å®‰è£…Node.js 20.xï¼ˆä½¿ç”¨å›½å†…æºï¼‰
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs

# å®‰è£…Python 3.11
RUN add-apt-repository ppa:deadsnakes/ppa && \
    apt-get update && \
    apt-get install -y python3.11 python3.11-pip python3.11-venv python3.11-dev && \
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1 && \
    update-alternatives --install /usr/bin/pip3 pip3 /usr/bin/pip3.11 1

# é…ç½®npmå›½å†…æº
RUN npm config set registry https://registry.npmmirror.com && \
    npm config set maxsockets 20 && \
    npm config set fetch-retries 3 && \
    npm config set fetch-retry-mintimeout 10000

# é…ç½®pipå›½å†…æº
RUN pip3 config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple/ && \
    pip3 config set global.trusted-host pypi.tuna.tsinghua.edu.cn

# å®‰è£…Playwrightæµè§ˆå™¨ä¾èµ–
RUN apt-get update && \
    apt-get install -y \
    libnss3 \
    libatk-bridge2.0-0 \
    libdrm2 \
    libxkbcommon0 \
    libgtk-3-0 \
    libgbm1 \
    libasound2 \
    && rm -rf /var/lib/apt/lists/*

# åˆ›å»ºå·¥ä½œç›®å½•
WORKDIR /workspace
RUN mkdir -p /workspace

# è®¾ç½®MySQLé…ç½®
RUN service mysql start && \
    mysql -e "CREATE DATABASE bravo_test;" && \
    mysql -e "CREATE USER 'bravo_user'@'localhost' IDENTIFIED BY 'bravo_password';" && \
    mysql -e "GRANT ALL PRIVILEGES ON bravo_test.* TO 'bravo_user'@'localhost';" && \
    mysql -e "CREATE USER 'bravo_user'@'127.0.0.1' IDENTIFIED BY 'bravo_password';" && \
    mysql -e "GRANT ALL PRIVILEGES ON bravo_test.* TO 'bravo_user'@'127.0.0.1';" && \
    mysql -e "FLUSH PRIVILEGES;" && \
    service mysql stop

# å¤åˆ¶é¡¹ç›®ä»£ç 
COPY . /workspace/

# åˆ›å»ºæ¨¡æ‹Ÿè„šæœ¬
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "ğŸš€ GitHub Actions æ¨¡æ‹Ÿå™¨å¯åŠ¨"\n\
echo "================================"\n\
echo "â° å¼€å§‹æ—¶é—´: $(date)"\n\
echo "ğŸ“ å·¥ä½œç›®å½•: $(pwd)"\n\
echo "ğŸ‘¤ å½“å‰ç”¨æˆ·: $(whoami)"\n\
echo "================================"\n\
\n\
# å¯åŠ¨MySQLæœåŠ¡\n\
echo "ğŸ—„ï¸ å¯åŠ¨MySQLæœåŠ¡..."\n\
service mysql start\n\
\n\
# ç­‰å¾…MySQLå°±ç»ª\n\
echo "â³ ç­‰å¾…MySQLå°±ç»ª..."\n\
for i in {1..30}; do\n\
    if mysql -u bravo_user -pbravo_password -h 127.0.0.1 -e "SELECT 1;" &>/dev/null; then\n\
        echo "âœ… MySQLè¿æ¥æˆåŠŸ"\n\
        break\n\
    fi\n\
    echo "ç­‰å¾…MySQLå¯åŠ¨... ($i/30)"\n\
    sleep 2\n\
done\n\
\n\
# è®¾ç½®ç¯å¢ƒå˜é‡\n\
export DB_HOST=127.0.0.1\n\
export DB_PORT=3306\n\
export DB_NAME=bravo_test\n\
export DB_USER=bravo_user\n\
export DB_PASSWORD=bravo_password\n\
export DJANGO_SETTINGS_MODULE=bravo.settings.test\n\
\n\
echo "ğŸ”§ é…ç½®å›½å†…é•œåƒæºåŠ é€Ÿ..."\n\
npm config set registry https://registry.npmmirror.com\n\
npm config set maxsockets 20\n\
npm config set fetch-retries 3\n\
pip3 config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple/\n\
\n\
echo "ğŸ“¦ å®‰è£…ä¾èµ–..."\n\
# å®‰è£…å‰ç«¯ä¾èµ–\n\
cd frontend\n\
npm ci\n\
cd ..\n\
\n\
# å®‰è£…E2Eä¾èµ–\n\
cd e2e\n\
npm ci\n\
npx playwright install chromium\n\
cd ..\n\
\n\
# å®‰è£…åç«¯ä¾èµ–\n\
cd backend\n\
pip3 install -r requirements/test.txt\n\
cd ..\n\
\n\
echo "ğŸ§ª è¿è¡Œæµ‹è¯•å¥—ä»¶ï¼ˆæ¨¡æ‹Ÿgate.ymlå¹¶è¡Œä½œä¸šï¼‰..."\n\
\n\
# Job 1: Frontend Tests\n\
echo "ğŸ“¦ Job: frontend-tests"\n\
cd frontend\n\
npm run test\n\
cd ..\n\
\n\
# Job 2: Backend Tests\n\
echo "ğŸ Job: backend-tests"\n\
cd backend\n\
python3 manage.py check --settings=bravo.settings.test\n\
python3 -m pytest tests/ -v --maxfail=0 --tb=short\n\
cd ..\n\
\n\
# Job 3: E2E Tests\n\
echo "ğŸ­ Job: e2e-tests"\n\
cd e2e\n\
npm run test\n\
cd ..\n\
\n\
echo "âœ… æ‰€æœ‰æµ‹è¯•å®Œæˆï¼"\n\
echo "â° ç»“æŸæ—¶é—´: $(date)"\n\
' > /run_github_actions_simulation.sh && \
chmod +x /run_github_actions_simulation.sh

# è®¾ç½®å¯åŠ¨å‘½ä»¤
CMD ["/run_github_actions_simulation.sh"]
