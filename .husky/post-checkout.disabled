#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ”„ Post-checkout é’©å­å¯åŠ¨..."

# è·å–å‚æ•°
old_head=$1
new_head=$2
branch_checkout=$3

# è®¾ç½®ç¯å¢ƒå˜é‡ä¾› Python è„šæœ¬ä½¿ç”¨
export GIT_PARAMS="$old_head $new_head $branch_checkout"

# è¿è¡Œ post-checkout æ£€æŸ¥
if [ -f "scripts/post_checkout_handler.py" ]; then
    echo "ğŸ è¿è¡Œ post-checkout æ£€æŸ¥è„šæœ¬..."
    python scripts/post_checkout_handler.py
    if [ $? -eq 0 ]; then
        echo "âœ… Post-checkout æ£€æŸ¥å®Œæˆ"
    else
        echo "âš ï¸  Post-checkout æ£€æŸ¥å‘ç°é—®é¢˜ï¼Œä½†ä¸å½±å“åˆ†æ”¯åˆ‡æ¢"
    fi
else
    echo "âš ï¸  Post-checkout æ£€æŸ¥è„šæœ¬ä¸å­˜åœ¨"
fi

# åˆ†æ”¯åˆ‡æ¢åçš„é¢å¤–å¤„ç†
if [ "$branch_checkout" = "1" ]; then
    echo "ğŸŒ¿ åˆ†æ”¯åˆ‡æ¢å®Œæˆï¼Œæ‰§è¡Œé¢å¤–å¤„ç†..."
    
    # æ£€æŸ¥æ˜¯å¦éœ€è¦å®‰è£…ä¾èµ–
    if [ -f "frontend/package.json" ] && [ ! -d "frontend/node_modules" ]; then
        echo "ğŸ“¦ æ£€æµ‹åˆ°å‰ç«¯ä¾èµ–ç¼ºå¤±ï¼Œå»ºè®®è¿è¡Œ: cd frontend && npm install"
    fi
    
    # æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
    if [ -f "backend/requirements.txt" ] && [ ! -d "backend/.venv" ]; then
        echo "ğŸ æ£€æµ‹åˆ°åç«¯è™šæ‹Ÿç¯å¢ƒç¼ºå¤±ï¼Œå»ºè®®è¿è¡Œ: cd backend && python -m venv .venv"
    fi
    
    # æ˜¾ç¤ºå½“å‰åˆ†æ”¯ä¿¡æ¯
    current_branch=$(git rev-parse --abbrev-ref HEAD)
    echo "ğŸ“ å½“å‰åˆ†æ”¯: $current_branch"
    
    # å¦‚æœæ˜¯ä¿æŠ¤åˆ†æ”¯ï¼Œæ˜¾ç¤ºè­¦å‘Š
    if [ "$current_branch" = "main" ] || [ "$current_branch" = "dev" ]; then
        echo "ğŸ›¡ï¸  è­¦å‘Š: æ‚¨æ­£åœ¨ä¿æŠ¤åˆ†æ”¯ä¸Šï¼Œè¯·è°¨æ…æ“ä½œ"
    fi
fi

echo "âœ… Post-checkout å¤„ç†å®Œæˆ"
