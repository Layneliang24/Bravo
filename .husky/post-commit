#!/bin/sh

echo "📊 提交后处理开始..."

# 获取提交信息
commit_msg=$(git log -1 --pretty=%B)
commit_hash=$(git log -1 --pretty=%h)

echo "📝 提交信息: $commit_msg"
echo "🔗 提交哈希: $commit_hash"

# 更新功能映射（如果存在且有features.json）
if [ -f "scripts/buildFeatureMap.js" ] && [ -f "features.json" ]; then
    echo "🗺️  更新功能映射..."
    node scripts/buildFeatureMap.js
    if [ $? -eq 0 ]; then
        echo "✅ 功能映射更新完成"
    else
        echo "⚠️  功能映射更新失败，但不影响提交"
    fi
else
    echo "ℹ️  跳过功能映射更新（features.json不存在）"
fi

# 更新代码变更统计（如果存在）
if [ -f "scripts/code_change_tracker.py" ]; then
    echo "📈 更新代码变更统计..."
    python scripts/code_change_tracker.py --commit
    if [ $? -eq 0 ]; then
        echo "✅ 代码统计更新完成"
    else
        echo "⚠️  代码统计更新失败，但不影响提交"
    fi
fi

# 检查是否需要更新依赖
if echo "$commit_msg" | grep -qE "(package\.json|requirements|dependencies)"; then
    echo "📦 检测到依赖变更，建议运行: npm run deps:check"
fi

# 检查是否是基础设施相关提交
if echo "$commit_msg" | grep -qE "(hook|infrastructure|ci|cd|build)"; then
    echo "🏗️  检测到基础设施变更，建议运行: npm run test:all"
fi

echo "✅ 提交后处理完成"
