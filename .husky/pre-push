#!/bin/sh

# 🚀 Git推送前的通行证验证和安全检查
echo "[PRE-PUSH] 🛡️ Git推送安全检查"
echo "[INFO] 验证本地测试通行证和推送安全性"

# 🚨 检测绕过尝试
if [ "$SKIP_PASSPORT_CHECK" = "1" ] || [ "$ALLOW_PASSPORT_BYPASS" = "1" ]; then
    echo "[ERROR] ======================================"
    echo "[ERROR] ❌ 检测到绕过尝试！"
    echo "[ERROR] ======================================"
    echo "[ERROR] 环境变量绕过已被禁止："
    echo "[ERROR]   SKIP_PASSPORT_CHECK=$SKIP_PASSPORT_CHECK"
    echo "[ERROR]   ALLOW_PASSPORT_BYPASS=$ALLOW_PASSPORT_BYPASS"
    echo ""
    echo "[ERROR] 推送被阻止，请先完成本地测试验证"
    exit 1
fi

GOLDEN_SCRIPTS="$(cd "$(dirname "$0")/.." && pwd)/scripts-golden"

# 🚨 第零层：保护分支检查（最高优先级，必须在通行证检查之前）
# 读取pre-push hook的参数：remote_name remote_url
remote_name="$1"
remote_url="$2"

# 获取当前分支名
current_branch=$(git branch --show-current 2>/dev/null)

# 检查是否尝试推送到保护分支
if [ -n "$remote_name" ] && [ -n "$current_branch" ]; then
    # 检查当前分支是否是保护分支
    if [ "$current_branch" = "dev" ] || [ "$current_branch" = "main" ] || [ "$current_branch" = "master" ]; then
        # 检查是否明确指定推送到保护分支（git push origin dev）
        # pre-push hook的参数格式：remote_name remote_url
        # 如果remote_name是origin且当前分支是保护分支，则拦截
        if [ "$remote_name" = "origin" ] || [ -z "$remote_name" ]; then
            echo "🚨🚨🚨 检测到严重违规：直接推送到${current_branch}分支 🚨🚨🚨"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "❌ 绝对禁止的Git操作！"
            echo "📋 基于30轮修复血泪教训，这会导致："
            echo "   • npm workspaces依赖漂移"
            echo "   • 代码质量检查被绕过"
            echo "   • 架构违规问题扩散"
            echo "   • 分支保护策略被绕过"
            echo ""
            echo "✅ 正确的解决方案："
            echo "   1. 修复检查发现的问题"
            echo "   2. 如果检查有误报，更新检查规则"
            echo "   3. 使用PR流程合并到保护分支"
            echo "   4. 紧急情况联系架构负责人"
            echo ""
            echo "🔗 详细文档："
            echo "   • docs/architecture/ADR-001-npm-workspaces.md"
            echo "   • docs/architecture/cursor-git-no-verify-fix.md"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo ""

            # 调用加密验证系统（如果需要密码验证）
            if [ -f "$GOLDEN_SCRIPTS/encrypted_auth_system.sh" ]; then
                if ! bash "$GOLDEN_SCRIPTS/encrypted_auth_system.sh" --verify "git push origin $current_branch" "git push origin $current_branch"; then
                    echo "❌ 密码验证失败"
                    echo "🚫 操作被拒绝"
                    exit 1
                fi
            else
                echo "❌ 密码验证失败 - 操作被拒绝"
                echo "💡 请修复问题后重新尝试"
                exit 1
            fi
        fi
    fi
fi

# 第一层：强制本地测试通行证验证
if [ -f "$GOLDEN_SCRIPTS/local_test_passport.py" ]; then
    echo ""
    echo "🎫 [第一层] 本地测试通行证验证（必需）..."

    if ! python "$GOLDEN_SCRIPTS/local_test_passport.py" --check; then
        echo ""
        echo "[ERROR] ======================================"
        echo "[ERROR] ❌ 本地测试通行证验证失败！"
        echo "[ERROR] ======================================"
        echo "[HELP] 推送前必须获得有效的本地测试通行证："
        echo "[HELP] 1. 运行本地测试: ./test"
        echo "[HELP] 2. 检查通行证: ./passport"
        echo "[HELP] 3. 安全推送: ./safe-push"
        echo ""
        echo "[INFO] 💡 或直接使用便捷命令："
        echo "[INFO]    ./test && ./safe-push"
        echo ""
        echo "[ERROR] 推送被阻止，请先完成本地测试验证"
        exit 1
    fi
    echo "✅ 本地测试通行证验证通过"
fi

# 第二层：防篡改依赖检查
GOLDEN_SCRIPTS="$(cd "$(dirname "$0")/.." && pwd)/scripts-golden"
if [ -f "$GOLDEN_SCRIPTS/dependency-guard.sh" ]; then
    echo ""
    echo "🛡️ [第二层] 防篡改依赖安全检查..."
    bash "$GOLDEN_SCRIPTS/dependency-guard.sh"
    if [ $? -ne 0 ]; then
        echo "[ERROR] 防篡改依赖检查失败，推送被阻止"
        exit 1
    fi
    echo "✅ 依赖安全检查通过"
fi

# 第三层：Git状态完整性检查
echo ""
echo "🔍 [第三层] Git状态完整性检查..."

# 检查是否有未追踪的重要文件
if [ -f "$GOLDEN_SCRIPTS/git-guard.sh" ]; then
    echo "✅ 防篡改脚本完整性正常"
fi

echo ""
echo "[SUCCESS] =================================="
echo "[SUCCESS] 🎉 所有推送前检查通过！"
echo "[SUCCESS] =================================="
echo "[INFO] 🚀 安全推送到远程仓库..."
echo "[INFO] 📊 已执行的检查：通行证验证 + 依赖安全 + Git完整性"
echo ""
