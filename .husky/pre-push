#!/bin/sh

echo "ğŸš€ æ¨é€å‰æ£€æŸ¥å¼€å§‹..."

# è·å–å½“å‰åˆ†æ”¯
current_branch=$(git rev-parse --abbrev-ref HEAD)
echo "ğŸ“ å½“å‰åˆ†æ”¯: $current_branch"

# æ£€æŸ¥æ˜¯å¦åœ¨ä¿æŠ¤åˆ†æ”¯ä¸Š
if [ "$current_branch" = "main" ] || [ "$current_branch" = "dev" ]; then
    echo "âŒ ç¦æ­¢ç›´æ¥æ¨é€åˆ°ä¿æŠ¤åˆ†æ”¯: $current_branch"
    echo "ğŸ’¡ è¯·ä½¿ç”¨featureåˆ†æ”¯å¼€å‘ï¼Œç„¶ååˆ›å»ºPRåˆå¹¶"
    echo "ğŸ”— å·¥ä½œæµ: feature/* â†’ dev â†’ main"
    echo ""
    echo "ğŸ”’ åˆ†æ”¯ä¿æŠ¤è§„åˆ™:"
    echo "  - mainåˆ†æ”¯: åªèƒ½é€šè¿‡PRä»devåˆ†æ”¯åˆå¹¶"
    echo "  - devåˆ†æ”¯: åªèƒ½é€šè¿‡PRä»featureåˆ†æ”¯åˆå¹¶"
    echo "  - featureåˆ†æ”¯: å¯ä»¥è‡ªç”±æ¨é€å’Œå¼€å‘"
    exit 1
fi

# è¿è¡Œæ¨é€å‰æµ‹è¯•æ£€æŸ¥
echo "ğŸ§ª è¿è¡Œæ¨é€å‰æµ‹è¯•æ£€æŸ¥..."
if [ -f "test_all.sh" ]; then
    bash test_all.sh
    if [ $? -ne 0 ]; then
        echo "âŒ æµ‹è¯•å¤±è´¥ï¼Œæ¨é€è¢«é˜»æ­¢"
        echo "ğŸ’¡ è¯·ä¿®å¤æµ‹è¯•é—®é¢˜åå†æ¨é€"
        exit 1
    fi
    echo "âœ… æµ‹è¯•æ£€æŸ¥é€šè¿‡"
else
    echo "â„¹ï¸  æœªæ‰¾åˆ°test_all.shï¼Œè·³è¿‡æµ‹è¯•æ£€æŸ¥"
fi

# æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„æ›´æ”¹
if ! git diff-index --quiet HEAD --; then
    echo "âŒ å­˜åœ¨æœªæäº¤çš„æ›´æ”¹ï¼Œè¯·å…ˆæäº¤"
    exit 1
fi

# æ£€æŸ¥æ˜¯å¦æœ‰æœªæ¨é€çš„æäº¤
if [ -n "$(git log @{u}..HEAD --oneline)" ]; then
    echo "ğŸ“¤ å‡†å¤‡æ¨é€ $(git log @{u}..HEAD --oneline | wc -l) ä¸ªæäº¤"
else
    echo "â„¹ï¸  æ²¡æœ‰æ–°çš„æäº¤éœ€è¦æ¨é€"
fi

echo "âœ… æ¨é€å‰æ£€æŸ¥é€šè¿‡"
