#!/usr/bin/env sh
# 工作流持续验证钩子
# 在提交前自动验证工作流文件

# 检查是否有工作流文件变更
CHANGED_WORKFLOWS=$(git diff --cached --name-only --diff-filter=AM | grep "^.github/workflows/.*\.yml$" || true)

if [ -n "$CHANGED_WORKFLOWS" ]; then
    echo "🔍 检测到工作流文件变更，启动验证..."
    echo ""

    # 运行验证脚本
    if bash "$(dirname "$0")/../scripts/workflow-continuous-validation.sh" auto; then
        echo ""
        echo "✅ 工作流验证通过"
        exit 0
    else
        echo ""
        echo "❌ 工作流验证失败"
        echo ""
        echo "💡 建议:"
        echo "  1. 检查工作流语法"
        echo "  2. 运行: act -l -W .github/workflows/your-workflow.yml"
        echo "  3. 修复问题后重新提交"
        echo ""
        echo "⚠️  如果确认修改正确，可以使用以下命令跳过验证:"
        echo "   export SKIP_WORKFLOW_VALIDATION=1"
        echo "   git commit ..."
        exit 1
    fi
else
    # 没有工作流变更，跳过验证
    exit 0
fi
