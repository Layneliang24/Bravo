#!/bin/sh

echo "ğŸ“Š æäº¤åå¤„ç†å¼€å§‹..."

# è·å–æäº¤ä¿¡æ¯
commit_msg=$(git log -1 --pretty=%B)
commit_hash=$(git log -1 --pretty=%h)

echo "ğŸ“ æäº¤ä¿¡æ¯: $commit_msg"
echo "ğŸ”— æäº¤å“ˆå¸Œ: $commit_hash"

# æ›´æ–°åŠŸèƒ½æ˜ å°„ï¼ˆå¦‚æœå­˜åœ¨ä¸”æœ‰features.jsonï¼‰
if [ -f "scripts/buildFeatureMap.js" ] && [ -f "features.json" ]; then
    echo "ğŸ—ºï¸  æ›´æ–°åŠŸèƒ½æ˜ å°„..."
    node scripts/buildFeatureMap.js
    if [ $? -eq 0 ]; then
        echo "âœ… åŠŸèƒ½æ˜ å°„æ›´æ–°å®Œæˆ"
    else
        echo "âš ï¸  åŠŸèƒ½æ˜ å°„æ›´æ–°å¤±è´¥ï¼Œä½†ä¸å½±å“æäº¤"
    fi
else
    echo "â„¹ï¸  è·³è¿‡åŠŸèƒ½æ˜ å°„æ›´æ–°ï¼ˆfeatures.jsonä¸å­˜åœ¨ï¼‰"
fi

# æ›´æ–°ä»£ç å˜æ›´ç»Ÿè®¡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
if [ -f "scripts/code_change_tracker.py" ]; then
    echo "ğŸ“ˆ æ›´æ–°ä»£ç å˜æ›´ç»Ÿè®¡..."
    python scripts/code_change_tracker.py --commit
    if [ $? -eq 0 ]; then
        echo "âœ… ä»£ç ç»Ÿè®¡æ›´æ–°å®Œæˆ"
    else
        echo "âš ï¸  ä»£ç ç»Ÿè®¡æ›´æ–°å¤±è´¥ï¼Œä½†ä¸å½±å“æäº¤"
    fi
fi

# æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°ä¾èµ–
if echo "$commit_msg" | grep -qE "(package\.json|requirements|dependencies)"; then
    echo "ğŸ“¦ æ£€æµ‹åˆ°ä¾èµ–å˜æ›´ï¼Œå»ºè®®è¿è¡Œ: npm run deps:check"
fi

# æ£€æŸ¥æ˜¯å¦æ˜¯åŸºç¡€è®¾æ–½ç›¸å…³æäº¤
if echo "$commit_msg" | grep -qE "(hook|infrastructure|ci|cd|build)"; then
    echo "ğŸ—ï¸  æ£€æµ‹åˆ°åŸºç¡€è®¾æ–½å˜æ›´ï¼Œå»ºè®®è¿è¡Œ: npm run test:all"
fi

echo "âœ… æäº¤åå¤„ç†å®Œæˆ"
