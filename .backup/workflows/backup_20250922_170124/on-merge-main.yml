name: Main Branch - Production Merge Validation

on:
  push:
    branches: [main]
    # Âè™Âú®ÂêàÂπ∂Êèê‰∫§Êó∂Ëß¶Âèë
  workflow_dispatch:

# Âπ∂ÂèëÊéßÂà∂
concurrency:
  group: main-merge-${{ github.ref }}
  cancel-in-progress: false # Áîü‰∫ßÂêàÂπ∂ÂêéÈ™åËØÅ‰∏çÂ∫îËØ•Ë¢´ÂèñÊ∂à

jobs:
  # Ê£ÄÊµãÊòØÂê¶ÊòØÂêàÂπ∂Êèê‰∫§
  detect-merge:
    name: Detect Production Merge
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      is-merge: ${{ steps.check.outputs.is-merge }}
      source-branch: ${{ steps.check.outputs.source-branch }}
      pr-number: ${{ steps.check.outputs.pr-number }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 10 # Ëé∑ÂèñË∂≥Â§üÁöÑÂéÜÂè≤ËÆ∞ÂΩï

      - name: Check if Production Merge Commit
        id: check
        run: |
          echo "üîç Ê£ÄÊµãÁîü‰∫ßÂêàÂπ∂Êèê‰∫§..."

          # Ê£ÄÊü•ÊúÄÊñ∞Êèê‰∫§ÊòØÂê¶ÊòØÂêàÂπ∂Êèê‰∫§
          if git show --format="%P" -s HEAD | wc -w | grep -q "2"; then
            echo "‚úÖ Ê£ÄÊµãÂà∞Áîü‰∫ßÂêàÂπ∂Êèê‰∫§"
            echo "is-merge=true" >> $GITHUB_OUTPUT

            # Â∞ùËØïËé∑ÂèñÂêàÂπ∂‰ø°ÊÅØ
            COMMIT_MSG=$(git log -1 --pretty=%B)
            echo "Êèê‰∫§‰ø°ÊÅØ: $COMMIT_MSG"

            # ÊèêÂèñPRÁºñÂè∑
            if [[ "$COMMIT_MSG" =~ Merge\ pull\ request\ #([0-9]+) ]]; then
              PR_NUMBER="${BASH_REMATCH[1]}"
              echo "pr-number=$PR_NUMBER" >> $GITHUB_OUTPUT
              echo "‚úÖ Ê£ÄÊµãÂà∞Áîü‰∫ßPR #$PR_NUMBER"
            fi

            # ÊèêÂèñÊ∫êÂàÜÊîØ (Â∫îËØ•ÊòØdevÂàÜÊîØ)
            if [[ "$COMMIT_MSG" =~ from\ .*/(.+) ]]; then
              SOURCE_BRANCH="${BASH_REMATCH[1]}"
              echo "source-branch=$SOURCE_BRANCH" >> $GITHUB_OUTPUT
              echo "‚úÖ Ê∫êÂàÜÊîØ: $SOURCE_BRANCH"

              # È™åËØÅÂè™ËÉΩ‰ªédevÂàÜÊîØÂêàÂπ∂Âà∞main
              if [[ "$SOURCE_BRANCH" != "dev" ]]; then
                echo "‚ùå ÈîôËØØ: Âè™ËÉΩ‰ªédevÂàÜÊîØÂêàÂπ∂Âà∞mainÂàÜÊîØ"
                echo "   ÂÆûÈôÖÊ∫êÂàÜÊîØ: $SOURCE_BRANCH"
                exit 1
              fi
            fi
          else
            echo "‚ÑπÔ∏è ÈùûÂêàÂπ∂Êèê‰∫§ÔºåË∑≥ËøáÁîü‰∫ßÂêàÂπ∂È™åËØÅ"
            echo "is-merge=false" >> $GITHUB_OUTPUT
          fi

  # Áîü‰∫ßÂ∞±Áª™Ê£ÄÊü•
  production-readiness:
    name: Production Readiness Check
    needs: detect-merge
    if: needs.detect-merge.outputs.is-merge == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install Dependencies
        run: |
          echo "üì¶ ÂÆâË£ÖÁîü‰∫ßÁéØÂ¢É‰æùËµñ..."
          npm ci --workspace=frontend
          cd backend && pip install -r requirements/base.txt

      - name: Production Environment Check
        run: |
          echo "üè≠ Ê£ÄÊü•Áîü‰∫ßÁéØÂ¢ÉÈÖçÁΩÆ..."

          # Ê£ÄÊü•Áîü‰∫ßÁéØÂ¢ÉÂèòÈáèÈÖçÁΩÆÊñá‰ª∂
          if [ ! -f "backend/bravo/settings/production.py" ]; then
            echo "‚ùå Áº∫Â∞ëÁîü‰∫ßÁéØÂ¢ÉÈÖçÁΩÆÊñá‰ª∂"
            exit 1
          fi

          # Ê£ÄÊü•ÂâçÁ´ØÁîü‰∫ßÊûÑÂª∫ÈÖçÁΩÆ
          if [ ! -f "frontend/vite.config.ts" ]; then
            echo "‚ùå Áº∫Â∞ëÂâçÁ´ØÊûÑÂª∫ÈÖçÁΩÆ"
            exit 1
          fi

          echo "‚úÖ Áîü‰∫ßÁéØÂ¢ÉÈÖçÁΩÆÊ£ÄÊü•ÈÄöËøá"

      - name: Security Configuration Check
        run: |
          echo "üîí Ê£ÄÊü•Áîü‰∫ßÂÆâÂÖ®ÈÖçÁΩÆ..."

          # Ê£ÄÊü•ÊòØÂê¶ÊúâÊïèÊÑü‰ø°ÊÅØÊö¥Èú≤
          if grep -r "DEBUG.*=.*True" backend/bravo/settings/production.py; then
            echo "‚ùå Áîü‰∫ßÁéØÂ¢É‰∏çÂ∫îÂêØÁî®DEBUG"
            exit 1
          fi

          # Ê£ÄÊü•ÊòØÂê¶ÊúâÊµãËØïÂØÜÈí•
          if grep -r "django-insecure" backend/bravo/settings/; then
            echo "‚ö†Ô∏è ÂèëÁé∞ÊµãËØïÂØÜÈí•ÔºåËØ∑‰ΩøÁî®Áîü‰∫ßÂØÜÈí•"
          fi

          echo "‚úÖ ÂÆâÂÖ®ÈÖçÁΩÆÊ£ÄÊü•ÈÄöËøá"

      - name: Database Migration Check
        working-directory: ./backend
        run: |
          echo "üóÑÔ∏è Ê£ÄÊü•Êï∞ÊçÆÂ∫ìËøÅÁßª..."

          # Ê£ÄÊü•ÊòØÂê¶ÊúâÊú™Â∫îÁî®ÁöÑËøÅÁßª
          python manage.py makemigrations --check --settings=bravo.settings.test

          echo "‚úÖ Êï∞ÊçÆÂ∫ìËøÅÁßªÊ£ÄÊü•ÈÄöËøá"

  # ÊÄßËÉΩÂü∫ÂáÜÊµãËØï
  performance-benchmark:
    name: Performance Benchmark
    needs: detect-merge
    if: needs.detect-merge.outputs.is-merge == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Dependencies
        run: |
          npm ci --workspace=frontend
          npm install -g @lhci/cli

      - name: Build for Production
        working-directory: ./frontend
        run: |
          echo "üî® ÊûÑÂª∫Áîü‰∫ßÁâàÊú¨..."
          npm run build

      - name: Run Lighthouse Performance Test
        run: |
          echo "‚ö° ËøêË°åLighthouseÊÄßËÉΩÊµãËØï..."

          # ÂàõÂª∫Áîü‰∫ßÁ∫ßÂà´ÁöÑlighthouseÈÖçÁΩÆ
          cat > lighthouserc.production.json << EOF
          {
            "ci": {
              "collect": {
                "staticDistDir": "./frontend/dist",
                "url": ["index.html"],
                "numberOfRuns": 5,
                "settings": {
                  "chromeFlags": "--no-sandbox --disable-dev-shm-usage --disable-gpu --disable-web-security --disable-features=VizDisplayCompositor --headless",
                  "maxWaitForFcp": 60000,
                  "maxWaitForLoad": 120000,
                  "pauseAfterFcpMs": 3000,
                  "pauseAfterLoadMs": 3000,
                  "networkQuietThresholdMs": 3000,
                  "cpuQuietThresholdMs": 3000,
                  "throttlingMethod": "simulate",
                  "emulatedFormFactor": "desktop"
                }
              },
              "assert": {
                "assertions": {
                  "categories:performance": ["error", {"minScore": 0.85}],
                  "categories:accessibility": ["error", {"minScore": 0.9}],
                  "categories:best-practices": ["error", {"minScore": 0.9}],
                  "categories:seo": ["error", {"minScore": 0.85}]
                }
              },
              "upload": {
                "target": "temporary-public-storage"
              }
            }
          }
          EOF

          lhci autorun --config=lighthouserc.production.json
          echo "‚úÖ ÊÄßËÉΩÂü∫ÂáÜÊµãËØïÂÆåÊàê"

  # ÂõûÊªöÂáÜÂ§á
  rollback-preparation:
    name: Rollback Preparation
    needs: detect-merge
    if: needs.detect-merge.outputs.is-merge == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 8
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Rollback Script
        run: |
          echo "üîÑ ÁîüÊàêÂõûÊªöËÑöÊú¨..."

          # Ëé∑Âèñ‰∏ä‰∏Ä‰∏™mainÂàÜÊîØÊèê‰∫§
          PREVIOUS_COMMIT=$(git log --format="%H" -n 2 HEAD | tail -n 1)

          # ÂàõÂª∫ÂõûÊªöËÑöÊú¨
          cat > rollback-script.sh << EOF
          #!/bin/bash
          # Áîü‰∫ßÁéØÂ¢ÉÁ¥ßÊÄ•ÂõûÊªöËÑöÊú¨
          # ÁîüÊàêÊó∂Èó¥: $(date)
          # ÂΩìÂâçÊèê‰∫§: ${{ github.sha }}
          # ÂõûÊªöÁõÆÊ†á: $PREVIOUS_COMMIT

          echo "üö® ÊâßË°åÁîü‰∫ßÁéØÂ¢ÉÁ¥ßÊÄ•ÂõûÊªö..."
          echo "ÂΩìÂâçÊèê‰∫§: ${{ github.sha }}"
          echo "ÂõûÊªöÂà∞: $PREVIOUS_COMMIT"

          # ÂàõÂª∫Á¥ßÊÄ•ÂàÜÊîØ
          git checkout -b emergency/rollback-$(date +%Y%m%d-%H%M%S)
          git reset --hard $PREVIOUS_COMMIT

          # Êé®ÈÄÅÁ¥ßÊÄ•ÂàÜÊîØ
          git push origin emergency/rollback-$(date +%Y%m%d-%H%M%S)

          echo "‚úÖ Á¥ßÊÄ•ÂõûÊªöÂàÜÊîØÂ∑≤ÂàõÂª∫"
          echo "ËØ∑Á´ãÂç≥ÂàõÂª∫PRÂ∞ÜÊ≠§ÂàÜÊîØÂêàÂπ∂Âà∞main"
          EOF

          chmod +x rollback-script.sh

          echo "‚úÖ ÂõûÊªöËÑöÊú¨Â∑≤ÁîüÊàê"

      - name: Upload Rollback Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-rollback-kit
          path: |
            rollback-script.sh
          retention-days: 30

  # ÂàõÂª∫ÂèëÂ∏ÉÊ†áÁ≠æ
  create-release-tag:
    name: Create Release Tag
    needs: [detect-merge, production-readiness, performance-benchmark]
    if: needs.detect-merge.outputs.is-merge == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Generate Release Tag
        run: |
          echo "üè∑Ô∏è ÂàõÂª∫ÂèëÂ∏ÉÊ†áÁ≠æ..."

          # ÁîüÊàêÁâàÊú¨Âè∑ (‰ΩøÁî®Êó•ÊúüÂíåÊèê‰∫§Áü≠hash)
          VERSION="v$(date +%Y.%m.%d)-$(git rev-parse --short HEAD)"

          # ÂàõÂª∫Ê†áÁ≠æ
          git tag -a "$VERSION" -m "Production Release $VERSION

          Source PR: #${{ needs.detect-merge.outputs.pr-number }}
          Source Branch: ${{ needs.detect-merge.outputs.source-branch }}
          Commit: ${{ github.sha }}
          Release Date: $(date)

          ‚úÖ Production Readiness: Passed
          ‚ö° Performance Benchmark: Passed
          üîÑ Rollback Kit: Generated
          "

          # Êé®ÈÄÅÊ†áÁ≠æ
          git push origin "$VERSION"

          echo "‚úÖ ÂèëÂ∏ÉÊ†áÁ≠æ $VERSION Â∑≤ÂàõÂª∫"
          echo "release-tag=$VERSION" >> $GITHUB_OUTPUT
        id: release

  # Áîü‰∫ßÂêàÂπ∂Ê±áÊÄªÊä•Âëä
  production-merge-summary:
    name: Production Merge Summary
    runs-on: ubuntu-latest
    needs:
      [
        detect-merge,
        production-readiness,
        performance-benchmark,
        rollback-preparation,
        create-release-tag,
      ]
    if: always() && needs.detect-merge.outputs.is-merge == 'true'
    steps:
      - name: Generate Production Report
        run: |
          echo "## üè≠ Production Merge Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release Tag:** ${{ needs.create-release-tag.outputs.release-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Merge Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Source Branch:** ${{ needs.detect-merge.outputs.source-branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**PR Number:** #${{ needs.detect-merge.outputs.pr-number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Merged By:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Êî∂ÈõÜÈ™åËØÅÁªìÊûú
          READINESS_STATUS="${{ needs.production-readiness.result }}"
          PERFORMANCE_STATUS="${{ needs.performance-benchmark.result }}"
          ROLLBACK_STATUS="${{ needs.rollback-preparation.result }}"
          RELEASE_STATUS="${{ needs.create-release-tag.result }}"

          echo "| Production Check | Status | Impact |" >> $GITHUB_STEP_SUMMARY
          echo "|------------------|---------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Production Readiness | $READINESS_STATUS | üî• Critical |" >> $GITHUB_STEP_SUMMARY
          echo "| Performance Benchmark | $PERFORMANCE_STATUS | üìä Critical |" >> $GITHUB_STEP_SUMMARY
          echo "| Rollback Preparation | $ROLLBACK_STATUS | üîÑ Essential |" >> $GITHUB_STEP_SUMMARY
          echo "| Release Tag Creation | $RELEASE_STATUS | üè∑Ô∏è Important |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Âà§Êñ≠Áîü‰∫ßÈÉ®ÁΩ≤ÁªìÊûú
          if [[ "$READINESS_STATUS" == "success" && "$PERFORMANCE_STATUS" == "success" ]]; then
            echo "‚úÖ **Production deployment READY!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üéâ Áîü‰∫ßÁéØÂ¢ÉÈÉ®ÁΩ≤È™åËØÅÈÄöËøá" >> $GITHUB_STEP_SUMMARY
            echo "üöÄ Á≥ªÁªüÂ∑≤ÂáÜÂ§áÂ•ΩÊúçÂä°Áîü‰∫ßÊµÅÈáè" >> $GITHUB_STEP_SUMMARY
            echo "üîÑ Á¥ßÊÄ•ÂõûÊªöÂ∑•ÂÖ∑ÂåÖÂ∑≤ÂáÜÂ§áÂ∞±Áª™" >> $GITHUB_STEP_SUMMARY

            if [[ "$ROLLBACK_STATUS" != "success" ]]; then
              echo "‚ö†Ô∏è ÂõûÊªöÂáÜÂ§áÊúâÈóÆÈ¢òÔºåËØ∑ÊâãÂä®Ê£ÄÊü•" >> $GITHUB_STEP_SUMMARY
            fi

            if [[ "$RELEASE_STATUS" != "success" ]]; then
              echo "‚ö†Ô∏è ÂèëÂ∏ÉÊ†áÁ≠æÂàõÂª∫Â§±Ë¥•ÔºåËØ∑ÊâãÂä®ÂàõÂª∫" >> $GITHUB_STEP_SUMMARY
            fi

            echo "Production merge validation completed successfully"
          else
            echo "‚ùå **Production deployment FAILED!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üö® Áîü‰∫ßÁéØÂ¢ÉÈÉ®ÁΩ≤È™åËØÅÂ§±Ë¥•" >> $GITHUB_STEP_SUMMARY
            echo "üí• ‰∏çË¶ÅÈÉ®ÁΩ≤Âà∞Áîü‰∫ßÁéØÂ¢É" >> $GITHUB_STEP_SUMMARY
            echo "üîß ÈúÄË¶ÅÁ´ãÂç≥ÂàõÂª∫‰øÆÂ§çPR" >> $GITHUB_STEP_SUMMARY
            echo "Production merge validation failed"
            exit 1
          fi

      - name: Production Status Notification
        run: |
          echo "üìç Production Merge Summary:"
          echo "   - Release Tag: ${{ needs.create-release-tag.outputs.release-tag }}"
          echo "   - Merge Commit: ${{ github.sha }}"
          echo "   - Source: ${{ needs.detect-merge.outputs.source-branch }}"
          echo "   - PR: #${{ needs.detect-merge.outputs.pr-number }}"
          echo "   - Status: Production Ready"
          echo "   - Rollback Kit: Available"
