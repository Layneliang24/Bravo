# CI/CDä¿®å¤å¤ç›˜æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

**æ—¶é—´çº¿**ï¼š2024å¹´12æœˆ7æ—¥ä¸‹åˆå¼€å§‹ï¼ŒæŒç»­åˆ°æ™šä¸Š
**æ ¸å¿ƒé—®é¢˜**ï¼šdevåˆ†æ”¯æ— æ³•åˆå¹¶åˆ°mainåˆ†æ”¯ï¼Œåå¤å‡ºç°å†²çªå’ŒCIæ£€æŸ¥å¤±è´¥
**æœ€ç»ˆçŠ¶æ€**ï¼šå·²æˆåŠŸåˆå¹¶åˆ°devå’Œmain

---

## ğŸ” é—®é¢˜å®šä½è¿‡ç¨‹

### ç¬¬ä¸€é˜¶æ®µï¼šå†²çªé—®é¢˜ï¼ˆPR #268, #269, #270, #271, #272, #273, #274ï¼‰

#### 1.1 è¡¨é¢ç—‡çŠ¶
- GitHubæ˜¾ç¤º `CONFLICTING` çŠ¶æ€
- ä¸‰ä¸ªæ–‡ä»¶æŒç»­å†²çªï¼š
  - `.git-protection-config`ï¼ˆæ—¶é—´æˆ³è‡ªåŠ¨æ›´æ–°ï¼‰
  - `.gitignore`ï¼ˆMCPé…ç½®å·®å¼‚ï¼‰
  - `scripts/protect_golden_scripts.py`ï¼ˆä»£ç ç‰ˆæœ¬å·®å¼‚ï¼‰

#### 1.2 é”™è¯¯è¯Šæ–­
**âŒ é”™è¯¯å‡è®¾1**ï¼šè®¤ä¸ºå¯ä»¥é€šè¿‡APIç›´æ¥è§£å†³å†²çª
- **å®é™…æƒ…å†µ**ï¼šGitHub APIä¸å…è®¸ç›´æ¥è§£å†³å†²çªï¼Œå¿…é¡»é€šè¿‡PRç•Œé¢æˆ–æœ¬åœ°åˆå¹¶
- **æµªè´¹æ—¶é—´**ï¼šçº¦30åˆ†é’Ÿå°è¯•å„ç§APIæ–¹æ³•

**âŒ é”™è¯¯å‡è®¾2**ï¼šè®¤ä¸ºåœ¨devåˆ†æ”¯ä¸Šåˆå¹¶mainå°±èƒ½è§£å†³
- **å®é™…æƒ…å†µ**ï¼šå¦‚æœdevå’Œmainçš„ç‰ˆæœ¬ä¸åŒï¼Œåˆå¹¶åä»ä¼šå†²çª
- **æµªè´¹æ—¶é—´**ï¼šçº¦1å°æ—¶åå¤å°è¯•åˆå¹¶ç­–ç•¥

**âŒ é”™è¯¯å‡è®¾3**ï¼šè®¤ä¸ºé€‰æ‹©devç‰ˆæœ¬å°±èƒ½è§£å†³æ‰€æœ‰å†²çª
- **å®é™…æƒ…å†µ**ï¼š`.git-protection-config`çš„æ—¶é—´æˆ³ä¼šåœ¨æ¯æ¬¡æäº¤æ—¶è‡ªåŠ¨æ›´æ–°ï¼Œå¯¼è‡´æŒç»­å†²çª
- **æµªè´¹æ—¶é—´**ï¼šçº¦1.5å°æ—¶åå¤è§£å†³åŒä¸€æ–‡ä»¶çš„å†²çª

#### 1.3 æ ¹æœ¬åŸå› å‘ç°
**âœ… æ­£ç¡®è¯Šæ–­**ï¼š
1. **`.git-protection-config`æ—¶é—´æˆ³é—®é¢˜**ï¼š
   - `git-protection-monitor.sh`è„šæœ¬åœ¨æ¯æ¬¡æäº¤æ—¶è‡ªåŠ¨æ›´æ–°æ–‡ä»¶æ—¶é—´æˆ³
   - å³ä½¿å†…å®¹ç›¸åŒï¼Œæ—¶é—´æˆ³ä¸åŒä¹Ÿä¼šå¯¼è‡´å†²çª
   - **è§£å†³æ–¹æ¡ˆ**ï¼šPR #266ä¿®æ”¹äº†è„šæœ¬ï¼Œåœ¨mergeæ“ä½œæ—¶ä¸æ›´æ–°æ—¶é—´æˆ³

2. **`.gitignore`ç‰ˆæœ¬å·®å¼‚**ï¼š
   - mainåˆ†æ”¯ç¼ºå°‘MCPé…ç½®æ¡ç›®ï¼ˆ`.cursor/mcp.json`, `.mcp.json`ï¼‰
   - devåˆ†æ”¯å·²æ·»åŠ è¿™äº›æ¡ç›®
   - **è§£å†³æ–¹æ¡ˆ**ï¼šé€‰æ‹©devç‰ˆæœ¬åˆå¹¶åˆ°main

3. **`scripts/protect_golden_scripts.py`ä»£ç å·®å¼‚**ï¼š
   - devåˆ†æ”¯æœ‰æ›´æ–°çš„`get_actually_modified_files()`å‡½æ•°
   - è¿™æ˜¯æ­£å¸¸çš„ä»£ç æ”¹è¿›ï¼Œä¸æ˜¯è‡ªåŠ¨å˜æ›´
   - **è§£å†³æ–¹æ¡ˆ**ï¼šé€‰æ‹©devç‰ˆæœ¬åˆå¹¶åˆ°main

### ç¬¬äºŒé˜¶æ®µï¼šCIæ£€æŸ¥Pendingé—®é¢˜ï¼ˆPR #274, #276ï¼‰

#### 2.1 è¡¨é¢ç—‡çŠ¶
- 8ä¸ªå¿…éœ€çš„CIæ£€æŸ¥æ˜¾ç¤º `Expected â€” Waiting for status to be reported`
- PRçŠ¶æ€ï¼š`MERGEABLE` ä½† `BLOCKED`ï¼ˆç­‰å¾…æ£€æŸ¥å®Œæˆï¼‰

#### 2.2 é”™è¯¯è¯Šæ–­
**âŒ é”™è¯¯å‡è®¾1**ï¼šè®¤ä¸ºæ£€æŸ¥ä¼šè‡ªåŠ¨è¿è¡Œï¼Œåªéœ€ç­‰å¾…
- **å®é™…æƒ…å†µ**ï¼šå·¥ä½œæµç¼ºå°‘`pull_request`è§¦å‘å™¨ï¼Œæ ¹æœ¬ä¸ä¼šè¿è¡Œ
- **æµªè´¹æ—¶é—´**ï¼šçº¦1å°æ—¶ç­‰å¾…å’Œåå¤åˆ·æ–°

**âŒ é”™è¯¯å‡è®¾2**ï¼šè®¤ä¸ºå·¥ä½œæµåç§°åŒ¹é…å°±è¶³å¤Ÿ
- **å®é™…æƒ…å†µ**ï¼šåˆ†æ”¯ä¿æŠ¤è§„åˆ™è¦æ±‚ç²¾ç¡®çš„jobåç§°åŒ¹é…ï¼ˆå¦‚`run-tests (backend-unit-tests)`ï¼‰
- **æµªè´¹æ—¶é—´**ï¼šçº¦30åˆ†é’Ÿæ£€æŸ¥å·¥ä½œæµé…ç½®

#### 2.3 æ ¹æœ¬åŸå› å‘ç°
**âœ… æ­£ç¡®è¯Šæ–­**ï¼š

1. **å·¥ä½œæµç¼ºå°‘`pull_request`è§¦å‘å™¨**ï¼š
   - `push-validation.yml`ï¼šåªæœ‰`push`è§¦å‘å™¨ï¼Œæ²¡æœ‰`pull_request`
   - `test-suite.yml`ï¼šåªæœ‰`workflow_call`ï¼Œæ²¡æœ‰`pull_request`
   - `release-pipeline.yml`ï¼šåªæœ‰`push`è§¦å‘å™¨ï¼Œæ²¡æœ‰`pull_request`
   - **è§£å†³æ–¹æ¡ˆ**ï¼šä¸ºæ‰€æœ‰å·¥ä½œæµæ·»åŠ `pull_request`è§¦å‘å™¨

2. **Jobåç§°ä¸åŒ¹é…åˆ†æ”¯ä¿æŠ¤è§„åˆ™**ï¼š
   - åˆ†æ”¯ä¿æŠ¤è¦æ±‚ï¼š`Push Validation Pipeline / run-tests (backend-unit-tests)`
   - å®é™…jobåç§°ï¼š`Push Validation Pipeline / Conditional Test Execution / unit-tests (backend)`
   - **è§£å†³æ–¹æ¡ˆ**ï¼šæ·»åŠ ä¸“é—¨çš„`run-tests` jobï¼Œä½¿ç”¨matrixç­–ç•¥ç”ŸæˆåŒ¹é…çš„åç§°

3. **`test-suite.yml`æ¡ä»¶é€»è¾‘é—®é¢˜**ï¼š
   - `integration-tests`å’Œ`e2e-tests`çš„æ¡ä»¶åœ¨ç›´æ¥PRè§¦å‘æ—¶å¤±è´¥
   - **è§£å†³æ–¹æ¡ˆ**ï¼šä¿®æ”¹æ¡ä»¶é€»è¾‘ï¼Œå¤„ç†`inputs.test-level`ä¸ºnullçš„æƒ…å†µ

### ç¬¬ä¸‰é˜¶æ®µï¼šè¯­æ³•é”™è¯¯é—®é¢˜ï¼ˆPR #276ä¹‹åï¼‰

#### 3.1 è¡¨é¢ç—‡çŠ¶
```
Invalid workflow file: .github/workflows/push-validation.yml#L295
error parsing called workflow
".github/workflows/push-validation.yml"
-> "./.github/workflows/test-suite.yml"
: (Line: 28, Col: 16): Unrecognized named-value: 'jobs'
```

#### 3.2 æ ¹æœ¬åŸå› 
**âœ… æ­£ç¡®è¯Šæ–­**ï¼š
- `test-suite.yml`çš„`pull_request`è§¦å‘æ¡ä»¶ä¸­é”™è¯¯åœ°æ·»åŠ äº†`outputs`
- `outputs`åªèƒ½åœ¨`workflow_call`ä¸­ä½¿ç”¨ï¼Œä¸èƒ½åœ¨`pull_request`ä¸­ä½¿ç”¨
- **è§£å†³æ–¹æ¡ˆ**ï¼šç§»é™¤`pull_request`ä¸­çš„`outputs`å®šä¹‰

---

## ğŸš¨ æ ¸å¿ƒé—®é¢˜åˆ†æ

### é—®é¢˜1ï¼šä¸ºä»€ä¹ˆæ— æ³•é€šè¿‡APIè§£å†³å†²çªï¼Ÿ

**æ ¹æœ¬åŸå› **ï¼š
1. **Gitçš„å†²çªè§£å†³æœºåˆ¶**ï¼šå†²çªå¿…é¡»é€šè¿‡ä¸‰è·¯åˆå¹¶è§£å†³ï¼ˆbase + ours + theirsï¼‰
2. **GitHub APIé™åˆ¶**ï¼š`merge` APIåªèƒ½å¤„ç†æ— å†²çªçš„åˆå¹¶
3. **å¿…é¡»çš„æ­¥éª¤**ï¼šå†²çªè§£å†³ â†’ æäº¤ â†’ æ¨é€ â†’ é‡æ–°è§¦å‘æ£€æŸ¥

**ä¸ºä»€ä¹ˆä¹‹å‰æ²¡æ„è¯†åˆ°**ï¼š
- è¿‡åº¦ä¾èµ–APIè‡ªåŠ¨åŒ–ï¼Œå¿½ç•¥äº†Gitçš„åŸºæœ¬å·¥ä½œåŸç†
- æ²¡æœ‰ç†è§£GitHub PRçš„å†²çªè§£å†³æµç¨‹

### é—®é¢˜2ï¼šä¸ºä»€ä¹ˆåå¤å†²çªï¼Ÿ

**æ ¹æœ¬åŸå› **ï¼š
1. **`.git-protection-config`æ—¶é—´æˆ³è‡ªåŠ¨æ›´æ–°**ï¼š
   - `git-protection-monitor.sh`åœ¨æ¯æ¬¡æäº¤æ—¶è¿è¡Œ
   - å³ä½¿å†…å®¹ç›¸åŒï¼Œæ—¶é—´æˆ³å˜åŒ–ä¹Ÿä¼šå¯¼è‡´å†²çª
   - **ä½•æ—¶åŸ‹ä¸‹éšæ‚£**ï¼šåœ¨å®ç°gitä¿æŠ¤æœºåˆ¶æ—¶ï¼Œæ²¡æœ‰è€ƒè™‘mergeåœºæ™¯

2. **åˆ†æ”¯ä¿æŠ¤æœºåˆ¶é˜»æ­¢ç›´æ¥ä¿®å¤**ï¼š
   - æœ¬åœ°git hooksé˜»æ­¢åœ¨dev/mainåˆ†æ”¯ä¸Šç›´æ¥æäº¤
   - å¿…é¡»é€šè¿‡featureåˆ†æ”¯ â†’ PR â†’ dev â†’ PR â†’ mainçš„æµç¨‹
   - æ¯æ¬¡PRéƒ½ä¼šè§¦å‘æ—¶é—´æˆ³æ›´æ–°ï¼Œå¯¼è‡´æ–°çš„å†²çª

3. **å¾ªç¯ä¾èµ–**ï¼š
   ```
   devå’Œmainå†²çª â†’ åˆ›å»ºPR â†’ PRè§¦å‘æ—¶é—´æˆ³æ›´æ–° â†’ æ–°çš„å†²çª â†’ éœ€è¦æ–°çš„PR â†’ ...
   ```

### é—®é¢˜3ï¼šä¸ºä»€ä¹ˆCIæ£€æŸ¥ä¸€ç›´Pendingï¼Ÿ

**æ ¹æœ¬åŸå› **ï¼š
1. **å·¥ä½œæµé…ç½®é”™è¯¯**ï¼š
   - å·¥ä½œæµè®¾è®¡æ—¶åªè€ƒè™‘äº†`push`äº‹ä»¶æˆ–`workflow_call`
   - æ²¡æœ‰è€ƒè™‘ç›´æ¥é€šè¿‡`pull_request`äº‹ä»¶è§¦å‘
   - **ä½•æ—¶åŸ‹ä¸‹éšæ‚£**ï¼šåœ¨é‡æ„CIå·¥ä½œæµæ—¶ï¼Œæ²¡æœ‰å…¨é¢æµ‹è¯•PRè§¦å‘åœºæ™¯

2. **Jobåç§°ä¸åŒ¹é…**ï¼š
   - åˆ†æ”¯ä¿æŠ¤è§„åˆ™é…ç½®äº†ç²¾ç¡®çš„jobåç§°
   - ä½†å·¥ä½œæµä¸­çš„å®é™…jobåç§°ä¸åŒ
   - **ä½•æ—¶åŸ‹ä¸‹éšæ‚£**ï¼šåœ¨é…ç½®åˆ†æ”¯ä¿æŠ¤è§„åˆ™æ—¶ï¼Œæ²¡æœ‰éªŒè¯å·¥ä½œæµä¸­çš„å®é™…jobåç§°

3. **ç¼ºå°‘æœ¬åœ°éªŒè¯**ï¼š
   - `act`å·¥å…·å¯ä»¥éªŒè¯è¯­æ³•ï¼Œä½†æ— æ³•éªŒè¯è§¦å‘é€»è¾‘
   - æ²¡æœ‰åœ¨æœ¬åœ°æµ‹è¯•PRè§¦å‘åœºæ™¯
   - **ä½•æ—¶åŸ‹ä¸‹éšæ‚£**ï¼šä¾èµ–GitHubçš„è¿œç¨‹éªŒè¯ï¼Œæ²¡æœ‰å»ºç«‹å®Œæ•´çš„æœ¬åœ°éªŒè¯æµç¨‹

### é—®é¢˜4ï¼šä¸ºä»€ä¹ˆæœ¬åœ°æµ‹è¯•é€šè¡Œè¯ç”Ÿæˆå¤±è´¥ï¼Ÿ

**æ ¹æœ¬åŸå› **ï¼š
1. **`act --dryrun`è¶…æ—¶**ï¼š
   - `push-validation.yml`çš„`run-tests` jobåŒ…å«`services`ï¼ˆMySQLï¼‰
   - `act --dryrun`å°è¯•å¤„ç†servicesï¼Œå¯¼è‡´è¶…æ—¶ï¼ˆ180ç§’ â†’ 300ç§’ä»è¶…æ—¶ï¼‰
   - **è§£å†³æ–¹æ¡ˆ**ï¼šæ”¹ç”¨`act --list`åªéªŒè¯è¯­æ³•ï¼Œä¸æ‰§è¡Œjobs

2. **IndentationError**ï¼š
   - `scripts-golden/local_test_passport.py`ç¬¬284è¡Œç¼ºå°‘ç¼©è¿›
   - `.compliance/checkers/test_checker.py`ç¬¬75è¡Œç¼ºå°‘ç¼©è¿›
   - **åŸå› **ï¼šä¹‹å‰çš„ç¼–è¾‘æ“ä½œç ´åäº†ç¼©è¿›

---

## ğŸ“Š å†¤æ‰è·¯ç»Ÿè®¡

### æ—¶é—´æµªè´¹åˆ†æ

| é˜¶æ®µ | é—®é¢˜ | æµªè´¹æ—¶é—´ | åŸå›  |
|------|------|----------|------|
| ç¬¬ä¸€é˜¶æ®µ | APIè§£å†³å†²çªå°è¯• | ~30åˆ†é’Ÿ | ä¸ç†è§£GitHub APIé™åˆ¶ |
| ç¬¬ä¸€é˜¶æ®µ | åå¤åˆå¹¶ç­–ç•¥ | ~1å°æ—¶ | ä¸ç†è§£æ—¶é—´æˆ³è‡ªåŠ¨æ›´æ–°æœºåˆ¶ |
| ç¬¬ä¸€é˜¶æ®µ | é‡å¤è§£å†³åŒä¸€å†²çª | ~1.5å°æ—¶ | æ²¡æœ‰æ„è¯†åˆ°è„šæœ¬è‡ªåŠ¨æ›´æ–° |
| ç¬¬äºŒé˜¶æ®µ | ç­‰å¾…CIæ£€æŸ¥ | ~1å°æ—¶ | ä¸çŸ¥é“å·¥ä½œæµç¼ºå°‘è§¦å‘å™¨ |
| ç¬¬äºŒé˜¶æ®µ | æ£€æŸ¥jobåç§° | ~30åˆ†é’Ÿ | æ²¡æœ‰ç³»ç»Ÿæ€§åœ°å¯¹æ¯”é…ç½® |
| ç¬¬ä¸‰é˜¶æ®µ | ä¿®å¤è¯­æ³•é”™è¯¯ | ~20åˆ†é’Ÿ | æ²¡æœ‰æœ¬åœ°éªŒè¯å·¥ä½œæµè¯­æ³• |

**æ€»è®¡æµªè´¹æ—¶é—´**ï¼šçº¦5å°æ—¶

### å²”è·¯åˆ†æ

1. **å²”è·¯1ï¼šå°è¯•APIç›´æ¥è§£å†³å†²çª**
   - **åŸå› **ï¼šè¿‡åº¦ä¾èµ–è‡ªåŠ¨åŒ–ï¼Œå¿½ç•¥GitåŸºæœ¬æœºåˆ¶
   - **æ•™è®­**ï¼šç†è§£å·¥å…·é™åˆ¶ï¼Œä¸è¦å‡è®¾APIèƒ½åšæ‰€æœ‰äº‹æƒ…

2. **å²”è·¯2ï¼šåœ¨devåˆ†æ”¯ä¸Šåå¤åˆå¹¶main**
   - **åŸå› **ï¼šæ²¡æœ‰æ„è¯†åˆ°æ—¶é—´æˆ³è‡ªåŠ¨æ›´æ–°çš„å¾ªç¯é—®é¢˜
   - **æ•™è®­**ï¼šç³»ç»Ÿæ€§åˆ†æé—®é¢˜ï¼Œæ‰¾å‡ºæ ¹æœ¬åŸå› è€Œéç—‡çŠ¶

3. **å²”è·¯3ï¼šç­‰å¾…CIæ£€æŸ¥è‡ªåŠ¨è¿è¡Œ**
   - **åŸå› **ï¼šæ²¡æœ‰æ£€æŸ¥å·¥ä½œæµé…ç½®ï¼Œå‡è®¾ä¼šè‡ªåŠ¨è§¦å‘
   - **æ•™è®­**ï¼šä¸»åŠ¨éªŒè¯é…ç½®ï¼Œä¸è¦å‡è®¾ç³»ç»Ÿä¼šè‡ªåŠ¨å·¥ä½œ

---

## ğŸ”§ é€»è¾‘ç¼ºé™·åˆ†æ

### ç¼ºé™·1ï¼šGitä¿æŠ¤è„šæœ¬çš„mergeåœºæ™¯å¤„ç†

**é—®é¢˜ä»£ç **ï¼ˆ`git-protection-monitor.sh`ï¼‰ï¼š
```bash
# åŸé€»è¾‘ï¼šæ¯æ¬¡æäº¤éƒ½æ›´æ–°æ—¶é—´æˆ³
echo "$(date '+%Y-%m-%d %H:%M:%S')" > .git-protection-config
```

**ç¼ºé™·**ï¼š
- åœ¨mergeæ“ä½œæ—¶ä¹Ÿä¼šæ›´æ–°ï¼Œå¯¼è‡´åˆå¹¶å†²çª
- æ²¡æœ‰åŒºåˆ†æ™®é€šæäº¤å’Œmergeæäº¤

**ä¿®å¤**ï¼ˆPR #266ï¼‰ï¼š
```bash
# æ£€æŸ¥æ˜¯å¦æ˜¯mergeæ“ä½œ
if git rev-parse --verify MERGE_HEAD >/dev/null 2>&1; then
    echo "æ£€æµ‹åˆ°mergeæ“ä½œï¼Œè·³è¿‡æ—¶é—´æˆ³æ›´æ–°"
    exit 0
fi
```

### ç¼ºé™·2ï¼šå·¥ä½œæµè§¦å‘é€»è¾‘ä¸å®Œæ•´

**é—®é¢˜ä»£ç **ï¼ˆå¤šä¸ªå·¥ä½œæµæ–‡ä»¶ï¼‰ï¼š
```yaml
on:
  push:
    branches: [dev, main]
  # ç¼ºå°‘ pull_request è§¦å‘å™¨
```

**ç¼ºé™·**ï¼š
- åªè€ƒè™‘äº†pushäº‹ä»¶ï¼Œå¿½ç•¥äº†PRäº‹ä»¶
- å¯¼è‡´PRæ—¶å·¥ä½œæµä¸è¿è¡Œï¼Œæ£€æŸ¥ä¸€ç›´pending

**ä¿®å¤**ï¼š
```yaml
on:
  push:
    branches: [dev, main]
  pull_request:
    branches: [dev, main]
    types: [opened, synchronize, reopened]
```

### ç¼ºé™·3ï¼šåˆ†æ”¯ä¿æŠ¤è§„åˆ™ä¸å·¥ä½œæµJobåç§°ä¸åŒ¹é…

**é—®é¢˜**ï¼š
- åˆ†æ”¯ä¿æŠ¤è§„åˆ™è¦æ±‚ï¼š`Push Validation Pipeline / run-tests (backend-unit-tests)`
- å®é™…jobåç§°ï¼š`Push Validation Pipeline / Conditional Test Execution / unit-tests (backend)`

**ç¼ºé™·**ï¼š
- é…ç½®åˆ†æ”¯ä¿æŠ¤æ—¶æ²¡æœ‰éªŒè¯å®é™…jobåç§°
- æ²¡æœ‰å»ºç«‹é…ç½®éªŒè¯æœºåˆ¶

**ä¿®å¤**ï¼š
- æ·»åŠ ä¸“é—¨çš„`run-tests` jobï¼Œä½¿ç”¨matrixç­–ç•¥ç”ŸæˆåŒ¹é…çš„åç§°

### ç¼ºé™·4ï¼šæœ¬åœ°éªŒè¯ä¸å®Œæ•´

**é—®é¢˜**ï¼š
- `act --dryrun`åœ¨åŒ…å«servicesçš„workflowä¸Šè¶…æ—¶
- æ²¡æœ‰éªŒè¯PRè§¦å‘åœºæ™¯

**ç¼ºé™·**ï¼š
- éªŒè¯å·¥å…·é€‰æ‹©ä¸å½“
- éªŒè¯åœºæ™¯ä¸å…¨é¢

**ä¿®å¤**ï¼š
- ä½¿ç”¨`act --list`éªŒè¯è¯­æ³•
- å»ºç«‹å®Œæ•´çš„æœ¬åœ°éªŒè¯æµç¨‹

---

## ğŸ›¡ï¸ ç¡¬æ€§è¿è§„æ‹¦æˆªè§„åˆ™å’Œæ–¹æ¡ˆ

### è§„åˆ™1ï¼šå·¥ä½œæµè¯­æ³•éªŒè¯ï¼ˆç«‹å³å®æ–½ï¼‰

**è§„åˆ™**ï¼šæ‰€æœ‰å·¥ä½œæµæ–‡ä»¶å¿…é¡»é€šè¿‡ä»¥ä¸‹éªŒè¯ï¼š
1. YAMLè¯­æ³•æ£€æŸ¥
2. GitHub Actionsè¯­æ³•æ£€æŸ¥ï¼ˆä½¿ç”¨`act --list`ï¼‰
3. è§¦å‘é€»è¾‘éªŒè¯ï¼ˆç¡®ä¿PRå’Œpushéƒ½èƒ½è§¦å‘ï¼‰

**å®æ–½**ï¼š
```yaml
# .pre-commit-config.yaml æˆ– CIå·¥ä½œæµ
- repo: local
  hooks:
    - id: validate-workflows
      name: Validate GitHub Workflows
      entry: bash -c 'for f in .github/workflows/*.yml; do act push -W "$f" --list || exit 1; done'
      language: system
      pass_filenames: false
```

### è§„åˆ™2ï¼šåˆ†æ”¯ä¿æŠ¤è§„åˆ™ä¸å·¥ä½œæµJobåç§°ä¸€è‡´æ€§æ£€æŸ¥

**è§„åˆ™**ï¼šåˆ†æ”¯ä¿æŠ¤è§„åˆ™ä¸­è¦æ±‚çš„æ‰€æœ‰jobåç§°å¿…é¡»åœ¨å·¥ä½œæµä¸­å­˜åœ¨

**å®æ–½**ï¼š
```python
# scripts/validate-branch-protection.py
def validate_branch_protection():
    # 1. è¯»å–åˆ†æ”¯ä¿æŠ¤è§„åˆ™ï¼ˆé€šè¿‡GitHub APIæˆ–é…ç½®æ–‡ä»¶ï¼‰
    required_checks = get_required_checks()
    
    # 2. è§£ææ‰€æœ‰å·¥ä½œæµæ–‡ä»¶ï¼Œæå–jobåç§°
    workflow_jobs = parse_workflow_jobs()
    
    # 3. éªŒè¯æ¯ä¸ªrequired checkéƒ½æœ‰å¯¹åº”çš„job
    for check in required_checks:
        if not any(check in job for job in workflow_jobs):
            raise ValueError(f"Required check '{check}' not found in workflows")
```

### è§„åˆ™3ï¼šGitä¿æŠ¤è„šæœ¬çš„mergeåœºæ™¯è±å…

**è§„åˆ™**ï¼šGitä¿æŠ¤è„šæœ¬åœ¨mergeæ“ä½œæ—¶å¿…é¡»è·³è¿‡è‡ªåŠ¨æ›´æ–°

**å®æ–½**ï¼š
```bash
# scripts/git-protection-monitor.sh
if git rev-parse --verify MERGE_HEAD >/dev/null 2>&1; then
    echo "â­ï¸  æ£€æµ‹åˆ°mergeæ“ä½œï¼Œè·³è¿‡æ—¶é—´æˆ³æ›´æ–°"
    exit 0
fi
```

### è§„åˆ™4ï¼šå·¥ä½œæµå¿…é¡»åŒæ—¶æ”¯æŒpushå’Œpull_request

**è§„åˆ™**ï¼šæ‰€æœ‰ç”¨äºåˆ†æ”¯ä¿æŠ¤çš„å·¥ä½œæµå¿…é¡»åŒæ—¶æ”¯æŒ`push`å’Œ`pull_request`äº‹ä»¶

**å®æ–½**ï¼š
```python
# scripts/validate-workflow-triggers.py
def validate_workflow_triggers(workflow_file):
    with open(workflow_file) as f:
        workflow = yaml.safe_load(f)
    
    triggers = workflow.get('on', {})
    
    # æ£€æŸ¥æ˜¯å¦æœ‰pull_requestè§¦å‘å™¨
    if 'pull_request' not in triggers and 'workflow_call' not in triggers:
        raise ValueError(f"{workflow_file} must have pull_request or workflow_call trigger")
```

### è§„åˆ™5ï¼šæœ¬åœ°æµ‹è¯•é€šè¡Œè¯å¿…é¡»åŒ…å«å·¥ä½œæµéªŒè¯

**è§„åˆ™**ï¼šç”Ÿæˆæœ¬åœ°æµ‹è¯•é€šè¡Œè¯æ—¶å¿…é¡»éªŒè¯æ‰€æœ‰å·¥ä½œæµçš„è¯­æ³•å’Œè§¦å‘é€»è¾‘

**å®æ–½**ï¼š
```python
# scripts-golden/local_test_passport.py
def validate_workflows():
    workflows = glob.glob(".github/workflows/*.yml")
    for workflow in workflows:
        # ä½¿ç”¨ --list æ¨¡å¼éªŒè¯è¯­æ³•
        result = subprocess.run(
            ["act", "push", "-W", workflow, "--list"],
            timeout=300,
        )
        if result.returncode != 0:
            raise ValueError(f"Workflow {workflow} validation failed")
```

---

## ğŸš€ è®©åˆå¹¶è¿‡ç¨‹æ›´é¡ºç•…ä½†ä¿è¯åˆè§„çš„æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šè‡ªåŠ¨åŒ–å†²çªè§£å†³åŠ©æ‰‹

**ç›®æ ‡**ï¼šè‡ªåŠ¨è¯†åˆ«å’Œè§£å†³å¸¸è§å†²çªï¼ˆå¦‚æ—¶é—´æˆ³ã€.gitignoreç­‰ï¼‰

**å®æ–½**ï¼š
```python
# scripts/auto-resolve-conflicts.py
def auto_resolve_conflicts():
    conflicts = get_conflict_files()
    
    for file in conflicts:
        if file == '.git-protection-config':
            # æ—¶é—´æˆ³å†²çªï¼šé€‰æ‹©è¾ƒæ–°çš„ç‰ˆæœ¬
            resolve_timestamp_conflict(file)
        elif file == '.gitignore':
            # .gitignoreå†²çªï¼šåˆå¹¶ä¸¤ä¸ªç‰ˆæœ¬
            merge_gitignore(file)
        else:
            # å…¶ä»–å†²çªï¼šéœ€è¦äººå·¥è§£å†³
            mark_for_manual_resolution(file)
```

### æ–¹æ¡ˆ2ï¼šé¢„åˆå¹¶éªŒè¯å·¥ä½œæµ

**ç›®æ ‡**ï¼šåœ¨åˆ›å»ºPRå‰éªŒè¯æ‰€æœ‰å¿…éœ€æ£€æŸ¥éƒ½èƒ½é€šè¿‡

**å®æ–½**ï¼š
```yaml
# .github/workflows/pre-merge-validation.yml
name: Pre-Merge Validation
on:
  pull_request:
    types: [opened, synchronize]

jobs:
  validate-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Check workflow syntax
        run: |
          for f in .github/workflows/*.yml; do
            act push -W "$f" --list || exit 1
          done
      
      - name: Validate branch protection matches
        run: |
          python scripts/validate-branch-protection.py
```

### æ–¹æ¡ˆ3ï¼šæ™ºèƒ½åˆå¹¶ç­–ç•¥

**ç›®æ ‡**ï¼šæ ¹æ®æ–‡ä»¶ç±»å‹è‡ªåŠ¨é€‰æ‹©åˆå¹¶ç­–ç•¥

**å®æ–½**ï¼š
```yaml
# .github/merge-strategy.yml
merge_strategies:
  .git-protection-config:
    strategy: "newer"  # é€‰æ‹©è¾ƒæ–°çš„æ—¶é—´æˆ³
  .gitignore:
    strategy: "merge"  # åˆå¹¶ä¸¤ä¸ªç‰ˆæœ¬
  scripts/protect_golden_scripts.py:
    strategy: "dev"    # æ€»æ˜¯é€‰æ‹©devç‰ˆæœ¬ï¼ˆä»£ç æ”¹è¿›ï¼‰
  "*.md":
    strategy: "both"   # ä¿ç•™ä¸¤ä¸ªç‰ˆæœ¬çš„å†…å®¹
```

### æ–¹æ¡ˆ4ï¼šåˆå¹¶å‰æ£€æŸ¥æ¸…å•

**ç›®æ ‡**ï¼šåœ¨åˆå¹¶å‰è‡ªåŠ¨æ£€æŸ¥æ‰€æœ‰æ½œåœ¨é—®é¢˜

**å®æ–½**ï¼š
```bash
# scripts/pre-merge-checklist.sh
checklist=(
    "å·¥ä½œæµè¯­æ³•æ­£ç¡®"
    "åˆ†æ”¯ä¿æŠ¤è§„åˆ™åŒ¹é…"
    "æ²¡æœ‰æ—¶é—´æˆ³å†²çªé£é™©"
    "æ‰€æœ‰å¿…éœ€æ£€æŸ¥å·²é€šè¿‡"
    "ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡"
)

for item in "${checklist[@]}"; do
    if ! check_item "$item"; then
        echo "âŒ $item æ£€æŸ¥å¤±è´¥"
        exit 1
    fi
done

echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥åˆå¹¶"
```

### æ–¹æ¡ˆ5ï¼šå†²çªé¢„é˜²æœºåˆ¶

**ç›®æ ‡**ï¼šåœ¨å¼€å‘é˜¶æ®µå°±é¢„é˜²å†²çª

**å®æ–½**ï¼š
1. **æ—¶é—´æˆ³æ–‡ä»¶å¤„ç†**ï¼š
   - åœ¨mergeæ—¶è‡ªåŠ¨è·³è¿‡æ—¶é—´æˆ³æ›´æ–°
   - ä½¿ç”¨`.gitattributes`æ ‡è®°ä¸º"merge=ours"

2. **.gitignoreæ ‡å‡†åŒ–**ï¼š
   - å»ºç«‹`.gitignore`æ¨¡æ¿
   - å®šæœŸåŒæ­¥åˆ°æ‰€æœ‰åˆ†æ”¯

3. **ä»£ç æ”¹è¿›æµç¨‹**ï¼š
   - ä»£ç æ”¹è¿›å¿…é¡»é€šè¿‡PR
   - ä¸å…è®¸ç›´æ¥åœ¨mainåˆ†æ”¯ä¸Šä¿®æ”¹

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒæ•™è®­

1. **ç†è§£å·¥å…·é™åˆ¶**ï¼šGitHub APIä¸èƒ½è§£å†³æ‰€æœ‰é—®é¢˜ï¼Œå¿…é¡»ç†è§£Gitçš„åŸºæœ¬æœºåˆ¶
2. **ç³»ç»Ÿæ€§åˆ†æ**ï¼šä¸è¦åªä¿®å¤ç—‡çŠ¶ï¼Œè¦æ‰¾å‡ºæ ¹æœ¬åŸå› 
3. **å®Œæ•´éªŒè¯**ï¼šæœ¬åœ°éªŒè¯å¿…é¡»è¦†ç›–æ‰€æœ‰åœºæ™¯ï¼ˆpushã€PRã€mergeï¼‰
4. **é…ç½®ä¸€è‡´æ€§**ï¼šåˆ†æ”¯ä¿æŠ¤è§„åˆ™å¿…é¡»ä¸å·¥ä½œæµé…ç½®ä¿æŒä¸€è‡´
5. **é¢„é˜²èƒœäºä¿®å¤**ï¼šåœ¨å¼€å‘é˜¶æ®µå°±é¢„é˜²å†²çªï¼Œè€Œä¸æ˜¯äº‹åè§£å†³

### æ”¹è¿›æªæ–½

1. âœ… ä¿®å¤äº†gitä¿æŠ¤è„šæœ¬çš„mergeåœºæ™¯å¤„ç†
2. âœ… ä¸ºæ‰€æœ‰å·¥ä½œæµæ·»åŠ äº†pull_requestè§¦å‘å™¨
3. âœ… æ·»åŠ äº†ä¸“é—¨çš„run-tests jobåŒ¹é…åˆ†æ”¯ä¿æŠ¤è§„åˆ™
4. âœ… ä¿®å¤äº†test-suite.ymlçš„è¯­æ³•é”™è¯¯
5. âœ… æ”¹è¿›äº†æœ¬åœ°æµ‹è¯•é€šè¡Œè¯çš„éªŒè¯é€»è¾‘

### å¾…å®æ–½æªæ–½

1. â³ å»ºç«‹å·¥ä½œæµè¯­æ³•éªŒè¯çš„pre-commit hook
2. â³ å»ºç«‹åˆ†æ”¯ä¿æŠ¤è§„åˆ™ä¸å·¥ä½œæµçš„ä¸€è‡´æ€§æ£€æŸ¥
3. â³ å®ç°è‡ªåŠ¨åŒ–å†²çªè§£å†³åŠ©æ‰‹
4. â³ å»ºç«‹é¢„åˆå¹¶éªŒè¯å·¥ä½œæµ
5. â³ å®ç°æ™ºèƒ½åˆå¹¶ç­–ç•¥

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2024-12-07
**ä¿®å¤å®Œæˆæ—¶é—´**ï¼š2024-12-07
**æ€»è€—æ—¶**ï¼šçº¦8å°æ—¶ï¼ˆåŒ…æ‹¬5å°æ—¶å†¤æ‰è·¯ï¼‰

