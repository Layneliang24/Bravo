# V4方案测试场景对照表 (T01-T10)

> **创建日期**: 2025-12-02
> **测试目的**: 验证V4合规引擎在关键场景下的拦截效果
> **测试状态**: 待验证

## 📊 测试场景总览

| 编号   | 场景名称        | 测试目的                   | 是否通过  | 备注                    |
| ------ | --------------- | -------------------------- | --------- | ----------------------- |
| ✅ T01 | 有PRD无任务     | 验证必须先生成任务才能开发 | ⚠️ 待测试 | 需要验证Task-Master集成 |
| ✅ T02 | 跳过Task-0自检  | 验证Task-0是强制入口       | ⚠️ 待测试 | 需要验证Task-0机制      |
| ✅ T03 | 无测试文件      | 验证TDD强制执行            | ✅ 已通过 | 对应现有场景2           |
| ✅ T04 | 测试失败提交    | 验证红色阶段不可提交       | ⚠️ 待测试 | 需要集成测试运行器      |
| ✅ T05 | 功能删除未改PRD | 验证功能删除必须先改PRD    | ✅ 已通过 | 对应现有场景7           |
| ✅ T06 | 测试文件被删    | 验证测试文件不可随意删除   | ⚠️ 待测试 | 需要验证删除检测        |
| ✅ T07 | 绕过--no-verify | 验证无法绕过本地检查       | ⚠️ 待测试 | 需要验证CI强制检查      |
| ✅ T08 | CI与本地不一致  | 验证CI是终极防线           | ⚠️ 待测试 | 需要验证CI配置          |
| ✅ T09 | PRD状态为draft  | 验证PRD必须审核才能开发    | ⚠️ 待测试 | 需要验证PRD状态检查     |
| ✅ T10 | 多人协作冲突    | 验证锁机制与冲突处理       | ⚠️ 待测试 | 需要验证锁机制          |

## 🔍 现有测试覆盖情况

### 已通过的测试场景（来自现有测试报告）

根据 `.v4-test-results/reports/test-results-summary.md`：

| 现有场景 | 对应T0X | 测试内容                      | 状态    |
| -------- | ------- | ----------------------------- | ------- |
| 场景1    | -       | 缺少PRD关联的代码文件         | ✅ 通过 |
| 场景2    | T03     | 缺少测试文件的代码文件        | ✅ 通过 |
| 场景3    | T01     | 缺少Task-Master任务的代码文件 | ✅ 通过 |
| 场景4    | -       | PRD文件缺少必需元数据         | ✅ 通过 |
| 场景5    | -       | 测试文件命名不符合规范        | ✅ 通过 |
| 场景6    | -       | 提交信息格式不符合V4规范      | ✅ 通过 |
| 场景7    | T05     | 删除功能代码但PRD未授权       | ✅ 通过 |

**现有测试通过率**: 7/7 (100%)

## 📋 详细测试场景

### ✅ T01: 有PRD无任务

**测试目的**: 验证必须先生成任务才能开发

**当前状态**: ⚠️ 部分实现

**已实现**:

- ✅ CodeChecker.\_check_task_link() 已实现
- ✅ 现有场景3已测试"缺少Task-Master任务"

**待验证**:

- ⚠️ 当前仅为警告，不是错误
- ⚠️ 需要在strict_mode下改为错误
- ⚠️ 需要验证Task-Master任务文件路径解析

**测试步骤**:

1. 创建PRD文件（包含完整元数据）
2. 创建代码文件（包含REQ-ID，但无对应Task-Master任务）
3. 尝试提交
4. 验证是否被拦截

**预期结果**: ❌ 提交应被拦截，错误信息："代码文件必须关联Task-Master任务"

---

### ✅ T02: 跳过Task-0自检

**测试目的**: 验证Task-0是强制入口

**当前状态**: ❌ 未实现

**问题**:

- ❌ 当前没有Task-0自检机制
- ❌ 没有验证Task-0是否完成

**需要实现**:

1. Task-0自检检查器
2. 验证Task-0状态为"done"
3. 拦截未完成Task-0就开始其他任务的提交

**测试步骤**:

1. 创建Task-1的代码（Task-0未完成）
2. 尝试提交
3. 验证是否被拦截

**预期结果**: ❌ 提交应被拦截，错误信息："必须先完成Task-0自检"

---

### ✅ T03: 无测试文件

**测试目的**: 验证TDD强制执行

**当前状态**: ✅ 已通过

**已实现**:

- ✅ TestChecker.check() 完整实现
- ✅ 现有场景2已测试并通过

**测试结果**:

- ✅ 提交被正确拦截
- ✅ 错误信息清晰："代码文件必须有对应的测试文件"

**对应日志**: `.v4-test-results/logs/scenario2-test.log`

---

### ✅ T04: 测试失败提交

**测试目的**: 验证红色阶段不可提交

**当前状态**: ❌ 未实现

**问题**:

- ❌ 当前没有集成测试运行器
- ❌ 没有验证测试是否通过

**需要实现**:

1. 在pre-commit钩子中运行测试
2. 验证测试结果
3. 测试失败时拦截提交

**测试步骤**:

1. 创建代码文件和测试文件
2. 测试文件包含失败的测试用例
3. 尝试提交
4. 验证是否被拦截

**预期结果**: ❌ 提交应被拦截，错误信息："测试失败，不允许提交"

---

### ✅ T05: 功能删除未改PRD

**测试目的**: 验证功能删除必须先改PRD

**当前状态**: ✅ 已通过

**已实现**:

- ✅ CodeChecker.\_check_deletion_authorization() 完整实现
- ✅ 现有场景7已测试并通过

**测试结果**:

- ✅ 提交被正确拦截
- ✅ 错误信息清晰："删除功能代码需要PRD授权"

**对应日志**: `.v4-test-results/logs/scenario7-test.log`

---

### ✅ T06: 测试文件被删

**测试目的**: 验证测试文件不可随意删除

**当前状态**: ⚠️ 部分实现

**已实现**:

- ✅ 删除检测逻辑存在
- ✅ 可以检测到文件删除

**待验证**:

- ⚠️ 需要验证测试文件删除是否需要PRD授权
- ⚠️ 需要验证删除测试文件时是否检查对应代码文件

**测试步骤**:

1. 删除现有测试文件
2. 不修改PRD的deletable字段
3. 尝试提交
4. 验证是否被拦截

**预期结果**: ❌ 提交应被拦截，错误信息："删除测试文件需要PRD授权"

---

### ✅ T07: 绕过--no-verify

**测试目的**: 验证无法绕过本地检查

**当前状态**: ⚠️ 待验证

**需要验证**:

1. 使用 `git commit --no-verify` 是否能绕过检查
2. CI是否会捕获绕过本地检查的提交
3. 服务器端钩子是否正确配置

**测试步骤**:

1. 创建不符合规范的代码
2. 使用 `git commit --no-verify` 提交
3. Push到远程仓库
4. 验证CI是否拦截

**预期结果**:

- ⚠️ 本地可能绕过（这是Git的特性）
- ✅ CI必须拦截

---

### ✅ T08: CI与本地不一致

**测试目的**: 验证CI是终极防线

**当前状态**: ⚠️ 待验证

**需要验证**:

1. CI配置是否与本地pre-commit一致
2. CI是否使用相同的合规引擎
3. CI是否能捕获所有本地检查的问题

**测试步骤**:

1. 修改本地pre-commit钩子（禁用某些检查）
2. 提交不符合规范的代码
3. Push到远程仓库
4. 验证CI是否拦截

**预期结果**: ✅ CI必须拦截所有不符合规范的提交

---

### ✅ T09: PRD状态为draft

**测试目的**: 验证PRD必须审核才能开发

**当前状态**: ❌ 未实现

**问题**:

- ❌ 当前没有检查PRD的status字段
- ❌ 没有验证PRD是否为approved状态

**需要实现**:

1. PRDChecker检查status字段
2. 拦截status为draft的PRD关联的代码提交
3. 只允许status为approved的PRD

**测试步骤**:

1. 创建PRD文件（status: draft）
2. 创建关联的代码文件
3. 尝试提交
4. 验证是否被拦截

**预期结果**: ❌ 提交应被拦截，错误信息："PRD状态为draft，必须先审核通过"

---

### ✅ T10: 多人协作冲突

**测试目的**: 验证锁机制与冲突处理

**当前状态**: ❌ 未实现

**问题**:

- ❌ 当前没有锁机制
- ❌ 没有冲突检测

**需要实现**:

1. 任务锁机制（防止多人同时修改同一任务）
2. PRD锁机制（防止多人同时修改同一PRD）
3. 冲突检测和提示

**测试步骤**:

1. 用户A开始Task-1（创建锁）
2. 用户B尝试修改Task-1关联的代码
3. 验证是否被拦截或警告

**预期结果**: ⚠️ 应警告或拦截，提示："Task-1正在被其他用户修改"

---

## 📊 测试覆盖率统计

### 总体统计

- **已通过**: 2/10 (20%) - T03, T05
- **部分实现**: 3/10 (30%) - T01, T06, T07
- **待实现**: 5/10 (50%) - T02, T04, T08, T09, T10

### 按优先级分类

**高优先级（必须实现）**:

- ❌ T02: Task-0自检机制
- ❌ T04: 测试失败拦截
- ❌ T09: PRD状态检查

**中优先级（建议实现）**:

- ⚠️ T01: Task-Master任务检查（改为错误）
- ⚠️ T06: 测试文件删除检查
- ⚠️ T08: CI一致性验证

**低优先级（可选实现）**:

- ⚠️ T07: 绕过检查验证（CI层面）
- ❌ T10: 锁机制（复杂，可后期实现）

---

## 🎯 下一步行动计划

### 阶段1: 完善现有检查器（高优先级）

1. **T02: 实现Task-0自检机制**

   - 创建Task0Checker
   - 验证Task-0状态
   - 集成到合规引擎

2. **T04: 集成测试运行器**

   - 在pre-commit钩子中运行pytest
   - 验证测试结果
   - 测试失败时拦截提交

3. **T09: 实现PRD状态检查**
   - 修改PRDChecker
   - 检查status字段
   - 拦截draft状态的PRD

### 阶段2: 优化现有功能（中优先级）

4. **T01: 将Task-Master检查改为错误**

   - 修改CodeChecker.\_check_task_link()
   - 在strict_mode下返回错误而非警告

5. **T06: 完善测试文件删除检查**

   - 验证测试文件删除逻辑
   - 确保需要PRD授权

6. **T08: 验证CI配置一致性**
   - 对比本地和CI的检查逻辑
   - 确保CI使用相同的合规引擎

### 阶段3: 高级功能（低优先级）

7. **T07: CI强制检查**

   - 配置服务器端钩子
   - 确保无法绕过CI检查

8. **T10: 实现锁机制**
   - 设计锁机制架构
   - 实现任务锁和PRD锁
   - 集成到合规引擎

---

## 📝 测试执行记录

### 测试环境

- **分支**: feature/v4-test-t01-t10
- **Docker环境**: ✅ 已配置
- **Git钩子**: ✅ 已安装
- **合规引擎**: ✅ V4架构

### 测试执行日志

测试日志将保存在：

- `.v4-test-results/logs/t01-*.log`
- `.v4-test-results/logs/t02-*.log`
- ...
- `.v4-test-results/logs/t10-*.log`

### 测试报告

测试完成后，将生成：

- `.v4-test-results/reports/t01-t10-summary.md` - 总结报告
- `.v4-test-results/reports/t01-t10-detailed.md` - 详细报告

---

## 🔗 相关文档

- [V4架构设计文档](../architecture/V4/AI-WORKFLOW-V4-PART1-ARCH.md)
- [V4合规引擎文档](../architecture/V4/AI-WORKFLOW-V4-PART5-COMPLIANCE.md)
- [现有测试结果](../../.v4-test-results/reports/test-results-summary.md)
- [测试计划](../architecture/V4/V4_COMPLIANCE_TEST_PLAN.md)

---

_本文档由AI Assistant生成，日期：2025-12-02_
_回答模型：Claude 3.5 Sonnet (claude-sonnet-4-20250514)_
