# GitHub Actions IP 白名单配置指南

## 问题说明

GitHub Actions 的 Runner IP 是动态的，每次运行可能使用不同的 IP 地址。如果只添加单个 IP 到白名单，其他 Runner IP 会被阻止，导致 SSH 连接超时。

## 重要提示：轻量应用服务器 vs 云服务器

### 轻量应用服务器

- 使用**服务器级别的防火墙**（在服务器管理页面中配置）
- **不支持安全组**配置
- 防火墙规则在服务器管理页面的"防火墙"标签中配置

### 云服务器（CVM）

- 使用**安全组**（在云服务器控制台配置）
- 安全组规则在"安全组"页面中配置

**如果您的服务器防火墙已经允许所有IPv4地址访问22端口，但SSH连接仍然超时，可能的原因：**

1. **DDoS防护或网络ACL**：腾讯云可能在网络层面有额外的防护
2. **轻量应用服务器的网络限制**：某些轻量应用服务器可能有特殊的网络配置
3. **IP段限制**：虽然允许所有IP，但可能对某些IP段有特殊限制

## 解决方案

### 对于轻量应用服务器

如果防火墙已经允许所有IPv4地址访问22端口，但连接仍然超时，建议：

1. **检查DDoS防护设置**：在轻量应用服务器控制台检查是否有DDoS防护或网络ACL设置
2. **检查网络监控**：查看是否有异常的网络流量或连接尝试
3. **联系腾讯云支持**：如果以上都正常，可能需要联系腾讯云技术支持检查网络层面的限制

### 对于云服务器（CVM）

需要在腾讯云安全组中添加整个 GitHub Actions IP 段，而不是单个 IP。

## 获取 GitHub Actions IP 范围

GitHub Actions 使用的 IP 范围可以通过以下方式获取：

```bash
curl https://api.github.com/meta | jq '.actions[]'
```

或者访问：https://api.github.com/meta

## 主要 IPv4 IP 段（需要添加到安全组）

以下是 GitHub Actions 使用的主要 IPv4 IP 段（CIDR 格式）：

### Azure 区域（主要）

- `4.148.0.0/16`
- `4.149.0.0/18`
- `4.149.64.0/19`
- `4.149.96.0/19`
- `4.149.128.0/17`
- `4.150.0.0/18`
- `4.150.64.0/18`
- `4.150.128.0/18`
- `4.150.192.0/19`
- `4.150.224.0/19`
- `4.151.0.0/16`
- `4.152.0.0/15`
- `4.154.0.0/15`
- `4.156.0.0/15`
- `4.175.0.0/16`
- `4.180.0.0/16`
- `4.207.0.0/16`
- `4.208.0.0/15`
- `4.210.0.0/17`
- `4.210.128.0/17`
- `4.227.0.0/17`
- `4.227.128.0/17`
- `4.231.0.0/17`
- `4.231.128.0/17`
- `4.236.0.0/17`
- `4.236.128.0/17`
- `4.242.0.0/17`
- `4.242.128.0/17`
- `4.245.0.0/17`
- `4.245.128.0/17`
- `4.246.0.0/17`
- `4.246.128.0/17`
- `4.249.0.0/17`
- `4.249.128.0/17`
- `4.255.0.0/17`
- `4.255.128.0/17`

### 其他区域

- `9.163.0.0/16`
- `9.169.0.0/17`
- `9.169.128.0/17`
- `9.234.0.0/17`
- `9.234.128.0/17`
- `13.64.0.0/16` 到 `13.105.255.255/32`（大量子网）
- `20.1.128.0/17` 到 `20.253.255.255/32`（大量子网）
- `23.96.0.0/17` 到 `23.102.255.255/32`（大量子网）
- `40.64.0.0/18` 到 `40.77.255.255/32`（大量子网）

**注意**：GitHub Actions 的 IP 范围非常大，包含数百个 IP 段。建议使用脚本自动获取并添加。

## 腾讯云安全组配置步骤

### 方法1：手动添加（适用于少量 IP 段）

1. 登录腾讯云控制台
2. 进入 **云服务器** → **安全组**
3. 找到你的服务器使用的安全组
4. 点击 **入站规则** → **添加规则**
5. 配置规则：
   - **类型**：自定义
   - **来源**：输入 IP 段（CIDR 格式，如 `4.148.0.0/16`）
   - **协议端口**：TCP:22
   - **策略**：允许
   - **备注**：GitHub Actions
6. 重复步骤 4-5，添加所有 IP 段

### 方法2：使用脚本批量添加（推荐）

由于 GitHub Actions 的 IP 段非常多，建议使用脚本自动获取并添加。

```bash
# 获取所有 GitHub Actions IP 段
curl -s https://api.github.com/meta | jq -r '.actions[]' | grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+/[0-9]+$' > github-actions-ips.txt

# 然后使用腾讯云 CLI 批量添加
# 注意：需要先安装腾讯云 CLI 并配置认证
```

### 方法3：临时测试（不推荐用于生产）

如果只是临时测试，可以临时允许所有 IP 访问 22 端口：

1. 在安全组中添加规则：

   - **来源**：`0.0.0.0/0`
   - **协议端口**：TCP:22
   - **策略**：允许
   - **备注**：临时测试 - GitHub Actions

2. **重要**：测试完成后，删除此规则，改为添加具体的 GitHub Actions IP 段。

## 验证配置

配置完成后，可以通过以下方式验证：

1. 查看工作流日志中的 "SSH Connection Diagnostics" 步骤
2. 确认显示的 Runner IP 是否在已添加的 IP 段范围内
3. 如果 SSH 连接成功，说明配置正确

## 自动更新 IP 段

GitHub Actions 的 IP 范围可能会定期更新，建议：

1. 定期检查 GitHub 的 meta API：https://api.github.com/meta
2. 使用脚本自动同步 IP 段到安全组
3. 或者订阅 GitHub 的 IP 变更通知

## 相关链接

- GitHub Actions IP 范围：https://api.github.com/meta
- 腾讯云安全组文档：https://cloud.tencent.com/document/product/213/12452
