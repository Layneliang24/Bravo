# workflow_run headBranch é—®é¢˜åˆ†æ

## é—®é¢˜æè¿°

è‡ªåŠ¨éƒ¨ç½²å·¥ä½œæµå¤±è´¥ï¼Œä½¿ç”¨äº†æ—§ç‰ˆæœ¬çš„å·¥ä½œæµæ–‡ä»¶ï¼ˆcommit `7242a7661d83e910e4f40b34740c6180d638d0cc`ï¼‰ï¼Œå¯¼è‡´éƒ¨ç½²è„šæœ¬ä»åœ¨æ‰§è¡Œ `git clone` ç­‰æ—§é€»è¾‘ã€‚

## æ ¹æœ¬åŸå› 

### 1. workflow_run è§¦å‘æœºåˆ¶

`workflow_run` è§¦å‘æ—¶ï¼ŒGitHub Actions çš„è¡Œä¸ºï¼š

1. **å·¥ä½œæµæ–‡ä»¶ç‰ˆæœ¬ç¡®å®šæ—¶æœº**ï¼šå·¥ä½œæµæ–‡ä»¶æœ¬èº«åœ¨è§¦å‘æ—¶ç¡®å®šï¼Œä½¿ç”¨çš„æ˜¯è§¦å‘å·¥ä½œæµï¼ˆæ„å»ºå·¥ä½œæµï¼‰çš„ `headBranch` å’Œ `headSha`
2. **headBranch ç»§æ‰¿**ï¼šå¦‚æœæ„å»ºå·¥ä½œæµä» `main` åˆ†æ”¯è§¦å‘ï¼Œéƒ¨ç½²å·¥ä½œæµçš„ `headBranch` ä¹Ÿä¼šæ˜¯ `main`
3. **branches é™åˆ¶ä¸è¶³**ï¼šè™½ç„¶è®¾ç½®äº† `branches: [dev]`ï¼Œä½†è¿™åªé™åˆ¶è§¦å‘æ¡ä»¶ï¼Œä¸ä¿è¯å·¥ä½œæµæ–‡ä»¶ä½¿ç”¨ dev åˆ†æ”¯çš„ç‰ˆæœ¬

### 2. å®é™…å‘ç”Ÿçš„æƒ…å†µ

ä»è¿è¡Œè®°å½•åˆ†æï¼š
- æ„å»ºå·¥ä½œæµï¼ˆ20120249577ï¼‰ï¼š`headBranch: "dev"`ï¼ŒæˆåŠŸ
- è‡ªåŠ¨éƒ¨ç½²å·¥ä½œæµï¼ˆ20120288322ï¼‰ï¼š`headBranch: "main"`ï¼Œ`headSha: "7242a76"`ï¼ˆæ—§commitï¼‰ï¼Œå¤±è´¥

**é—®é¢˜**ï¼šè™½ç„¶æ„å»ºå·¥ä½œæµä» dev åˆ†æ”¯è§¦å‘ï¼Œä½†è‡ªåŠ¨éƒ¨ç½²å·¥ä½œæµçš„ `headBranch` å´æ˜¯ `main`ï¼Œè¯´æ˜ï¼š
- å¯èƒ½æœ‰å…¶ä»–æ„å»ºå·¥ä½œæµä» main åˆ†æ”¯è§¦å‘ï¼Œå¯¼è‡´éƒ¨ç½²å·¥ä½œæµè¢«é”™è¯¯è§¦å‘
- æˆ–è€… `workflow_run` çš„ `branches: [dev]` é™åˆ¶æ²¡æœ‰æ­£ç¡®å·¥ä½œ

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šåœ¨ if æ¡ä»¶ä¸­æ£€æŸ¥ head_branchï¼ˆå·²å®æ–½ï¼‰

```yaml
if: ${{ github.event_name == 'workflow_dispatch' || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'dev') }}
```

**ä¼˜ç‚¹**ï¼š
- ç¡®ä¿åªæœ‰ä» dev åˆ†æ”¯è§¦å‘çš„æ„å»ºå·¥ä½œæµæ‰ä¼šè§¦å‘éƒ¨ç½²
- å³ä½¿ `workflow_run` è¢«é”™è¯¯è§¦å‘ï¼Œä¹Ÿä¼šåœ¨ if æ¡ä»¶ä¸­è¢«è¿‡æ»¤

**ç¼ºç‚¹**ï¼š
- å¦‚æœæ„å»ºå·¥ä½œæµä» main åˆ†æ”¯è§¦å‘ï¼Œéƒ¨ç½²å·¥ä½œæµä¸ä¼šæ‰§è¡Œï¼ˆè¿™æ˜¯æœŸæœ›çš„è¡Œä¸ºï¼‰

### æ–¹æ¡ˆ2ï¼šç¡®ä¿æ„å»ºå·¥ä½œæµåªä» dev åˆ†æ”¯è§¦å‘

æ£€æŸ¥ `build-and-push-images.yml` çš„è§¦å‘æ¡ä»¶ï¼Œç¡®ä¿ï¼š
- åªæœ‰ dev åˆ†æ”¯çš„ push æ‰ä¼šè§¦å‘æ„å»º
- æˆ–è€…ï¼Œåœ¨æ„å»ºå·¥ä½œæµä¸­æ·»åŠ åˆ†æ”¯æ£€æŸ¥

### æ–¹æ¡ˆ3ï¼šä½¿ç”¨ workflow_call æ›¿ä»£ workflow_run

`workflow_call` å¯ä»¥æ›´ç²¾ç¡®åœ°æ§åˆ¶è§¦å‘æ¡ä»¶ï¼Œä½†éœ€è¦ä¿®æ”¹æ„å»ºå·¥ä½œæµï¼Œåœ¨æ„å»ºå®Œæˆåæ˜¾å¼è°ƒç”¨éƒ¨ç½²å·¥ä½œæµã€‚

## éªŒè¯æ–¹æ³•

1. **æ£€æŸ¥æ„å»ºå·¥ä½œæµçš„è§¦å‘åˆ†æ”¯**ï¼š
   ```bash
   gh run list --workflow="ğŸ³ Build and Push Docker Images" --limit 10 --json headBranch,event
   ```

2. **æ£€æŸ¥éƒ¨ç½²å·¥ä½œæµçš„è§¦å‘æ¥æº**ï¼š
   ```bash
   gh run view <run-id> --json event,headBranch,headSha
   ```

3. **éªŒè¯ä¿®å¤æ•ˆæœ**ï¼š
   - è§¦å‘ä¸€æ¬¡æ„å»ºå·¥ä½œæµï¼ˆä» dev åˆ†æ”¯ï¼‰
   - æ£€æŸ¥è‡ªåŠ¨éƒ¨ç½²å·¥ä½œæµæ˜¯å¦ä½¿ç”¨æ­£ç¡®çš„ headBranch å’Œ headSha

## å‚è€ƒæ–‡æ¡£

- [GitHub Actions: workflow_run](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow_run)
- [GitHub Actions: workflow_run context](https://docs.github.com/en/actions/learn-github-actions/contexts#workflow_run-context)

