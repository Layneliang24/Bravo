# V4架构合规引擎测试计划

> **创建日期**: 2025-11-30
> **目标**: 全面验证V4架构的合规引擎是否完整落地，各种场景是否被正确约束

## 📋 测试场景清单

### 场景1: 没有PRD文件时提交代码
**预期行为**: 应该被拦截
**测试步骤**:
1. 创建新代码文件（无PRD关联）
2. 尝试提交
3. 验证是否被合规引擎拦截

### 场景2: 没有测试文件时提交代码
**预期行为**: 应该被拦截
**测试步骤**:
1. 创建代码文件（有PRD但无测试文件）
2. 尝试提交
3. 验证是否被合规引擎拦截

### 场景3: 没有Task-Master任务时提交代码
**预期行为**: 应该被拦截或警告
**测试步骤**:
1. 创建代码文件（有PRD但无Task-Master任务）
2. 尝试提交
3. 验证是否被合规引擎拦截

### 场景4: PRD元数据不完整
**预期行为**: 应该被拦截
**测试步骤**:
1. 创建PRD文件但缺少必需字段（test_files, implementation_files等）
2. 尝试提交
3. 验证是否被合规引擎拦截

### 场景5: 测试文件位置不正确
**预期行为**: 应该被拦截
**测试步骤**:
1. 在错误位置创建测试文件（如backend/下而非backend/tests/unit/）
2. 尝试提交
3. 验证是否被合规引擎拦截

### 场景6: 测试文件命名不规范
**预期行为**: 应该被拦截
**测试步骤**:
1. 创建测试文件但命名不符合规范（如test.py而非test_module.py）
2. 尝试提交
3. 验证是否被合规引擎拦截

### 场景7: 代码文件缺少追溯链
**预期行为**: 应该警告或拦截
**测试步骤**:
1. 创建代码文件但缺少REQ-ID注释
2. 尝试提交
3. 验证是否被合规引擎警告或拦截

### 场景8: 删除功能未更新PRD
**预期行为**: 应该被拦截
**测试步骤**:
1. 删除已有功能代码
2. 未更新PRD的deletable字段
3. 尝试提交
4. 验证是否被合规引擎拦截

## 🔍 当前实现检查

### 已实现的检查器

1. **PRDChecker** ✅
   - 检查Frontmatter格式
   - 验证必需元数据字段
   - 验证字段格式（req_id, status等）
   - 验证文件结构（必需章节）
   - 验证内容长度

2. **TestChecker** ✅
   - 检查文件位置
   - 检查文件命名
   - 检查文件内容（测试函数、断言）

3. **CodeChecker** ✅
   - 检查PRD关联（通过注释）
   - 检查代码质量（文档字符串、类型提示）

4. **CommitChecker** ✅
   - 检查提交信息格式

5. **TaskChecker** ✅
   - 检查Task-Master任务文件结构

### 缺失的检查逻辑

根据V4设计文档，以下检查逻辑**尚未完全实现**：

1. **代码文件与PRD的强制关联** ⚠️
   - 当前：仅警告，不强制拦截
   - 设计要求：必须拦截

2. **代码文件与测试文件的强制关联** ⚠️
   - 当前：TestChecker检查测试文件本身，但不检查代码文件是否有对应测试
   - 设计要求：提交代码文件时，必须检查是否有对应测试文件

3. **Task-Master任务的强制关联** ⚠️
   - 当前：TaskChecker检查任务文件，但不检查代码文件是否有对应任务
   - 设计要求：提交代码文件时，必须检查是否有对应Task-Master任务

4. **删除功能的PRD授权检查** ❌
   - 当前：未实现
   - 设计要求：检测到功能删除时，必须检查PRD的deletable字段

5. **自动回滚机制** ❌
   - 当前：未实现
   - 设计要求：检测到违规删除时，自动git revert

## 📊 实现完整性评估

| 功能模块 | 设计文档要求 | 当前实现 | 完整性 | 备注 |
|---------|------------|---------|--------|------|
| PRD元数据验证 | ✅ 必需 | ✅ 已实现 | 100% | 完整 |
| PRD文件结构验证 | ✅ 必需 | ✅ 已实现 | 100% | 完整 |
| 测试文件位置验证 | ✅ 必需 | ✅ 已实现 | 100% | 完整 |
| 测试文件命名验证 | ✅ 必需 | ✅ 已实现 | 100% | 完整 |
| 测试文件内容验证 | ✅ 必需 | ✅ 已实现 | 80% | 缺少覆盖率检查 |
| 代码文件PRD关联 | ✅ 必需 | ⚠️ 仅警告 | 50% | 需要改为强制拦截 |
| 代码文件测试关联 | ✅ 必需 | ❌ 未实现 | 0% | 需要实现 |
| 代码文件任务关联 | ✅ 必需 | ❌ 未实现 | 0% | 需要实现 |
| 删除功能PRD授权 | ✅ 必需 | ❌ 未实现 | 0% | 需要实现 |
| 自动回滚机制 | ✅ 必需 | ❌ 未实现 | 0% | 需要实现 |
| 提交信息格式验证 | ✅ 必需 | ✅ 已实现 | 100% | 完整 |
| Task-Master任务验证 | ✅ 必需 | ✅ 已实现 | 80% | 缺少与代码文件的关联检查 |

## 🎯 需要补充的实现

### 优先级1: 核心约束（必须实现）

1. **代码文件与PRD的强制关联检查**
   - 位置：`CodeChecker._check_prd_link()`
   - 修改：从警告改为错误，在strict_mode下拒绝提交

2. **代码文件与测试文件的关联检查**
   - 位置：新增 `CodeChecker._check_test_file_exists()`
   - 逻辑：检查代码文件是否有对应的测试文件

3. **代码文件与Task-Master任务的关联检查**
   - 位置：新增 `CodeChecker._check_task_exists()`
   - 逻辑：检查代码文件是否有对应的Task-Master任务

### 优先级2: 删除功能保护（重要）

4. **删除功能的PRD授权检查**
   - 位置：新增 `CodeChecker._check_deletion_authorization()`
   - 逻辑：检测git diff中的删除操作，检查PRD的deletable字段

5. **自动回滚机制**
   - 位置：`engine.py` 或新增 `rollback.py`
   - 逻辑：检测到严重违规时，自动执行git revert

### 优先级3: 增强功能（可选）

6. **测试覆盖率检查**
   - 位置：`TestChecker._check_coverage()`
   - 逻辑：运行覆盖率工具，检查是否达到最低要求

7. **API契约验证**
   - 位置：新增 `ApiContractChecker`
   - 逻辑：检查API变更是否更新了OpenAPI契约

## 📝 测试验证脚本

需要创建自动化测试脚本来验证各种场景：

```bash
scripts/compliance/test_scenarios.sh
```

测试场景包括：
- 场景1-8的所有情况
- 边界情况
- 错误处理

## 🔄 下一步行动

1. **立即补充**：优先级1的核心约束检查
2. **重要补充**：优先级2的删除功能保护
3. **完善测试**：创建自动化测试脚本
4. **文档更新**：更新实施状态文档

