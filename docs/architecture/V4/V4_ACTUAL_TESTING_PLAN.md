# V4架构实际测试计划

> **创建日期**: 2025-01-30
> **测试目标**: 验证V4合规引擎在实际场景中的拦截效果
> **测试方法**: 人类视角实际操作 + 日志记录 + 截图保存

## 📋 测试概述

### 测试目标

验证V4合规引擎在以下场景中能够正确拦截违规提交：

1. 缺少PRD关联的代码提交
2. 缺少测试文件的代码提交
3. 缺少Task-Master任务的代码提交
4. PRD元数据不完整的提交
5. 删除功能未授权的提交
6. 提交信息格式错误的提交

### 测试环境

- **分支**: `feature/v4-compliance-testing`
- **测试方法**: 实际操作 + 观察拦截效果
- **记录方式**: 日志文件 + 截图 + 测试报告

## 🎯 测试场景设计

### 场景1: 缺少PRD关联的代码提交

#### 测试步骤

1. 创建新分支：`git checkout -b feature/v4-compliance-testing`
2. 创建一个新的Python文件（不包含REQ-ID）：
   ```python
   # backend/apps/example/views.py
   def test_view(request):
       return {"status": "ok"}
   ```
3. 尝试提交：`git add backend/apps/example/views.py && git commit -m "[REQ-2025-TEST] 测试缺少PRD关联"`
4. 观察pre-commit钩子是否拦截

#### 预期结果

- ❌ pre-commit钩子应该拦截提交
- 错误提示：`代码文件必须包含REQ-ID关联（在文件头部注释中）`
- 提交被拒绝

#### 实际结果记录

```
[ ] 测试时间: ___________
[ ] 测试结果: 通过 / 失败
[ ] 错误信息: ___________
[ ] 截图路径: ___________
```

---

### 场景2: 缺少测试文件的代码提交

#### 测试步骤

1. 创建一个包含REQ-ID的代码文件：
   ```python
   # backend/apps/example/views.py
   # REQ-ID: REQ-2025-TEST-001
   def test_view(request):
       return {"status": "ok"}
   ```
2. 不创建对应的测试文件
3. 尝试提交：`git add backend/apps/example/views.py && git commit -m "[REQ-2025-TEST-001] 测试缺少测试文件"`
4. 观察pre-commit钩子是否拦截

#### 预期结果

- ❌ pre-commit钩子应该拦截提交
- 错误提示：明确指出需要创建的测试文件路径
- 提交被拒绝

#### 实际结果记录

```
[ ] 测试时间: ___________
[ ] 测试结果: 通过 / 失败
[ ] 错误信息: ___________
[ ] 截图路径: ___________
```

---

### 场景3: 缺少Task-Master任务的代码提交

#### 测试步骤

1. 创建一个包含REQ-ID和测试文件的代码文件：
   ```python
   # backend/apps/example/views.py
   # REQ-ID: REQ-2025-TEST-002
   def test_view(request):
       return {"status": "ok"}
   ```
2. 创建对应的测试文件：
   ```python
   # backend/tests/unit/test_example_views.py
   def test_test_view():
       assert True
   ```
3. 不创建Task-Master任务目录
4. 尝试提交：`git add . && git commit -m "[REQ-2025-TEST-002] 测试缺少Task-Master任务"`
5. 观察pre-commit钩子是否拦截

#### 预期结果

- ❌ pre-commit钩子应该拦截提交
- 错误提示：`代码文件缺少Task-Master任务关联`
- 提交被拒绝

#### 实际结果记录

```
[ ] 测试时间: ___________
[ ] 测试结果: 通过 / 失败
[ ] 错误信息: ___________
[ ] 截图路径: ___________
```

---

### 场景4: PRD元数据不完整的提交

#### 测试步骤

1. 创建一个PRD文件，但缺少必需字段（如`test_files`）：

   ```markdown
   ---
   req_id: REQ-2025-TEST-003
   title: 测试PRD
   status: draft
   # 缺少 test_files
   # 缺少 implementation_files
   ---

   # 测试PRD内容
   ```

2. 尝试提交：`git add docs/00_product/requirements/REQ-2025-TEST-003/REQ-2025-TEST-003.md && git commit -m "[REQ-2025-TEST-003] 测试PRD元数据不完整"`
3. 观察pre-commit钩子是否拦截

#### 预期结果

- ❌ pre-commit钩子应该拦截提交
- 错误提示：`PRD元数据缺少必需字段: test_files, implementation_files`
- 提交被拒绝

#### 实际结果记录

```
[ ] 测试时间: ___________
[ ] 测试结果: 通过 / 失败
[ ] 错误信息: ___________
[ ] 截图路径: ___________
```

---

### 场景5: 删除功能未授权的提交

#### 测试步骤

1. 创建一个功能文件：
   ```python
   # backend/apps/example/views.py
   # REQ-ID: REQ-2025-TEST-004
   def important_function(request):
       return {"status": "important"}
   ```
2. 创建对应的PRD，但`deletable: false`
3. 删除该功能文件
4. 尝试提交：`git add . && git commit -m "[REQ-2025-TEST-004] 删除功能（未授权）"`
5. 观察pre-commit钩子是否拦截

#### 预期结果

- ❌ pre-commit钩子应该拦截提交
- 错误提示：`删除功能未获得PRD授权`
- 提交被拒绝

#### 实际结果记录

```
[ ] 测试时间: ___________
[ ] 测试结果: 通过 / 失败
[ ] 错误信息: ___________
[ ] 截图路径: ___________
```

---

### 场景6: 提交信息格式错误的提交

#### 测试步骤

1. 创建一个符合所有要求的代码文件（有PRD、测试、任务）
2. 使用错误的提交信息格式：`git commit -m "fix: 测试提交"`
3. 观察commit-msg钩子是否拦截

#### 预期结果

- ❌ commit-msg钩子应该拦截提交
- 错误提示：`提交信息格式不符合V4规范`
- 提交被拒绝

#### 实际结果记录

```
[ ] 测试时间: ___________
[ ] 测试结果: 通过 / 失败
[ ] 错误信息: ___________
[ ] 截图路径: ___________
```

---

### 场景7: 正确的提交（应该通过）

#### 测试步骤

1. 创建完整的PRD文件（包含所有必需字段）
2. 创建代码文件（包含REQ-ID）
3. 创建测试文件
4. 创建Task-Master任务目录
5. 使用正确的提交信息格式：`git commit -m "[REQ-2025-TEST-005] Task-1 实现测试功能"`
6. 观察所有钩子是否通过

#### 预期结果

- ✅ pre-commit钩子通过
- ✅ commit-msg钩子通过
- ✅ post-commit钩子执行状态同步
- 提交成功

#### 实际结果记录

```
[ ] 测试时间: ___________
[ ] 测试结果: 通过 / 失败
[ ] 日志输出: ___________
[ ] 截图路径: ___________
```

---

## 🔍 CI/CD流程测试

### 场景8: PR验证流程测试

#### 测试步骤

1. 创建一个包含违规代码的PR
2. 推送到远程：`git push origin feature/v4-compliance-testing`
3. 创建PR到dev分支
4. 观察GitHub Actions中的`compliance-validation` job是否失败

#### 预期结果

- ❌ CI/CD中的合规检查应该失败
- PR状态显示为失败
- 错误信息清晰显示违规原因

#### 实际结果记录

```
[ ] 测试时间: ___________
[ ] PR链接: ___________
[ ] CI/CD结果: 通过 / 失败
[ ] 错误信息: ___________
[ ] 截图路径: ___________
```

---

### 场景9: Push验证流程测试（main/dev分支）

#### 测试步骤

1. 在main或dev分支上创建一个违规提交
2. 推送到远程：`git push origin main`
3. 观察GitHub Actions中的`compliance-check-and-rollback` job是否执行回滚

#### 预期结果

- ❌ 合规检查应该失败
- 自动回滚机制应该被触发（或提供回滚指导）
- 审计日志应该记录违规信息

#### 实际结果记录

```
[ ] 测试时间: ___________
[ ] 分支: main / dev
[ ] 合规检查结果: 通过 / 失败
[ ] 回滚机制: 已触发 / 未触发
[ ] 审计日志: ___________
[ ] 截图路径: ___________
```

---

## 📊 测试执行记录表

| 场景                       | 测试时间 | 测试结果 | 错误信息 | 优化措施 | 重测结果 | 截图/日志 |
| -------------------------- | -------- | -------- | -------- | -------- | -------- | --------- |
| 场景1: 缺少PRD关联         |          |          |          |          |          |           |
| 场景2: 缺少测试文件        |          |          |          |          |          |           |
| 场景3: 缺少Task-Master任务 |          |          |          |          |          |           |
| 场景4: PRD元数据不完整     |          |          |          |          |          |           |
| 场景5: 删除功能未授权      |          |          |          |          |          |           |
| 场景6: 提交信息格式错误    |          |          |          |          |          |           |
| 场景7: 正确提交（通过）    |          |          |          |          |          |           |
| 场景8: PR验证流程          |          |          |          |          |          |           |
| 场景9: Push验证流程        |          |          |          |          |          |           |

---

## 🛠️ 测试工具和脚本

### 测试辅助脚本

创建 `scripts/testing/v4-test-scenarios.sh` 用于自动化测试场景：

```bash
#!/bin/bash
# V4合规引擎测试脚本

set -e

TEST_DIR=".v4-test-results"
mkdir -p "$TEST_DIR"

echo "🧪 开始V4合规引擎测试..."

# 场景1: 缺少PRD关联
echo "📋 测试场景1: 缺少PRD关联"
# ... 测试代码 ...

# 场景2: 缺少测试文件
echo "📋 测试场景2: 缺少测试文件"
# ... 测试代码 ...

# ... 其他场景 ...
```

---

## 📝 测试结果报告模板

### 测试报告结构

```markdown
# V4架构测试结果报告

## 测试概览

- 测试日期: \***\*\_\_\_\*\***
- 测试人员: \***\*\_\_\_\*\***
- 测试分支: \***\*\_\_\_\*\***
- 总体通过率: \_\_\_%

## 详细测试结果

### 场景1: 缺少PRD关联

- **状态**: ✅ 通过 / ❌ 失败
- **错误信息**: \***\*\_\_\_\*\***
- **优化措施**: \***\*\_\_\_\*\***
- **重测结果**: \***\*\_\_\_\*\***

### 场景2: 缺少测试文件

- **状态**: ✅ 通过 / ❌ 失败
- **错误信息**: \***\*\_\_\_\*\***
- **优化措施**: \***\*\_\_\_\*\***
- **重测结果**: \***\*\_\_\_\*\***

## 发现的问题

1. ***
2. ***

## 优化建议

1. ***
2. ***

## 结论

V4合规引擎在实际测试中表现：✅ 良好 / ⚠️ 需要优化 / ❌ 存在问题
```

---

## 🎯 测试执行计划

### 阶段1: 本地钩子测试（1-2小时）

- [ ] 场景1: 缺少PRD关联
- [ ] 场景2: 缺少测试文件
- [ ] 场景3: 缺少Task-Master任务
- [ ] 场景4: PRD元数据不完整
- [ ] 场景5: 删除功能未授权
- [ ] 场景6: 提交信息格式错误
- [ ] 场景7: 正确提交（通过）

### 阶段2: CI/CD流程测试（1-2小时）

- [ ] 场景8: PR验证流程
- [ ] 场景9: Push验证流程

### 阶段3: 问题修复和重测（2-4小时）

- [ ] 分析测试失败原因
- [ ] 优化合规引擎逻辑
- [ ] 重测所有失败场景
- [ ] 生成最终测试报告

---

## 📸 截图和日志保存规范

### 目录结构

```
.v4-test-results/
├── screenshots/
│   ├── scenario1-precommit-error.png
│   ├── scenario2-cicd-failure.png
│   └── ...
├── logs/
│   ├── scenario1-precommit.log
│   ├── scenario2-cicd.log
│   └── ...
└── reports/
    └── test-report-YYYY-MM-DD.md
```

### 日志记录要求

- 所有pre-commit输出保存到 `.v4-test-results/logs/scenario{N}-precommit.log`
- 所有CI/CD输出保存到 `.v4-test-results/logs/scenario{N}-cicd.log`
- 所有错误信息详细记录

---

## ✅ 测试完成标准

1. **所有场景测试完成**: 9个场景全部执行
2. **所有拦截场景通过**: 违规提交被正确拦截
3. **正确提交通过**: 合规提交能够成功
4. **CI/CD集成验证**: PR和Push流程正常工作
5. **问题修复完成**: 所有发现的问题已修复并重测通过
6. **文档完整**: 测试报告、日志、截图全部保存

---

## 🚀 开始测试

执行以下命令开始测试：

```bash
# 1. 创建测试分支
git checkout -b feature/v4-compliance-testing

# 2. 创建测试结果目录
mkdir -p .v4-test-results/{screenshots,logs,reports}

# 3. 开始测试场景1
# ... 按照测试步骤执行 ...
```

---

**注意**: 测试过程中发现的问题需要立即记录并优化，确保V4合规引擎在实际使用中能够可靠工作。
