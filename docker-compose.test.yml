# æµ‹è¯•éªŒè¯ç¯å¢ƒ Docker ç¼–æ’é…ç½®
# ç”¨äºéªŒè¯CIç¯å¢ƒä¸­çš„MySQLè¿æ¥ä¿®å¤

version: "3.8"

services:
  # MySQLæµ‹è¯•æ•°æ®åº“
  mysql-test:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: bravo_test
      MYSQL_USER: bravo_user
      MYSQL_PASSWORD: bravo_password
    ports:
      - "3307:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    command: >
      --default-authentication-plugin=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci

  # åç«¯æµ‹è¯•æœåŠ¡
  backend-test:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    environment:
      # æ¨¡æ‹ŸCIç¯å¢ƒå˜é‡
      - CI=true
      - DJANGO_SETTINGS_MODULE=bravo.settings.test
      - DB_HOST=mysql-test
      - DB_PORT=3306
      - DB_NAME=bravo_test
      - DB_USER=bravo_user
      - DB_PASSWORD=bravo_password
    volumes:
      - ./backend:/app
    depends_on:
      mysql-test:
        condition: service_healthy
    command: >
      bash -c "
        echo 'ğŸ”§ ç­‰å¾…MySQLæœåŠ¡å¯åŠ¨...'
        sleep 10
        echo 'âœ… MySQLæœåŠ¡å·²å¯åŠ¨'
        
        echo 'ğŸ”„ è¿è¡Œæ•°æ®åº“è¿ç§»...'
        python manage.py migrate --run-syncdb
        echo 'âœ… æ•°æ®åº“è¿ç§»å®Œæˆ'
        
        echo 'ğŸ§ª è¿è¡Œåç«¯æµ‹è¯•...'
        echo 'yes' | python manage.py test --verbosity=2
        echo 'âœ… åç«¯æµ‹è¯•å®Œæˆ'
      "

  # å‰ç«¯æµ‹è¯•æœåŠ¡
  frontend-test:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    environment:
      - NODE_ENV=test
      - CI=true
      - VITE_API_URL=http://backend-test:8000
    volumes:
      - ./frontend:/app
      - frontend_test_node_modules:/app/node_modules
    command: >
      bash -c "
        echo 'ğŸ§ª è¿è¡Œå‰ç«¯æµ‹è¯•...'
        npm run test:coverage
        echo 'âœ… å‰ç«¯æµ‹è¯•å®Œæˆ'
      "

  # E2Eæµ‹è¯•æœåŠ¡
  e2e-test:
    build:
      context: ./e2e
      dockerfile: Dockerfile.dev
    environment:
      # æ¨¡æ‹ŸCIç¯å¢ƒ
      - CI=true
      - GITHUB_ACTIONS=true
      - NODE_ENV=test
      - DOCKER_ENV=true
      - TEST_BASE_URL=http://frontend-test:3000
      - API_URL=http://backend-test:8000
      - DB_HOST=mysql-test
      - DB_PORT=3306
      - DB_NAME=bravo_test
      - DB_USER=bravo_user
      - DB_PASSWORD=bravo_password
    volumes:
      - ./e2e:/app
      - e2e_test_node_modules:/app/node_modules
    depends_on:
      - mysql-test
      - backend-test
      - frontend-test
    command: >
      bash -c "
        echo 'ğŸ”§ ç­‰å¾…æœåŠ¡å¯åŠ¨...'
        sleep 10
        
        echo 'ğŸ§ª è¿è¡ŒE2Eæµ‹è¯•...'
        npm run test
        echo 'âœ… E2Eæµ‹è¯•å®Œæˆ'
      "

  # æµ‹è¯•éªŒè¯æœåŠ¡ - è¿è¡Œæˆ‘ä»¬çš„éªŒè¯è„šæœ¬
  test-validator:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    environment:
      - CI=true
      - DJANGO_SETTINGS_MODULE=bravo.settings.test
      - DB_HOST=mysql-test
      - DB_PORT=3306
      - DB_NAME=bravo_test
      - DB_USER=bravo_user
      - DB_PASSWORD=bravo_password
    volumes:
      - ./backend:/app
      - .:/workspace
    depends_on:
      mysql-test:
        condition: service_healthy
    working_dir: /workspace
    command: >
      bash -c "
        echo 'ğŸ”§ ç­‰å¾…MySQLæœåŠ¡å®Œå…¨å¯åŠ¨...'
        sleep 5
        
        echo 'ğŸ§ª è¿è¡ŒCIä¿®å¤éªŒè¯è„šæœ¬...'
        python test_ci_fix.py
        echo 'âœ… éªŒè¯è„šæœ¬æ‰§è¡Œå®Œæˆ'
      "

volumes:
  frontend_test_node_modules:
  e2e_test_node_modules: