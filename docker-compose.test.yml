version: "3.8"

services:
  # é¢„é…ç½®çš„MySQLæœåŠ¡
  mysql-test:
    image: mysql:8.0
    environment:
      MYSQL_DATABASE: bravo_test
      MYSQL_USER: bravo_user
      MYSQL_PASSWORD: bravo_password
      MYSQL_ROOT_PASSWORD: root_password
    tmpfs:
      - /var/lib/mysql # ä½¿ç”¨å†…å­˜å­˜å‚¨ï¼ŒåŠ é€Ÿæµ‹è¯•
    command: --default-authentication-plugin=mysql_native_password --skip-log-bin
    healthcheck:
      test:
        [
          "CMD",
          "bash",
          "-c",
          "mysqladmin ping -h localhost && mysql -u root -proot_password -e 'USE bravo_test; SELECT 1;'",
        ]
      interval: 5s
      timeout: 5s
      retries: 15

  # åç«¯æµ‹è¯•æœåŠ¡
  backend-test:
    build:
      context: ./backend
      dockerfile: Dockerfile.test
    depends_on:
      mysql-test:
        condition: service_healthy
    environment:
      DB_HOST: mysql-test
      DB_NAME: bravo_test
      DB_USER: bravo_user
      DB_PASSWORD: bravo_password
    volumes:
      - ./backend:/app
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/"]
      interval: 5s
      timeout: 3s
      retries: 10

  # å‰ç«¯æ„å»ºæœåŠ¡
  frontend-build:
    build:
      context: ./frontend
      dockerfile: Dockerfile.test
    volumes:
      - ./frontend/dist:/app/dist
    command: npm run build
    restart: "no" # æ„å»ºå®Œæˆåä¸é‡å¯

  # å‰ç«¯æµ‹è¯•æœåŠ¡
  frontend-test:
    build:
      context: ./frontend
      dockerfile: Dockerfile.test
    depends_on:
      frontend-build:
        condition: service_completed_successfully
    ports:
      - "3001:3000"
    volumes:
      - ./frontend/dist:/app/dist
    environment:
      VITE_API_URL: http://backend-test:8000
    command: |
      bash -c "
        echo 'ğŸš€ å¯åŠ¨å‰ç«¯æµ‹è¯•æœåŠ¡...'
        if [ -d '/app/dist' ] && [ -n \"\$(ls -A /app/dist 2>/dev/null)\" ]; then
          echo 'ğŸ“¦ ä½¿ç”¨æ„å»ºåçš„é™æ€æ–‡ä»¶'
          cd /app/dist && python3 -m http.server 3000 --bind 0.0.0.0
        else
          echo 'ğŸ”§ ä½¿ç”¨å¼€å‘æœåŠ¡å™¨'
          npm run dev -- --host 0.0.0.0 --port 3000
        fi
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 5s
      timeout: 3s
      retries: 10

  # E2Eæµ‹è¯•æœåŠ¡
  e2e-tests:
    build:
      context: ./e2e
      dockerfile: Dockerfile.test
    depends_on:
      backend-test:
        condition: service_healthy
      frontend-test:
        condition: service_healthy
    volumes:
      - ./e2e:/app
    environment:
      BACKEND_URL: http://backend-test:8000
      FRONTEND_URL: http://frontend-test:3000
      TEST_BASE_URL: http://frontend-test:3000
    command: |
      bash -c "
        echo 'â³ ç­‰å¾…æ‰€æœ‰æœåŠ¡å°±ç»ª...'
        timeout 60 bash -c 'until curl -s http://backend-test:8000/health/; do echo \"ç­‰å¾…åç«¯æœåŠ¡...\"; sleep 2; done'
        timeout 60 bash -c 'until curl -s http://frontend-test:3000/; do echo \"ç­‰å¾…å‰ç«¯æœåŠ¡...\"; sleep 2; done'

        echo 'ğŸ” æœåŠ¡çŠ¶æ€éªŒè¯...'
        echo \"åç«¯æœåŠ¡: \$(curl -s http://backend-test:8000/health/ | head -c 100)\"
        echo \"å‰ç«¯æœåŠ¡: \$(curl -s http://frontend-test:3000/ | head -c 100)\"
        echo \"ç¯å¢ƒå˜é‡: TEST_BASE_URL=\$TEST_BASE_URL, FRONTEND_URL=\$FRONTEND_URL\"

        echo 'ğŸ§ª è¿è¡Œå…³é”®E2Eæµ‹è¯•...'
        npm run test -- --grep '@critical' --project=chromium
      "
