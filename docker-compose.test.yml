version: "3.8"

services:
  # é¢„é…ç½®çš„MySQLæœåŠ¡
  mysql-test:
    image: mysql:8.0
    environment:
      MYSQL_DATABASE: bravo_test
      MYSQL_USER: bravo_user
      MYSQL_PASSWORD: bravo_password
      MYSQL_ROOT_PASSWORD: root_password
    tmpfs:
      - /var/lib/mysql # ä½¿ç”¨å†…å­˜å­˜å‚¨ï¼ŒåŠ é€Ÿæµ‹è¯•
    command: --default-authentication-plugin=mysql_native_password --skip-log-bin
    healthcheck:
      test:
        [
          "CMD",
          "bash",
          "-c",
          "mysqladmin ping -h localhost && mysql -u root -proot_password -e 'USE bravo_test; SELECT 1;'",
        ]
      interval: 5s
      timeout: 5s
      retries: 15
      start_period: 30s

  # åç«¯æµ‹è¯•æœåŠ¡
  backend-test:
    build:
      context: ./backend
      dockerfile: Dockerfile.test
    depends_on:
      mysql-test:
        condition: service_healthy
    environment:
      DB_HOST: mysql-test
      DB_NAME: bravo_test
      DB_USER: bravo_user
      DB_PASSWORD: bravo_password
    volumes:
      - ./backend:/app
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/"]
      interval: 5s
      timeout: 5s
      retries: 15
      start_period: 45s

  # å‰ç«¯æµ‹è¯•æœåŠ¡ - ç¬¬21è½®ä¿®å¤ï¼šç§»é™¤frontend-buildä¾èµ–ï¼Œè‡ªç»™è‡ªè¶³
  frontend-test:
    build:
      context: ./frontend
      dockerfile: Dockerfile.test
    # ç§»é™¤å¯¹frontend-buildçš„ä¾èµ–ï¼Œæ¶ˆé™¤ä¸€æ¬¡æ€§ä»»åŠ¡å¯¼è‡´çš„Docker Composeç»ˆæ­¢é—®é¢˜
    ports:
      - "3001:3000"
    environment:
      VITE_API_URL: http://backend-test:8000
      PORT: 3000
    command:
      [
        "/bin/sh",
        "-c",
        "echo 'ğŸš€ å¯åŠ¨å‰ç«¯æµ‹è¯•æœåŠ¡...' && echo 'ğŸ”§ å®¹å™¨å†…ç‹¬ç«‹æ„å»ºå‰ç«¯é¡¹ç›®...' && npm run build && echo 'ğŸ“ æ£€æŸ¥æ„å»ºæ–‡ä»¶ç›®å½•...' && ls -la /app/dist/ || echo 'âš ï¸ æ„å»ºç›®å½•æ£€æŸ¥å¤±è´¥' && if [ -d '/app/dist' ] && [ -f '/app/dist/index.html' ]; then echo 'âœ… æ‰¾åˆ°æ„å»ºæ–‡ä»¶ï¼Œä½¿ç”¨ Vite preview æ¨¡å¼' && npm run preview -- --host 0.0.0.0 --port 3000; else echo 'âŒ æ„å»ºå¤±è´¥ï¼Œå›é€€åˆ°å¼€å‘æ¨¡å¼' && npm run dev -- --host 0.0.0.0 --port 3000; fi",
      ]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 30s

  # E2Eæµ‹è¯•æœåŠ¡ - ğŸš€ Phase 5.2ç¼“å­˜ä¼˜åŒ–æ¶æ„
  e2e-tests:
    build:
      context: ./e2e
      dockerfile: Dockerfile.test
    depends_on:
      backend-test:
        condition: service_healthy
      frontend-test:
        condition: service_healthy
    # GitHub Actionsç¯å¢ƒé…ç½®
    environment:
      - CI=true
      - NODE_ENV=test
      - TEST_BASE_URL=http://frontend-test:3000
      - FRONTEND_URL=http://frontend-test:3000
      - BACKEND_URL=http://backend-test:8000
    command:
      - /bin/sh
      - -c
      - |
        echo 'â³ ç­‰å¾…æ‰€æœ‰æœåŠ¡å°±ç»ª...'
        echo 'ğŸ”— æµ‹è¯•æœåŠ¡è¿é€šæ€§...'
        until curl -s http://backend-test:8000/health/; do
          echo "ç­‰å¾…åç«¯æœåŠ¡..."; sleep 3
        done
        echo 'âœ… åç«¯æœåŠ¡å·²å°±ç»ª'
        until curl -s http://frontend-test:3000/; do
          echo "ç­‰å¾…å‰ç«¯æœåŠ¡..."; sleep 3
        done
        echo 'âœ… å‰ç«¯æœåŠ¡å·²å°±ç»ª'
        echo 'ğŸ” è¯¦ç»†æœåŠ¡çŠ¶æ€éªŒè¯...'
        echo "åç«¯å¥åº·æ£€æŸ¥: $(curl -s http://backend-test:8000/health/)"
        echo "å‰ç«¯é¦–é¡µå“åº”: $(curl -s http://frontend-test:3000/ | head -c 200)"
        echo "ç¯å¢ƒå˜é‡: TEST_BASE_URL=$$TEST_BASE_URL, FRONTEND_URL=$$FRONTEND_URL"
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        echo "Playwrighté…ç½®: $(cat playwright.config.ts | grep baseURL || echo 'æœªæ‰¾åˆ°baseURLé…ç½®')"
        echo 'ğŸ§ª æ‰§è¡Œè‡ªç»™è‡ªè¶³E2Eæµ‹è¯•...'
        ./run-tests.sh
