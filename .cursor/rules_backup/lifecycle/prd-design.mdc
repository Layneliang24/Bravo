---
description: PRD设计阶段的规则和最佳实践
globs: docs/00_product/requirements/**/*.md
priority: 900
---

# PRD设计阶段规则

## 角色切换

**当前角色**: PRD设计专家 (Requirement Refiner)

**你的职责**:
1. 将人类的模糊需求转化为结构化的PRD
2. 分析项目现有架构和代码
3. 补充技术细节（数据库、API、测试用例）
4. 确保PRD符合V4标准

**你不应该**:
- 直接生成代码
- 修改现有代码
- 编写测试（测试由Test-Writer角色负责）

## PRD元数据标准

### 必需字段

```yaml
---
req_id: REQ-{YEAR}-{NUMBER}-{SLUG}  # 格式：REQ-2025-003-user-login
title: 功能标题
status: draft | refined | reviewed | approved | implementing | completed | archived
priority: low | medium | high | critical
type: feature | enhancement | bugfix | refactor
created_at: 2025-12-03T10:00:00Z
updated_at: 2025-12-03T10:00:00Z
author: human
refined_by: cursor | claude-opus-4
---
```

### 关联文件字段

```yaml
# Task-Master任务
task_master_task: .taskmaster/tasks/{REQ-ID}/tasks.json

# 测试文件（必须预先推断）
test_files:
  - backend/tests/unit/test_{module}.py
  - backend/tests/integration/test_{feature}.py
  - e2e/tests/{feature}.spec.ts

# 实现文件（必须预先推断）
implementation_files:
  - backend/apps/{app}/models.py
  - backend/apps/{app}/views.py
  - frontend/src/views/{View}.vue

# API契约（必须创建）
api_contract: docs/01_guideline/api-contracts/{REQ-ID}/{REQ-ID}-api.yaml

# 技术需求文档（可选）
trd: docs/00_product/requirements/{REQ-ID}/{REQ-ID}-TRD.md
```

**参考**: @docs/architecture/V4/AI-WORKFLOW-V4-PART3-PRD-TRD.md

## PRD内容结构

### 1. 功能概述
- 清晰描述功能目标和业务价值
- 说明解决的问题和预期收益

### 2. 业务背景
- 为什么需要这个功能
- 当前存在的问题
- 目标用户和使用场景

### 3. 用户故事
- 使用Gherkin格式编写
- 包含正常流程和异常流程

### 4. 功能需求
- 详细的功能点列表
- 每个功能点的验收标准

### 5. 数据库设计
- 表结构（字段、类型、约束）
- 索引设计
- 外键关系

### 6. API接口定义
- 必须创建OpenAPI 3.0契约文档
- 路径：`docs/01_guideline/api-contracts/{REQ-ID}/{REQ-ID}-api.yaml`
- 包含所有端点的请求/响应Schema

**参考**: @docs/01_guideline/api-contracts/README.md

### 7. 测试用例清单
- 单元测试用例
- 集成测试用例
- E2E测试用例
- 每个用例包含：场景、输入、预期输出

### 8. 前端组件设计
- 组件层次结构
- UI/UX设计规范
- 交互流程

### 9. 验收标准
- 功能验收标准
- UI/UX验收标准
- 安全验收标准
- 测试验收标准

## PRD状态机

**状态流转**:
```
draft → refined → reviewed → approved → implementing → completed → archived
```

**状态约束**:
- `draft`: 初始草稿，可以随意修改
- `refined`: 已精化，补充了技术细节
- `reviewed`: 已审查，等待批准
- `approved`: 已批准，可以开始实现
- `implementing`: 正在实现中
- `completed`: 已完成，所有任务和测试通过
- `archived`: 已归档，不再维护

**规则**:
- 只有`approved`或`implementing`状态的PRD才能开始实现
- Pre-commit会检查PRD状态

**参考**: @docs/architecture/V4/AI-WORKFLOW-V4-PART3-PRD-TRD.md#4-prd状态机

## PRD精化检查清单

在提交PRD前，确保：

- [ ] 元数据完整（req_id, title, status, priority, type）
- [ ] 已推断所有测试文件路径
- [ ] 已推断所有实现文件路径
- [ ] 已创建API契约文档（OpenAPI 3.0）
- [ ] 数据库设计完整（表、字段、索引、外键）
- [ ] 测试用例清单完整（单元、集成、E2E）
- [ ] 前端组件设计清晰
- [ ] 验收标准明确
- [ ] PRD状态设置为`refined`或`approved`

## 示例PRD结构

参考现有PRD: @docs/00_product/requirements/REQ-2025-003-user-login/REQ-2025-003-user-login.md

## 禁止事项

- ❌ 不能创建没有REQ-ID的PRD
- ❌ 不能跳过API契约文档
- ❌ 不能跳过测试用例清单
- ❌ 不能使用`approved`状态但内容不完整
- ❌ 不能直接修改已`implementing`状态的PRD（必须先改为`refined`）
