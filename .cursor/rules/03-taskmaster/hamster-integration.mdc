---
description: 使用 Task Master CLI 处理 Hamster 任务的指南
globs: .taskmaster/**/*.json, .taskmaster/**/*.md
priority: 800
---

# Hamster 集成工作流

本指南说明在连接 Hamster brief 时，如何使用 Task Master 处理导入的任务。请严格按以下规则操作，确保任务管理与流程正确。

## 命令限制

### 允许的命令
- **✅ 只用这些 CLI 命令**：
  ```bash
  tm list                      # 查看任务列表
  tm show <sub/task id> --json # 查看任务详情（json 省 token）
  tm set-status                # 更新任务/子任务状态
  tm auth refresh              # 刷新身份 token
  tm context <brief url>       # 重新连接 Hamster brief
  ```

### 禁用的命令
- **❌ 禁用** MCP 工具（尚未适配 Hamster）
- **❌ 禁用** 其他未验证的 Task Master CLI 命令

## 任务流

### 开始任务
```bash
# 标记任务及子任务为进行中
tm set-status -i 1,1.1 -s in-progress
# 可用逗号一次性标记多个
tm set-status -i 1,1.1,1.2,2 -s in-progress
```

### 实施流程
1) 阅读任务：`tm show <id> --json`
2) 检查子任务：有子任务则逐个完成
3) 实施子任务
4) 质量校验：`npm lint && npm typecheck`
5) 标记完成：`tm set-status -i 1.1 -s done`
6) 提交代码
7) 循环直到所有子任务完成

### 完成父任务
```bash
npm lint
npm typecheck
tm set-status -i 1 -s done
```

## 多任务上下文

### 同时查看多个任务
```bash
tm show 1,1.1,2,2.1 --json
# 比多次 tm show 更高效
```

### 并行子任务
- 条件：子任务改动的文件/模块完全不重叠
- 要求：明确拆分，必要时并行
- 示例：1.1 改 src/api.js，1.2 改 src/utils.js，可并行

## PR 管理

### 建议
- 尽量一个 PR 覆盖同一 brief（范围可控）
- 工作量过大再拆分，并先与人确认
- 多 PR 时，后续 PR 基于前一 PR
```bash
gh pr create --title "Task X: [Task Title]" --body "Description"
```

### 提交策略
- 只要范围未变，持续提交到同一 PR
- 如范围膨胀，先与人沟通再分 PR

## 认证与上下文

### 刷新 token
```bash
tm auth refresh
tm context <brief url>  # 若仍异常，重新连接
```
- 记录 brief URL，方便重连

## Git 工作流
- 分支：`task-XXX`
- 子任务增量提交
- 任务完成后创建 PR
- 遵循提交信息规范

## 工作流总结（Mermaid）
```mermaid
flowchart TD
    A[Start: Connect to Hamster Brief] --> B[Get Brief URL]
    B --> C[tm list - View Tasks]
    C --> D[Select Task]
    D --> E[tm show <id> --json - Read Task]
    E --> F{Has Subtasks?}
    F -->|Yes| G[Select First Subtask]
    F -->|No| M[Implement Task]
    G --> H[tm set-status -i X.Y -s in-progress]
    H --> I[Implement Subtask]
    I --> J[npm lint && npm typecheck]
    J --> K{Passes?}
    K -->|Yes| L[tm set-status -i X.Y -s done]
    K -->|No| I
    L --> N{More Subtasks?}
    N -->|Yes| G
    N -->|No| O[Final lint/typecheck]
    M --> O
    O --> P[tm set-status -i X -s done]
    P --> Q[Commit & Create PR]
    Q --> R{More Tasks?}
    R -->|Yes| D
    R -->|No| S[Complete]
```

## 核心原则
- 渐进推进：一次只做一个子任务
- 质量闸口：done 前必须 lint+typecheck
- 清晰沟通：拆 PR 前先确认
- 高效取数：查看多任务用逗号 ID
- 认证管理：token 异常及时 refresh/context

## 相关规则
- `git_workflow.mdc`（标准 Git 分支/PR 流程）
- `tools/taskmaster-workflow.mdc`（Task Master 开发模式）
- `tasks.mdc`（任务结构与操作）

---

## 规则应用声明

**当AI被路由到此规则时，必须在响应开头明确声明**：

```
[应用规则：@.cursor/rules/03-taskmaster/hamster-integration.mdc]
```

**验证要求**：
- ✅ 必须明确声明应用了此规则
- ✅ 必须遵循本规则中的所有约束和流程
- ✅ 不能跳过声明步骤直接执行操作
