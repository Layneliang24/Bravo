---
alwaysApply: true
---
# Bug排查优先级规则

> **核心原则**: PRD是需求的唯一真源，所有排查必须从PRD开始

---

## 🎯 排查优先级顺序（强制）

当发现**实现效果不满意**或**出现bug**时，必须按照以下顺序排查：

```
步骤1: 查看PRD（需求定义）
  ↓
步骤2: 查看测试用例CSV（测试设计）
  ↓
步骤3: 查看测试代码（测试实现）
  ↓
步骤4: 查看代码实现（功能实现）
  ↓
步骤5: 判断问题层次并修复
```

---

## 📋 详细排查流程

### 步骤1：查看PRD（最高优先级）

**规则**：**必须先看PRD，因为PRD是需求的唯一真源**

**操作**：
1. 从代码文件提取REQ-ID
   ```bash
   grep -r "REQ-ID" frontend/src/views/Register.vue
   # 输出: // REQ-ID: REQ-2025-003-user-login
   ```

2. 查找对应的PRD文件
   ```bash
   cat docs/00_product/requirements/REQ-2025-003-user-login/REQ-2025-003-user-login.md
   ```

3. 查看PRD中的关键信息
   - **功能概述**：需求是什么？
   - **验收标准**：成功标准是什么？
   - **功能点**：包含哪些功能？
   - **用户故事**：用户期望的行为是什么？

**判断**：
- ✅ 如果PRD中没有明确描述该需求 → **这是PRD问题**，需要先完善PRD
- ✅ 如果PRD中有描述，但实现不符合 → **这是实现问题**，进入下一步

**禁止跳过**：
- ❌ 不能跳过PRD直接看测试用例
- ❌ 不能假设需求是什么，必须从PRD确认

---

### 步骤2：查看测试用例CSV

**规则**：测试用例必须覆盖PRD中的所有场景

**操作**：
1. 查找测试用例CSV文件
   ```bash
   cat docs/00_product/requirements/REQ-2025-003-user-login/REQ-2025-003-user-login-test-cases.csv
   ```

2. 查看相关的测试用例
   - 该功能点有哪些测试用例？
   - 测试用例的预期结果是什么？
   - 测试用例是否覆盖了这个场景？

**判断**：
- ✅ 如果测试用例CSV中没有对应场景 → **这是测试用例设计问题**，需要补充测试用例
- ✅ 如果测试用例有，但预期结果与PRD不一致 → **这是测试用例问题**，需要修正测试用例
- ✅ 如果测试用例正确 → **进入下一步**

**禁止跳过**：
- ❌ 不能跳过测试用例CSV直接看测试代码
- ❌ 不能假设测试用例应该是什么

---

### 步骤3：查看测试代码

**规则**：测试代码必须与CSV用例一一对应

**操作**：
1. 根据测试用例ID查找测试代码
   ```bash
   # E2E测试
   grep -r "TC-AUTH_REGISTER-001" e2e/tests/

   # 集成测试
   grep -r "TC-AUTH_REGISTER-001" backend/tests/integration/
   ```

2. 查看测试代码的实现
   - 测试代码是否正确实现了CSV中的测试步骤？
   - 测试代码的断言是否符合CSV中的预期结果？
   - 测试代码是否覆盖了所有测试场景？

**判断**：
- ✅ 如果测试代码不存在或未实现CSV用例 → **这是测试代码问题**，需要补充测试代码
- ✅ 如果测试代码实现错误（与CSV不一致） → **这是测试代码问题**，需要修正测试代码
- ✅ 如果测试代码正确但测试失败 → **进入下一步**

**禁止跳过**：
- ❌ 不能跳过测试代码直接看实现代码
- ❌ 不能假设测试应该通过

---

### 步骤4：查看代码实现

**规则**：代码实现必须符合PRD，并通过测试用例验证

**操作**：
1. 查看实现代码
   ```bash
   # 前端代码
   cat frontend/src/views/Register.vue

   # 后端代码
   cat backend/apps/users/views.py
   ```

2. 对比实现与PRD和测试用例
   - 实现是否符合PRD描述？
   - 实现是否能通过测试用例？
   - 实现的逻辑是否正确？

**判断**：
- ✅ 如果实现不符合PRD → **这是实现问题**，需要修改代码符合PRD
- ✅ 如果实现符合PRD但测试失败 → **这是实现bug**，需要修复代码
- ✅ 如果实现和测试都正确，但效果不满意 → **可能是PRD或测试用例问题**，需要重新审视需求

---

### 步骤5：判断问题层次并修复

**问题分类**：

| 问题类型 | 判断标准 | 修复方法 |
|---------|---------|---------|
| **PRD问题** | PRD中没有明确描述或描述不清 | 1. 更新PRD<br>2. 重新设计测试用例<br>3. 重新实现 |
| **测试用例设计问题** | 测试用例CSV缺失或不完整 | 1. 补充/修正测试用例CSV<br>2. 重新实现测试代码<br>3. 重新实现功能代码 |
| **测试代码问题** | 测试代码未实现CSV用例或实现错误 | 1. 修正测试代码<br>2. 重新运行测试<br>3. 修正功能代码直到测试通过 |
| **实现问题** | 代码不符合PRD或测试失败 | 1. 修正功能代码<br>2. 确保测试通过<br>3. 验证符合PRD |

**修复顺序**：
1. **如果是PRD问题**：先修复PRD → 再修复测试用例 → 再修复代码
2. **如果是测试用例问题**：先修复测试用例CSV → 再修复测试代码 → 再修复功能代码
3. **如果是测试代码问题**：先修复测试代码 → 再修复功能代码
4. **如果是实现问题**：直接修复功能代码 → 确保测试通过

---

## 🔍 具体排查场景

### 场景1：功能缺失

**现象**：某个功能没有实现

**排查顺序**：
1. **查看PRD** → PRD中是否有这个功能？
   - 有 → 进入步骤2
   - 没有 → **PRD问题**，需要添加功能点到PRD

2. **查看测试用例CSV** → 是否有对应测试用例？
   - 有 → 进入步骤3
   - 没有 → **测试用例设计问题**，需要添加测试用例

3. **查看测试代码** → 是否有测试代码？
   - 有 → 进入步骤4
   - 没有 → **测试代码问题**，需要实现测试代码

4. **查看代码实现** → 是否有实现代码？
   - 有但不符合 → **实现问题**
   - 没有 → **实现问题**，需要实现功能

---

### 场景2：功能行为不符合预期

**现象**：功能实现了，但行为不符合预期

**排查顺序**：
1. **查看PRD** → PRD中期望的行为是什么？
   - 明确描述 → 进入步骤2
   - 描述不清 → **PRD问题**，需要明确PRD描述

2. **查看测试用例CSV** → 测试用例的预期结果是什么？
   - 与PRD一致 → 进入步骤3
   - 与PRD不一致 → **测试用例问题**，需要修正测试用例

3. **查看测试代码** → 测试代码的断言是什么？
   - 与CSV一致 → 进入步骤4
   - 与CSV不一致 → **测试代码问题**，需要修正测试代码

4. **查看代码实现** → 代码实际行为是什么？
   - 符合PRD和测试 → **可能是PRD或测试用例问题**，需要重新审视
   - 不符合 → **实现问题**，需要修正代码

---

### 场景3：测试失败

**现象**：测试用例执行失败

**排查顺序**：
1. **查看PRD** → 确认需求是否正确理解
   - 确认需求 → 进入步骤2

2. **查看测试用例CSV** → 测试用例是否正确？
   - 测试用例正确 → 进入步骤3
   - 测试用例错误 → **测试用例问题**，需要修正测试用例CSV

3. **查看测试代码** → 测试代码是否正确实现CSV？
   - 测试代码正确 → 进入步骤4
   - 测试代码错误 → **测试代码问题**，需要修正测试代码

4. **查看代码实现** → 代码是否通过测试？
   - 测试应该通过但失败 → **实现问题**，需要修正代码
   - 测试不应该通过 → **测试用例问题**，需要修正测试用例

---

### 场景4：UI效果不满意

**现象**：UI显示效果不满意

**排查顺序**：
1. **查看PRD** → PRD中对UI的描述是什么？
   - 有明确描述 → 进入步骤2
   - 描述不清 → **PRD问题**，需要补充UI设计到PRD

2. **查看测试用例CSV** → 是否有UI验证点？
   - 有UI验证点 → 进入步骤3
   - 没有UI验证点 → **测试用例设计问题**，需要添加UI验证点

3. **查看测试代码** → 是否有UI测试代码？
   - 有UI测试 → 进入步骤4
   - 没有UI测试 → **测试代码问题**，需要实现UI测试

4. **查看代码实现** → UI代码是否符合PRD和测试？
   - 符合但效果不满意 → **可能是PRD或测试用例问题**，需要重新审视UI需求
   - 不符合 → **实现问题**，需要修正UI代码

**特殊要求**：
- UI问题必须使用MCP工具验证浏览器环境（见v4-core.mdc）
- E2E测试通过 ≠ 浏览器正常，必须额外验证浏览器环境

---

## 🚫 禁止行为

### 禁止跳过步骤

```
❌ 禁止跳过PRD直接看测试用例
❌ 禁止跳过测试用例CSV直接看测试代码
❌ 禁止跳过测试代码直接看实现代码
❌ 禁止假设需求是什么
❌ 禁止假设测试应该是什么
```

### 禁止错误的修复顺序

```
❌ 不能先修复代码，再检查PRD
❌ 不能先修复测试，再检查PRD
❌ 不能修改测试用例使其通过，而不检查PRD
❌ 不能修改PRD使其符合代码，而应该修改代码符合PRD
```

---

## 📚 追溯链要求

根据V4架构，所有代码必须可追溯到PRD：

```
REQ-ID → Task-ID → Test-File → Code-File → Commit → Deployment
```

**排查时必须遵循追溯链**：
1. 从代码文件的REQ-ID开始
2. 追溯到PRD
3. 追溯到测试用例CSV
4. 追溯到测试代码
5. 追溯回代码实现

**每个步骤都要验证追溯链的完整性**。

---

## ✅ 排查检查清单

使用此清单确保不遗漏任何步骤：

### 步骤1：PRD检查
- [ ] 已从代码提取REQ-ID
- [ ] 已查找并阅读对应PRD文件
- [ ] 已确认PRD中是否有相关功能描述
- [ ] 已确认PRD的验收标准是什么
- [ ] 已确认PRD状态是否为approved

### 步骤2：测试用例CSV检查
- [ ] 已查找测试用例CSV文件
- [ ] 已确认是否有相关测试用例
- [ ] 已确认测试用例的预期结果是什么
- [ ] 已确认测试用例是否与PRD一致

### 步骤3：测试代码检查
- [ ] 已根据测试用例ID查找测试代码
- [ ] 已确认测试代码是否正确实现CSV用例
- [ ] 已确认测试代码的断言是否正确
- [ ] 已运行测试确认是否通过

### 步骤4：代码实现检查
- [ ] 已查看实现代码
- [ ] 已确认代码是否符合PRD
- [ ] 已确认代码是否能通过测试
- [ ] 已确认代码逻辑是否正确

### 步骤5：问题判断和修复
- [ ] 已判断问题类型（PRD/测试用例/测试代码/实现）
- [ ] 已按照正确顺序修复问题
- [ ] 已验证修复后符合PRD
- [ ] 已验证修复后测试通过

---

## 📖 参考文档

- [V4核心原则](.cursor/rules/principles/v4-core.mdc) - PRD是需求的唯一真源
- [测试用例设计规则](.cursor/rules/workflows/testcase-design.mdc) - 测试用例设计流程
- [代码审查规则](.cursor/rules/workflows/code-review.mdc) - 代码审查清单
- [调试规则](.cursor/rules/workflows/debugging.mdc) - 调试方法论

---

## 💡 核心要点总结

1. **PRD优先**：所有排查必须从PRD开始，因为PRD是需求的唯一真源
2. **顺序固定**：PRD → 测试用例CSV → 测试代码 → 代码实现
3. **不能跳过**：禁止跳过任何步骤，不能假设
4. **追溯链**：遵循REQ-ID追溯链，确保完整性
5. **正确修复**：根据问题类型按照正确顺序修复
