---
description: 开发阶段的代码实现规则
globs: backend/apps/**/*.py, frontend/src/**/*.{ts,tsx,vue,js,jsx}
priority: 750
---

# 开发阶段规则

## 角色切换

**当前角色**: 开发专家 (Developer)

**你的职责**:
1. 根据测试文件实现功能代码
2. 遵循TDD流程（测试红 → 代码绿 → 重构）
3. 确保代码符合项目规范
4. 确保代码通过所有测试

**你不应该**:
- 跳过测试直接写代码
- 实现测试未要求的功能
- 忽略代码质量检查

## TDD开发流程

### 1. 查看测试文件

**必须执行**:
```bash
# 查看相关测试文件
cat backend/tests/unit/test_*.py
cat backend/tests/integration/test_*.py

# 运行测试，确认失败（红色阶段）
docker-compose exec backend pytest backend/tests/unit/test_*.py -v
```

### 2. 实现最少代码

**原则**: 只写刚好通过测试的代码

**步骤**:
1. 查看测试失败的错误信息
2. 实现最小功能使测试通过
3. 不要添加测试未要求的功能
4. 不要优化或重构（这是下一阶段）

**示例**:
```python
# 测试要求：登录接口返回token
# 最少实现：
def login(request):
    return Response({"token": "dummy-token"})  # 刚好通过测试
```

### 3. 运行测试验证

**必须执行**:
```bash
# 运行相关测试
docker-compose exec backend pytest backend/tests/unit/test_*.py -v

# 确认所有测试通过
```

### 4. 重构代码

**原则**: 在测试通过的基础上优化

**步骤**:
1. 提取重复逻辑
2. 改善代码可读性
3. 优化性能（如果需要）
4. 运行测试，确保仍然通过

## Docker容器化开发

**核心规则**: 所有开发、构建、测试必须在Docker容器中进行

**命令格式**:
```bash
# 后端开发
docker-compose exec backend python manage.py <command>
docker-compose exec backend pytest
docker-compose exec backend python manage.py makemigrations
docker-compose exec backend python manage.py migrate

# 前端开发
docker-compose exec frontend npm run dev
docker-compose exec frontend npm run build
docker-compose exec frontend npm run test
```

**禁止操作**:
- ❌ 不能在宿主机执行`python manage.py`
- ❌ 不能在宿主机执行`npm run dev`
- ❌ 不能安装本地Python虚拟环境
- ❌ 不能安装本地MySQL/Redis

**参考**: @.cursorrules (Docker开发项目部分)

## 代码文件REQ-ID注释

**规则**: 所有代码文件必须包含REQ-ID注释

**格式**:
```python
# backend/apps/users/views.py
# REQ-ID: REQ-2025-003-user-login
"""用户认证相关视图"""
```

```typescript
// frontend/src/api/auth.ts
// REQ-ID: REQ-2025-003-user-login
import { ... } from '...'
```

```vue
<!-- frontend/src/views/Login.vue -->
<script setup lang="ts">
// REQ-ID: REQ-2025-003-user-login
import { ... } from '...'
</script>
```

**验证**: Pre-commit会自动检查

## API实现必须遵循契约

**规则**: API实现必须严格遵循OpenAPI契约

**步骤**:
1. 查看API契约: `docs/01_guideline/api-contracts/{REQ-ID}/{REQ-ID}-api.yaml`
2. 实现API端点，确保：
   - 请求参数符合Schema
   - 响应格式符合Schema
   - 状态码符合契约定义
   - 错误响应格式符合契约

**验证**:
- 使用`drf-spectacular`自动生成文档
- 对比生成的文档与契约文档
- 运行契约测试

**参考**: @docs/01_guideline/api-contracts/README.md

## 代码质量要求

### 后端代码

**检查命令**:
```bash
# 格式化
docker-compose exec backend black .
docker-compose exec backend isort .

# 代码检查
docker-compose exec backend flake8 .
docker-compose exec backend pylint apps/

# 类型检查
docker-compose exec backend mypy apps/

# 安全检查
docker-compose exec backend bandit -r apps/
```

**参考**: @.cursor/rules/quality/code-standards.mdc

### 前端代码

**检查命令**:
```bash
# 格式化
cd frontend && npm run format

# 代码检查
cd frontend && npm run lint

# 类型检查
cd frontend && npm run type-check
```

## 利用已有项目成果

**规则**: 在已有项目基础上扩展，而非重新创建

**检查清单**:
- [ ] 查看现有User模型，扩展而非重新创建
- [ ] 查看现有项目结构，遵循相同模式
- [ ] 查看现有测试模式，使用相同工具和风格
- [ ] 查看现有API风格，保持一致

**参考**: PRD中的"已有项目约束"部分

## 禁止事项

- ❌ 不能跳过TDD流程
- ❌ 不能在没有测试的情况下提交代码
- ❌ 不能实现测试未要求的功能
- ❌ 不能忽略API契约
- ❌ 不能提交没有REQ-ID注释的代码
- ❌ 不能在宿主机直接执行开发命令
