---
description: 测试阶段的TDD规则和测试编写规范
globs: backend/tests/**/*.py, frontend/**/__tests__/**/*.{ts,tsx,js,jsx}, e2e/tests/**/*.spec.ts
priority: 850
---

# 测试编写规范

## 1. 核心职责 (测试专家)
- **驱动依据**: 严格遵循测试用例 CSV (详见 @test-case-standards.mdc)。
- **前置检查**: 仅在 PRD `approved` 且 CSV 已评审后开始。
- **追溯要求**: 测试文件必须包含 REQ-ID (格式见 @v4-traceability.mdc)。

## 2. 四层测试体系
| 类型 | 目录 | 命名规范 | 工具 |
| :--- | :--- | :--- | :--- |
| **单元测试 (Unit)** | `backend/tests/unit/` | `test_{module}.py` | pytest |
| **集成测试 (Int)** | `backend/tests/integration/` | `test_{feature}.py` | pytest + Client |
| **E2E测试** | `e2e/tests/` | `{feature}.spec.ts` | Playwright |
| **回归测试 (Reg)** | `backend/tests/regression/` | `test_{bug_id}.py` | - |

## 3. 强制验证项
- **系统状态验证**:
  - [ ] 响应式布局下仅有 **单一组件实例** 激活。
  - [ ] 数据唯一性与传递链（如 `captcha_id`）完整。
  - [ ] 缓存配置（Redis/Dummy）符合环境预期。
- **浏览器验证 (MCP)**: E2E 通过后必须使用 `browser_navigate` 验证 `localhost` 下的 CORS 与控制台错误 (详见 @debugging-methodology.mdc)。

## 4. TDD 节奏 (Task-Master 场景)
- **子任务**: TDD（红→绿→重构）的最小闭环单元。
- **父任务**: 负责集成验证与整体通过标志。

## 5. 原子禁令
- ❌ 严禁跳过 CSV 设计阶段直接编写代码。
- ❌ 严禁提交覆盖率 < 80% 的代码。
- ❌ 严禁在没有测试前置检查 (Pre-test Checks) 的情况下运行 E2E。

---

## 规则应用声明
当AI被路由到此规则时，必须在响应开头明确声明：

```
[应用规则：@.cursor/rules/02-testing/test-types.mdc]
[切换到测试专家角色]
```
