# 测试用例评审规则

> **版本**: V1.0
> **定位**: 测试用例设计和评审的强制规则
> **参考**: @docs/architecture/V4/TESTING-REFLECTION.md

---

## 🎯 核心原则

**测试用例必须验证完整的业务流程，而不仅仅是API响应**

---

## 📋 测试用例设计检查清单

### 1. 业务流程完整性

- [ ] 测试用例是否覆盖了完整的业务流程？
- [ ] 测试用例是否验证了所有相关的数据库状态？
- [ ] 测试用例是否验证了所有相关的异步任务？
- [ ] 测试用例是否验证了错误场景和边界情况？

### 2. 用户视角

- [ ] 测试用例是否从用户角度描述场景？
- [ ] 测试用例是否描述了用户可见的行为？
- [ ] 测试用例是否验证了用户期望的结果？

### 3. 状态验证

- [ ] 测试用例是否明确列出了需要验证的数据库状态？
- [ ] 测试用例是否明确列出了需要验证的异步任务？
- [ ] 测试用例是否明确列出了需要验证的业务逻辑？

### 4. 优先级和覆盖

- [ ] 测试用例的优先级是否合理（P0/P1/P2）？
- [ ] 测试用例是否覆盖了所有关键功能点？
- [ ] 测试用例是否覆盖了所有错误场景？

---

## 🔍 测试用例评审流程

### 评审时机

1. **PRD批准后**: 测试用例设计完成后，必须经过评审
2. **实现前**: 测试用例评审通过后，才能开始实现
3. **变更时**: 测试用例变更时，必须重新评审

### 评审人员

- **必须**: 至少2人评审（测试专家 + 开发专家）
- **建议**: 包括产品专家（验证用户视角）

### 评审内容

1. **完整性检查**: 使用检查清单验证测试用例完整性
2. **业务逻辑检查**: 验证测试用例是否覆盖了完整的业务流程
3. **优先级检查**: 验证测试用例的优先级是否合理
4. **可执行性检查**: 验证测试用例是否可执行和可验证

### 评审记录

- **必须记录**: 评审意见、评审结果、评审人员
- **必须跟踪**: 评审问题必须跟踪和解决
- **必须归档**: 评审记录必须归档保存

---

## 💻 测试实现审查检查清单

### 1. API响应验证

- [ ] 测试是否验证了API响应状态码？
- [ ] 测试是否验证了API响应数据格式？
- [ ] 测试是否验证了API响应内容？

### 2. 数据库状态验证

- [ ] 测试是否验证了所有相关的数据库记录？
- [ ] 测试是否验证了记录的字段和关系？
- [ ] 测试是否验证了记录的默认值和约束？

### 3. 邮件/通知内容验证

- [ ] 测试是否验证了邮件内容格式？
- [ ] 测试是否验证了邮件中的链接格式？
- [ ] 测试是否验证了链接指向正确的页面（前端而非后端API）？
- [ ] 测试是否验证了所有用户可见的输出？

### 3. 异步任务验证

- [ ] 测试是否Mock了外部依赖（如Celery）？
- [ ] 测试是否验证了异步任务的调用？
- [ ] 测试是否验证了异步任务的参数？
- [ ] 测试是否验证了异步任务生成的内容（如邮件链接）？

### 4. 业务逻辑完整性

- [ ] 测试是否验证了业务流程的每个环节？
- [ ] 测试是否验证了业务逻辑的正确性？
- [ ] 测试是否验证了错误处理和边界情况？
- [ ] 测试是否验证了端到端用户体验流程？

### 5. 代码质量

- [ ] 测试代码是否清晰可读？
- [ ] 测试代码是否遵循项目规范？
- [ ] 测试代码是否包含必要的注释？

---

## 🔄 测试实现审查流程

### 审查时机

1. **实现完成后**: 测试实现完成后，必须经过代码审查
2. **合并前**: 测试实现审查通过后，才能合并到主分支
3. **变更时**: 测试实现变更时，必须重新审查

### 审查人员

- **必须**: 至少1人审查（测试专家或开发专家）
- **建议**: 包括代码作者之外的人员

### 审查内容

1. **完整性检查**: 使用检查清单验证测试实现完整性
2. **代码质量检查**: 验证测试代码是否符合项目规范
3. **覆盖率检查**: 验证测试是否覆盖了所有关键点
4. **可维护性检查**: 验证测试代码是否易于维护

### 审查记录

- **必须记录**: 审查意见、审查结果、审查人员
- **必须跟踪**: 审查问题必须跟踪和解决
- **必须归档**: 审查记录必须归档保存

---

## 📊 测试覆盖率要求

### 最低覆盖率

- **P0测试用例**: 100%覆盖（所有检查点都必须验证）
- **P1测试用例**: 80%覆盖（关键检查点必须验证）
- **P2测试用例**: 60%覆盖（主要检查点必须验证）

### 覆盖率检查

1. **自动检查**: 使用pytest-cov生成覆盖率报告
2. **定期检查**: 每周检查一次覆盖率报告
3. **问题跟踪**: 识别未覆盖的关键点，补充测试用例

---

## 🚫 禁止事项

### 测试用例设计

- ❌ 禁止只验证API响应，忽略业务流程
- ❌ 禁止只验证功能，忽略业务逻辑
- ❌ 禁止跳过测试用例评审

### 测试实现

- ❌ 禁止只验证API响应，忽略数据库状态
- ❌ 禁止忽略异步任务验证
- ❌ 禁止跳过测试实现审查

---

## 📝 参考文档

- `docs/architecture/V4/TESTING-REFLECTION.md` - 测试缺陷深度反思报告
- `docs/architecture/V4/TESTING-GAP-ANALYSIS.md` - 测试覆盖缺陷分析报告
- `docs/00_product/requirements/REQ-2025-003-user-login/REQ-2025-003-user-login-test-cases.csv` - 测试用例CSV

---

**规则生效时间**: 2025-12-14
**规则状态**: 已生效，强制执行
