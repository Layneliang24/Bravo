---
description: PRD精化规则（处理原始需求草稿）
globs: .taskmaster/docs/**/*-raw.txt, .taskmaster/docs/**/raw/**/*.txt
priority: 900
---

# PRD精化规则

> **用途**：当处理`.taskmaster/docs/`中的原始需求文件时，自动触发精化流程

## 触发条件

当用户提到以下关键词时，应用此规则：

- "精化需求"
- "精化PRD"
- "补充技术细节"
- "refine requirement"
- 引用`.taskmaster/docs/`中的`*-raw.txt`文件

---

## 精化流程

### 1. 保留原始需求

**不要删除或修改人类的原始需求内容**，在其基础上补充。

### 2. 补充以下章节

#### 2.1 数据库设计

**格式**：使用Markdown表格

**内容**：

- 表名（使用项目命名规范）
- 字段列表（名称、类型、说明、约束）
- 主键、外键、索引
- 表关系（一对一、一对多、多对多）

**示例**：

```markdown
## 数据库设计

### User表

| 字段名        | 类型         | 说明     | 约束             |
| ------------- | ------------ | -------- | ---------------- |
| id            | UUID         | 主键     | PK, NOT NULL     |
| email         | VARCHAR(255) | 邮箱     | UNIQUE, NOT NULL |
| password_hash | VARCHAR(255) | 密码哈希 | NOT NULL         |
| created_at    | TIMESTAMP    | 创建时间 | DEFAULT NOW()    |

**索引**：

- idx_email: email (UNIQUE)

**关系**：

- User → UserProfile (一对一)
```

---

#### 2.2 API接口定义

**格式**：使用清晰的端点列表 + 请求/响应示例

**内容**：

- HTTP方法和路径
- 请求参数（路径参数、查询参数、请求体）
- 响应格式（成功和错误）
- 状态码
- 认证要求

**示例**：

````markdown
## API接口定义

### POST /api/auth/login

用户登录

**请求体**：

```json
{
  "email": "user@example.com",
  "password": "password123"
}
```
````

**成功响应** (200):

```json
{
  "token": "jwt-token-here",
  "user": {
    "id": "uuid",
    "email": "user@example.com"
  }
}
```

**错误响应** (401):

```json
{
  "error": "Invalid credentials"
}
```

**认证**：不需要（公开端点）

````

---

#### 2.3 前端组件设计

**格式**：组件层次 + 状态管理 + 交互流程

**内容**：
- 页面结构（主页面、子组件）
- 组件层次关系
- 状态管理方案（Pinia/Vuex/Context）
- 用户交互流程
- 路由配置

**示例**：

```markdown
## 前端组件设计

### 页面结构
- LoginView.vue (登录主页面)
  - LoginForm.vue (登录表单组件)
  - SocialLogin.vue (第三方登录组件)

### 状态管理
使用Pinia store: `stores/auth.ts`

**State**：
- user: User | null
- token: string | null
- isAuthenticated: boolean

**Actions**：
- login(email, password)
- logout()
- checkAuth()

### 交互流程
1. 用户访问 /login 路由
2. 显示LoginView页面
3. 用户填写邮箱和密码
4. 点击"登录"按钮
5. 调用API: POST /api/auth/login
6. 成功：保存token，跳转到首页
7. 失败：显示错误提示
````

---

#### 2.4 测试策略

**格式**：按测试类型分组，列出测试文件路径和测试用例

**内容**：

- 单元测试（后端模型、视图、工具函数）
- 集成测试（API端点、数据库交互）
- E2E测试（完整用户流程）
- 测试数据准备

**示例**：

```markdown
## 测试策略

### 后端测试

**单元测试**：

- `backend/tests/unit/test_user_model.py`

  - 测试User模型的创建
  - 测试密码哈希
  - 测试字段验证

- `backend/tests/unit/test_auth_views.py`
  - 测试登录视图逻辑
  - 测试token生成
  - 测试错误处理

**集成测试**：

- `backend/tests/integration/test_auth_api.py`
  - 测试完整的登录流程
  - 测试token验证
  - 测试并发登录

### 前端测试

**组件测试**：

- `frontend/src/components/__tests__/LoginForm.spec.ts`
  - 测试表单渲染
  - 测试表单验证
  - 测试提交逻辑

**E2E测试**：

- `e2e/tests/auth/login.spec.ts`
  - 测试完整登录流程
  - 测试登录失败场景
  - 测试登录后跳转
```

---

#### 2.5 技术实现细节

**格式**：技术选型 + 架构决策 + 第三方库

**内容**：

- 后端技术栈
- 前端技术栈
- 第三方库和服务
- 架构决策和理由
- 性能优化方案
- 安全考虑

**示例**：

```markdown
## 技术实现细节

### 后端技术栈

- Django REST framework (API开发)
- djangorestframework-simplejwt (JWT认证)
- django-cors-headers (CORS处理)

### 前端技术栈

- Vue 3 Composition API
- Pinia (状态管理)
- Vue Router (路由)
- Axios (HTTP客户端)
- VeeValidate (表单验证)

### 第三方服务

- 无（纯本地认证）

### 架构决策

**JWT vs Session**：

- 选择JWT：支持前后端分离，无状态，易于扩展

**密码哈希**：

- 使用Django内置的PBKDF2算法
- 自动加盐，防止彩虹表攻击

**Token刷新策略**：

- Access Token: 15分钟有效期
- Refresh Token: 7天有效期
- 使用HTTP-only Cookie存储Refresh Token

### 安全考虑

- 密码强度验证（最少8位，包含字母和数字）
- 登录失败次数限制（5次失败后锁定10分钟）
- HTTPS强制（生产环境）
- CSRF保护
```

---

## 输出格式

### 选项1：在原文件中补充（快速模式）

直接在`*-raw.txt`文件中追加精化内容，保留原始需求在顶部。

### 选项2：创建refined版本（推荐）

创建新文件`*-refined.txt`，包含：

1. 原始需求（引用或复制）
2. 所有精化章节

---

## 精化模板

```markdown
# [功能名称]

## 原始需求

[保留人类的原始描述]

## 数据库设计

[表结构、字段、关系]

## API接口定义

[端点、方法、请求/响应格式、错误码]

## 前端组件设计

[页面结构、组件层次、状态管理、交互流程]

## 测试策略

[测试文件路径、测试用例、测试数据]

## 技术实现细节

[技术选型、架构决策、第三方库、安全考虑]

## 实施优先级（可选）

### Phase 1 (MVP)

- [核心功能]

### Phase 2

- [增强功能]

### Phase 3

- [高级功能]
```

---

## 注意事项

1. **保持一致性**：使用项目现有的命名规范、目录结构、技术栈
2. **具体而非抽象**：提供具体的表名、字段名、端点路径、文件路径
3. **可执行性**：精化后的PRD应该可以直接用于Task Master解析
4. **测试优先**：明确列出所有测试文件路径和测试用例
5. **安全意识**：考虑认证、授权、数据验证、错误处理

---

## 示例对话

**用户**：

```
@user-login-raw.txt 请精化这个需求
```

**Cursor响应**：

```
我将为您精化这个登录需求，补充技术细节。

[创建 user-login-refined.txt]

已完成精化，包含：
✅ 数据库设计（User表、Session表）
✅ API接口定义（登录、登出、验证token）
✅ 前端组件设计（LoginView、LoginForm）
✅ 测试策略（单元测试、集成测试、E2E测试）
✅ 技术实现（JWT认证、密码哈希、安全策略）

下一步：
1. 快速验证：task-master parse-prd --input=.taskmaster/docs/user-login-refined.txt
2. 正式立项：bash scripts/migrate-to-standard-prd.sh .taskmaster/docs/user-login-refined.txt REQ-2025-001-user-login
```

---

**遵循此规则，确保PRD精化的一致性和完整性！** 📋
