---
description: 根据用户意图路由到对应的工作流/角色规则
globs: **/*
alwaysApply: true
priority: 980
---

# 意图识别与规则路由

> **重要**：本规则不依赖打开任何文件，只根据**对话内容**来决定该激活哪些规则。即使文件还没打开，也要严格遵守相应规则。

## 核心原则

**当用户表达特定意图时，AI必须主动应用相应的规则，即使相关文件还没打开，同时需明确告知，你当前在引用哪条规则**

### 意图识别检查清单（必须执行）

**在响应任何请求前，必须检查以下关键词（使用包含匹配，不要求精确匹配）**：

**第一步：基础关键词检查**
1. [ ] 是否包含PRD相关关键词？（"PRD"、"需求文档"、"分析PRD"、"检查PRD"等）
2. [ ] 是否包含任务相关关键词？（"生成任务"、"Task-Master"、"parse-prd"等）
3. [ ] 是否包含开发/实现相关关键词？（"实现"、"开发"、"编码"等）
4. [ ] 是否包含测试相关关键词？（"测试"、"测试用例"、"单元测试"、"E2E"、"测试架构"等）
5. [ ] 是否包含提交相关关键词？（"提交代码"、"commit"、"push"等）
6. [ ] 是否包含调试/排查相关关键词？（"调试"、"排查"、"排查问题"、"修复bug"、"问题"、"难排查"等）
7. [ ] 是否包含API契约相关关键词？（"API契约"、"OpenAPI"、"设计API"等）
8. [ ] 是否包含文档维护相关关键词？（"更新文档"、"写文档"、"文档维护"等）
9. [ ] 是否包含代码审查相关关键词？（"代码审查"、"review"、"审查代码"等）
10. [ ] 是否包含项目初始化相关关键词？（"项目初始化"、"项目启动"、"setup"等）
11. [ ] 是否包含架构相关关键词？（"架构"、"架构设计"、"架构分析"、"测试架构"等）

**第二步：上下文和语义理解（智能匹配）**
- [ ] 分析用户意图的上下文（如"分析本项目测试架构" → 测试 + 架构）
- [ ] 识别隐含意图（如"这个测试用例到底什么问题，怎么这么难排查" → 测试 + 排查）
- [ ] 识别组合意图（使用"并"、"和"、"同时"等连接词，或语义上明显需要多个意图）

**第三步：组合意图判断**
- [ ] 如果匹配多个意图，判断是否需要组合应用
- [ ] 组合意图的判断标准：
  - 用户明确使用连接词（"并"、"和"、"同时"）
  - 语义上明显需要多个角色/规则（如"分析测试架构"需要测试专家+架构专家）
  - 上下文暗示需要多个意图（如"测试用例问题难排查"需要测试+调试）

**如果匹配任何意图，必须按以下格式响应**：

**单一意图**：
```
[识别到{意图类型}意图：{用户的具体请求}]
   [应用规则：@.cursor/rules/00-core/intent-recognition.mdc]
   [应用规则：@.cursor/rules/{阶段目录}/{具体规则文件}.mdc]
   [应用规则：@.cursor/rules/09-roles/{具体角色文件}.mdc]
[切换到{角色名称}角色]
[开始执行：{具体操作}]
```

**组合意图**（如果匹配多个意图）：
```
[识别到组合意图：{意图1} + {意图2}]
   [应用规则：@.cursor/rules/00-core/intent-recognition.mdc]
   [应用规则：@.cursor/rules/{阶段目录1}/{规则文件1}.mdc]
   [应用规则：@.cursor/rules/{阶段目录2}/{规则文件2}.mdc]
   [应用规则：@.cursor/rules/09-roles/{角色文件1}.mdc]
   [应用规则：@.cursor/rules/09-roles/{角色文件2}.mdc]
[切换到{角色1} + {角色2}角色]
[开始执行：{具体操作}]
```

**禁止行为**：
- ❌ 不能直接执行操作而不明确告知规则引用
- ❌ 不能跳过意图识别步骤
- ❌ 不能省略"明确告知"步骤

---

## 1. PRD相关意图

**触发关键词**: "PRD"、"需求文档"、"分析PRD"、"检查PRD"、"生成PRD"、"创建PRD"、"写PRD"、"设计PRD"、"精化需求"、"product requirements"

**应用规则**:
- @.cursor/rules/01-product/prd-standards.mdc
- @.cursor/rules/01-product/prd-refinement.mdc（如果是精化需求）
- @.cursor/rules/09-roles/prd-designer.mdc
- @.cursor/rules/09-roles/architect.mdc

**切换到角色**: PRD设计专家 + 架构专家

---

## 2. 任务相关意图

**触发关键词**: "生成任务"、"Task-Master"、"parse-prd"、"创建任务"、"拆分任务"、"task-master"、"generate tasks"

**应用规则**:
- @.cursor/rules/03-taskmaster/task-generation.mdc
- @.cursor/rules/03-taskmaster/taskmaster-workflow.mdc
- @.cursor/rules/03-taskmaster/taskmaster-cli.mdc

**切换到角色**: 任务管理专家

---

## 3. 开发/实现相关意图

**触发关键词**: "实现"、"开发"、"编码"、"写代码"、"实现功能"、"implement"、"develop"、"write code"、"开始做Task-X"

**应用规则**:
- @.cursor/rules/04-development/development-workflow.mdc
- @.cursor/rules/04-development/task-execution.mdc
- @.cursor/rules/09-roles/developer.mdc

**切换到角色**: 开发专家

---

## 4. 测试相关意图

**触发关键词**: "测试"、"测试用例"、"单元测试"、"E2E"、"写测试"、"加E2E"、"test"、"unit test"、"integration test"、"E2E test"、"测试架构"

**应用规则**:
- @.cursor/rules/02-testing/test-types.mdc
- @.cursor/rules/02-testing/test-case-standards.mdc
- @.cursor/rules/02-testing/test-case-review.mdc
- @.cursor/rules/02-testing/e2e-testing.mdc
- @.cursor/rules/09-roles/tester.mdc

**切换到角色**: 测试专家

---

## 5. 提交/推送相关意图

**触发关键词**: "提交代码"、"推送代码"、"commit"、"push"、"生成提交信息"、"git commit"

**应用规则**:
- @.cursor/rules/06-cicd/pre-commit.mdc
- @.cursor/rules/06-cicd/compliance.mdc
- @.cursor/rules/00-core/v4-traceability.mdc

**切换到角色**: 无特定角色（执行提交流程）

---

## 6. 调试相关意图

**触发关键词**: "调试"、"排查"、"排查问题"、"修复bug"、"问题"、"难排查"、"debug"、"troubleshoot"、"fix bug"、"为什么报错"

**应用规则**:
- @.cursor/rules/05-debugging/debugging-methodology.mdc
- @.cursor/rules/05-debugging/troubleshooting-checklist.mdc

**切换到角色**: 无特定角色（执行调试流程）

---

## 7. API契约相关意图

**触发关键词**: "API契约"、"OpenAPI"、"设计API"、"创建API契约"、"API contract"、"design API"

**应用规则**:
- @.cursor/rules/02-testing/contract-testing.mdc
- @.cursor/rules/09-roles/architect.mdc

**切换到角色**: 架构专家

---

## 8. 文档维护相关意图

**触发关键词**: "更新文档"、"写文档"、"文档维护"、"创建文档"、"documentation"、"update docs"

**应用规则**:
- @.cursor/rules/07-documentation/documentation-standards.mdc

**切换到角色**: 无特定角色（执行文档维护流程）

---

## 9. 代码审查相关意图

**触发关键词**: "代码审查"、"代码评审"、"审查代码"、"review"、"code review"

**应用规则**:
- @.cursor/rules/1-quality/code-review.mdc

**切换到角色**: 无特定角色（执行代码审查流程）

---

## 10. 项目初始化相关意图 → 项目启动规则

### 触发语义（关键词匹配）

**中文关键词**：
- "项目初始化"、"项目启动"、"初始化项目"、"项目设置"
- "setup"、"启动项目"

**英文关键词**：
- "project setup"、"project initialization"、"initialize project"
- "setup"、"init"

### 应用规则

当检测到上述意图时，AI必须：

1. **视为进入项目初始化阶段**
2. **必须明确告知规则引用**：
   ```
   [识别到项目初始化相关意图：{用户的具体请求}]
   [应用规则：@.cursor/rules/00-core/intent-recognition.mdc]
   [应用规则：@.cursor/rules/08-project/project-setup.mdc]
   ```
3. **主动应用并严格遵守以下规则**：
   - `@.cursor/rules/08-project/project-setup.mdc`

4. **初始化检查清单**：
   - 阅读项目架构文档
   - 确认目录结构
   - 确认技术栈
   - 检查开发环境配置

---

## 11. 架构相关意图

**触发关键词**: "架构"、"架构设计"、"架构分析"、"架构评估"、"architecture"、"architect"、"系统架构"、"测试架构"

**应用规则**:
- @.cursor/rules/09-roles/architect.mdc
- @.cursor/rules/00-core/v4-core.mdc

**切换到角色**: 架构专家

---

## 12. 意图识别逻辑

### 关键词匹配方式（增强版）

**匹配规则**：使用**包含匹配**（子串匹配）+ **语义理解**，不是精确匹配

**基础匹配示例**：
- ✅ "看看单元测试用例是否合理" → 包含"单元测试" → **匹配测试相关意图**
- ✅ "分析PRD完整性" → 包含"PRD" → **匹配PRD相关意图**
- ✅ "检查登录接口的测试" → 包含"测试" → **匹配测试相关意图**
- ✅ "评估这个测试用例" → 包含"测试用例" → **匹配测试相关意图**

**智能匹配示例**（新增）：
- ✅ "分析本项目测试架构" → 包含"测试" + "架构" → **匹配测试意图 + 架构意图**（组合意图）
- ✅ "这个测试用例到底什么问题，怎么这么难排查" → 包含"测试用例" + "问题" + "排查" → **匹配测试意图 + 调试意图**（组合意图）
- ✅ "检查测试覆盖率并优化性能" → 包含"测试" + "性能" → **匹配测试意图 + 性能优化意图**（组合意图）
- ✅ "设计API并写文档" → 包含"API" + "文档" → **匹配API契约意图 + 文档维护意图**（组合意图）

**匹配逻辑**：
1. **基础匹配**：检查用户输入是否**包含**任何关键词（不要求完整匹配）
2. **语义理解**：分析上下文，识别隐含意图（如"测试架构"需要测试+架构）
3. **组合判断**：如果匹配多个意图，判断是否需要组合应用
4. **关键词可以是短语的一部分**（如"单元测试用例"包含"单元测试"）
5. **支持模糊匹配**：即使关键词不完全匹配，也要从语义上理解意图

### 优先级规则（更新）

1. **组合意图优先**：如果识别到组合意图，优先应用组合意图（不要只选一个）
2. **显性意图优先**：用户明确表达的意图（如"生成PRD"）优先于隐式意图
3. **语义理解优先**：从上下文和语义理解意图（如"测试架构"需要测试+架构）
4. **最近意图优先**：如果对话中有多个意图，以最近一次为准
5. **上下文理解**：结合对话历史理解意图（如果用户之前提到PRD，后续的"生成"可能指PRD）

### 智能意图识别（新增）

**核心原则**：不仅要匹配关键词，还要理解语义和上下文

**识别策略**：

1. **上下文分析**：
   - "分析本项目测试架构" → 虽然没明确说"测试规则"，但"测试架构"明显需要测试专家视角
   - "这个测试用例到底什么问题" → 虽然没明确说"调试"，但"问题"+"难排查"明显需要调试规则

2. **语义推断**：
   - "架构"相关词汇 → 可能需要架构专家角色
   - "排查"、"问题"、"难" → 可能需要调试规则
   - "分析" + 领域词 → 可能需要该领域的专家角色

3. **组合判断**：
   - 如果问题涉及多个领域，自动组合相关意图
   - 如果分析需要多个视角，自动组合相关角色

**示例**：
- "分析本项目测试架构" → 测试意图（测试架构） + 架构意图（架构分析） → 测试专家 + 架构专家
- "这个测试用例到底什么问题，怎么这么难排查" → 测试意图（测试用例） + 调试意图（问题排查） → 测试专家 + 调试规则

### 组合意图处理（新增）

**支持组合意图**：如果用户表达需要多个意图，必须同时应用所有相关规则

**组合意图识别标准**：

1. **显式组合**（使用连接词）：
   - "生成PRD并写测试" → PRD意图 + 测试意图
   - "实现功能并写测试" → 开发意图 + 测试意图
   - "设计API并更新文档" → API契约意图 + 文档维护意图

2. **语义组合**（从上下文推断）：
   - "分析本项目测试架构" → 测试意图 + 架构意图（需要测试专家+架构专家）
   - "这个测试用例到底什么问题，怎么这么难排查" → 测试意图 + 调试意图（需要测试专家+调试规则）
   - "检查PRD并设计API" → PRD意图 + API契约意图

3. **上下文组合**（从问题性质推断）：
   - 如果问题涉及多个领域，自动组合相关意图
   - 如果分析需要多个角色视角，自动组合相关角色

**组合意图应用规则**：

当识别到组合意图时，AI必须：
1. **识别所有匹配的意图**（不要只选一个）
2. **按顺序应用所有意图的规则**
3. **切换到所有相关角色**（可以同时应用多个角色）
4. **明确告知所有应用的规则**

**示例响应格式**：
```
[识别到组合意图：测试相关 + 架构相关]
[应用规则：@.cursor/rules/00-core/intent-recognition.mdc]
[应用规则：@.cursor/rules/02-testing/test-types.mdc]
[应用规则：@.cursor/rules/01-product/prd-standards.mdc]（架构设计相关）
[应用规则：@.cursor/rules/09-roles/tester.mdc]
[应用规则：@.cursor/rules/09-roles/architect.mdc]
[切换到测试专家 + 架构专家角色]
[开始执行：分析测试架构，从测试和架构两个角度分析]
```

### 单一意图处理（如果只匹配一个意图）

如果只匹配一个意图：
- 按原有规则处理
- 应用单一意图的规则和角色

### 意图识别失败

如果无法识别用户意图：
- 保持当前规则状态
- 不强制应用任何规则
- 但核心原则（alwaysApply）仍然生效

---

## 13. 规则应用说明

### 不替代file-based globs

- 工作流程规则仍保留自己的`globs`配置
- 当你打开对应文件时，规则仍然会通过file-based方式触发
- 本规则只是补充"通过对话意图触发"的通路
- 解决"不爱先打开文件"的使用习惯

### 规则叠加

- 意图识别规则不会覆盖file-based规则
- 两者可以同时生效
- 如果同时触发，按优先级应用

### 性能考虑

- 意图识别规则优先级980，低于核心原则（1000），高于pre-commit（950）
- 确保在大多数工作流程规则之前应用
- 但不会影响核心原则的优先级

---

## 14. 参考规则

- `@.cursor/rules/00-core/v4-core.mdc`（核心原则，alwaysApply）
- `@.cursor/rules/00-core/v4-traceability.mdc`（追溯链规则，通过意图路由在提交时加载）
- `@.cursor/rules/06-cicd/pre-commit.mdc`（提交前检查，通过意图路由在提交时加载）

**当前alwaysApply规则（仅2个）**：
- `v4-core.mdc` (priority: 1000) - 核心宪法，必须总是生效
- `intent-recognition.mdc` (priority: 980) - 路由层，必须总是生效
