---
description: Pre-commit和本地通行证阶段的规则
globs: **/*
priority: 950
---

# Pre-commit和本地通行证阶段规则

## 四层检查体系

Pre-commit hook执行四层检查：

### 第一层：依赖安全检查
- 检查是否有包管理命令正在运行
- 防止依赖安装冲突

### 第二层：本地测试通行证验证
- 验证本地测试是否通过
- 推送前必需完整通行证

### 第三层：代码质量检查
- 执行`scripts/code-quality-check.sh`
- 包括格式化、代码检查、类型检查等

### 第四层：V4合规引擎检查
- 执行`.compliance/runner.py`
- 检查PRD、测试文件、代码关联等

**参考**: @.husky/pre-commit

## 合规警告主动修复

**核心原则**: 所有合规警告都必须主动修复，不得等待用户指出

**常见警告及修复**:

1. **REQ-ID缺失**:
   - **详细规则**: 参考 @.cursor/rules/00-core/v4-traceability.mdc
   - 添加REQ-ID注释到文件头部
   - Python: `# REQ-ID: REQ-YYYY-NNN-description`
   - TypeScript: `// REQ-ID: REQ-YYYY-NNN-description`
   - Vue: `<script>`标签内第一行

2. **测试文件缺失**:
   - 根据代码文件创建对应的测试文件
   - 确保测试文件也包含REQ-ID注释

3. **PRD状态问题**:
   - 检查PRD状态是否为`approved`或`implementing`
   - 修复PRD状态

**参考**: @.cursor/rules/06-cicd/compliance.mdc

## 提交前检查清单

- [ ] 代码已通过所有测试
- [ ] 代码已通过lint检查
- [ ] 代码已通过类型检查
- [ ] 已检查pre-commit输出
- [ ] 已修复所有合规警告
- [ ] 已验证修复后无新警告
- [ ] 提交信息包含REQ-ID
- [ ] 所有新文件都包含REQ-ID注释

## 禁止事项

- ❌ 不能使用`--no-verify`绕过检查
- ❌ 不能忽略合规警告
- ❌ 不能提交包含警告的代码
