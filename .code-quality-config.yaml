# é¢„æäº¤é’©å­é…ç½®æ¨¡æ¿

repos:
  # ğŸš€ å¿«é€Ÿè¯­æ³•å’Œæ ¼å¼æ£€æŸ¥ä¼˜å…ˆ
  # é€šç”¨æ£€æŸ¥ - å¿«é€Ÿå¤±è´¥
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.4.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
        exclude: "bandit-report.json"
      - id: check-yaml
      - id: check-json
      - id: check-merge-conflict
      - id: check-added-large-files
      - id: check-case-conflict
      - id: debug-statements

  # Python ä»£ç æ ¼å¼åŒ–
  - repo: https://github.com/psf/black
    rev: 23.11.0
    hooks:
      - id: black
        language_version: python3.10

  # Python å¯¼å…¥æ’åº
  - repo: https://github.com/pycqa/isort
    rev: 5.12.0
    hooks:
      - id: isort
        args: ["--profile", "black"]

  # Python ä»£ç æ£€æŸ¥
  - repo: https://github.com/pycqa/flake8
    rev: 6.1.0
    hooks:
      - id: flake8
        args: [--config=backend/.flake8]

  # Python ç±»å‹æ£€æŸ¥
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.7.1
    hooks:
      - id: mypy
        args:
          [
            --config-file=backend/pyproject.toml,
            --disable-error-code=var-annotated,
          ]
        additional_dependencies: ["django-stubs[mypy]"]
        files: ^backend/
        exclude: ^backend/(migrations|tests)/

  # Python å®‰å…¨æ£€æŸ¥ (ä¿®å¤Windowsç¼–ç é—®é¢˜)
  - repo: https://github.com/pycqa/bandit
    rev: 1.7.5
    hooks:
      - id: bandit
        args: ["-r", "backend/apps/", "-f", "json", "-o", "bandit-report.json"]
        exclude: "tests|test_"
        additional_dependencies: ["pbr"]
        pass_filenames: false

  # JavaScript/TypeScript ä»£ç æ ¼å¼åŒ–
  - repo: https://github.com/pre-commit/mirrors-prettier
    rev: v3.1.0
    hooks:
      - id: prettier
        files: \.(js|jsx|ts|tsx|json|css|scss|md|yml|yaml)$
        exclude: |
          (?x)^(
            docs/02_test_report/.*\.json$|
            docs/02_test_report/.*_report\.md$|
            .*temp_modifications.*\.json$|
            .*\.log$|
            .*\.report$
          )$

  # ESLintæ£€æŸ¥ - disabled due to configuration compatibility issues
  # - repo: https://github.com/pre-commit/mirrors-eslint
  #   rev: v8.53.0
  #   hooks:
  #     - id: eslint
  #       files: ^frontend/.*\.(js|jsx|ts|tsx|vue)$
  #       args:
  #         [
  #           "frontend/**/*.{js,ts,vue}",
  #           "--config",
  #           "frontend/.eslintrc.cjs",
  #           "--fix",
  #         ]
  #       additional_dependencies:
  #         - eslint@8.53.0
  #         - "@typescript-eslint/eslint-plugin@6.12.0"
  #         - "@typescript-eslint/parser@6.12.0"
  #         - "eslint-plugin-vue@9.18.1"

  # ğŸ” é‡å‹æ£€æŸ¥æœ€åæ‰§è¡Œ
  # å…¨é¢ä»£ç è´¨é‡æ£€æŸ¥ - ç§»åˆ°æœ€å
  - repo: local
    hooks:
      - id: comprehensive-check
        name: Comprehensive code quality check
        entry: python scripts/code_change_tracker.py --validate-commit
        language: system
        pass_filenames: false
        always_run: true
        fail_fast: true

  # Docker æ–‡ä»¶æ£€æŸ¥ - é€šè¿‡Dockeré•œåƒæ‰§è¡Œï¼Œç¬¦åˆçº¯Dockerå¼€å‘åŸåˆ™
  - repo: local
    hooks:
      - id: hadolint-docker
        name: Hadolint Docker file linter
        entry: bash -c 'cat "$1" | docker run --rm -i hadolint/hadolint:v2.12.0 hadolint --ignore DL3008 --ignore DL3009 --ignore DL3015 --ignore DL3018 --ignore DL3059 --ignore DL4006 --ignore DL3013 -'
        language: system
        files: ^.*Dockerfile.*$
        pass_filenames: true
        args: ["--"]

  # æäº¤ä¿¡æ¯æ£€æŸ¥
  - repo: https://github.com/commitizen-tools/commitizen
    rev: v3.13.0
    hooks:
      - id: commitizen
        stages: [commit-msg]

  # å‘½åè§„åˆ™æ£€æŸ¥
  - repo: local
    hooks:
      - id: python-naming-check
        name: Python Naming Convention Check
        entry: sh -c 'if docker-compose ps backend | grep -q "Up"; then docker-compose exec -T backend python -m flake8 --select=N --config=/app/.flake8 /app/ || true; else echo "Skipping - backend not running"; fi'
        language: system
        files: ^backend/.*\.py$
        pass_filenames: false

      # Temporarily disabled due to missing pylint module
      # - id: python-pylint-naming
      #   name: Python Pylint Naming Check
      #   entry: python -m pylint --rcfile=backend/.pylintrc.naming --load-plugins=pylint.extensions.bad_builtin,pylint.extensions.check_elif,pylint.extensions.docparams,pylint.extensions.docstyle,pylint.extensions.empty_comment,pylint.extensions.mccabe,pylint.extensions.overlapping_exceptions,pylint.extensions.private_import,pylint.extensions.redefined_variable_type,pylint.extensions.typing,pylint.extensions.while_used --ignore=.venv,migrations,settings backend/apps/ backend/tests/
      #   language: system
      #   files: ^backend/(apps|tests)/.*\.py$
      #   pass_filenames: false

      - id: typescript-syntax-check
        name: TypeScript Syntax Check
        entry: sh -c 'echo "æ£€æŸ¥E2E TypeScript..." && cd e2e && npm run type-check && echo "E2E TypeScriptè¯­æ³•æ£€æŸ¥é€šè¿‡"'
        language: system
        files: \.(ts|tsx|vue|json)$
        exclude: node_modules
        pass_filenames: false

      - id: github-actions-syntax-check
        name: GitHub Actions Workflow Syntax Check
        entry: sh -c 'echo "æ£€æŸ¥workflowè¯­æ³•..." && find .github/workflows -name "*.yml" -o -name "*.yaml" | xargs -I {} python -c "import yaml; yaml.safe_load(open(\"{}\", \"r\", encoding=\"utf-8\"))" && echo "è¯­æ³•æ£€æŸ¥é€šè¿‡"'
        language: system
        files: ^\.github/workflows/.*\.(yml|yaml)$
        pass_filenames: false

      # TypeScriptå‘½åæ£€æŸ¥ - æš‚æ—¶ç¦ç”¨ï¼Œéœ€è¦å‰ç«¯æœåŠ¡è¿è¡Œ
      # - id: typescript-naming-check
      #   name: TypeScript Naming Convention Check
      #   entry: sh -c 'docker-compose exec -T frontend npx eslint --config .eslintrc.cjs --no-fix'
      #   language: system
      #   files: ^frontend/src/.*\.(ts|tsx)$
      #   pass_filenames: true

      # - id: vue-naming-check
      #   name: Vue Naming Convention Check
      #   entry: sh -c 'docker-compose exec -T frontend npx eslint --config .eslintrc.cjs --no-fix'
      #   language: system
      #   files: ^frontend/src/.*\.vue$
      #   pass_filenames: true

  # æœ¬åœ°ç›®å½•å®ˆå«é’©å­
  - repo: local
    hooks:
      - id: root-clutter
        name: Root Clutter Guard (strict)
        entry: >
          sh -c '
          FILES=$(git diff --cached --name-status | grep "^[AM]" | cut -f2- |
                  grep -E "^[^/]+\." |
                  grep -v -E "^\.|^(package|docker-compose|Dockerfile)" |
                  grep -v -E "^(setup|install|configure|build|deploy)\.(sh|py|js)$" |
                  grep -v -E "^(README|CODE_OF_CONDUCT|CONTRIBUTING|SECURITY|CHANGELOG|LICENSE)\.md$");
          if [ -n "$FILES" ]; then
            echo "âŒ ç¦æ­¢åœ¨æ ¹ç›®å½•æ·»åŠ æ–‡ä»¶ï¼Œåªå…è®¸æ ‡å‡†æ–‡æ¡£å’Œå®‰è£…è„šæœ¬";
            echo "$FILES";
            echo "ğŸ’¡ å…è®¸çš„å®‰è£…è„šæœ¬: setup.sh, install.sh, configure.sh, build.sh, deploy.sh";
            exit 1;
          fi
          '
        language: system
        always_run: true
        fail_fast: true

  # åˆ†æ”¯ä¿æŠ¤é’©å­
  - repo: local
    hooks:
      - id: branch-protection
        name: Branch Protection Check
        entry: sh scripts/branch_protection.sh
        language: system
        stages: [pre-push]
        always_run: true

      # æ–°å¢ä¸¥æ ¼æ£€æŸ¥é¡¹
      - id: no-skip-verify
        name: Prevent --no-verify usage
        entry: sh -c 'if [ -f ".git/hooks/pre-commit" ]; then echo "[OK] Pre-commit hooks å·²å®‰è£…"; else echo "[ERROR] Pre-commit hooks æœªå®‰è£…æˆ–è¢«ç»•è¿‡" && exit 1; fi'
        language: system
        stages: [pre-commit]
        pass_filenames: false
        always_run: true

      - id: file-size-check
        name: Large file check (strict)
        entry: sh -c 'git diff --cached --name-only | xargs -I {} find {} -type f -size +5M 2>/dev/null | head -1 | grep . && echo "âŒ æ–‡ä»¶è¶…è¿‡5MBï¼Œè¯·ä½¿ç”¨Git LFS" && exit 1 || exit 0'
        language: system
        always_run: true

      - id: security-scan
        name: Basic security scan
        entry: echo "[INFO] Security scan skipped - scanner removed for code quality"
        language: system
        pass_filenames: false
        always_run: true

      # ğŸ›¡ï¸ NPM WORKSPACES æ¶æ„ä¿æŠ¤ï¼Œé˜²æ­¢ä¾èµ–ç®¡ç†è¿è§„
      - id: npm-workspaces-guard
        name: NPM Workspaces Architecture Guard
        entry: python scripts/check_npm_workspaces.py
        language: system
        files: '\.(yml|yaml|py|js|json|sh|Makefile)$'
        pass_filenames: true
        description: "æ£€æŸ¥npm workspacesæ¶æ„è¿è§„ï¼Œé˜²æ­¢å­ç›®å½•npm ci/installè°ƒç”¨"

      # ğŸ—‚ï¸ DELETABLE æ–‡ä»¶å…ƒæ•°æ®æ£€æŸ¥
      - id: file-metadata-check
        name: Deletable File Metadata Check
        entry: python scripts/file_metadata_checker.py
        language: system
        pass_filenames: true
        description: "æ£€æŸ¥å¸¦deletableæ ‡è¯†çš„æ–‡ä»¶æ˜¯å¦åŒ…å«å¿…éœ€çš„å…ƒæ•°æ®æ³¨é‡Š"

      # ğŸ³ DOCKER-COMPOSE æ–‡ä»¶æ•°é‡é™åˆ¶
      - id: docker-compose-limit
        name: Docker Compose Files Limit Guard
        entry: python scripts/check_docker_compose_limit.py
        language: system
        files: "^docker-compose.*\\.(yml|yaml)$"
        pass_filenames: false
        always_run: true
        description: "é˜²æ­¢æ ¹ç›®å½•docker-composeæ–‡ä»¶æ•°é‡æ— é™å¢é•¿ï¼Œä¿æŒé…ç½®ç®€æ´"

      # ğŸ”’ SCRIPTS-GOLDEN æ ¸å¿ƒä¿æŠ¤è„šæœ¬å®ˆæŠ¤
      - id: scripts-golden-protection
        name: Scripts-Golden Protection Guard
        entry: python scripts/protect_golden_scripts.py
        language: system
        files: "^scripts-golden/.*$"
        pass_filenames: true
        fail_fast: true
        description: "ä¿æŠ¤scripts-goldenç›®å½•ä¸­çš„æ ¸å¿ƒå®‰å…¨è„šæœ¬ï¼Œé˜²æ­¢AIç¯¡æ”¹"
