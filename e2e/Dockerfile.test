# E2Eæµ‹è¯•çŽ¯å¢ƒ Dockerfile - è‡ªç»™è‡ªè¶³æž¶æž„
FROM node:20-slim

# è®¾ç½®å·¥ä½œç›®å½•ï¼ˆä¿æŒåœ¨æ ¹ç›®å½•ï¼Œé¿å…è·¯å¾„é—®é¢˜ï¼‰
WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆPlaywrightéœ€è¦ï¼‰
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    wget \
    ca-certificates \
    fonts-liberation \
    libasound2 \
    libatk-bridge2.0-0 \
    libatk1.0-0 \
    libc6 \
    libcairo2 \
    libcups2 \
    libdbus-1-3 \
    libexpat1 \
    libfontconfig1 \
    libgbm1 \
    libgcc1 \
    libglib2.0-0 \
    libgtk-3-0 \
    libnspr4 \
    libnss3 \
    libpango-1.0-0 \
    libpangocairo-1.0-0 \
    libstdc++6 \
    libx11-6 \
    libx11-xcb1 \
    libxcb1 \
    libxcomposite1 \
    libxcursor1 \
    libxdamage1 \
    libxext6 \
    libxfixes3 \
    libxi6 \
    libxrandr2 \
    libxrender1 \
    libxss1 \
    libxtst6 \
    lsb-release \
    xdg-utils \
    curl \
    && ln -s /usr/bin/python3 /usr/bin/python \
    && rm -rf /var/lib/apt/lists/*

# ðŸŽ¯ æœ€ä¼˜æ–¹æ¡ˆ1ï¼šç›´æŽ¥åœ¨å®¹å™¨å†…è®¾ç½®æ‰€æœ‰çŽ¯å¢ƒå˜é‡ï¼Œæ¶ˆé™¤å¤–éƒ¨ä¾èµ–
ENV CI=true
ENV NODE_ENV=test
ENV NPM_CONFIG_REGISTRY=https://registry.npmmirror.com/
ENV PLAYWRIGHT_BROWSERS_PATH=/app/ms-playwright
ENV TEST_BASE_URL=http://frontend-test:3000
ENV FRONTEND_URL=http://frontend-test:3000
ENV BACKEND_URL=http://backend-test:8000

# å¤åˆ¶e2eæµ‹è¯•ä»£ç 
COPY . ./e2e/

# è¿›å…¥e2eç›®å½•è¿›è¡Œå®‰è£…
WORKDIR /app/e2e

# ðŸŽ¯ æœ€ä¼˜æ–¹æ¡ˆ2ï¼šå½»åº•ç¦ç”¨workspaceï¼Œç¡®ä¿ä¾èµ–æœ¬åœ°å®‰è£…
RUN echo 'workspace-root=false' > .npmrc && \
    echo 'legacy-peer-deps=true' >> .npmrc

# ä¸¥æ ¼å¯é‡å¤æž„å»º
RUN npm config set registry https://registry.npmmirror.com/ && \
    npm config set fetch-timeout 300000 && \
    npm config set fetch-retry-maxtimeout 120000 && \
    npm config set fetch-retry-mintimeout 10000 && \
    npm ci --verbose

# ðŸš€ Phase 5.2: ç§»é™¤æµè§ˆå™¨ä¸‹è½½ï¼Œä¾èµ–æŒ‚è½½çš„ç¼“å­˜ (å…³é”®ä¼˜åŒ–)
# æ³¨é‡ŠæŽ‰æµè§ˆå™¨ä¸‹è½½ï¼šå°†é€šè¿‡Docker volumeæŒ‚è½½å®¿ä¸»æœºç¼“å­˜
# RUN npx playwright install --with-deps  # ç§»é™¤ï¼šèŠ‚çœ4-5åˆ†é’Ÿä¸‹è½½æ—¶é—´
RUN npx playwright --version && \
    npm list @playwright/test && \
    ls -la node_modules/.bin/ | grep playwright && \
    echo "ðŸš€ Playwrightå°†ä½¿ç”¨æŒ‚è½½çš„æµè§ˆå™¨ç¼“å­˜ï¼Œè·³è¿‡ä¸‹è½½ä»¥èŠ‚çœæ—¶é—´"

# ðŸš€ Phase 5.2: åˆ›å»ºç¼“å­˜ä¼˜åŒ–çš„å¯åŠ¨è„šæœ¬
RUN echo '#!/bin/bash' > /app/e2e/run-tests.sh && \
    echo 'set -e' >> /app/e2e/run-tests.sh && \
    echo 'echo "ðŸš€ Phase 5.2: E2EçŽ¯å¢ƒè‡ªæ£€ (ç¼“å­˜ä¼˜åŒ–ç‰ˆ)..."' >> /app/e2e/run-tests.sh && \
    echo 'echo "å·¥ä½œç›®å½•: $(pwd)"' >> /app/e2e/run-tests.sh && \
    echo 'echo "çŽ¯å¢ƒå˜é‡: TEST_BASE_URL=$TEST_BASE_URL, FRONTEND_URL=$FRONTEND_URL"' >> /app/e2e/run-tests.sh && \
    echo 'echo "Playwrightç‰ˆæœ¬: $(npx playwright --version)"' >> /app/e2e/run-tests.sh && \
    echo 'echo "ðŸš€ ç¼“å­˜ä¼˜åŒ–æ£€æŸ¥: PLAYWRIGHT_BROWSERS_PATH=$PLAYWRIGHT_BROWSERS_PATH"' >> /app/e2e/run-tests.sh && \
    echo 'echo "æŒ‚è½½çš„æµè§ˆå™¨ç¼“å­˜:"' >> /app/e2e/run-tests.sh && \
    echo 'ls -la $PLAYWRIGHT_BROWSERS_PATH/ 2>/dev/null || echo "âš ï¸ ç¼“å­˜è·¯å¾„æœªæ‰¾åˆ°ï¼Œå°†ä½¿ç”¨é»˜è®¤ä½ç½®"' >> /app/e2e/run-tests.sh && \
    echo 'echo "å¯ç”¨é…ç½®æ–‡ä»¶:"' >> /app/e2e/run-tests.sh && \
    echo 'ls -la *.config.* || echo "æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶"' >> /app/e2e/run-tests.sh && \
    echo 'echo "ðŸ§ª å¼€å§‹æ‰§è¡ŒE2Eæµ‹è¯• (ç¼“å­˜ä¼˜åŒ–ï¼Œæ— éœ€ä¸‹è½½)..."' >> /app/e2e/run-tests.sh && \
    echo 'exec ./node_modules/.bin/playwright test --grep "@critical" --project=chromium --reporter=list' >> /app/e2e/run-tests.sh && \
    chmod +x /app/e2e/run-tests.sh

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD ./node_modules/.bin/playwright --version > /dev/null 2>&1

# ðŸŽ¯ æœ€ä¼˜æ–¹æ¡ˆï¼šä½¿ç”¨è‡ªç»™è‡ªè¶³è„šæœ¬ï¼Œæ¶ˆé™¤æ‰€æœ‰ä¸­é—´çŽ¯èŠ‚
CMD ["./run-tests.sh"]
